                                                                                                     
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="google-site-verification" content="avAOYmLGInigyninrH1UV5TAnarbb_TEx8vKUeGaN-o" />
   <!-- ‚úÖ Leaflet (OpenStreetMap) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <title>Teacher Swaps Kenya</title>
  <style>
    /* ... Your existing styles unchanged ... */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .blurred {
      filter: blur(5px);
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }
    .blurred:hover {
      filter: none; /* Hint at visibility after payment */
    }
    header {
      background-color: #4CAF50;
      color: white;
      padding: 15px;
      text-align: center;
    }
    nav ul {
      list-style-type: none;
      padding: 0;
    }
    nav ul li {
      display: inline;
      margin: 0 10px;
    }
#swapTable th {
  color: red;
  font-weight: bold;
}

    main {
      padding: 20px;
    }
    footer {
      background-color: #4CAF50;
      color: white;
      text-align: center;
      padding: 10px;
      position: relative;
      bottom: 0;
      width: 100%;
    }
    form {
      max-width: 400px;
      margin: auto;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input,
    select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table,
    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }

    /* Payment Modal Styles */
    #paymentModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
    }
    #paymentModal .modal-content {
      margin: 15% auto;
      padding: 20px;
      background: white;
      width: 80%;
      max-width: 400px;
      text-align: center;
      border-radius: 8px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
    }

    /* Alert Styling */
    .alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #4CAF50;
      color: white;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
      z-index: 1000;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
    }
  #matchesModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 70%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 500px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    text-align: center;
  }
  .modal-content button {
  margin-top: 15px;
  padding: 10px 20px;
  background-color: #4CAF50; /* Green */
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.modal-content button:hover {
  background-color: #45a049; /* Slightly darker green for hover */
}

  #registerForm input {
    background-color: #e6f7ff; /* Light blue background */
    border: 2px solid #3399ff; /* Blue border */
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
    font-size: 16px;
  }

  #registerForm input:focus {
    background-color: #d0f0ff; /* Slightly brighter on focus */
    outline: none;
    border-color: #007acc;
  }

  #registerForm label {
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
    font-weight: bold;
  }

  #registerForm button {
    margin-top: 15px;
    padding: 10px 20px;
    background-color: #3399ff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
  }

  #registerForm button:hover {
    background-color: #007acc;
  }
  /* Common input/select styling */
  form input,
  form select {
    background-color: #e6f7ff;
    border: 2px solid #3399ff;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
    font-size: 16px;
  }

  form input:focus,
  form select:focus {
    background-color: #d0f0ff;
    outline: none;
    border-color: #007acc;
  }

  form label {
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
    font-weight: bold;
  }

  form button {
    margin-top: 15px;
    padding: 10px 20px;
    background-color: #3399ff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
  }

  form button:hover {
    background-color: #007acc;
  }
  /* Styled input and select fields */
  form input,
  form select,
  select {
    background-color: #e6f7ff;
    border: 2px solid #3399ff;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 8px;
    width: 100%;
    box-sizing: border-box;
    font-size: 16px;
  }

  form input:focus,
  form select:focus,
  select:focus {
    background-color: #d0f0ff;
    outline: none;
    border-color: #007acc;
  }

  /* Labels */
  label {
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
    font-weight: bold;
  }

  /* Buttons */
  button {
    margin: 8px 5px 15px 0;
    padding: 10px 16px;
    background-color: #3399ff;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
  }

  button:hover {
    background-color: #007acc;
  }

  .trigger-button {
    background-color: #33cc99;
  }

  .trigger-button:hover {
    background-color: #29a37d;
  }
 #register {
    display: none;
    background-image: url('https://i.imgur.com/WKwJ73A.jpeg');
    background-size: cover;
    background-position: center;
    padding: 40px;
    border-radius: 12px;
    color: white;
    min-height: 100vh; /* full viewport height */
  }

  #register h2,
  #register label {
    color: white;
    text-shadow: 1px 1px 3px #000;
  }

  #registerForm {
    background-color: rgba(0, 0, 0, 0.5); /* semi-transparent form background */
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    margin: auto;
  }

  #registerForm input {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: none;
    border-radius: 5px;
  }

  #registerForm button {
    width: 100%;
    padding: 10px;
    background-color: #4CAF50;
    border: none;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }

  #registerForm button:hover {
    background-color: #45a049;
  }

 #login {
    display: none;
    background-image: url('  https://i.imgur.com/iqBwsWm.png           ');
    background-size: cover;
    background-position: center;
    padding: 40px;
    border-radius: 12px;
    color: white;
    min-height: 100vh;
  }

  #login h2,
  #login label {
    color: white;
    text-shadow: 1px 1px 3px #000;
  }

  #loginForm {
    background-color: rgba(0, 0, 0, 0.5); /* transparent dark background for form */
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    margin: auto;
  }

  #loginForm input {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: none;
    border-radius: 5px;
  }

  #loginForm button {
    width: 100%;
    padding: 10px;
    background-color: #2196F3;
    border: none;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }

  #loginForm button:hover {
    background-color: #1976D2;
  }

#swaps {
  display: none;
  background-color: #4caf50; /* Green color */
  padding: 40px;
  border-radius: 12px;
  color: white;
  min-height: 100vh;
}


  #swaps h2,
  #swaps label {
    color: white;
    text-shadow: 1px 1px 3px #000;
  }

  #swapForm {
    background-color: rgba(0, 0, 0, 0.5); /* dark translucent form bg */
    padding: 20px;
    border-radius: 10px;
    max-width: 600px;
    margin: auto;
  }

  #swapForm input,
  #swapForm select {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: none;
    border-radius: 5px;
  }

  #swapForm button {
    width: 100%;
    padding: 10px;
    background-color: #ff9800;
    border: none;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }

  #swapForm button:hover {
    background-color: #f57c00;
  }

.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.7);
}

.modal-content {
  background: linear-gradient(135deg, #fff0f6, #ffe6f0);
  margin: 10% auto;
  padding: 20px;
  border-radius: 12px;
  width: 80%;
  max-width: 350px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  font-family: 'Arial', sans-serif;
}

.modal-body p {
  margin: 10px 0;
  color: #444;
  font-size: 15px;
}

.close {
  float: right;
  font-size: 24px;
  font-weight: bold;
  color: #f44336;
  cursor: pointer;
}
.market-card {
  padding: 20px;
  background: #ffe4b5;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.1);
  box-sizing: border-box;
  width: 100%; /* ‚úÖ Allow it to fully fill the grid cell */
}

#bomJobsTable {
  width: 100%;
  border-collapse: collapse;
}
  .form-wrapper {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    gap: 20px;
    padding: 20px;
  }

  .form-wrapper form {
    flex: 1;
    max-width: 600px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 10px;
    background: #f9f9f9;
  }

  .side-image {
    flex: 0 0 150px;
  }

  .side-image img {
    width: 100%;
    height: auto;
    border-radius: 10px;
  }

  form input,
  form select,
  form button {
    width: 100%;
    margin-bottom: 12px;
    padding: 10px;
    font-size: 16px;
  }

  form button {
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }

  form button:hover {
    background-color: #0056b3;
  }

  @media (max-width: 768px) {
    .form-wrapper {
      flex-direction: column;
      align-items: center;
    }

    .side-image {
      display: none;
    }
  }
  .chat-bubble {
    display: flex;
    margin-bottom: 10px;
    max-width: 90%;
  }

  .chat-bubble.left {
    justify-content: flex-start;
  }

  .chat-bubble.right {
    justify-content: flex-end;
  }

  .chat-avatar {
    width: 35px;
    height: 35px;
    background: #bbb;
    color: white;
    border-radius: 50%;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    line-height: 35px;
    margin-right: 10px;
    flex-shrink: 0;
  }

  .chat-bubble.right .chat-avatar {
    order: 2;
    margin-left: 10px;
    margin-right: 0;
  }

  .chat-content {
    background: #f1f1f1;
    border-radius: 8px;
    padding: 8px 12px;
    max-width: 250px;
    position: relative;
  }

  .chat-bubble.right .chat-content {
    background: #007bff;
    color: white;
  }

  .chat-name {
    font-size: 0.9em;
    font-weight: bold;
    margin-bottom: 4px;
  }

  .chat-time {
    font-size: 0.75em;
    color: #999;
    text-align: right;
    margin-top: 4px;
  }
 .form-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px; /* space between items */
  }

  .side-image {
    width: 120px;
    height: auto;
  }

  #resourceForm {
    display: flex;
    flex-direction: column;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  #resourceForm label {
    margin-top: 10px;
  }

  #resourceForm input,
  #resourceForm button {
    margin-top: 5px;
    padding: 8px;
    font-size: 1rem;
  }

  #resourceForm button {
    margin-top: 15px;
    background-color: #1e90ff;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #resourceForm button i {
    margin-right: 6px;
  }
.form-container {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .side-image {
    width: 120px;
    height: auto;
  }

  #soulmateForm {
    display: flex;
    flex-direction: column;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    max-width: 400px;
    flex: 1;
  }

  #soulmateForm label {
    margin-top: 10px;
    font-weight: bold;
  }

  #soulmateForm input,
  #soulmateForm select {
    margin-top: 5px;
    padding: 8px;
    font-size: 1rem;
  }

  #soulmateForm button {
    margin-top: 20px;
    background-color: #e91e63;
    color: white;
    border: none;
    padding: 10px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 4px;
  }

  #soulmateForm button i {
    margin-right: 6px;
  }
.swap-card button:hover {
  opacity: 0.9;
  cursor: pointer;
}
.job-card {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  background-color: #f9f9f9;
}

.job-card h3 {
  color: #2e7d32;
}

.job-card p {
  margin-bottom: 8px;
}

.job-card button {
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
}

.rating {
  margin-top: 10px;
}

.rating .fas {
  cursor: pointer;
  color: #ccc;
}
#soulmateContainer {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Larger cards */
  gap: 20px;
  padding: 20px;
  box-sizing: border-box;
  max-width: 1200px;           
  margin: 0 auto;              
  max-height: 90vh;            
  overflow-y: auto;            /* Enables scrolling */
  scroll-behavior: smooth;     /* ‚úÖ Smooth scrolling */
  
  /* Hide scrollbar (works on most browsers) */
  scrollbar-width: none;       /* Firefox */
}
#soulmateContainer::-webkit-scrollbar {
  display: none;               /* Chrome, Safari */
}

body {
  margin: 0;
  padding: 0;
  font-family: sans-serif;
  background: #fafafa;
}

.soulmate-card {
  padding: 20px;
  background: #f0f8ff;         
  border: 1px solid #ccc;
  border-radius: 10px;
  min-height: 170px;
  width: 100%;                 
  box-sizing: border-box;
  box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.soulmate-card:hover {
  transform: translateY(-5px); /* ‚úÖ Floating effect instead of snap */
  box-shadow: 4px 6px 15px rgba(0,0,0,0.15);
}


@media (max-width: 768px) {
  /* Adjust the layout for mobile */
  #soulmateContainer {
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); /* Ensures smaller screens still look good */
  }

  .soulmate-card {
    padding: 15px; /* Slightly reduced padding for mobile */
  }
}
/* Style for headers */
header h1 {
  color: white;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.5rem;
  padding: 10px 20px;
  border: 2px solid #4CAF50; /* Green border */
  border-radius: 10px; /* Rounded corners */
  margin: 10px 0;
  background-color: rgba(0, 0, 0, 0.2); /* Semi-transparent background */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); /* Shadow for depth */
}

/* Apply border to other headers, like h2 */
h2 {
  color: #2196f3;
  padding: 8px 15px;
  border: 2px solid #2196f3; /* Blue border */
  border-radius: 8px;
  margin-bottom: 15px;
  background-color: #f1f8ff; /* Light background for contrast */
}

/* For smaller screens, adjust the header for better visibility */
@media (max-width: 768px) {
  header h1 {
    font-size: 1.2rem; /* Slightly smaller font size */
    padding: 8px 15px; /* Adjust padding for mobile */
  }

  h2 {
    font-size: 1.1rem;
    padding: 6px 12px; /* Adjust padding for smaller screens */
  }
}


.verified-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #4caf50;
  color: white;
  font-size: 12px;
  padding: 3px 7px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 2px rgba(0,0,0,0.2);
}


/* Photo Section */
.soulmate-photo img {
  border-radius: 8px;
  object-fit: cover;
  max-height: 200px;
  width: 100%;
}

/* Header Section (Name and Title) */
.soulmate-details h3 {
  color: #ffffff; /* White text for the name */
  font-size: 1.2em;
  background-color: #00796b; /* Green background for the name header */
  padding: 8px;
  border-radius: 8px;
  margin: 0;
  text-align: center;
}

/* Text Details Styling */
.soulmate-details p {
  margin-bottom: 5px;
  color: #333; /* Dark text color for clarity */
}

/* Contact Actions */
.contact-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.contact-actions a {
  color: #2196f3; /* Blue color for the phone/whatsapp links */
  text-decoration: none;
}

.contact-actions button {
  padding: 8px 12px;
  border-radius: 5px;
  cursor: pointer;
  background-color: #673ab7; /* Purple color for buttons */
  color: white;
  border: none;
  transition: background-color 0.3s ease;
}

.contact-actions button:hover {
  background-color: #5e35b1; /* Slightly darker purple on hover */
}

/* Rating Section */
.rating {
  margin-top: 10px;
}

.rating .fas {
  cursor: pointer;
  color: #ccc;
}

.rating .avg-rating {
  font-size: 1.1em;
  color: #00796b; /* Green color for the average rating */
}

/* Background Color Variations (Optional) */
.soulmate-card:nth-child(odd) {
  background-color: #e0f7fa; /* Light cyan for odd cards */
}

.soulmate-card:nth-child(even) {
  background-color: #f1f8e9; /* Light green for even cards */
}

.soulmate-details p {
  margin-bottom: 5px;
  color: #333; /* Dark text color */
  display: flex;
  align-items: center;
}

.soulmate-details p i {
  margin-right: 8px; /* Space between icon and text */
  color: #00796b; /* Color for the icons */
}

.soulmate-details h3 {
  font-size: 1.2em;
  display: flex;
  align-items: center;
}

.soulmate-details h3 i {
  margin-right: 8px;
}

.contact-actions button {
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  background-color: #673ab7;
  color: white;
  border: none;
}

.contact-actions a {
  color: #2196f3;
  text-decoration: none;
}
/* Highlight occupation with red background */
.highlight-occupation {
  color: red; /* Red text */
  font-weight: bold; /* Bold text */
  background-color: #ffebee; /* Light red background */
  padding: 4px; /* Padding to give space around the text */
  border-radius: 4px; /* Rounded corners */
}

.service-card {
  scroll-snap-align: start;
  padding: 12px; /* Reduced padding to decrease card height */
  background: #f0f8ff; /* Light blue background */
  border: 1px solid #ccc;
  border-radius: 10px;
  min-height: 80px; /* Reduced the minimum height */
  width: 100%; /* Makes it fill available grid column */
  box-sizing: border-box; /* Includes padding in width */
  box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease; /* Optional: smooth hover effect */
  overflow: hidden; /* Ensure content doesn't overflow */
}


/* Service Details */
.service-details {
  font-size: 1em;
}

.service-details p {
  margin-bottom: 5px;
  display: flex;
  align-items: center;
}

.service-details i {
  margin-right: 8px; /* Space between icon and text */
}

/* Contact Buttons */
.contact-actions a {
  color: #2196f3;
  text-decoration: none;
}

.contact-actions button {
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  background-color: #673ab7;
  color: white;
  border: none;
}

.contact-actions button:hover {
  background-color: #5e35b1;
}

/* Rating Stars */
.rating .fas {
  cursor: pointer;
  color: #ccc;
}
/* Highlight occupation with red background */
.highlight-occupation {
  color: red; /* Red text */
  font-weight: bold; /* Bold text */
  background-color: #ffebee; /* Light red background */
  padding: 4px; /* Padding to give space around the text */
  border-radius: 4px; /* Rounded corners */
}

/* Contact Buttons */
.contact-actions a {
  color: #2196f3;
  text-decoration: none;
}

.contact-actions button {
  padding: 6px 12px;
  border-radius: 5px;
  cursor: pointer;
  background-color: #673ab7;
  color: white;
  border: none;
}

.contact-actions button:hover {
  background-color: #5e35b1;
}

/* Rating Stars */
.rating .fas {
  cursor: pointer;
  color: #ccc;
}
.verified-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background-color: #e6f2ff;
  color: #007bff;
  font-weight: bold;
  font-size: 0.85em;
  padding: 4px 8px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}
 nav ul {
  list-style: none;
  padding: 0;
  margin: 0 auto;
  max-width: 1000px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px;
  justify-content: center;
}

nav ul li {
  text-align: center;
}

.menu-box {
  display: block;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 16px 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  text-decoration: none;
  color: #333;
}

.menu-box:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.menu-box img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  margin-bottom: 8px;
}

.menu-box span {
  display: block;
  font-size: 14px;
  font-weight: 600;
  margin-top: 4px;
}

/* Notification badge */
#notifBadge {
  display: none;
  background: red;
  color: white;
  border-radius: 50%;
  padding: 2px 6px;
  font-size: 11px;
  position: absolute;
  top: -5px;
  right: -5px;
}
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

.alert {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #4CAF50;
  color: white;
  padding: 15px;
  border-radius: 5px;
  text-align: center;
  z-index: 1000;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
}
.chat-item {
  display: flex;
  align-items: center;
  background: #ffffff;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.chat-item:hover {
  background: #f7f7f7;
}

.chat-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #d5d5d5;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #333;
  font-weight: bold;
  font-size: 20px;
  margin-right: 14px;
  overflow: hidden;
}

.chat-item-content {
  flex: 1;
}

.chat-name {
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.chat-last-message {
  font-size: 14px;
  color: #666;
  margin-top: 4px;
}

.chat-timestamp {
  font-size: 12px;
  color: #999;
  margin-top: 4px;
}

.chat-badge {
  background: #e53935;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  position: absolute;
  right: 12px;
  top: 12px;
}
.blurred-number {
  filter: blur(5px);
  color: gray;
  cursor: pointer;
  user-select: none;
}
@keyframes popFade {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.4); opacity: 0.8; }
  100% { transform: scale(1.8); opacity: 0; }
}
.like-button {
  background: #f0f2f5;
  border: 1px solid #ccc;
  border-radius: 20px;
  font-size: 16px;
  padding: 4px 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.like-button.liked {
  background: #1877f2;
  color: white;
  border-color: #1877f2;
}
@keyframes floatUp {
  to {
    transform: translateY(-120vh) rotate(360deg);
    opacity: 0;
  }
}
.custom-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
}

.custom-modal-content {
  background: linear-gradient(to right, #fdfbfb, #ebedee);
  border-radius: 12px;
  padding: 25px 30px;
  text-align: center;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  position: relative;
  animation: fadeIn 0.4s ease;
}

.custom-modal-content h2 {
  color: #2196f3;
  margin-bottom: 12px;
}

.custom-modal-content p {
  color: #444;
  margin-bottom: 20px;
}

.custom-close-btn {
  position: absolute;
  top: 10px;
  right: 14px;
  font-size: 24px;
  color: #f44336;
  cursor: pointer;
}

.pay-now-btn {
  background: #4CAF50;
  color: white;
  font-size: 16px;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.pay-now-btn:hover {
  background: #388e3c;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}
  .scrolling-banner {
    background-color: #fff3e0;
    border-bottom: 2px solid #ff7043;
    overflow: hidden;
    position: relative;
    white-space: nowrap;
    height: 40px;
    display: flex;
    align-items: center;
  }

  .scrolling-banner-content {
    display: inline-block;
    white-space: nowrap;
    padding-left: 120%;
    animation: scrollRight 100s linear infinite; /* ‚¨ÖÔ∏è Slower scroll */
    font-weight: bold;
    color: #d84315;
    font-size: 18px;
  }

  @keyframes scrollRight {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }
.scrolling-banner-content:hover {
  animation-play-state: paused;
}
/* üîÑ Spinner Fix (in case Font Awesome didn‚Äôt load properly) */
.fa-spinner {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* üé® Trending Highlight Animation */
.trending-highlight {
  background: #fffde7;
  border: 2px solid #ff9800;
  border-radius: 10px;
  padding: 10px;
  animation: glowPulse 1.8s ease-in-out infinite;
  box-shadow: 0 0 10px rgba(255, 152, 0, 0.4);
  margin-bottom: 12px;
}

@keyframes glowPulse {
  0% {
    box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
  }
  50% {
    box-shadow: 0 0 20px rgba(255, 152, 0, 0.6);
  }
  100% {
    box-shadow: 0 0 10px rgba(255, 152, 0, 0.3);
  }
}
.stars-container {
  display: flex;
  gap: 5px;
  cursor: pointer;
}

.star {
  font-size: 30px;
  color: #ddd;
}

.star:hover {
  color: gold;
}

.star.selected {
  color: gold;
}
.photo-container {
    position: relative;
    width: 200px;
    text-align: center;
    background-color: #f8f8f8;
    border-radius: 10px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 320px;
  }

  .photo-container img {
    width: 100%;
    height: 150px;
    object-fit: cover;
  }

  .buy-button {
    position: relative;
    margin-top: 10px;
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    margin-top: auto;
  }

  .photo-container:hover img {
    filter: blur(5px);
  }

  /* Modal Styles */
  #imageModal {
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  #buyNowButton {
    display: block;
  }

  #downloadButton {
    display: none; /* Hidden until after payment */
  }
/* Style for the logged-in user display */
#loggedInUser {
  text-align: center;
  margin-top: 10px;
  font-size: 18px;
  font-weight: bold;
}

#loggedInUser button {
  padding: 4px 8px;
  border: none;
  border-radius: 5px;
  background: red;
  color: white;
  cursor: pointer;
}

#loggedInUser button:hover {
  background: darkred; /* Darker color on hover */
}

/* Additional Header Styling */
header {
  background-color: #4CAF50;
  padding: 15px;
  text-align: center;
  position: relative;
}
/* Header container style */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
}

/* Left and Right Image Style */
header img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 50%; /* Circular images */
}

/* Logged-in user section styling */
#loggedInUser {
  text-align: center;
  font-weight: bold;
  color: white;
  margin-top: 10px;
}

/* Advertisement styling inside the header */
header p {
  font-size: 14px;
  color: white;
  margin-top: 10px;
}

/* Sponsored ad link style */
header a {
  color: #007bff;
  font-weight: bold;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  header {
    flex-direction: column; /* Stack header items vertically on smaller screens */
    align-items: center;
  }

  header img {
    width: 40px;
    height: 40px;
  }

  #loggedInUser {
    font-size: 14px;
  }

  header p {
    font-size: 12px;
  }

  header a {
    font-size: 12px;
  }
}
#alertsContainer {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px;
  max-height: 400px;
  overflow-y: auto;
  background: #e8f5e9; /* pale green */
  border: 2px solid #4CAF50;
  border-radius: 10px;
}
.alert-box {
  background: #ffffff;
  border: 2px solid #4CAF50;
  padding: 12px 16px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  font-size: 15px;
  color: #333;
}
#alertsContainer::-webkit-scrollbar {
  width: 6px;
}
#alertsContainer::-webkit-scrollbar-thumb {
  background-color: #4CAF50;
  border-radius: 10px;
}

  .likes-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .likes-modal-content {
    background: #fff;
    padding: 15px 20px;
    border-radius: 6px;
    width: 80%;
    max-width: 300px; /* Reduced width */
    max-height: 75%;
    overflow-y: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    text-align: center;
    font-size: 14px; /* Smaller text */
  }

  .likes-modal-close {
    position: absolute;
    right: 18px;
    top: 12px;
    font-size: 24px;
    cursor: pointer;
    color: #666;
  }

  #likesList {
    list-style: none;
    padding: 0;
    margin: 12px 0 0;
    text-align: left;
    font-size: 13px; /* Smaller list text */
  }

  #likesList li {
    padding: 6px;
    border-bottom: 1px solid #eee;
  }
  .alert-card {
    position: relative;
    background: #f9f9f9;
    border-left: 4px solid #007bff;
    padding: 10px 15px;
    margin: 10px 0;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .dots-btn {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
  }

  .dropdown {
    position: relative;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background-color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    padding: 5px;
    border-radius: 4px;
    z-index: 1000;
  }

  .dropdown-content button {
    background: none;
    border: none;
    padding: 5px 10px;
    width: 100%;
    text-align: left;
    cursor: pointer;
  }

  .dropdown-content button:hover {
    background-color: #f0f0f0;
  }
  #loadingSpinner {
    display: flex;
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
    z-index: 9999;
  }
  .spinner-container {
    text-align: center;
    padding: 30px;
  }
  .spinner {
    font-size: 36px;
    color: #ff5722;
  }
  .spinner-text {
    color: #666;
    font-weight: bold;
    margin-top: 10px;
    }
.chat-msg {
  margin: 6px 0;
  padding: 8px;
  border-radius: 6px;
  max-width: 75%;
  word-wrap: break-word;
}
.chat-out {
  background: #4CAF50;
  color: #fff;
  align-self: flex-end;
}
.chat-in {
  background: #ccc;
  color: #000;
  align-self: flex-start;
}
.chat-loading {
  text-align: center;
  color: gray;
}
.chat-alert {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  padding: 10px 15px;
  border-radius: 5px;
  font-weight: bold;
  color: #fff;
  z-index: 9999;
}
/* Incoming message */
.chat-msg.chat-in {
  background: #f1f1f1;
  color: #333;
  padding: 6px 10px;
  border-radius: 10px;
  max-width: 70%;
  margin: 4px 0;
  font-size: 14px;
  line-height: 1.4;
  align-self: flex-start;
}

/* Outgoing message */
.chat-msg.chat-out {
  background: #dcf8c6; /* WhatsApp-like green */
  color: #000;
  padding: 6px 10px;
  border-radius: 10px;
  max-width: 70%;
  margin: 4px 0;
  font-size: 14px;
  line-height: 1.4;
  align-self: flex-start; /* Changed from flex-end */
}

/* Delete button inside outgoing */
.msg-del-btn {
  background: none;
  border: none;
  font-size: 14px;
  margin-right: 5px;
  cursor: pointer;
  color: #888;
}

.msg-del-btn:hover {
  color: red;
}

/* Chat container flex column */
#marketChatMessages {
  display: flex;
  flex-direction: column;
}
.msg-username {
  font-size: 12px;
  font-weight: bold;
  color: #555;
  margin-bottom: 2px;
}
/* Style for Sent Chats Section */
.chat-item {
  display: flex;
  align-items: center;
  background: #f9f9f9;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  cursor: pointer;
}

.chat-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #bbb;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 20px;
  margin-right: 14px;
}

.chat-name {
  font-size: 16px;
  font-weight: bold;
}

.chat-last-message {
  font-size: 14px;
  color: #666;
}

.chat-timestamp {
  font-size: 12px;
  color: #999;
}

#marketChatModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
  display: none;
}

#marketChatMessages {
  max-height: 60vh;
  overflow-y: auto;
}

.chat-msg {
  padding: 8px;
  border-radius: 6px;
  max-width: 70%;
}

.chat-out {
  background: #4CAF50;
  color: #fff;
  align-self: flex-end;
}

.chat-in {
  background: #ccc;
  color: #000;
  align-self: flex-start;
}

button {
  background-color: #4CAF50;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

button:hover {
  background-color: #45a049;
}
/* Style for three dots menu (ellipsis) */
.chat-msg .msg-options {
  cursor: pointer;
  font-size: 18px;
  color: #888;
  margin-left: 10px;
}

/* Styling for the message options popup */
.chat-msg-options {
  display: none;
  position: absolute;
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 5px;
  padding: 10px;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
  z-index: 9999;
  font-size: 14px;
}

.chat-msg-options button {
  background: none;
  border: none;
  color: #007bff;
  cursor: pointer;
  padding: 5px 10px;
  width: 100%;
  text-align: left;
}

.chat-msg-options button:hover {
  background-color: #f1f1f1;
}

.chat-msg-options .option-header {
  font-weight: bold;
  margin-bottom: 10px;
}
   /* Modal background */
.image-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

/* Modal content */
.modal-content {
  position: relative;
  background-color: white;
  padding: 20px;
  border-radius: 8px;
  max-width: 90%;
  max-height: 90%;
  overflow: hidden;
  text-align: center;
}

/* Close button */
.close {
  position: absolute;
  top: 10px;
  right: 10px;
  color: #aaa;
  font-size: 30px;
  font-weight: bold;
  cursor: pointer;
}

/* Loader Spinner */
.loading-message {
  text-align: center;
  padding: 30px;
}

.loading-icon {
  font-size: 36px;
  color: #ff5722;
}

.trending-label {
  font-size: 13px;
  background: #ff5722;
  color: white;
  padding: 3px 8px;
  border-radius: 4px;
  font-weight: bold;
  margin-bottom: 8px;
}

/* No Trending Items Message */
.no-trending-items {
  text-align: center;
  color: #999;
  font-size: 16px;
  font-weight: 500;
  margin-top: 20px;
}

/* For Trending Highlight Animations */
.trending-highlight {
  margin-bottom: 12px;
  padding: 10px;
  background: #f9f9f9;
  border-radius: 8px;
  box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

  /* Desktop - Grid layout (default) */
  #servicesContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Grid with flexible columns */
    gap: 20px;
  }

  /* Mobile - Stacked layout */
  @media (max-width: 768px) {
    #servicesContainer {
      display: block; /* Stack the items vertically on mobile */
      padding: 10px; /* Reduced padding for mobile */
      overflow-y: visible; /* Allow full content visibility without scroll */
      max-height: none; /* No height restriction on mobile */
    }

    /* Optional: Styling for individual cards */
    .service-card {
      padding: 15px; /* Adjust card padding on mobile */
      margin-bottom: 10px; /* Space between cards */
    }
  }

  #filters label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
  }

  #filters select, 
  #filters input {
    width: 150px; /* Reduced width */
    padding: 6px;
    margin-bottom: 10px;
    font-size: 14px;
  }

  #filters {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }

  #filters select,
  #filters input {
    margin-right: 15px;
  }

  /* Optional: Adjust label width for better spacing */
  #filters label {
    width: 120px;
    display: inline-block;
    margin-right: 10px;
  }

.modal {
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 400px;
  text-align: center;
  position: relative;
}
.modal-content h3 {
  margin-top: 0;
}
.modal-buttons {
  display: flex;
  justify-content: space-around;
  margin-top: 20px;
}
.btn-danger {
  background-color: #e53935;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
}
.btn-secondary {
  background-color: #9e9e9e;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
}
.close {
  position: absolute;
  top: 10px; right: 15px;
  font-size: 24px;
  cursor: pointer;
}
/* ‚úÖ Modal (centered popup) */
.modal {
  display: none; /* hidden until triggered */
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6); /* slightly darker backdrop */
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  position: relative;
}

/* ‚úÖ Close button (X) */
.close {
  position: absolute;
  top: 10px; right: 15px;
  font-size: 24px;
  cursor: pointer;
}
.close:hover {
  color: red;
}

/* ‚úÖ Spinner always above modals */
#loadingSpinner {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000; /* higher than modal */
}

/* ‚úÖ Alerts always on top */
.custom-alert {
  position: fixed;
  top: 20px; left: 50%;
  transform: translateX(-50%);
  z-index: 3000; /* highest */
  padding: 12px 20px;
  border-radius: 5px;
  font-weight: bold;
  background: #333;
  color: white;
  display: none;
}

/* Background images for each modal */
.register-bg {
  background: url('https://i.imgur.com/oWpi8PT.jpeg') no-repeat center center;
  background-size: cover;
  color: white; /* make text readable */
}

.login-bg {
  background: url('https://i.imgur.com/1fafhnF.jpeg') no-repeat center center;
  background-size: cover;
  color: white; /* make text readable */
}

/* Optional: make inputs stand out */
.register-bg form input,
.login-bg form input {
  background-color: rgba(255, 255, 255, 0.9);
  border: none;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 5px;
}

.register-bg h2,
.login-bg h2 {
  text-shadow: 1px 1px 3px #000;
}
/* Dark Mode Styles */
body.dark-mode {
  background-color: #121212;
  color: #e0e0e0;
}

.dark-mode header {
  background-color: #1f1f1f;
}

.dark-mode .menu-box {
  background-color: #333;
  color: #e0e0e0;
  border: 1px solid #555;
}

.dark-mode button {
  background-color: #333;
  color: white;
}

.dark-mode button:hover {
  background-color: #555;
}

.dark-mode #loggedInUser {
  color: #e0e0e0;
}

.dark-mode .scrolling-banner {
  background-color: #2c2c2c;
  color: #e0e0e0;
}

.dark-mode a {
  color: #bb86fc;
}
/* Custom Mode Styles */
body.custom-mode {
  background-color: var(--custom-bg-color, #ffffff);
  color: var(--custom-text-color, #000000);
  font-size: var(--custom-font-size, 16px);
}

/* Define styles for each theme */
body.theme1 {
  background-color: #1e3a5f;
  color: #ffffff;
}

body.theme2 {
  background-color: #2e8b57;
  color: #ffffff;
}

body.theme3 {
  background-color: #ff5733;
  color: #ffffff;
}

body.theme4 {
  background-color: #e1b07b;
  color: #4e4e4e;
}

body.theme5 {
  background-color: #9b1e5a;
  color: #ffffff;
}

body.theme6 {
  background-color: #f4c6d9;
  color: #4e4e4e;
}

body.theme7 {
  background-color: #5a5a5a;
  color: #e8e8e8;
}

body.theme8 {
  background-color: #87ceeb;
  color: #ffffff;
}

body.theme9 {
  background-color: #8b4513;
  color: #ffffff;
}

body.theme10 {
  background-color: #0a2f52;
  color: #ffffff;
}

body.theme11 {
  background-color: #6a5acd;
  color: #ffffff;
}

body.theme12 {
  background-color: #ff8c00;
  color: #ffffff;
}

body.theme13 {
  background-color: #1f1f1f;
  color: #e6f0ff;
}

body.theme14 {
  background-color: #ff7f32;
  color: #ffffff;
}

body.theme15 {
  background-color: #b3e5fc;
  color: #1a237e;
}

body.theme16 {
  background-color: #212121;
  color: #bdbdbd;
}

body.theme17 {
  background-color: #66bb6a;
  color: #ffffff;
}

body.theme18 {
  background-color: #ffe5b4;
  color: #000000;
}

body.theme19 {
  background-color: #9e2a2b;
  color: #ffffff;
}

body.theme20 {
  background-color: #98ff98;
  color: #1b5e20;
}
/* Theme Customization Modal Width */
#themeCustomization {
  max-width: 400px; /* Default width for larger screens */
  width: 100%; /* Full width on small screens */
}

/* For small devices like phones */
@media (max-width: 768px) {
  #themeCustomization {
    max-width: 300px; /* Narrower modal on smaller devices */
    width: 100%;
  }
}
/* Styling for the floating buttons */
#themeCustomizeToggle, #scanPricesBtn {
  position: fixed;
  z-index: 9999;
  padding: 10px 15px;
  border-radius: 6px;
  color: white;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

/* Theme Customization Button */
#themeCustomizeToggle {
  bottom: 80px; /* Distance from the bottom */
  right: 20px;
  background: #4CAF50;
}

/* Scan Prices Button */
#scanPricesBtn {
  bottom: 20px; /* Distance from the bottom */
  right: 20px;
  background: #007bff;
}

/* Responsive Design for smaller screens */
@media (max-width: 768px) {
  #themeCustomizeToggle, #scanPricesBtn {
    font-size: 12px;
    padding: 8px 12px;
  }
  #themeCustomizeToggle {
    bottom: 70px; /* Adjust bottom position for mobile */
  }
  #scanPricesBtn {
    bottom: 30px; /* Adjust bottom position for mobile */
  }
}
body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:0; }
    h2 { color:#2196f3; }
    form, .panel { max-width:400px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    form input, form select, form button, .panel button { width:100%; padding:10px; margin:8px 0; border-radius:5px; border:1px solid #ccc; }
    form button, .panel button { background:#4CAF50; color:white; border:none; cursor:pointer; }
    form button:hover, .panel button:hover { background:#45a049; }
    .ride-card { margin:10px auto; padding:15px; max-width:500px; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    nav { background:#333; padding:10px; }
    nav a { color:white; margin:0 10px; text-decoration:none; font-weight:bold; }
    nav a:hover { text-decoration:underline; }
    #rideSystem { display:none; padding:40px; }
    #map { height: 300px; margin:20px auto; border-radius:8px; }
.menu-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    padding: 8px;   /* reduced padding */
    margin: 6px 0;
  }

  .menu-box img {
    width: 60px;    /* same size */
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 5px;
  }

  .menu-box span {
    font-size: 14px;
    text-align: center;
  }
</style>
</head>
<body>
<header style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-image: url('https://i.imgur.com/6c6FCiB.jpeg'); background-size: cover; background-position: center;">

  <!-- Left Image -->
  <img src="https://i.imgur.com/pdTgJX3.jpeg" alt="Left Image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">

  <!-- Header Content -->
  <div style="flex-grow: 1; text-align: center;">
    <h1 style="color: white; font-weight: bold; display: flex; align-items: center; gap: 10px; justify-content: center;">
      <i class="fas fa-star"></i>
      Nyota Mtaani ‚Äì Teacher Swaps & Daily Hustles
    </h1>

<!-- Display logged-in user and logout button inside the header -->
<div id="loggedInUser" style="text-align:center; color: white; margin-top: 10px; font-family: Arial, sans-serif;">
  <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">
    <i class="fas fa-user-circle" style="font-size: 24px; color: #4CAF50;"></i>
    <!-- Removed the placeholder name here -->
  </div>
  <span style="font-size: 14px; font-style: italic; color: #B0B0B0;">Good Evening!</span> <!-- Dynamic greeting -->
  <br>


<!-- Dark Mode Toggle Button -->
<div style="text-align: center; margin-top: 15px;">
  <button id="darkModeToggle" style="background-color: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s;">
    üåô Dark Mode
  </button>
</div>



  <!-- Advertisement inside the header -->
<div style="margin-top:10px; padding:12px; background: #ffecb3; border-radius:8px; text-align:center; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
  <p style="font-size: 14px; color: #5d4037; margin:0;">
 "üöÄ Boost Your Business! Advertise with Nyota Mtaani and reach thousands instantly!"
  </p>
<p style="margin:6px 0 0 0; font-size:14px;">
  <a href="mailto:Nyotamtaani@gmail.com" target="_blank" style="color: #d32f2f; font-weight:bold; text-decoration:none;">
    Email us on :Nyotamtaani@gmail.com
  </a>
</p>

</div>


  <!-- Right Image -->
  <img src="https://i.imgur.com/ZubSv7f.jpeg" alt="Right Image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">



</header>



<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    üåü From Village to City ‚Äî Your Swap, Your Way: County Moves, Mtaani Vibes,All Jobs, Market,Soulmate,Services & Swapsu | üì¶ To Book This Space call 0792755676 | üì± All in One Spot on Kenya‚Äôs #1 Nyota Platform for People Making Big Transitions | üçî Order lunch from Mama John's Kitchen | üì∏ Book events with StarPix Photography | üõ†Ô∏è Car repairs at QuickFix Nairobi | üíª Affordable Web Design by PixelStorm | üì∑ Wedding shoots by EliteLens Studios
  </div>
</div>
<div id="loggedInUser" style="position:absolute; top:15px; right:20px; color:white; font-weight:bold;"></div>
<nav style="background-image: url('https://i.imgur.com/NqDfbfn.jpeg'); background-size: cover; background-position: center; padding: 20px 20px;">

  
<ul>
  <!-- Core Navigation -->
  <li><a class="menu-box" href="#" onclick="showPage('home')">
    <img src="https://i.imgur.com/0V3g8Ur.png" alt="Home">
    <span>Home</span></a>
  </li>

  <li>
    <a class="menu-box" href="#" onclick="openModal('registerModal')">
      <img src="https://i.imgur.com/jKZaOkH.jpeg" alt="Register">
      <span>Register</span>
    </a>
  </li>

  <li>
    <a class="menu-box" href="#" onclick="openModal('loginModal')">
      <img src="https://i.imgur.com/TsXskJc.jpeg" alt="Login">
      <span>Login</span>
    </a>
  </li>

  <!-- Toggle Button to open theme customization panel -->
  <button id="themeCustomizeToggle" style="position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white; border: none; padding: 10px; border-radius: 5px;">
    Customize Theme
  </button>

  <li><a class="menu-box" href="#" onclick="showPage('usageHelp')">
    <img src="https://i.imgur.com/JUXFrkV.png" alt="How to Use">
    <span>üìò How to Use</span></a>
  </li>

  <!-- Main Features -->
  <li><a class="menu-box" href="#" onclick="showPage('bomJobs')">
    <img src="https://i.imgur.com/qdgoH1P.jpeg" alt="Jobs">
    <span>My Jobs</span></a>
  </li>

  <li>
    <a class="menu-box" href="#" onclick="showPage('swaps'); resetSwapBadge();">
      <img src="https://i.imgur.com/EH75psB.png" alt="Swaps">
      <span>View Swaps</span>
      <span id="swapBadge" style="
        display:none;
        background:red;
        color:white;
        font-size:12px;
        font-weight:bold;
        padding:2px 6px;
        border-radius:12px;
        margin-left:6px;
        vertical-align:top;
      ">0</span>
    </a>
  </li>

 <li>
  <a class="menu-box" href="#" onclick="showPage('rideSystem')">
    <img src="https://i.imgur.com/k3kH1Li.png" alt="Ride System">
    <span>Book Ride</span>
  </a>
</li>



  <li><a class="menu-box" href="#" onclick="showPage('market')">
    <img src="https://i.imgur.com/L1yWLoN.png" alt="Market">
    <span>Market</span></a>
  </li>

  <!-- ‚úÖ Price Scanner Button (hidden by default) -->
  <button id="scanPricesBtn" 
          style="display:none; position:fixed; bottom:20px; right:20px; z-index:9999;
                 background:#007bff; color:white; border:none; padding:10px 15px; 
                 border-radius:6px; cursor:pointer; font-size:14px;">
    Scan Prices
  </button>

  <!-- üîò Button to load payments (Admins Only) -->
  <li id="viewPaymentsBtn" style="display:none;">
    <a class="menu-box" href="#" onclick="showPage('payments')">
      <img src="https://i.imgur.com/t0TUHfP.png" alt="Payments">
      <span>üí≥ View Payments</span>
    </a>
  </li>

  <li style="position: relative;">
    <a class="menu-box" href="#" onclick="showPage('soulmates'); resetSoulmateBadge();">
      <img src="https://i.imgur.com/JulT2Na.png" alt="Soulmate">
      <span>Soulmate</span>
      <span id="soulmateBadge" style="
        display: none;
        position: absolute;
        top: 0;
        right: 0;
        background: red;
        color: white;
        font-size: 12px;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 12px;
        transform: translate(50%, -50%);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      ">0</span>
    </a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('resources')">
    <img src="https://i.imgur.com/wuYiPr5.png" alt="Resources">
    <span>Resources</span></a>
  </li>

  <li id="adminNotifBtn" style="display:none;">
    <a class="menu-box" href="#" onclick="showPage('notifications')" style="position: relative;">
      <img src="https://i.imgur.com/PtqAWTY.png" alt="Notifications">
      <span>Admin Notifications</span>
      <span id="notifBadge">0</span>
    </a>
  </li>

  <li>
    <a class="menu-box" href="#" onclick="openMyChats()" style="position:relative;">
      <img src="https://i.imgur.com/9OvoTnl.jpeg" alt="My Chats">
      <span>My Chats</span>
      <span id="myChatsUnreadBadge" style="
        display:none;
        background:#f44336;
        color:white;
        font-size:12px;
        padding:2px 6px;
        border-radius:50%;
        position:absolute;
        top:0;
        right:0;
        font-weight:bold;
        min-width:18px;
        text-align:center;
      ">0</span>
    </a>
  </li>

  <li>
    <a class="menu-box" href="#" onclick="loadAlerts()" style="position: relative;">
      <img src="https://i.imgur.com/JfWHw6A.jpeg" alt="Alerts">
      <span>Alerts</span>
      <span id="alertsBadge" style="
        display:none;
        background:#f44336;
        color:white;
        font-size:12px;
        padding:2px 6px;
        border-radius:50%;
        position:absolute;
        top:0;
        right:0;
        font-weight:bold;
        min-width:18px;
        text-align:center;
      ">0</span>
    </a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('trendingSection'); loadTrendingItems();">
    <img src="https://i.imgur.com/SjtDlJi.jpeg" alt="Trending">
    <span>Trending</span></a>
  </li>

  <li><a class="menu-box" href="#" onclick="showPage('contact')">
    <img src="https://i.imgur.com/SPqGvz9.jpeg" alt="Contact">
    <span>Contact Us</span></a>
  </li>
</ul>



</nav>


</header>


<!-- Loading Spinner Container -->
<div id="loadingSpinner" style="display: none;">
  <div class="spinner-container">
    <i class="fas fa-spinner fa-spin spinner"></i>
<p class="spinner-text" style="color: red;">Nyota</p>

  </div>
</div>

<!-- Custom Alert Modal -->
<div id="customAlert" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="custom-alert-content" style="background: white; padding: 20px; max-width: 400px; margin: auto; border-radius: 8px; text-align: center;">
        <span id="alertMessage" style="font-size: 16px; color: #333;"></span>
        <button onclick="closeCustomAlert()" style="background: #4CAF50; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">
            Close
        </button>
    </div>
</div>
<!-- Loading Spinner -->
<div id="loadingSpinner" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="spinner" style="border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 2s linear infinite;"></div>
</div>
<!-- Likes Modal -->
<div id="likesModal" class="likes-modal-overlay" style="display: none;" onclick="handleBackdropClick(event)">
  <div class="likes-modal-content">
    <span class="likes-modal-close" onclick="closeLikesModal()">&times;</span>
    <h2>‚ù§Ô∏è Liked by</h2>
    <ul id="likesList"></ul>
    <button onclick="closeLikesModal()" style="margin-top: 15px; padding: 6px 12px; font-size: 13px; border: none; border-radius: 4px; background-color: #f44336; color: white; cursor: pointer;">
      Close
    </button>
  </div>
</div>
<div id="logoutToast" style="
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #4CAF50;
  color: white;
  padding: 10px 20px;
  border-radius: 5px;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 10000;
">
  ‚úÖ You have been logged out successfully see you again .
</div>

<!-- üîπ Market Chat Modal -->
<div id="marketChatModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div style="background:white; width:90%; max-width:500px; border-radius:8px; padding:15px; display:flex; flex-direction:column; height:80%;">
    
    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 id="marketChatName" style="margin:0;"></h3>
      <div style="display:flex; gap:5px;">
<button id="deleteChatBtn" style="background:#d8000c; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">
  <i class="fas fa-trash-alt" style="margin-right:5px;"></i> Delete Chat
</button>

<button onclick="closeMarketChat()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px;">
  <i class="fas fa-times" style="margin-right:5px;"></i> Close
</button>

      </div>
    </div>
<h2 style="color: #ff0000;">
  <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
  Do not pay in advance even for delivery!
</h2>

    <!-- Messages container -->
    <div id="marketChatMessages" style="flex:1; overflow-y:auto; border:1px solid #ccc; border-radius:6px; padding:10px; margin:10px 0;">
      <p style="text-align:center; color:gray;">Loading messages...</p>
    </div>

    <!-- Input area -->
    <div style="display:flex; gap:5px;">
      <input id="marketChatInput" type="text" placeholder="Type your message..." style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
 <button id="marketSendBtn" style="background:#4CAF50; color:white; border:none; padding:8px 15px; border-radius:4px;">
  <i class="fas fa-paper-plane" style="margin-right:6px;"></i> Send
</button>

    </div>

 <!-- Quick message buttons -->
<div style="margin-top:8px; display:flex; gap:5px; flex-wrap:wrap;">
  <button onclick="sendMarketQuick('Hello üëã')" style="padding:6px; border:1px solid #ccc; border-radius:4px; background:#4caf50; color:white;">
    <i class="fas fa-hand-paper" style="margin-right:4px;"></i> Hello
  </button>

  <button onclick="sendMarketQuick('I am interested!')" style="padding:6px; border:1px solid #ccc; border-radius:4px; background:#2196f3; color:white;">
    <i class="fas fa-star" style="margin-right:4px;"></i> I am interested!
  </button>

  <button onclick="sendMarketQuick('Can you provide more details?')" style="padding:6px; border:1px solid #ccc; border-radius:4px; background:#ff9800; color:white;">
    <i class="fas fa-info-circle" style="margin-right:4px;"></i> Can you provide more details?
  </button>

  <button onclick="sendMarketQuick('How much is this?')" style="padding:6px; border:1px solid #ccc; border-radius:4px; background:#9c27b0; color:white;">
    <i class="fas fa-money-bill-wave" style="margin-right:4px;"></i> How much is this?
  </button>

  <button onclick="sendMarketQuick('Is it still available?')" style="padding:6px; border:1px solid #ccc; border-radius:4px; background:#f44336; color:white;">
    <i class="fas fa-question-circle" style="margin-right:4px;"></i> Is it still available?
  </button>

  <button onclick="sendMarketQuick('I‚Äôd like to negotiate the price!')" style="padding:6px; border:1px solid #ccc; border-radius:4px; background:#ff5722; color:white;">
    <i class="fas fa-handshake" style="margin-right:4px;"></i> I‚Äôd like to negotiate the price!
  </button>

  <button onclick="sendMarketQuick('When is the best time to contact you?')" style="padding:6px; border:1px solid #ccc; border-radius:4px; background:#795548; color:white;">
    <i class="fas fa-clock" style="margin-right:4px;"></i> When is the best time to contact you?
  </button>

    </div>
  </div>
</div>
<!-- ‚úÖ Ride System -->
<div id="rideSystem" class="page-section" style="display:none;">
  <h2>üöñ Nyota Ride System</h2>

  <!-- Choose Role -->
  <div class="panel" id="rolePanel" style="
    background:url('https://i.imgur.com/C7Rb7LA.jpeg') no-repeat center center/cover;
    padding:30px; 
    border-radius:12px; 
    display:flex; 
    flex-direction:column; 
    gap:15px; 
    align-items:center;
  ">
    <button onclick="showRider()" style="
      width:80%; padding:12px; background:#4caf50; color:#fff; font-weight:bold;
      border:none; border-radius:8px; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;
    ">
      <i class="fas fa-user"></i> I am a Rider
    </button>

    <button onclick="showDriverLogin()" style="
      width:80%; padding:12px; background:#2196f3; color:#fff; font-weight:bold;
      border:none; border-radius:8px; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;
    ">
      <i class="fas fa-car"></i> I am a Driver
    </button>

    <button onclick="showDriverRegister()" style="
      width:80%; padding:12px; background:#ff9800; color:#fff; font-weight:bold;
      border:none; border-radius:8px; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;
    ">
      <i class="fas fa-id-card"></i> Register as Driver
    </button>
  </div>

  <!-- Rider Form -->
  <div id="riderPanel" style="
    display:none; margin-top:20px; padding:20px; border-radius:10px;
    background:url('https://i.imgur.com/C7Rb7LA.jpeg') no-repeat center center/cover;
    color:#fff;
  ">
    <h3>üìç Book a Ride</h3>
    <form id="rideForm" style="background:rgba(0,0,0,0.6); padding:15px; border-radius:10px;">
      <label>Pickup Location</label>
      <input type="text" id="pickup" required style="width:100%; padding:8px; margin:5px 0;">

      <label>Destination</label>
      <input type="text" id="destination" required style="width:100%; padding:8px; margin:5px 0;">

      <label>Choose Ride</label>
      <select id="rideType" style="width:100%; padding:8px; margin:5px 0;">
        <option value="car">Car</option>
        <option value="bike">Motorbike</option>
      </select>

      <button type="submit" style="
        width:100%; padding:10px; background:#ff9800; border:none; border-radius:5px; 
        color:#fff; font-weight:bold; margin-top:10px; display:flex; align-items:center; justify-content:center; gap:8px;
      ">
        <i class="fas fa-search-location"></i> Find Nearby Rides
      </button>
    </form>
  </div>

  <div id="map"></div>
  <div id="rideResults" style="margin-top:20px;"></div>
</div>

<!-- Driver Registration -->
<div id="driverRegister" style="
  display:none; margin-top:20px; padding:20px; border-radius:10px;
  background:url('https://i.imgur.com/v298Kg2.jpeg') no-repeat center center/cover;
  color:#fff;
">
  <h2 style="text-align:center; margin-bottom:20px;">üöò Driver Registration</h2>

  <form id="driverRegisterForm" style="background:rgba(0,0,0,0.6); padding:15px; border-radius:10px; display:flex; flex-direction:column; gap:10px;">
    <label>Full Name</label>
    <input type="text" id="driverName" required style="width:100%; padding:8px; margin:5px 0; border-radius:5px; border:none;">

    <label>Email</label>
    <input type="email" id="driverEmail" required style="width:100%; padding:8px; margin:5px 0; border-radius:5px; border:none;">

    <label>Password</label>
    <input type="password" id="driverPassword" required style="width:100%; padding:8px; margin:5px 0; border-radius:5px; border:none;">

    <label>Phone Number</label>
    <input type="tel" id="driverPhone" required placeholder="07XXXXXXXX" style="width:100%; padding:8px; margin:5px 0; border-radius:5px; border:none;">

    <label>Vehicle Model</label>
    <input type="text" id="driverVehicle" required style="width:100%; padding:8px; margin:5px 0; border-radius:5px; border:none;">

    <label>Plate Number</label>
    <input type="text" id="driverPlate" required style="width:100%; padding:8px; margin:5px 0; border-radius:5px; border:none;">

    <label>Engine Capacity (CC)</label>
    <select id="driverEngine" required style="width:100%; padding:8px; margin:5px 0; border-radius:5px; border:none;">
      <option value="1300cc">1300cc</option>
      <option value="1400cc">1400cc</option>
      <option value="1500cc">1500cc</option>
      <option value="1800cc">1800cc</option>
      <option value="2000cc">2000cc</option>
    </select>

    <label>Cost per Km (KES)</label>
    <input type="number" id="driverCost" step="1" required style="width:100%; padding:8px; margin:5px 0; border-radius:5px; border:none;">

    <button type="submit" style="
      width:100%; padding:10px; background:#4CAF50; border:none; border-radius:5px; 
      color:#fff; font-weight:bold; margin-top:10px; display:flex; align-items:center; justify-content:center; gap:8px;
    ">
      <i class="fas fa-user-plus"></i> Register as Driver
    </button>
  </form>

  <p style="margin-top:15px; text-align:center;">
    Already registered? 
    <a href="#" onclick="showDriverLogin()" style="color:#ffd700; font-weight:bold;">
      <i class="fas fa-sign-in-alt"></i> Login here
    </a>
  </p>
</div>

<!-- üîπ Global Loading Spinner -->
<div id="loadingSpinner" style="
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6); justify-content:center; align-items:center;
  z-index:10000;
">
  <div style="background:#fff; padding:20px 30px; border-radius:10px; font-size:18px; font-weight:bold; color:#333;">
    ‚è≥ Loading...
  </div>
</div>

<!-- Driver Login -->
<div id="driverLogin" style="
  display:none; background:url('https://i.imgur.com/v298Kg2.jpeg') no-repeat center center/cover;
  padding:30px; border-radius:12px; color:#fff; max-width:400px; margin:20px auto; box-shadow:0 4px 12px rgba(0,0,0,0.3);
">
  <h3 style="text-align:center; margin-bottom:20px;">üîë Driver Login</h3>
  
  <form id="driverLoginForm" style="
    background:rgba(0,0,0,0.6); padding:20px; border-radius:10px; display:flex; flex-direction:column; gap:12px;
  ">
    <label>Email</label>
    <input type="email" id="driverLoginEmail" required style="padding:10px; border-radius:6px; border:none;">

    <label>Password</label>
    <input type="password" id="driverLoginPassword" required style="padding:10px; border-radius:6px; border:none;">

    <button type="submit" style="
      background:#2196f3; color:white; padding:12px; font-weight:bold; font-size:16px; border:none; 
      border-radius:8px; cursor:pointer; margin-top:10px; display:flex; align-items:center; justify-content:center; gap:8px;
    ">
      <i class="fas fa-sign-in-alt"></i> Login
    </button>
  </form>
</div>

<!-- Driver Panel -->
<div id="driverPanel" style="display:none; margin-top:20px;">
  <h3>üöï Driver Panel</h3>
  <p id="driverInfo"></p>
  <div id="pendingRides"></div>
</div>
</div>

<!-- Triangular Swap Modal (v3: with paywall/blur UI + navigation) --> 
<div id="triangularSwapModal" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  z-index:10000;
">
  <div role="dialog" aria-modal="true" aria-labelledby="triSwapTitle" style="
    background:white;
    padding:20px;
    border-radius:10px;
    max-width:420px;
    width:90%;
    max-height:80%;
    overflow-y:auto;
    position:relative;
    box-shadow:0 8px 28px rgba(0,0,0,0.25);
  ">
    <!-- Close -->
    <button id="closeTriangularSwapModal" style="
      position:absolute;
      top:8px; right:8px;
      background:red; color:white;
      border:none; padding:5px 8px;
      border-radius:4px; cursor:pointer;">
      ‚úñ
    </button>

    <!-- Title -->
    <h3 id="triSwapTitle" style="margin-top:0; color:#1a237e;">
      üî∫ Triangular Swap Results
    </h3>

    <!-- Notice / status (errors, 'searching...', success) -->
    <div id="triangularSwapNotice" style="
      display:none;
      margin-bottom:10px;
      padding:8px 10px;
      border-radius:8px;
      background:#e3f2fd;
      color:#0d47a1;
      font-size:14px;">
      <!-- Filled by JS -->
    </div>

    <!-- Results will be rendered here (3 teacher cards) -->
    <div id="triangularSwapModalContent" style="display:block;">
      <!-- Filled by JS -->
    </div>

    <!-- Paywall: one contact locked -->
    <div id="triangularSwapPaywall" style="
      display:none;
      margin-top:12px;
      padding:12px;
      background:#fff8e1;
      border:1px dashed #ff9800;
      border-radius:8px;">
      <div style="font-weight:600; margin-bottom:6px;">
     Swapmates   contacts  locked üîí
      </div>
      <div style="font-size:14px; margin-bottom:10px; line-height:1.4;">
        Unlock <span id="lockedTeacherName" style="font-weight:700;"></span>'s All numbers for
        <span id="triangularUnlockPrice" style="font-weight:700;">Ksh 500</span>.
      </div>
      <button id="unlockTriangularContactBtn" style="
        background:#e91e63; color:white;
        border:none; padding:10px 12px;
        border-radius:8px; cursor:pointer; font-weight:600;">
        üí≥ Unlock Full Contact
      </button>
      <div style="font-size:12px; color:#616161; margin-top:6px;">
        Admins & owners see all numbers for free.
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div style="margin-top:12px; display:flex; justify-content:space-between;">
      <button id="prevSwapBtn" style="
        background:#1976d2; color:white;
        border:none; padding:8px 12px;
        border-radius:6px; cursor:pointer; font-weight:600;">
        ‚¨Ö Previous
      </button>
      <button id="nextSwapBtn" style="
        background:#1976d2; color:white;
        border:none; padding:8px 12px;
        border-radius:6px; cursor:pointer; font-weight:600;">
        Next ‚û°
      </button>
    </div>

    <!-- Spinner inside modal (for payment / loading) -->
    <div id="triangularSwapModalSpinner" style="display:none; margin-top:10px; text-align:center; font-size:14px;">
      Processing‚Ä¶
    </div>
  </div>
</div>


<!-- Thank You Alert -->
<div id="thankYouAlert" style="
  position: fixed;
  top: 20px;
  right: 20px;
  background: #4caf50;
  color: white;
  padding: 10px 14px;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  font-family: Arial, sans-serif;
  font-size: 13px;
  display: none;
  z-index: 10000;
">
  ‚úÖ Thank you for agreeing!
</div>
<!-- ‚úÖ Hidden Popup -->
<div id="pricePopup" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.6); z-index:10000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:80%; max-width:700px; 
              max-height:80%; overflow-y:auto; box-shadow:0 4px 12px rgba(0,0,0,0.3);">
    <h2 style="margin-top:0; font-size:18px; color:#333;">üí∞ Extracted Monetization Prices</h2>
    <div id="priceResults" style="white-space:pre-wrap; font-size:14px; color:#111;"></div>
    <button id="closePopup" 
            style="margin-top:10px; padding:6px 12px; background:#dc3545; color:white; border:none; 
                   border-radius:5px; cursor:pointer;">Close</button>
  </div>
</div>
<!-- üìä Admin Payments Dashboard -->
<div id="paymentsDashboard" style="display:none; padding:20px; border:1px solid #ccc; border-radius:8px; background:#fafafa;">
  <div style="display:flex; justify-content:space-between; align-items:center;">
<h2 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 20px; color: #000; display: inline-block;">
  <i class="fas fa-briefcase" style="color:#6f42c1; margin-right: 8px;"></i>
üí≥ Payment Records
</h2>
    <div>
 <!-- üîÑ Refresh Button with emoji icon -->
<button id="refreshPaymentsBtn" style="
  background-color:#00796b;
  color:white;
  border:none;
  padding:6px 12px;
  border-radius:5px;
  cursor:pointer;
  margin-right:8px;
  display:flex;
  align-items:center;
  gap:6px;">
  üîÑ Refresh
</button>


      <!-- ‚úñ Close Button -->
      <button id="closePaymentsBtn" style="background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">
        ‚úñ Close
      </button>
    </div>
  </div>

  
  <table border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse; margin-top:10px;">
    <thead style="background:#f4f4f4;">
      <tr>
        <th>User ID</th>
        <th>Amount</th>
        <th>Method</th>
        <th>Reference</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="paymentsTable"></tbody>
  </table>
</div>

<!-- ‚úÖ How to Use the System Section -->
<div id="usageHelp" class="page" style="display:none; padding: 20px;">
  <h2 style="background-color: yellow; padding: 10px 15px; border-radius: 5px; font-weight: bold; font-size: 22px; color: #000; text-align:center; display: inline-block;">
    üìò How to Use the System
  </h2>
  <div style="max-width:800px; margin:auto; background:#f9f9f9; padding:20px; border-radius:10px;">
    <ul style="line-height:1.7; list-style:none; padding:0;">
     

      
      <li><a href="#" onclick="showPage('home')"><img src="https://i.imgur.com/lek58ah.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Home</strong></a> ‚Äì See latest updates, featured jobs, market items, and quick links to other sections.</li>
     
      <li><a href="#" onclick="showPage('register')"><img src="https://i.imgur.com/jKZaOkH.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Register</strong></a> ‚Äì Create a new account by filling in your name, email, and password.</li>
      
 
      <li><a href="#" onclick="showPage('login')"><img src="https://i.imgur.com/TsXskJc.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Login</strong></a> ‚Äì Enter your email and password to access your account. Use ‚ÄúForgot Password‚Äù if needed.</li>
      
      <li><a href="#" onclick="loadAlerts()"><img src="https://i.imgur.com/IvZc6We.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Alerts</strong></a> ‚Äì Notifications when someone shows interest in your listing, follows you, or interacts with your posts.</li>
      
      <li><a href="#" onclick="openMessagesPage()"><img src="https://i.imgur.com/XBAeDCN.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Messages</strong></a> ‚Äì View and reply to job, market, swap, or service chats. Unread messages are highlighted.</li>
      
      <li><a href="#" onclick="showPage('bomJobs')"><img src="https://i.imgur.com/8KM6Rib.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>My Jobs</strong></a> ‚Äì Post jobs, view applicants, show interest in other jobs, follow updates, unlock contacts, close/reopen jobs, and leave ratings.</li>
      
      <li><a href="#" onclick="showPage('swaps')"><img src="https://i.imgur.com/iqBwsWm.png" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Swaps</strong></a> ‚Äì Browse and post swap listings  Contact owners via chat or phone.</li>
      
      <li><a href="#" onclick="showPage('seekingServices')"><img src="https://i.imgur.com/P1tHi7L.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Services</strong></a> ‚Äì Browse or post services and contact providers directly once unlocked.</li>
      
      <li><a href="#" onclick="showPage('market')"><img src="https://i.imgur.com/P1MIsGM.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Market</strong></a> ‚Äì Buy or sell products. Use search and filters. Post your own items for sale.</li>
      
      <li><a href="#" onclick="showPage('soulmates')"><img src="https://i.imgur.com/FJjbSK9.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Soulmate</strong></a> ‚Äì Discover and connect with people for social or personal networking.</li>
      
      <li><a href="#" onclick="showPage('resources')"><img src="https://i.imgur.com/GavIBlL.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Resources</strong></a> ‚Äì Access useful information, guides, and learning materials.</li>
      
      <li><a href="#" onclick="showPage('trendingSection'); loadTrendingItems();"><img src="https://i.imgur.com/SjtDlJi.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>üî• Trending</strong></a> ‚Äì See popular boosted jobs, services, and items. Boost your listing for 7 days to appear here.</li>
      
      <li><a href="#" onclick="showPage('usageHelp')"><img src="https://i.imgur.com/tHuRu3z.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>üìò How to Use</strong></a> ‚Äì Read this guide anytime to understand all features.</li>
      
      <li><a href="#" onclick="showPage('contact')"><img src="https://i.imgur.com/SPqGvz9.jpeg" style="width:24px; vertical-align:middle; margin-right:8px;"> <strong>Contact Us</strong></a> ‚Äì Reach the admin team via email, phone, or WhatsApp.</li>
      
      <li>üí≥ <strong>Payments</strong> ‚Äì Pay via MPESA to unlock job or service contacts, or access premium features like boosting listings.</li>
      
      <li>üöÄ <strong>Boost Listings</strong> ‚Äì Make your job or item appear in the üî• Trending section for 7 days.</li>
    </ul>
    <p style="color:#888;font-style:italic;">üí° Tip: Keep your profile updated, check üî• Trending daily, and use chat for faster responses.</p>
  </div>
</div>


<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>üåù Delete Resource</h3>
    <p>Are you sure you want to delete this resource? This action cannot be undone.</p>
    <div class="modal-buttons">
      <button id="confirmDelete" class="btn-danger">Yes, Delete</button>
      <button id="cancelDelete" class="btn-secondary">Cancel</button>
    </div>
  </div>
</div>


  
<!-- üî≤ Review Modal -->
<div id="reviewModal" style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;z-index:999;justify-content:center;align-items:center;">
  <div style="background:white;padding:20px;border-radius:8px;max-width:400px;width:90%;position:relative;">
    <h3 style="margin-top:0;">üìù Leave a Review</h3>
    <input type="email" id="reviewEmail" placeholder="Your Email" style="width:100%;margin-bottom:10px;padding:8px;border-radius:5px;border:1px solid #ccc;">
    <textarea id="reviewComment" placeholder="Write your review..." style="width:100%;padding:8px;border-radius:5px;border:1px solid #ccc;"></textarea>
    
    <button onclick="submitReviewFromModal()" style="margin-top:10px;background:#4CAF50;color:#fff;padding:8px 14px;border:none;border-radius:5px;">Submit</button>
    
    <!-- ‚úÖ New Close Button -->
    <button onclick="closeReviewModal()" style="margin-top:10px;background:#f44336;color:#fff;padding:8px 14px;border:none;border-radius:5px;">Close</button>

    <!-- ‚ùå Top-right corner close icon -->
    <button onclick="closeReviewModal()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:18px;">‚ùå</button>
  </div>
</div>

<div id="allReviewsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:#fff; padding:20px; width:50%; max-width:600px; max-height:80%; overflow:auto; border-radius:10px; position:relative;">
    <span onclick="closeAllReviewsModal()" style="position:absolute; top:10px; right:20px; cursor:pointer; font-weight:bold; font-size:18px;">‚úñ</span>
    <h3>üí¨ All Reviews</h3>
    <div id="allReviewsContainer" style="margin-top:10px;"></div>
  </div>
</div>

<!-- ‚úÖ Colored Contact Section -->
<div id="contact" class="page" style="display:none; padding: 20px;">
  <div style="max-width:800px; margin:auto; background:#f0f8ff; padding:25px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.05);">
 <h2 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 20px; color: #000; display: inline-block;">
  <i class="fas fa-briefcase" style="color:#6f42c1; margin-right: 8px;"></i>
 Contact Us
</h2>
    
    <p style="font-size:16px;">
      <i class="fas fa-envelope" style="color:#f57c00; margin-right:6px;"></i>
      <strong>Email:</strong> support@Nyotakenya.com
    </p>

    <p style="font-size:16px;">
      <i class="fas fa-phone" style="color:#009688; margin-right:6px;"></i>
      <strong>Phone 2:</strong> +254 792 755 676
    </p>

    <p style="font-size:16px;">
      <i class="fab fa-whatsapp" style="color:#25D366; margin-right:6px;"></i>
      <strong>WhatsApp:</strong> 
      <a href="https://wa.me/254792755676" target="_blank" style="color:#25D366; text-decoration:none;">
        Chat on WhatsApp
      </a>
    </p>

    <p style="font-size:16px;">
      <i class="fab fa-facebook" style="color:#1877f2; margin-right:6px;"></i>
      <strong>Facebook:</strong> <a href="#" style="color:#1877f2;">Visit Page</a>
    </p>

    <p style="font-size:16px;">
      <i class="fab fa-youtube" style="color:#ff0000; margin-right:6px;"></i>
      <strong>YouTube:</strong> <a href="#" style="color:#ff0000;">Visit Channel</a>
    </p>

    <p style="font-size:16px;">
      <i class="fab fa-telegram" style="color:#0088cc; margin-right:6px;"></i>
      <strong>Telegram:</strong> <a href="#" style="color:#0088cc;">Join Group</a>
    </p>
  </div>
</div>

<section id="trendingSection" style="display: none; padding: 16px;">
<h2 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 20px; color: #000; display: inline-block;">
  <i class="fas fa-briefcase" style="color:#6f42c1; margin-right: 8px;"></i>
Trending 
</h2>
  <div id="trendingContainer" style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; align-items: center; width: 100%;">
    <!-- Trending items (cards) will appear here -->
  </div>
</section>


</div>
</div>

<!-- Theme Customization Panel -->
<div id="themeCustomization" style="position: fixed; top: 20px; right: 20px; background-color: rgba(255, 255, 255, 0.8); background-image: url('https://i.imgur.com/6c6FCiB.jpeg'); background-size: cover; background-position: center; padding: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 10000; display: none; max-width: 300px; width: 100%; transition: all 0.3s ease;">
  <h3 style="color: white;">Theme Customization</h3>
  
  <!-- Theme Select -->
  <label for="themeSelect" style="color: white;">Select Theme: </label>
  <select id="themeSelect">
    <option value="light">Light</option>
    <option value="dark">Dark</option>
    <option value="custom">Custom</option>
    <option value="theme1">Blue Ocean</option>
    <option value="theme2">Green Forest</option>
    <option value="theme3">Sunset Red</option>
    <option value="theme4">Golden Desert</option>
    <option value="theme5">Purple Night</option>
    <option value="theme6">Pink Blossom</option>
    <option value="theme7">Misty Mountain</option>
    <option value="theme8">Sky Blue</option>
    <option value="theme9">Earthy Brown</option>
    <option value="theme10">Deep Ocean</option>
    <option value="theme11">Lavender Fields</option>
    <option value="theme12">Autumn Leaves</option>
    <option value="theme13">Neon Glow</option>
    <option value="theme14">Citrus Orange</option>
    <option value="theme15">Sea Breeze</option>
    <option value="theme16">Space Black</option>
    <option value="theme17">Tropical Green</option>
    <option value="theme18">Soft Peach</option>
    <option value="theme19">Rustic Red</option>
    <option value="theme20">Cool Mint</option>
  </select>

  <div id="customThemeOptions" style="display: none;">
    <h4 style="color: white;">Custom Theme</h4>
    <label for="bgColor" style="color: white;">Background Color: </label>
    <input type="color" id="bgColor" value="#ffffff"><br><br>
    
    <label for="textColor" style="color: white;">Text Color: </label>
    <input type="color" id="textColor" value="#000000"><br><br>

    <label for="fontSize" style="color: white;">Font Size: </label>
    <input type="number" id="fontSize" value="16" min="12" max="24">
  </div>

  <button id="applyThemeBtn" style="margin-top: 10px; padding: 8px 15px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer;">Apply Theme</button>
  <button id="resetThemeBtn" style="margin-top: 10px; padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">Reset to Default</button>
  
  <!-- Close Button -->
  <button id="closeThemePanel" style="margin-top: 10px; padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 5px;">Close</button>
</div>

<!-- Content Section -->
<main id="content">
  <div id="home" class="page" style="display: none;">
    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0;">
      <img src="https://i.imgur.com/ld8vrze.jpeg" alt="Rasm" class="logo-img" style="width: 200px;">
      <img src="https://i.imgur.com/JTvf2AF.jpeg" alt="Rasm" class="logo-img" style="width: 200px;">
    </div>
  </div>



<!-- Register Modal (HIDDEN by default) -->
<div id="registerModal" class="modal" style="display:none;">
  <div class="modal-content register-bg">
    <span class="close" onclick="closeModal('registerModal')">&times;</span>
    <h2><i class="fas fa-user-shield" style="color:#f44336; margin-right: 8px;"></i> Register</h2>
    <form id="registerForm">
      <label for="name">Name:</label>
      <input type="text" id="name" required />
      <label for="email">Email:</label>
      <input type="email" id="email" required />
      <label for="password">Password:</label>
      <input type="password" id="password" required />
      <button type="submit"><i class="fas fa-user-plus"></i> Register</button>
    </form>
  </div>
</div>

<!-- Login Modal (HIDDEN by default) -->
<div id="loginModal" class="modal" style="display:none;">
  <div class="modal-content login-bg">
    <span class="close" onclick="closeModal('loginModal')">&times;</span>
    <h2><i class="fas fa-sign-in-alt" style="color:#2196f3; margin-right: 8px;"></i> Login</h2>

    <!-- Login Form -->
    <form id="loginForm">
      <label for="loginEmail">Email:</label>
      <input type="email" id="loginEmail" required />
      <label for="loginPassword">Password:</label>
      <input type="password" id="loginPassword" required />
      <button type="submit"><i class="fas fa-sign-in-alt"></i> Login</button>

      <!-- Forgot Password -->
      <div style="text-align: center; margin-top: 10px;">
        <a href="#" onclick="showPasswordReset()" style="color:#2196F3;">
          <i class="fas fa-key"></i> Forgot Password?
        </a>
      </div>
    </form>

    <!-- Reset Request (hidden initially) -->
    <div id="resetRequestForm" style="display:none;">
      <h3>Forgot Password?</h3>
      <form onsubmit="handlePasswordReset(event, 'request')">
        <label for="resetEmail">Enter your email:</label>
        <input type="email" id="resetEmail" required />
        <button type="submit">Send Reset Link</button>
      </form>
      <p><a href="#" onclick="hidePasswordReset()">Back to Login</a></p>
    </div>

    <!-- Reset Password (hidden initially) -->
    <div id="resetPasswordForm" style="display:none;">
      <h3>Reset Password</h3>
      <form onsubmit="handlePasswordReset(event, 'confirm')">
        <label for="newPassword">New Password:</label>
        <input type="password" id="newPassword" required />
        <label for="confirmPassword">Confirm Password:</label>
        <input type="password" id="confirmPassword" required />
        <button type="submit">Reset Password</button>
      </form>
      <p><a href="#" onclick="hidePasswordReset()">Back to Login</a></p>
    </div>
  </div>
</div>
 

    <div id="swaps" class="page" style="display:none;">
<h2>
  <i class="fas fa-exchange-alt" style="color:red; margin-right: 8px;"></i>
  <span style="color:red;">üåü Be part of the smart teacher network ‚Äì your perfect swap awaits register your swap here!</span>
</h2>


<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    üåü Try Mary's Salon in Kisumu | üì¶ Order from Speedy Courier Services | üì± Fix your phone at TechHub Eldoret | üçî Order lunch from Mama John's Kitchen | üì∏ Book events with StarPix Photography | üõ†Ô∏è Car repairs at QuickFix Nairobi | üíª Affordable Web Design by PixelStorm | üì∑ Wedding shoots by EliteLens Studios
  </div>
</div>
<form id="swapForm" style="
  max-width: 500px;
  margin: 40px auto;
  padding: 25px;
  border-radius: 12px;
  background: url('https://i.imgur.com/iqBwsWm.png') no-repeat center center;
  background-size: cover;
  color: #fff;
  font-family: Arial, sans-serif;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
">
  <label for="teacherName" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Teacher's Name:</label>
  <input type="text" id="teacherName" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;" />

  <label for="phone" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Phone Number:</label>
  <input type="tel" id="phone" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;" />

  <label for="subjectCombination" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Subject Combination:</label>
  <input type="text" id="subjectCombination" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;" />

  <label for="county" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Current County:</label>
  <select id="county" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;"></select>

  <label for="subCounty" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Current Sub-county:</label>
  <select id="subCounty" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;">
    <option value="">Select Sub-county</option>
  </select>

 <label for="swapCounty" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">
  Swap County To (Optional, select up to 3):
</label>

<!-- Container for tags -->
<div id="swapCountyTags" style="margin-top:6px; min-height:28px;"></div>

<select id="swapCounty" multiple size="5" style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;">
  <option value="">Select County</option>
</select>

<small style="color:red; display:block; margin-top:4px; font-style:italic;">
  Hold Ctrl (Cmd on Mac) to select multiple counties.
</small>


  <label for="category" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Category:</label>
  <select id="category" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;">
    <option value="">Select Category</option>
    <option value="Primary School">Primary School Swaps</option>
    <option value="Junior Secondary">Junior Secondary Swaps</option>
    <option value="Senior Secondary">Senior Secondary Swaps</option>
  </select>

  <label for="hardship" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Hardship:</label>
  <select id="hardship" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;">
    <option value="Without Hardship">Without Hardship</option>
    <option value="With Hardship">With Hardship</option>
  </select>

  <button type="submit" style="
    margin-top:20px;
    width:100%;
    padding:12px;
    background:#007BFF;
    border:none;
    border-radius:8px;
    font-size:16px;
    color:white;
    cursor:pointer;
    font-weight:bold;
    transition:background 0.3s ease;
  ">
    <i class="fas fa-plus-circle" style="margin-right:6px; color:#ffffff;"></i> Add Swap
  </button>
</form>





<h3 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 18px; color: #000; display: inline-flex; align-items: center; gap: 8px;">
  <i class="fas fa-filter" style="color:#43a047;"></i>
  Filter Swaps
</h3>


<!-- ‚úÖ Horizontal Compact Filter Box with Black Labels -->
<div style="
  border: 2px solid #c8e6c9; 
  background-image: url('https://i.imgur.com/eCHzlc4.jpeg'); /* Add your image URL here */
  background-size: cover;
  background-position: center;
  padding: 16px; 
  border-radius: 12px; 
  margin-bottom: 20px; 
  max-width: 1000px; 
  margin: 0 auto; 
  display: flex; 
  flex-wrap: wrap; 
  justify-content: center; 
  gap: 20px;
">

  <!-- Category -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select id="filterCategory" style="
      width: 180px; 
      background-color: rgba(224, 247, 250, 0.8); /* Semi-transparent background */
      border: 2px solid #26a69a; 
      padding: 8px; 
      border-radius: 6px; 
      font-weight: bold; 
      font-size: 14px;
      color: #333;
    ">
      <option value="">All</option>
      <option value="Primary School">Primary School</option>
      <option value="Junior Secondary">Junior Secondary</option>
      <option value="Senior Secondary">Senior Secondary</option>
    </select>
    <label for="filterCategory" style="margin-top: 6px; font-size: 13px; color: black; font-weight: 500;">Category</label>
  </div>

  <!-- Swap County -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select id="filterSwapCounty" onchange="handleCountyChange('filterSwapCounty', 'filterSwapSubCounty')" style="
      width: 180px; 
      background-color: rgba(225, 245, 254, 0.8); 
      border: 2px solid #039be5; 
      padding: 8px; 
      border-radius: 6px; 
      font-weight: bold; 
      font-size: 14px;
      color: #333;
    ">
    </select>
    <label for="filterSwapCounty" style="margin-top: 6px; font-size: 13px; color: black; font-weight: 500;">Swap County</label>
  </div>

  <!-- Swap Sub-county -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select id="filterSwapSubCounty" style="
      width: 180px; 
      background-color: rgba(243, 229, 245, 0.8); 
      border: 2px solid #9c27b0; 
      padding: 8px; 
      border-radius: 6px; 
      font-weight: bold; 
      font-size: 14px;
      color: #333;
    ">
      <option value="">All Sub-counties</option>
    </select>
    <label for="filterSwapSubCounty" style="margin-top: 6px; font-size: 13px; color: black; font-weight: 500;">Swap Sub-county</label>
  </div>

  <!-- Hardship -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select id="filterHardship" style="
      width: 180px; 
      background-color: rgba(255, 243, 224, 0.8); 
      border: 2px solid #fb8c00; 
      padding: 8px; 
      border-radius: 6px; 
      font-weight: bold; 
      font-size: 14px;
      color: #333;
    ">
      <option value="">All</option>
      <option value="With Hardship">With Hardship</option>
      <option value="Without Hardship">Without Hardship</option>
    </select>
    <label for="filterHardship" style="margin-top: 6px; font-size: 13px; color: black; font-weight: 500;">Hardship</label>
  </div>

  <!-- Subject -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <input type="text" id="filterSubjectCombination" placeholder="e.g. Math/Physics" style="
      width: 180px; 
      background-color: rgba(241, 248, 233, 0.8); 
      border: 2px solid #8bc34a; 
      padding: 8px; 
      border-radius: 6px; 
      font-weight: bold; 
      font-size: 14px;
      color: #333;
    " />
    <label for="filterSubjectCombination" style="margin-top: 6px; font-size: 13px; color: black; font-weight: 500;">Subject</label>
  </div>

  <!-- üîò Horizontal Buttons -->
  <div style="display: flex; flex-direction: row; align-items: center; gap: 15px; margin-top: 20px;">
    <button onclick="filterSwaps()" style="
      padding: 8px 16px; 
      background: #43a047; 
      color: white; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 14px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    ">
      <i class="fas fa-filter" style="margin-right: 6px;"></i> Filter Swaps
    </button>

    <button onclick="resetSwapFilters()" style="
      padding: 8px 16px; 
      background: #c62828; 
      color: white; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 14px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    ">
      <i class="fas fa-times-circle" style="margin-right: 6px;"></i> Reset
    </button>
  </div>
</div>

<!-- ‚úÖ Active Filters Display -->
<div id="activeFilters" style="margin: 20px auto; max-width: 900px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;"></div>

<!-- ‚úÖ End Vertical Action Box -->

<!-- ‚úÖ Compact Action Box Wrapper End -->

<!-- ‚úÖ Action Box Wrapper End -->

<h3 style="background-color: white; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 18px; color: #000; display: inline-block;">
  <i class="fas fa-people-arrows" style="color:#ff9800; margin-right: 8px;"></i>
  üèÜ Don‚Äôt wait ‚Äì find your ideal swap partners and complete your triangular cycle today!
</h3>

<div id="triangularSwapSection" style="
      margin:20px; 
      padding:15px; 
      background:#f1f1f1 url('https://i.imgur.com/sX7PxsF.jpeg') no-repeat center center; 
      background-size:cover; 
      border-radius:8px; 
      max-width:500px; 
      color:#fff;
">
  <h3 style="color:#1a237e; margin-bottom:6px;">üî∫ Find Triangular Swap</h3>
  
<!-- Short note for users -->
<p style="font-size:13px; color:red; margin-bottom:12px; background-color: yellow; padding: 5px; border-radius: 3px;">
  Enter three counties to find a matching triangular swap. All three must have teachers wanting to swap in a cycle. Click "Find Triangular Swap" to see results.
</p>

  
  <input type="text" id="countyA" placeholder="Enter County A" 
         style="margin:4px 0; padding:10px; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; font-size:14px;" />
         
  <input type="text" id="countyB" placeholder="Enter County B" 
         style="margin:4px 0; padding:10px; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; font-size:14px;" />
         
  <input type="text" id="countyC" placeholder="Enter County C" 
         style="margin:4px 0; padding:10px; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; font-size:14px;" />
         
  <button id="findTriangularSwapBtn" 
          style="margin-top:10px; padding:10px 12px; background:#4CAF50; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; width:100%;">
    Find Triangular Swap
  </button>
  
  <div id="triangularSwapResult" style="margin-top:12px;"></div>
</div>


<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    üåü Try Mary's Salon in Kisumu | üì¶ Order from Speedy Courier Services | üì± Fix your phone at TechHub Eldoret | üçî Order lunch from Mama John's Kitchen | üì∏ Book events with StarPix Photography | üõ†Ô∏è Car repairs at QuickFix Nairobi | üíª Affordable Web Design by PixelStorm | üì∑ Wedding shoots by EliteLens Studios
  </div>
</div>
<h3 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 18px; color: #000; display: inline-block;">
  <i class="fas fa-people-arrows" style="color:#ff9800; margin-right: 8px;"></i>
  üî∫ Unlock a perfect swap today ‚Äì find teachers ready to exchange counties effortlessly. Let's scroll down!
</h3>

<!-- üî• VIP Swaps Modal -->
<div id="vipSwapsModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; max-height:80%; overflow:auto; background:white; padding:20px; border:2px solid crimson; border-radius:10px; z-index:9999; box-shadow:0 0 12px rgba(0,0,0,0.3);">
  <h3 style="color:crimson;">üî• Available VIP Swaps</h3>
  <div id="vipSwapsList"></div>
  <div style="text-align:right; margin-top:15px;">
    <button onclick="document.getElementById('vipSwapsModal').style.display='none'" style="padding:6px 12px; background:#ccc; border:none; border-radius:5px;">Close</button>
  </div>
</div>
<div id="swapCardContainer" style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; margin-top: 16px;">
  <!-- Swap cards will be dynamically injected here by loadSwaps() -->
</div>
</div>

<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    üåü Try Mary's Salon in Kisumu | üì¶ Order from Speedy Courier Services | üì± Fix your phone at TechHub Eldoret | üçî Order lunch from Mama John's Kitchen | üì∏ Book events with StarPix Photography | üõ†Ô∏è Car repairs at QuickFix Nairobi | üíª Affordable Web Design by PixelStorm | üì∑ Wedding shoots by EliteLens Studios
  </div>
</div>

<div id="bomJobs" class="page" style="display:none;">
<h2 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 20px; color: #000; display: inline-block;">
  <i class="fas fa-briefcase" style="color:#6f42c1; margin-right: 8px;"></i>
  Post Any Job Opportunity Here
</h2>

<!-- üîÅ Flex container -->
<div class="form-wrapper">
  
  <!-- Left Image -->
  <div class="side-image">
 <img src="https://i.imgur.com/5bWHfIX.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/2YaRtCe.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/y4n1NSY.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/kKIs8rW.jpeg " alt="Left Side" class="side-image" />

  </div>

<!-- The Form -->
<form id="bomJobForm" style="
  max-width: 500px;
  margin: 40px auto;
  padding: 25px;
  border-radius: 12px;
  background: url('https://i.imgur.com/wVWJ0QC.jpeg') no-repeat center center;
  background-size: cover;
  color: #fff;
  font-family: Arial, sans-serif;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
">
  <label for="bomOrg" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Organization Name:</label>
  <input type="text" id="bomOrg" placeholder="e.g. Thika High School" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;" />

  <label for="bomJobType" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Type of Job Opportunity:</label>
  <input type="text" id="bomJobType" placeholder="e.g. Teaching, House Manager, Cook" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;" />

  <label for="bomContact" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Contact (Phone Number or Link):</label>
  <input type="text" id="bomContact" placeholder="e.g. 0712345678 or https://t.me/username" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;" />
  <small style="color:#ddd; text-shadow:1px 1px 2px #000;">Enter a phone number or a link (WhatsApp, Telegram, etc.)</small>

  <label for="bomCounty" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">County:</label>
  <select id="bomCounty" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;">
    <option value="">Select County</option>
  </select>

  <label for="bomSubCounty" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Sub-county:</label>
  <select id="bomSubCounty" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;">
    <option value="">Select Sub-county</option>
  </select>

  <label for="bomSalaryRange" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Expected Salary Range (Ksh):</label>
  <input type="text" id="bomSalaryRange" placeholder="e.g. 15000 - 25000" required style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.85); font-size:14px;" />

  <label for="bomDate" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Date Posted:</label>
  <input type="text" id="bomDate" readonly style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.6); font-size:14px;" />

  <label for="bomPostedBy" style="display:block; margin-top:12px; font-weight:bold; text-shadow:1px 1px 2px #000;">Posted By (Name or Email):</label>
  <input type="text" id="bomPostedBy" placeholder="e.g. siro@example.com" readonly style="width:100%; padding:10px; margin-top:6px; border:none; border-radius:6px; background:rgba(255,255,255,0.6); font-size:14px;" />

  <button type="submit" style="
    margin-top:20px;
    width:100%;
    padding:12px;
    background:#28a745;
    border:none;
    border-radius:8px;
    font-size:16px;
    color:white;
    cursor:pointer;
    font-weight:bold;
    transition:background 0.3s ease;
  ">
    <i class="fas fa-briefcase" style="margin-right:6px; color:#ffffff;"></i>
    Post Job
  </button>
</form>


  <!-- Right Image -->
  <div class="side-image">
   <img src="https://i.imgur.com/lIZ1IQi.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/XRks66A.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/KdsEBmH.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/rXTm8kr.jpeg " alt="Left Side" class="side-image" />

  </div>

</div>

<!-- üì¶ BOM Filter Action Box -->
<div style="
  border: 2px solid #c8e6c9; 
  background-image: url('https://i.imgur.com/mn4M1kD.jpeg'); /* Add your image URL here */
  background-size: cover; 
  background-position: center;
  padding: 16px; 
  border-radius: 10px; 
  margin-bottom: 20px; 
  display: flex; 
  flex-wrap: wrap; 
  gap: 16px; 
  align-items: flex-start;
">

  <!-- County Filter -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select
      id="filterCounty"
      onchange="handleCountyChange('filterCounty', 'filterSubCounty')"
      style="
        width: 160px; 
        background-color: rgba(227, 242, 253, 0.8); /* Semi-transparent background */
        border: 2px solid #42a5f5; 
        padding: 8px; 
        border-radius: 6px; 
        font-weight: bold;
        font-size: 14px;
        color: #333;
      "
    >
      <option value="">All Counties</option>
    </select>
    <label for="filterCounty" style="margin-top: 6px; font-size: 13px; color: #1565c0;">County</label>
  </div>

  <!-- Sub-county Filter -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <select
      id="filterSubCounty"
      style="
        width: 160px; 
        background-color: rgba(237, 231, 246, 0.8); /* Semi-transparent background */
        border: 2px solid #7e57c2; 
        padding: 8px; 
        border-radius: 6px; 
        font-weight: bold;
        font-size: 14px;
        color: #333;
      "
    >
      <option value="">All Sub-counties</option>
    </select>
    <label for="filterSubCounty" style="margin-top: 6px; font-size: 13px; color: #512da8;">Sub-county</label>
  </div>

  <!-- Salary Filter -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <input
      type="number"
      id="filterSalary"
      placeholder="Min Salary (Ksh)"
      style="
        width: 160px; 
        background-color: rgba(255, 253, 231, 0.8); /* Semi-transparent background */
        border: 2px solid #fbc02d; 
        padding: 8px; 
        border-radius: 6px; 
        font-weight: bold;
        font-size: 14px;
        color: #333;
      "
    />
    <label for="filterSalary" style="margin-top: 6px; font-size: 13px; color: #f57f17;">Min Salary</label>
  </div>

  <!-- Apply Filters Button -->
  <div style="display: flex; flex-direction: column; align-items: center;">
    <button
      onclick="applyBOMFilters()"
      style="
        width: 160px; 
        padding: 10px; 
        background-color: #43a047; 
        color: white; 
        font-weight: bold;
        border: none; 
        border-radius: 6px; 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 6px;
        font-size: 14px;
      ">
      <i class="fas fa-filter"></i> Apply Filters
    </button>
    <label style="visibility: hidden;">&nbsp;</label>
  </div>

</div>


<!-- Custom Confirmation Modal -->
<div id="customConfirmModal" style="display:none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 999;">
  <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; width: 300px;">
    <p id="confirmMessage" style="font-size: 16px; color: #333;"></p>
    <div>
      <button id="confirmYes" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Yes</button>
      <button id="confirmNo" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">No</button>
    </div>
  </div>
</div>
<h3 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 18px; color: #000; display: inline-block;">
  <i class="fas fa-clipboard-list" style="color:#6f42c1; margin-right: 8px;"></i>
  Available Job Opportunities
</h3>

<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    üåü Try Mary's Salon in Kisumu | üì¶ Order from Speedy Courier Services | üì± Fix your phone at TechHub Eldoret | üçî Order lunch from Mama John's Kitchen | üì∏ Book events with StarPix Photography | üõ†Ô∏è Car repairs at QuickFix Nairobi | üíª Affordable Web Design by PixelStorm | üì∑ Wedding shoots by EliteLens Studios
  </div>
</div>
<div id="jobContainer" style="
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  width: 100%;               /* Fill full width of screen */
  padding: 10px 20px;        /* Optional horizontal padding */
  margin-top: 20px;
  overflow-y: auto;
  max-height: 600px;         /* Increase height to show more rows */
  scroll-snap-type: y mandatory;
  box-sizing: border-box;
">
</div>
</div>

<div id="resources" class="page-section" style="display:none;">
  <h2 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 20px; color: #000; display: inline-block;">
    <i class="fas fa-upload" style="color:#4CAF50; margin-right: 8px;"></i>
    Teaching Resources
  </h2>

  <!-- Filters Section with Action Box -->
  <div id="filters" style="background-image: url('https://i.imgur.com/h5MhbFN.jpeg'); background-size: cover; padding: 20px; border-radius: 8px; color: white;">
    <h3>Filter Resources</h3>
    
    <div class="action-box">
      <label for="resourceCategory">Category:</label>
      <select id="resourceCategory" required>
        <option value="">Select Category</option>
        <option value="english">English</option>
        <option value="kiswahili">Kiswahili</option>
        <option value="mathematics">Mathematics</option>
        <option value="environmental-activities">Environmental Activities</option>
        <option value="creative-arts">Creative Arts</option>
        <option value="religious-education">Religious Education</option>
        <option value="physical-education">Physical Education</option>
        <option value="science">Science</option>
        <option value="social-studies">Social Studies</option>
        <option value="health-education">Health Education</option>
        <option value="agriculture">Agriculture</option>
        <option value="integrated-science">Integrated Science</option>
        <option value="pre-technical-studies">Pre-Technical Studies</option>
        <option value="creative-arts-and-sports">Creative Arts and Sports</option>
        <option value="biology">Biology</option>
        <option value="chemistry">Chemistry</option>
        <option value="physics">Physics</option>
        <option value="history">History</option>
        <option value="geography">Geography</option>
        <option value="cre">Religious Education (CRE)</option>
        <option value="business-studies">Business Studies</option>
        <option value="computer-studies">Computer Studies / ICT</option>
        <option value="home-science">Home Science</option>
        <option value="art-and-design">Art and Design</option>
        <option value="music">Music</option>
        <option value="sports">Sports</option>
        <option value="french">French</option>
        <option value="german">German</option>
        <option value="arabic">Arabic</option>
        <option value="technical-drawing">Technical Drawing</option>
        <option value="engineering">Engineering</option>
        <option value="commerce">Commerce</option>
        <option value="psychology">Psychology</option>
        <option value="sociology">Sociology</option>
        <option value="law">Law</option>
        <option value="philosophy">Philosophy</option>
        <option value="economics">Economics</option>
        <option value="entrepreneurship">Entrepreneurship</option>
      </select>

      <label for="searchResources">Search Resources:</label>
      <input type="text" id="searchResources" placeholder="Search by title or keyword">

      <label for="resourceGrade">Grade:</label>
      <select id="resourceGrade" required>
        <option value="">Select Grade</option>
        <option value="grade1">Grade 1</option>
        <option value="grade2">Grade 2</option>
        <option value="grade3">Grade 3</option>
        <option value="grade4">Grade 4</option>
        <option value="grade5">Grade 5</option>
        <option value="grade6">Grade 6</option>
        <option value="grade7">Grade 7</option>
        <option value="grade8">Grade 8</option>
        <option value="grade9">Grade 9</option>
        <option value="grade10">Grade 10</option>
        <option value="grade11">Grade 11</option>
        <option value="grade12">Grade 12</option>
      </select>

      <label for="resourceLevel">Level:</label>
      <select id="resourceLevel">
        <option value="">All Levels</option>
        <option value="primary">Primary School</option>
        <option value="juniorSecondary">Junior Secondary</option>
        <option value="seniorSecondary">Senior Secondary</option>
      </select>

      <!-- New Term filter -->
      <label for="resourceTerm">Term:</label>
      <select id="resourceTerm">
        <option value="">All Terms</option>
        <option value="term1">Term 1</option>
        <option value="term2">Term 2</option>
        <option value="term3">Term 3</option>
      </select>

      <!-- New Strand filter -->
      <label for="resourceStrand">Strand:</label>
      <input type="text" id="resourceStrand" placeholder="Search by Strand">
    </div>
  </div>

  <!-- Admin only view -->
  <div id="adminUploadForm" style="display:none;">
    <div class="form-container">
      <img src="https://i.imgur.com/x9v3Czl.jpeg" alt="Left Side" class="side-image" />

      <form id="resourceForm" style="
        background-image: url('https://i.imgur.com/hrktUII.jpeg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        padding: 25px;
        border-radius: 12px;
        color: #fff;
      ">
        <label for="uploadTitle">Title:</label>
        <input type="text" id="uploadTitle" />

        <label for="uploadPrice">Price (Ksh):</label>
        <input type="number" id="uploadPrice" />

        <label for="uploadCategory">Category:</label>
        <select id="uploadCategory">
          <option value="english">English</option>
          <option value="kiswahili">Kiswahili</option>
          <option value="mathematics">Mathematics</option>
          <option value="science">Science</option>
          <option value="social-studies">Social Studies</option>
          <option value="creative-arts">Creative Arts</option>
          <option value="religious-education">Religious Education</option>
          <option value="health-education">Health Education</option>
          <option value="agriculture">Agriculture</option>
          <option value="integrated-science">Integrated Science</option>
          <option value="pre-technical-studies">Pre-Technical Studies</option>
          <option value="creative-arts-and-sports">Creative Arts and Sports</option>
          <option value="biology">Biology</option>
          <option value="chemistry">Chemistry</option>
          <option value="physics">Physics</option>
          <option value="history">History</option>
          <option value="geography">Geography</option>
          <option value="cre">Religious Education (CRE)</option>
          <option value="business-studies">Business Studies</option>
          <option value="computer-studies">Computer Studies / ICT</option>
          <option value="home-science">Home Science</option>
          <option value="art-and-design">Art and Design</option>
          <option value="music">Music</option>
          <option value="sports">Sports</option>
          <option value="french">French</option>
          <option value="german">German</option>
          <option value="arabic">Arabic</option>
          <option value="technical-drawing">Technical Drawing</option>
          <option value="engineering">Engineering</option>
          <option value="commerce">Commerce</option>
          <option value="psychology">Psychology</option>
          <option value="sociology">Sociology</option>
          <option value="law">Law</option>
          <option value="philosophy">Philosophy</option>
          <option value="economics">Economics</option>
          <option value="entrepreneurship">Entrepreneurship</option>
        </select>

        <label for="uploadGrade">Grade:</label>
        <select id="uploadGrade">
          <option value="">Select Grade</option>
          <option value="grade1">Grade 1</option>
          <option value="grade2">Grade 2</option>
          <option value="grade3">Grade 3</option>
          <option value="grade4">Grade 4</option>
          <option value="grade5">Grade 5</option>
          <option value="grade6">Grade 6</option>
          <option value="grade7">Grade 7</option>
          <option value="grade8">Grade 8</option>
          <option value="grade9">Grade 9</option>
          <option value="grade10">Grade 10</option>
          <option value="grade11">Grade 11</option>
          <option value="grade12">Grade 12</option>
        </select>

        <label for="uploadLevel">Level:</label>
        <select id="uploadLevel">
          <option value="">Select Level</option>
          <option value="primary">Primary School</option>
          <option value="juniorSecondary">Junior Secondary</option>
          <option value="seniorSecondary">Senior Secondary</option>
        </select>

        <label for="uploadTerm">Term:</label>
        <select id="uploadTerm">
          <option value="">Select Term</option>
          <option value="term1">Term 1</option>
          <option value="term2">Term 2</option>
          <option value="term3">Term 3</option>
        </select>

        <label for="uploadStrand">Strand:</label>
        <input type="text" id="uploadStrand" placeholder="Enter Strand" />

        <label for="uploadFile">Upload File (optional):</label>
        <input type="file" id="uploadFile" accept=".pdf,.doc,.docx,.ppt,.pptx" />

        <button type="submit">
          <i class="fas fa-upload"></i> Upload Resource
        </button>
      </form>

      <img src="https://i.imgur.com/ytrul2r.jpeg" alt="Right Side" class="side-image" />
    </div>
  </div>

  <h3 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 18px; color: #000; display: inline-block;">
    <i class="fas fa-book-open" style="color:#3f51b5; margin-right: 8px;"></i>
    Available Resources
  </h3>

  <table id="resourcesTable">
    <thead>
      <tr>
        <th>Title</th>
        <th>Price (Ksh)</th>
        <th>Category</th>
        <th>Grade</th>
        <th>Level</th>
        <th>Term</th>
        <th>Strand</th>
        <th>Download</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<div id="soulmates" class="page" style="display:none;">
<h3 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 18px; color: #000; display: inline-block;">
  <i class="fas fa-venus-mars" style="color:#e91e63; margin-right: 8px;"></i>
  Register To Connect With Available Soulmates
</h3>

<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    üåü Try Mary's Salon in Kisumu | üì¶ Order from Speedy Courier Services | üì± Fix your phone at TechHub Eldoret | üçî Order lunch from Mama John's Kitchen | üì∏ Book events with StarPix Photography | üõ†Ô∏è Car repairs at QuickFix Nairobi | üíª Affordable Web Design by PixelStorm | üì∑ Wedding shoots by EliteLens Studios
  </div>
</div>
<div class="form-container">
  <img src="   https://i.imgur.com/pfeMjzi.jpeg " alt="Left Side" class="side-image" />
<img src="   https://i.imgur.com/WKwJ73A.jpeg" alt="Left Side" class="side-image" />
<img src="   https://i.imgur.com/kngaoSj.jpeg" alt="Left Side" class="side-image" />
<img src="   https://i.imgur.com/dlbQbGo.jpeg" alt="Left Side" class="side-image" />
<form id="soulmateForm">
  <style>
    #soulmateForm {
      max-width: 500px;
      margin: 40px auto;
      padding: 25px;
      border-radius: 12px;
      background: url('https://i.imgur.com/eaxK2rz.jpeg') no-repeat center center;
      background-size: cover; /* makes image cover whole form */
      color: #fff; /* text visible on image */
      font-family: Arial, sans-serif;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    #soulmateForm label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    }

    #soulmateForm input,
    #soulmateForm select {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border: none;
      border-radius: 6px;
    }

    #soulmateForm button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      background: rgba(255, 0, 100, 0.9);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    #soulmateForm button:hover {
      background: rgba(200, 0, 80, 1);
    }
  </style>

  <label for="smName">Your Name:</label>
  <input type="text" id="smName" required />

  <label for="smCounty">Home County:</label>
  <select id="smCounty" required></select>

  <label for="smSubCounty">Home Sub-county:</label>
  <select id="smSubCounty" required>
    <option value="">Select Sub-county</option>
  </select>

  <label for="smAge">Age:</label>
  <input type="number" id="smAge" required />

  <label for="smTribe">Tribe:</label>
  <input type="text" id="smTribe" required />

  <label for="smSex">Sex:</label>
  <select id="smSex" required>
    <option value="">Select Sex</option>
    <option value="Male">Male</option>
    <option value="Female">Female</option>
  </select>

  <label for="smOccupation">Occupation:</label>
  <input type="text" id="smOccupation" required />

  <label for="smWorkCounty">Work County:</label>
  <select id="smWorkCounty" required></select>

  <label for="smPhone">Phone Number:</label>
  <input type="tel" id="smPhone" required />

  <label for="smStatus">Marital Status:</label>
  <select id="smStatus" required>
    <option value="">Select Status</option>
    <option value="Single">Single</option>
    <option value="Divorced">Divorced</option>
    <option value="Searching">Searching</option>
  </select>

  <label for="smKids">Do you have kids?</label>
  <select id="smKids" required>
    <option value="">Select</option>
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <label for="smPhoto">Upload Photo (optional):</label>
  <input type="file" id="smPhoto" accept="image/*" />

  <button type="submit">
    <i class="fas fa-heart"></i> Submit Profile
  </button>
</form>

   <img src="https://i.imgur.com/mUvDPiM.jpeg " alt="Right Side" class="side-image" />
  <img src="https://i.imgur.com/4pi7IZ6.jpeg " alt="Right Side" class="side-image" />
 <img src="https://i.imgur.com/R0QCWyv.jpeg " alt="Right Side" class="side-image" />
<img src="https://i.imgur.com/dYvavhy.jpeg " alt="Right Side" class="side-image" />


</div>

<!-- ‚îÄ‚îÄ‚îÄ FILTER UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<!-- ‚îÄ‚îÄ‚îÄ ACTION BOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="action-box" style="
    border: 1px solid #e0e0e0;
    padding: 20px;
    border-radius: 10px;
    background-color: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    font-family: 'Arial', sans-serif;
    ">
  <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center; background-image: url('https://i.imgur.com/9txrlso.jpeg'); background-size: cover; background-position: center; padding: 20px; border-radius: 8px;">
    
    <!-- Age Filter -->
    <label for="ageFilter" style="font-weight: 600; color: #fff; min-width: 150px;">
      Filter by Age:
    </label>
    <select id="ageFilter" style="
      width: 180px; 
      background-color: #f7faff; 
      border: 1px solid #ccc; 
      padding: 8px; 
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      box-sizing: border-box;
      ">
      <option value="">All</option>
      <option value="20-29">20‚Äì29</option>
      <option value="30-39">30‚Äì39</option>
      <option value="40-49">40‚Äì49</option>
      <option value="50+">50+</option>
    </select>

    <!-- Tribe Filter -->
    <label for="filterTribe" style="font-weight: 600; color: #fff; min-width: 100px;">
      Tribe:
    </label>
    <input type="text" id="filterTribe" placeholder="e.g. Kikuyu" style="
      width: 150px;
      background-color: #f7faff;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      box-sizing: border-box;
      "/>

    <!-- Gender Filter -->
    <label for="filterSex" style="font-weight: 600; color: #fff; min-width: 100px;">
      Gender:
    </label>
    <select id="filterSex" style="
      width: 150px;
      background-color: #f7faff;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      box-sizing: border-box;
      ">
      <option value="">All</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>

    <!-- Sort By Likes Dropdown -->
    <select id="sortByLikes" onchange="loadSoulmates()" style="
      padding: 8px;
      margin: 10px 0;
      background-color: #f7faff;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      min-width: 180px;
      ">
      <option value="recent">Sort: Most Recent</option>
      <option value="likes">Sort: Most Liked</option>
    </select>

    <!-- Filter Dropdown for Verified/Unverified -->
    <select id="filterVerified" onchange="loadSoulmates()" style="
      padding: 8px;
      margin: 10px 0;
      background-color: #f7faff;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      min-width: 180px;
      ">
      <option value="">All</option>
      <option value="verified">Verified</option>
      <option value="unverified">Unverified</option>
    </select>

    <!-- Action Buttons -->
    <div style="display: flex; gap: 10px;">
      <button onclick="loadSoulmates()" style="
        padding: 8px 16px; 
        background-color: #4caf50; 
        color: white; 
        border: none; 
        border-radius: 6px; 
        cursor: pointer; 
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: background-color 0.3s ease;
        ">
        Apply Filters
      </button>
      <button onclick="resetSoulmateFilters()" style="
        padding: 8px 16px; 
        background-color: #f44336; 
        color: white; 
        border: none; 
        border-radius: 6px; 
        cursor: pointer; 
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: background-color 0.3s ease;
        ">
        Reset
      </button>
    </div>
  </div>
</div>



<div id="soulmateContainer" style="
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  max-height: 600px;
  overflow-y: auto;
  box-sizing: border-box;
  background: #f9f9f9;
  border-radius: 10px;
">
  <!-- Cards will be dynamically added here -->
</div>

<div id="endOfListMessage" style="
  display: none;
  text-align: center;
  margin-top: 15px;
  font-weight: bold;
  color: #555;
  font-size: 16px;
">
  That's all for now!
</div>

  </div>


<div id="soulmateModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeSoulmateModal()">&times;</span>
    <h3>Soulmate Profile</h3>
    <div id="soulmateDetails">
      <!-- Details will be injected here -->
    </div>
  </div>
</div>

<div id="notifications" class="page" style="display:none;"> 
  <h2 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 20px; color: #000; display: inline-block;">
    üîî My Notifications
  </h2>
  <ul id="notificationList" style="margin-top: 12px;"></ul>
</div>


<!-- üîπ Market Alerts Section -->
<div id="marketAlerts" class="page" style="display:none; padding:15px;">
  <h2 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 20px; color: #000; display: inline-block;">
    üì¢ My Alerts
  </h2>
  <div id="alertsList" style="margin-top: 12px;">
    <p style="color:gray; text-align:center;">Loading alerts...</p>
  </div>
</div>




<!-- üîπ My Chats Section -->
<div id="myChatsSection" class="page" style="display: none; padding: 20px;">
<h2 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 20px; color: #000; display: inline-block;">
  <i class="fas fa-briefcase" style="color:#6f42c1; margin-right: 8px;"></i>
My Chats
</h2>
  <ul id="chatList" style="list-style:none; padding:0; margin-top:10px;">
    <!-- Chats will be dynamically added here -->
  </ul>
</div>



<!-- Seeking Services Section -->
<div id="seekingServices" class="page" style="display:none;">
<h2 style="display: flex; align-items: center; color: #000; background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 20px; gap: 8px;">
  <i class="fas fa-concierge-bell" style="color:#009688;"></i>
   üöÄ Don‚Äôt wait! Showcase your services today and connect with potential clients instantly.  
  The more you share, the more opportunities you create! üíº‚ú®
</h2>

<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    üåü Try Mary's Salon in Kisumu | üì¶ Order from Speedy Courier Services | üì± Fix your phone at TechHub Eldoret | üçî Order lunch from Mama John's Kitchen | üì∏ Book events with StarPix Photography | üõ†Ô∏è Car repairs at QuickFix Nairobi | üíª Affordable Web Design by PixelStorm | üì∑ Wedding shoots by EliteLens Studios
  </div>
</div>

 <div class="form-container">
  <img src="https://i.imgur.com/3Bdn0Dx.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/79Aw5LM.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/yw7eeD6.jpeg " alt="Left Side" class="side-image" />
<img src="https://i.imgur.com/D83bieA.jpeg " alt="Left Side" class="side-image" />
<form id="serviceForm" 
  style="
    max-width:420px;
    margin:20px auto;
    padding:20px;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
    background-image: url('https://i.imgur.com/ioXkQhJ.jpeg');
    background-size: cover;
    background-position: center;
    color: #fff;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
  ">
  
  <h2 style="text-align:center;color:#fff;margin-bottom:16px;">üìã Post a Service</h2>

  <label for="svcName" style="font-weight:bold;display:block;margin-top:8px;">Name:</label>
  <input type="text" id="svcName" required 
    style="width:100%;padding:10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:6px;"/>

  <label for="svcCounty" style="font-weight:bold;display:block;margin-top:8px;">County:</label>
  <select id="svcCounty" required 
    style="width:100%;padding:10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:6px;"></select>

  <label for="svcSubCounty" style="font-weight:bold;display:block;margin-top:8px;">Sub-county:</label>
  <select id="svcSubCounty" required 
    style="width:100%;padding:10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:6px;">
    <option value="">Select Sub-county</option>
  </select>

  <label for="svcOccupation" style="font-weight:bold;display:block;margin-top:8px;">Occupation:</label>
  <input type="text" id="svcOccupation" required 
    style="width:100%;padding:10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:6px;"/>

  <label for="svcExperience" style="font-weight:bold;display:block;margin-top:8px;">Experience (in years):</label>
  <input type="number" id="svcExperience" required 
    style="width:100%;padding:10px;margin:6px 0 12px;border:1px solid #ccc;border-radius:6px;"/>

  <label for="svcPhone" style="font-weight:bold;display:block;margin-top:8px;">Phone Number:</label>
  <input type="tel" id="svcPhone" required 
    style="width:100%;padding:10px;margin:6px 0 18px;border:1px solid #ccc;border-radius:6px;"/>

  <label for="svcPhotos" style="font-weight:bold;display:block;margin-top:8px;">Upload Photos (Optional):</label>
  <input type="file" id="svcPhotos" accept="image/*" multiple 
    style="width:100%;padding:10px;margin:6px 0 18px;border:1px solid #ccc;border-radius:6px;"/>

  <button type="submit" 
    style="width:100%;background:#00796b;color:white;padding:12px;border:none;border-radius:8px;
           font-size:16px;cursor:pointer;">
    <i class="fas fa-concierge-bell"></i> Submit Service
  </button>
</form>



 <img src="https://i.imgur.com/qUGmfzC.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/V2t9pgK.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/lPPcTF4.jpeg " alt="Left Side" class="side-image" />
 <img src="https://i.imgur.com/GHIpXpv.jpeg " alt="Left Side" class="side-image" />
</div>
<h3>
 
<!-- ‚úÖ Services Filter Action Box -->
<div style="
  border: 2px solid #c8e6c9; 
  background-image: url('https://i.imgur.com/vVljwKd.jpeg'); /* Add your image URL here */
  background-size: cover; 
  background-position: center;
  padding: 16px 20px; 
  border-radius: 10px; 
  margin-bottom: 20px;
">

  <h3 style="margin-bottom: 12px; color: #ffffff;">
    <i class="fas fa-filter" style="margin-right: 6px;"></i> Filter Services
  </h3>

  <div style="display: flex; flex-wrap: wrap; gap: 14px; align-items: flex-start;">

    <!-- County Dropdown -->
    <div style="display: flex; flex-direction: column; align-items: flex-start;">
      <select id="filterServiceCounty" onchange="filterServices()"
        style="
          width: 180px; 
          background-color: rgba(232, 245, 233, 0.8); /* Semi-transparent background */
          border: 2px solid #81c784; 
          padding: 8px; 
          border-radius: 6px; 
          font-weight: bold;
          font-size: 14px;
          color: #333;
        ">
        <option value="">-- Select County --</option>
        <option value="All Kenya">All Kenya</option>
        <!-- Other counties will be dynamically inserted -->
      </select>
      <label for="filterServiceCounty" style="font-size: 13px; color: #388e3c; margin-top: 6px;">County</label>
    </div>

    <!-- Occupation Input -->
    <div style="display: flex; flex-direction: column; align-items: flex-start;">
      <input type="text" id="filterOccupation" placeholder="Search Occupation..."
        onkeyup="filterServices()"
        style="
          width: 180px; 
          background-color: rgba(240, 248, 255, 0.8); /* Semi-transparent background */
          border: 2px solid #64b5f6; 
          padding: 8px; 
          border-radius: 6px; 
          font-weight: bold;
          font-size: 14px;
          color: #333;
        " />
      <label for="filterOccupation" style="font-size: 13px; color: #1976d2; margin-top: 6px;">Occupation</label>
    </div>

  </div>
</div>



<h3 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 18px; color: crimson; display: inline-flex; align-items: center; gap: 8px;">
  <i class="fas fa-users-cog" style="color:#00796b;"></i>
  Available Service Providers
</h3>

<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    üåü Try Mary's Salon in Kisumu | üì¶ Order from Speedy Courier Services | üì± Fix your phone at TechHub Eldoret | üçî Order lunch from Mama John's Kitchen | üì∏ Book events with StarPix Photography | üõ†Ô∏è Car repairs at QuickFix Nairobi | üíª Affordable Web Design by PixelStorm | üì∑ Wedding shoots by EliteLens Studios
  </div>
</div>

<!-- Services Cards Container -->
<div id="servicesContainer" style="
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Flexible column layout */
  gap: 20px; /* Increased gap between cards */
  width: 100%; /* Ensure container uses full available width */
  max-width: 1200px; /* Optionally limit maximum container width for better layout */
  padding: 20px; /* Adds spacing inside the container */
  margin-top: 20px;
  overflow-y: auto; /* Vertical scrolling */
  max-height: 600px; /* Limiting the height */
  scroll-snap-type: y mandatory; /* Ensures smooth snapping on scroll */
  box-sizing: border-box;
  scrollbar-width: thin; /* Firefox custom scrollbar */
  scrollbar-color: #4caf50 #f0f8ff; /* Customize scrollbar colors for a sleek design */
">
  <!-- Service cards will be dynamically added here -->
  <!-- Example cards for testing -->
  <div style="
    background: #e6f7ff;
    padding: 20px;             /* ‚úÖ Spacing inside each card */
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Optional for nicer separation */
  ">
    <h4 style="margin: 0 0 10px;">Service 1</h4>
    <p style="margin: 0;">Description goes here.</p>
  </div>

  <div style="
    background: #e6f7ff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  ">
    <h4 style="margin: 0 0 10px;">Service 2</h4>
    <p style="margin: 0;">Description goes here.</p>
  </div>

  <div style="
    background: #e6f7ff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  ">
    <h4 style="margin: 0 0 10px;">Service 3</h4>
    <p style="margin: 0;">Description goes here.</p>
  </div>
  </div>
  </div>
<div id="market" class="page" style="display:none;">
<h2 style="background-color: yellow; padding: 8px 12px; border-radius: 5px; font-weight: bold; font-size: 20px; color: crimson; display: inline-block;">
  üõí Market Place - Post & Browse Items
</h2>

<div class="scrolling-banner">
  <div class="scrolling-banner-content">
    üåü Try Mary's Salon in Kisumu | üì¶ Order from Speedy Courier Services | üì± Fix your phone at TechHub Eldoret | üçî Order lunch from Mama John's Kitchen | üì∏ Book events with StarPix Photography | üõ†Ô∏è Car repairs at QuickFix Nairobi | üíª Affordable Web Design by PixelStorm | üì∑ Wedding shoots by EliteLens Studios
  </div>
</div>
<div class="form-container">
   <img src=" https://i.imgur.com/nxHMHAI.jpeg" class="side-image" />
 <img src="https://i.imgur.com/nYPCM6a.jpeg " class="side-image" />
 <img src="https://i.imgur.com/uyloDlg.jpeg " class="side-image" />
 <img src="https://i.imgur.com/CLnRHF4.jpeg" class="side-image" />
<form id="marketForm" style="
    background-image: url('https://i.imgur.com/ORcAA8t.jpeg');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    padding: 20px;
    border-radius: 10px;
    color: #fff;
">
   <label for="itemName">Item Name</label>
    <input type="text" id="itemName" placeholder="Item Name" required>

    <label for="itemCategory">Category</label>
    <select id="itemCategory" required>
    <option value="">üîΩ Select Category</option>

<optgroup label="üè† Home & Living">
  <option value="HousesApartments">üè† Houses & Apartments</option>
  <option value="Furniture">ü™ë Furniture</option>
  <option value="HomeAppliances">üîå Home Appliances</option>
  <option value="InteriorDecor">üñºÔ∏è Interior Decor</option>
  <option value="Lighting">üí° Lighting</option>
  <option value="Gardening">ü™¥ Gardening</option>
  <option value="Cleaning">üßº Cleaning Supplies</option>
  <option value="Art">üé® Art & Crafts</option>
</optgroup>

<optgroup label="üëï Fashion & Personal">
  <option value="Clothes">üëó Clothes</option>
  <option value="Shoes">üëü Shoes</option>
  <option value="Bags">üëú Bags</option>
  <option value="Jewelry">üíç Jewelry</option>
  <option value="Watches">‚åö Watches</option>
  <option value="Beauty">üíÑ Beauty</option>
  <option value="Perfumes">üå∏ Perfumes & Fragrances</option>
  <option value="TraditionalWear">üß• Traditional Wear</option>
  <option value="Accessories">üß¢ Fashion Accessories</option>
</optgroup>

<optgroup label="üì± Tech & Electronics">
  <option value="Electronics">üíª Electronics</option>
  <option value="Phones">üì± Phones</option>
  <option value="Tablets">üì≤ Tablets</option>
  <option value="Cameras">üì∑ Cameras</option>
  <option value="Drones">üõ∏ Drones</option>
  <option value="Audio">üéß Audio & Headphones</option>
  <option value="Gaming">üéÆ Gaming</option>
  <option value="Software">üß† Software</option>
  <option value="SmartHome">üè° Smart Home Devices</option>
</optgroup>

<optgroup label="üöó Vehicles">
  <option value="Cars">üöó Cars</option>
  <option value="Motorbikes">üèçÔ∏è Motorbikes</option>
  <option value="Bicycles">üö¥ Bicycles</option>
  <option value="Trucks">üöö Trucks</option>
  <option value="Buses">üöå Buses</option>
  <option value="Marine">‚õ¥Ô∏è Marine & Boats</option>
  <option value="VehicleParts">‚öôÔ∏è Vehicle Parts & Accessories</option>
  <option value="TyresBatteries">üîã Tyres & Batteries</option>
</optgroup>

<optgroup label="üìö Education & Work">
  <option value="Books">üìö Books</option>
  <option value="Stationery">üñäÔ∏è Stationery</option>
  <option value="OfficeSupplies">üóÇÔ∏è Office Supplies</option>
  <option value="Tutoring">üìñ Tutoring Services</option>
  <option value="OnlineCourses">üíª Online Courses</option>
</optgroup>

<optgroup label="üé§ Events & Services">
  <option value="EventServices">üé§ Event Services</option>
  <option value="WeddingSupplies">üíí Wedding Supplies</option>
  <option value="PhotographyServices">üì∏ Photography & Video</option>
  <option value="RepairConstruction">üõ†Ô∏è Repair & Construction</option>
  <option value="Security">üõ°Ô∏è Security & Safety</option>
  <option value="Energy">‚ö° Energy & Solar</option>
  <option value="CourierDelivery">üì¶ Courier & Delivery</option>
  <option value="PrintingBranding">üñ®Ô∏è Printing & Branding</option>
</optgroup>

<optgroup label="üß∏ Lifestyle & Leisure">
  <option value="Toys">üß∏ Toys</option>
  <option value="Sports">üèÄ Sports</option>
  <option value="LeisureActivities">üèñÔ∏è Leisure & Activities</option>
  <option value="Travel">üß≥ Travel</option>
  <option value="MusicalInstruments">üé∏ Musical Instruments</option>
  <option value="BooksMagazines">üì∞ Magazines & Comics</option>
  <option value="Collectibles">üóø Collectibles</option>
</optgroup>

<optgroup label="üçº Family & Health">
  <option value="PetSupplies">üê∂ Pet Supplies</option>
  <option value="BabyProducts">üçº Baby Products</option>
  <option value="Food">üçî Food & Beverages</option>
  <option value="Health">üíä Health</option>
  <option value="MedicalSupplies">ü©∫ Medical Supplies</option>
  <option value="Fitness">üèãÔ∏è‚Äç‚ôÇÔ∏è Fitness & Gym</option>
</optgroup>

<optgroup label="üåæ Industrial & Agriculture">
  <option value="AgricultureFarming">üåæ Agriculture & Farming</option>
  <option value="FarmMachinery">üöú Farm Machinery</option>
  <option value="IndustrialEquipment">üè≠ Industrial Equipment</option>
  <option value="Chemicals">üß™ Chemicals</option>
  <option value="RawMaterials">üì¶ Raw Materials</option>
</optgroup>

<optgroup label="üåü Miscellaneous">
  <option value="JobListings">üíº Job Listings</option>
  <option value="LostFound">üîç Lost & Found</option>
  <option value="Donations">ü§ù Donations & Charity</option>
  <option value="Other">üåü Other</option>
</optgroup>

    </select>

    <label for="itemDescription">Item Description</label>
    <textarea id="itemDescription" placeholder="Describe the item..." required></textarea>

    <label for="itemPrice">Price (KES)</label>
    <input type="number" id="itemPrice" placeholder="e.g. 1500" required>

    <label for="itemCounty">County</label>
    <select id="itemCounty" required>
      <option value="">Select County</option>
    </select>

    <label for="itemSubcounty">Sub-county</label>
    <select id="itemSubcounty" required>
      <option value="">Select Sub-county</option>
    </select>

    <label for="itemPhone">Phone Number</label>
    <input type="text" id="itemPhone" placeholder="e.g. 0712345678" required>

<label for="itemCondition">Condition</label>
<select id="itemCondition" required>
  <option value="New">New</option>
  <option value="Used">Used</option>
</select>

    <label for="itemPhoto">Upload Item Photo</label>
    <input type="file" id="itemPhoto" accept="image/*">

    <button type="submit">
      <i class="fas fa-upload"></i> Post Item
    </button>
</form>

 <img src="https://i.imgur.com/vwwqSJU.jpeg " class="side-image" />
 <img src="https://i.imgur.com/s4w8sJa.jpeg " class="side-image" />
 <img src="https://i.imgur.com/bpolGgB.jpeg " class="side-image" />
 <img src="https://i.imgur.com/b3gZc2W.jpeg " class="side-image" />
</div>
  <div>


<!-- Container for Market Action / Filter Box -->
<div class="market-action-wrapper" style="margin-top: 40px;">
  <div style="
      border: 2px solid #cfd8dc; 
      background-image: url('https://i.imgur.com/67LD3Dq.jpeg');
      background-size: cover; 
      background-position: center;
      padding: 16px 20px; 
      border-radius: 10px; 
  ">
  <!-- üîç Free Text Search -->
<div style="margin-bottom: 14px; background:#f44336; padding:8px 20px; border-radius:6px; display:inline-block;">
  <label for="filterSearch" style="font-size: 13px; color: #ffffff; margin-bottom: 4px; display:block;">
    <i class="fas fa-search" style="margin-right: 6px; color:#fff;"></i>
    Search Anything:
  </label>


    <input type="text" id="filterSearch" placeholder="Type to search..."
      oninput="filterMarketItems()" 
      style="width: 100%; background-color: rgba(255, 255, 255, 0.85); 
             border: 2px solid #64b5f6; padding: 8px; 
             border-radius: 6px; font-weight: bold;" />
  </div>
  <div class="scrolling-banner">
    <div class="scrolling-banner-content">
      üåü Try Mary's Salon in Kisumu | üì¶ Order from Speedy Courier Services | üì± Fix your phone at TechHub Eldoret | üçî Order lunch from Mama John's Kitchen | üì∏ Book events with StarPix Photography | üõ†Ô∏è Car repairs at QuickFix Nairobi | üíª Affordable Web Design by PixelStorm | üì∑ Wedding shoots by EliteLens Studios
    </div>
  </div>

  <div style="display: flex; flex-wrap: wrap; gap: 14px; align-items: flex-start;">

<!-- Category Filter -->
<div style="display: flex; flex-direction: column; background:#ff9800; padding:8px 12px; border-radius:6px; margin-bottom:12px; width:fit-content;">
  <label for="filterItemCategory" style="font-size: 13px; color: #ffffff; margin-bottom: 4px;">
    <i class="fas fa-tags" style="margin-right: 6px; color:#fff;"></i>
    Filter by Category:
  </label>


      <select id="filterItemCategory" onchange="filterMarketItems()"
        style="width: 180px; background-color: rgba(227, 242, 253, 0.8); border: 2px solid #90caf9; padding: 6px; border-radius: 6px; font-weight: bold;">
        <option value="">üîΩ Select Category</option>
        <optgroup label="üåü Miscellaneous">
          <option value="JobListings">üíº Job Listings</option>
          <option value="LostFound">üîç Lost & Found</option>
          <option value="Donations">ü§ù Donations & Charity</option>

<optgroup label="üè† Home & Living">
  <option value="HousesApartments">üè† Houses & Apartments</option>
  <option value="Furniture">ü™ë Furniture</option>
  <option value="HomeAppliances">üîå Home Appliances</option>
  <option value="InteriorDecor">üñºÔ∏è Interior Decor</option>
  <option value="Lighting">üí° Lighting</option>
  <option value="Gardening">ü™¥ Gardening</option>
  <option value="Cleaning">üßº Cleaning Supplies</option>
  <option value="Art">üé® Art & Crafts</option>
</optgroup>

<optgroup label="üëï Fashion & Personal">
  <option value="Clothes">üëó Clothes</option>
  <option value="Shoes">üëü Shoes</option>
  <option value="Bags">üëú Bags</option>
  <option value="Jewelry">üíç Jewelry</option>
  <option value="Watches">‚åö Watches</option>
  <option value="Beauty">üíÑ Beauty</option>
  <option value="Perfumes">üå∏ Perfumes & Fragrances</option>
  <option value="TraditionalWear">üß• Traditional Wear</option>
  <option value="Accessories">üß¢ Fashion Accessories</option>
</optgroup>

<optgroup label="üì± Tech & Electronics">
  <option value="Electronics">üíª Electronics</option>
  <option value="Phones">üì± Phones</option>
  <option value="Tablets">üì≤ Tablets</option>
  <option value="Cameras">üì∑ Cameras</option>
  <option value="Drones">üõ∏ Drones</option>
  <option value="Audio">üéß Audio & Headphones</option>
  <option value="Gaming">üéÆ Gaming</option>
  <option value="Software">üß† Software</option>
  <option value="SmartHome">üè° Smart Home Devices</option>
</optgroup>

<optgroup label="üöó Vehicles">
  <option value="Cars">üöó Cars</option>
  <option value="Motorbikes">üèçÔ∏è Motorbikes</option>
  <option value="Bicycles">üö¥ Bicycles</option>
  <option value="Trucks">üöö Trucks</option>
  <option value="Buses">üöå Buses</option>
  <option value="Marine">‚õ¥Ô∏è Marine & Boats</option>
  <option value="VehicleParts">‚öôÔ∏è Vehicle Parts & Accessories</option>
  <option value="TyresBatteries">üîã Tyres & Batteries</option>
</optgroup>

<optgroup label="üìö Education & Work">
  <option value="Books">üìö Books</option>
  <option value="Stationery">üñäÔ∏è Stationery</option>
  <option value="OfficeSupplies">üóÇÔ∏è Office Supplies</option>
  <option value="Tutoring">üìñ Tutoring Services</option>
  <option value="OnlineCourses">üíª Online Courses</option>
</optgroup>

<optgroup label="üé§ Events & Services">
  <option value="EventServices">üé§ Event Services</option>
  <option value="WeddingSupplies">üíí Wedding Supplies</option>
  <option value="PhotographyServices">üì∏ Photography & Video</option>
  <option value="RepairConstruction">üõ†Ô∏è Repair & Construction</option>
  <option value="Security">üõ°Ô∏è Security & Safety</option>
  <option value="Energy">‚ö° Energy & Solar</option>
  <option value="CourierDelivery">üì¶ Courier & Delivery</option>
  <option value="PrintingBranding">üñ®Ô∏è Printing & Branding</option>
</optgroup>

<optgroup label="üß∏ Lifestyle & Leisure">
  <option value="Toys">üß∏ Toys</option>
  <option value="Sports">üèÄ Sports</option>
  <option value="LeisureActivities">üèñÔ∏è Leisure & Activities</option>
  <option value="Travel">üß≥ Travel</option>
  <option value="MusicalInstruments">üé∏ Musical Instruments</option>
  <option value="BooksMagazines">üì∞ Magazines & Comics</option>
  <option value="Collectibles">üóø Collectibles</option>
</optgroup>

<optgroup label="üçº Family & Health">
  <option value="PetSupplies">üê∂ Pet Supplies</option>
  <option value="BabyProducts">üçº Baby Products</option>
  <option value="Food">üçî Food & Beverages</option>
  <option value="Health">üíä Health</option>
  <option value="MedicalSupplies">ü©∫ Medical Supplies</option>
  <option value="Fitness">üèãÔ∏è‚Äç‚ôÇÔ∏è Fitness & Gym</option>
</optgroup>

<optgroup label="üåæ Industrial & Agriculture">
  <option value="AgricultureFarming">üåæ Agriculture & Farming</option>
  <option value="FarmMachinery">üöú Farm Machinery</option>
  <option value="IndustrialEquipment">üè≠ Industrial Equipment</option>
  <option value="Chemicals">üß™ Chemicals</option>
  <option value="RawMaterials">üì¶ Raw Materials</option>
          <option value="Other">üåü Other</option>
        </optgroup>
      </select>
    </div>

    <!-- County Filter -->
    <div style="display: flex; flex-direction: column;">
      <label for="filterItemCounty" style="font-size: 13px; color: #ffffff; margin-bottom: 4px;">
        <i class="fas fa-map-marker-alt" style="margin-right: 6px;"></i>County:
      </label>
      <select id="filterItemCounty" onchange="filterMarketItems()"
        style="width: 180px; background-color: rgba(237, 231, 246, 0.8); border: 2px solid #9575cd; padding: 6px; border-radius: 6px; font-weight: bold;">
        <option value="">All Kenya</option>
        <!-- More county options will be populated dynamically -->
      </select>
    </div>

  <!-- Min Price Filter -->
<div style="display: flex; flex-direction: column; background:#4caf50; padding:8px 12px; border-radius:6px; margin-bottom:12px; width:fit-content;">
  <label for="filterMinPrice" style="font-size: 13px; color: #ffffff; margin-bottom: 4px;">
    <i class="fas fa-dollar-sign" style="margin-right: 6px; color:#fff;"></i>
    Min Price:
  </label>


      <input type="number" id="filterMinPrice" placeholder="KES 0" onchange="filterMarketItems()"
        style="width: 120px; background-color: rgba(232, 245, 233, 0.8); border: 2px solid #a5d6a7; padding: 6px; border-radius: 6px; font-weight: bold;" />
    </div>

<!-- Max Price Filter -->
<div style="display: flex; flex-direction: column; background:#2e7d32; padding:8px 12px; border-radius:6px; margin-bottom:12px; width:fit-content;">
  <label for="filterMaxPrice" style="font-size: 13px; color: #ffffff; margin-bottom: 4px;">
    <i class="fas fa-dollar-sign" style="margin-right: 6px; color:#fff;"></i>
    Max Price:
  </label>
      <input type="number" id="filterMaxPrice" placeholder="KES 10000" onchange="filterMarketItems()"
        style="width: 120px; background-color: rgba(255, 235, 238, 0.8); border: 2px solid #ef9a9a; padding: 6px; border-radius: 6px; font-weight: bold;" />
    </div>

    <!-- Apply & Reset Buttons -->
    <div style="display: flex; gap: 8px; margin-top: 6px;">
      <button onclick="filterMarketItems()"
        style="padding: 6px 12px; background: #4caf50; color: #fff; border: none; border-radius: 6px; cursor: pointer;">
        Apply Filters
      </button>
      <button onclick="resetMarketFilters()"
        style="padding: 6px 12px; background: #f44336; color: #fff; border: none; border-radius: 6px; cursor: pointer;">
        Reset
      </button>
    </div>

  </div>
</div>
<!-- ‚ö†Ô∏è Floating Payment Alert -->
<div id="paymentAlert" style="
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #ffeb3b; /* Yellow background */
    color: #d32f2f;            /* Red text */
    padding: 16px 20px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 9999;
    max-width: 300px;
">
  <i class="fas fa-exclamation-triangle" style="font-size: 18px;"></i>
  <span> Attention: Always pay <u>after delivery</u>! Avoid advance payments to prevent fraud.</span>
  <button onclick="document.getElementById('paymentAlert').style.display='none';" 
          style="
            margin-left: auto;
            background: transparent;
            border: none;
            color: #d32f2f;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
          ">
    √ó
  </button>
</div>



<!-- ‚úÖ Market Items Container -->
<div id="marketContainer" style="
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 40px;
  width: 100%;
  padding: 40px 30px;
  margin-top: 20px;
  box-sizing: border-box;
  background-color: #f9fbff;
">
  <!-- Market Item Cards -->
  <div style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);">
    <h4 style="margin: 0 0 10px;">Market Item 1</h4>
    <p style="margin: 0;">Description of the item here.</p>
  </div>
  <div style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);">
    <h4 style="margin: 0 0 10px;">Market Item 2</h4>
    <p style="margin: 0;">Description of the item here.</p>
  </div>
  <div style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);">
    <h4 style="margin: 0 0 10px;">Market Item 3</h4>
    <p style="margin: 0;">Description of the item here.</p>
  </div>
</div>

<section id="trendingSection" class="page" hidden>
  <h2>
    <i class="fas fa-fire" aria-hidden="true"></i>
    Trending Boosted Items
  </h2>
  
  <div class="scrolling-banner">
    <div class="scrolling-banner-content">
      üåü Hot listings from every corner of Kenya | üíº Jobs | üõçÔ∏è Market | ‚ù§Ô∏è Soulmates | üõ†Ô∏è Services ‚Äì All Boosted & Trending Now!
    </div>
  </div>
  
  <div id="trendingContainer">
    <!-- Boosted cards will be inserted here -->
  </div>
</section>



<!-- ‚úÖ Confirm Delete Modal -->
<div id="confirmDeleteModal" style="display:none; position: fixed; top: 0; left: 0;
  width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
  <div style="background: white; padding: 20px 25px; border-radius: 10px; box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      width: 90%; max-width: 400px; text-align: center;">
    <h3 style="margin-bottom: 10px; color: #dc3545;">Confirm Deletion</h3>
    <p style="font-size: 16px;">Are you sure you want to delete this swap?</p>
    <div style="height: 8px; background: #eee; border-radius: 5px; margin-top: 15px;">
      <div id="confirmProgressBar" style="width: 100%; height: 8px; background-color: #28a745; border-radius: 5px;"></div>
    </div>
    <span style="color: crimson; font-weight: bold;">üî• VIP</span>
    <div style="margin-top: 20px;">
      <button id="confirmYes" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none;
        border-radius: 6px; margin-right: 10px; cursor: pointer;">Yes, Delete</button>
      <button id="confirmNo" style="background-color: #6c757d; color: white; padding: 10px 20px; border: none;
        border-radius: 6px; cursor: pointer;">Cancel</button>
    </div>
  </div>
</div>

<!-- ‚úÖ Notification Badge -->
<span id="notifBadge" style="display:none; background:red; color:white; border-radius:50%; padding:2px 6px;">0</span>

<!-- ‚úÖ Centered Toast -->
<div id="customToast" style="
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #d32f2f;
  color: #fff;
  padding: 16px 24px;
  border-radius: 10px;
  display: none;
  z-index: 9999;
  font-size: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  max-width: 90%;
  text-align: center;
  opacity: 0;
  transition: opacity 0.4s ease;
">
  <span id="toastMessage">This is a toast message.</span>
  <button onclick="hideCustomToast()" style="
    position: absolute;
    top: 8px;
    right: 12px;
    background: transparent;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;">&times;
  </button>
</div>


<!-- ‚úÖ Toast Container -->
<div id="toastContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>
<!-- ‚úÖ Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>


<script>
  // ‚úÖ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyD7qfXm0hmz4oyvKzICwFQ2xQR1_RkLNYg",
    authDomain: "rowan-494f7.firebaseapp.com",
    databaseURL: "https://rowan-494f7-default-rtdb.firebaseio.com",
    projectId: "rowan-494f7",
    storageBucket: "rowan-494f7.firebasestorage.app",
    messagingSenderId: "158143387761",
    appId: "1:158143387761:web:2606fa93a3c812bddd23d0",
    measurementId: "G-V9Q98Q09F2"
  };

   // ‚úÖ Firebase Init
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
const storage = firebase.storage();  // ‚úÖ This line is missing!
const bomRef = db.collection("bomJobs");
const soulmateRef = db.collection("soulmates");
const resourceRef = db.collection("teachingResources");
const servicesRef = db.collection("seekingServices");
const marketRef = db.collection("marketItems");

 // ‚úÖ Global State
  let isLoggedIn = false;
  let hasPaid = false;
  let hasPaid100 = false;
  let hasPaidVip1000 = false;
  let currentUser = null;
  let isAdmin = false;
  let currentUserId = null;

  // ‚úÖ Load user payment status
  async function loadUserPaymentStatus() {
    if (!currentUserId) return;

    try {
      const userDoc = await db.collection("users").doc(currentUserId).get();
      const data = userDoc.data();

      hasPaid100 = data?.hasPaid100 || false;
      hasPaidVip1000 = data?.hasPaidVip1000 || false;
    } catch (error) {
      console.error("Error loading payment status:", error.message);
    }
  }
// ‚úÖ Global helper to check if user is admin
async function checkIfAdmin(user) {
  if (!user) return false;
  try {
    const doc = await db.collection("admins").doc(user.uid).get();
    return doc.exists; // ‚úÖ true if UID exists in admins collection
  } catch (error) {
    console.error("Error checking admin status:", error);
    return false;
  }
}

// ‚úÖ Monitor Auth State
auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    isLoggedIn = true;

    // üîπ Firestore-based admin check
    isAdmin = await checkIfAdmin(user);

    await loadUserPaymentStatus(); // ‚úÖ Load payment info immediately after login

    attachMarketFormSubmit();
    loadMarketItems(); // ‚úÖ Load marketplace (without redirect)

    // Admin-specific actions
    if (isAdmin) {
      loadAdminNotifications();
      updateAdminNotifBadge();

      // Show admin upload form for admins only
      document.getElementById("adminUploadForm").style.display = "block";
    } else {
      // Hide upload form for non-admin users
      document.getElementById("adminUploadForm").style.display = "none";
    }

    // Toggle Admin Notifications button visibility
    toggleAdminNotifications(); // This ensures the button is shown only for admins

  } else {
    isLoggedIn = false;
    currentUser = null;
    currentUserId = null;
    isAdmin = false;
    hasPaid = false;
    hasPaid100 = false;
    hasPaidVip1000 = false;
    showPage("home");

    // Ensure the admin upload form is hidden when logged out
    document.getElementById("adminUploadForm").style.display = "none";
  }
});

// Function to toggle Admin Notifications button visibility
function toggleAdminNotifications() {
  const adminNotifBtn = document.getElementById('adminNotifBtn');
  
  if (isAdmin) {
    adminNotifBtn.style.display = 'block'; // Show for admins
  } else {
    adminNotifBtn.style.display = 'none'; // Hide for non-admins
  }
}
// ==================== Resource Upload ====================
document.getElementById("resourceForm").addEventListener("submit", async e => {
  e.preventDefault();

  document.getElementById("loadingSpinner").style.display = "flex";

  if (!isLoggedIn) {
    showCustomAlert("Please login to upload resources.", "error");
    document.getElementById("loadingSpinner").style.display = "none";
    return;
  }

  const file = document.getElementById("uploadFile").files[0]; // optional
  const title = document.getElementById("uploadTitle").value.trim();
  const price = document.getElementById("uploadPrice").value.trim();
  const category = document.getElementById("uploadCategory").value;
  const grade = document.getElementById("uploadGrade").value;
  const level = document.getElementById("uploadLevel").value;
  const term = document.getElementById("uploadTerm").value;
  const strand = document.getElementById("uploadStrand").value.trim();

  try {
    let downloadURL = null;
    let filePath = null;

    if (file) {
      filePath = `resources/${Date.now()}_${file.name}`;
      const uploadTask = await storage.ref(filePath).put(file);
      downloadURL = await uploadTask.ref.getDownloadURL();
    }

    await resourceRef.add({
      title: title || null,
      price: price || null,
      category: category || null,
      grade: grade || null,
      level: level || null,
      term: term || null,
      strand: strand || null,
      downloadURL,
      filePath,
      uploadedBy: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    showCustomAlert("‚úÖ Resource uploaded!", "success");
    document.getElementById("resourceForm").reset();
    loadResources(); // Reload table after upload

  } catch (err) {
    showCustomAlert("‚ùå Error: " + err.message, "error");
  } finally {
    document.getElementById("loadingSpinner").style.display = "none";
  }
});

// ==================== Filters (keep original filter IDs) ====================
const categoryFilter = document.getElementById("resourceCategory");
const gradeFilter = document.getElementById("resourceGrade");
const levelFilter = document.getElementById("resourceLevel");
const termFilter = document.getElementById("resourceTerm");
const strandFilter = document.getElementById("resourceStrand");
const searchFilter = document.getElementById("searchResources");



let allResources = []; // Store all resources for filtering

// ==================== Load Resources ====================
async function loadResources() {
  const tbody = document.querySelector("#resourcesTable tbody");
  tbody.innerHTML = "";

  try {
    const snapshot = await resourceRef.orderBy("timestamp", "desc").get();

    if (snapshot.empty) {
      tbody.innerHTML = `<tr><td colspan="9">No resources available.</td></tr>`;
      allResources = [];
      return;
    }

    allResources = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    applyFilters(); // Show filtered resources
  } catch (err) {
    showCustomAlert("‚ùå Error loading resources: " + err.message, "error");
  }
}

// ==================== Apply Filters ====================
function applyFilters() {
  const tbody = document.querySelector("#resourcesTable tbody");
  tbody.innerHTML = "";

  const categoryVal = categoryFilter.value;
  const gradeVal = gradeFilter.value;
  const levelVal = levelFilter.value;
  const termVal = termFilter.value;
  const strandVal = strandFilter.value.toLowerCase();
  const searchVal = searchFilter.value.toLowerCase();

  const filtered = allResources.filter(r => {
    const matchesCategory = !categoryVal || r.category === categoryVal;
    const matchesGrade = !gradeVal || r.grade === gradeVal;
    const matchesLevel = !levelVal || r.level === levelVal;
    const matchesTerm = !termVal || r.term === termVal;
    const matchesStrand = !strandVal || (r.strand && r.strand.toLowerCase().includes(strandVal));
    const matchesSearch = !searchVal || (r.title && r.title.toLowerCase().includes(searchVal));
    return matchesCategory && matchesGrade && matchesLevel && matchesTerm && matchesStrand && matchesSearch;
  });

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9">No resources match your filters.</td></tr>`;
    return;
  }

  filtered.forEach(r => {
    const tr = document.createElement("tr");

    let downloadContent = "No file";
    if (r.downloadURL) {
      if (isAdmin) {
        downloadContent = `<a href="${r.downloadURL}" target="_blank">Download</a>`;
      } else {
        downloadContent = hasPaid
          ? `<a href="${r.downloadURL}" target="_blank">Download</a>`
          : `<button onclick="showPaymentModal()">Pay to Download</button>`;
      }
    }

    let deleteBtn = "";
    if (isAdmin || (currentUser && currentUser.uid === r.uploadedBy)) {
      deleteBtn = `<button class="delete-btn" data-id="${r.id}" data-path="${r.filePath || ""}">Delete</button>`;
    }

    tr.innerHTML = `
      <td>${r.title}</td>
      <td>${r.price}</td>
      <td>${r.category}</td>
      <td>${r.grade}</td>
      <td>${r.level}</td>
      <td>${r.term || "-"}</td>
      <td>${r.strand || "-"}</td>
      <td>${downloadContent}</td>
      <td>${deleteBtn}</td>
    `;

    tbody.appendChild(tr);
  });

  // Attach delete modal listeners
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      openDeleteModal(btn.dataset.id, btn.dataset.path);
    });
  });
}

// ==================== Filter Event Listeners ====================
[categoryFilter, gradeFilter, levelFilter, termFilter, strandFilter, searchFilter].forEach(el => {
  el.addEventListener("input", applyFilters);
});

// ==================== Delete Modal ====================
let deleteResourceId = null;
let deleteFilePath = null;

function openDeleteModal(resourceId, filePath) {
  deleteResourceId = resourceId;
  deleteFilePath = filePath;
  document.getElementById("deleteModal").style.display = "flex";
}

function closeDeleteModal() {
  document.getElementById("deleteModal").style.display = "none";
  deleteResourceId = null;
  deleteFilePath = null;
}

document.getElementById("confirmDelete").addEventListener("click", async () => {
  if (!deleteResourceId) return;
  await deleteResource(deleteResourceId, deleteFilePath);
  closeDeleteModal();
});

document.getElementById("cancelDelete").addEventListener("click", closeDeleteModal);

async function deleteResource(resourceId, filePath) {
  try {
    await resourceRef.doc(resourceId).delete();
    if (filePath) await storage.ref(filePath).delete();
    showCustomAlert("‚úÖ Resource deleted!", "success");
    loadResources();
  } catch (err) {
    showCustomAlert("‚ùå Error deleting resource: " + err.message, "error");
  }
}

// ==================== Load on Page Load ====================
document.addEventListener("DOMContentLoaded", () => {
  loadResources(); // Load all resources immediately
});


// ‚úÖ Hot counties for VIP swap prioritization
const vipHotCounties = ["Nairobi", "Kisumu", "Mombasa", "Kisii", "Nakuru"];

// ‚úÖ Counties and Sub-counties Map
const countySubCountyMap = {
  "Mombasa": ["Changamwe", "Miritini", "Chaani", "Port Reitz", "Kipevu", "Jomvu", "Mikindani", "Jomvu Kuu", "Miritini","Kisauni","Bamburi","Mshomoroni","Mtopanga","Shanzu","Frere Town","Likoni","Shika Adabu","Bofu","Mtongwe","Mvita","Old Town","Tudor","Tononoka","Ganjoni","Majengo","Nyali","Kongowea","Kadzandani","Ziwa la Ng‚Äôombe"],
  "Kwale": ["Msambweni","Ukunda","Diani","Shimoni","Vanga","Lunga Lunga","Majoreni","Pongwe","Mkongani","Matuga","Tiwi","Kubo South","Mwaluphamba","Kinango","Samburu","Mazeras","Kwale Town","Ndavaya","Kaseeni","Mackinnon Road"],
  "Kilifi": ["Kilifi North","Kilifi South","Kaloleni","Rabai","Ganze","Malindi","Magarini","Chonyi","Mtwapa","Watamu","Sokoke","Vipingo","Mariakani","Mtondia","Kikambala"],
  "Tana River": ["Galole","Garsen","Bura","Galedyertu","Bangal","Hola","Kipini","Tarasaa","Idzowe","Madogo","Wenje","Ngao","Oda","Chara","Kailo"],
  "Lamu": ["Lamu East","Lamu West","Amu","Mokowe","Hindi","Kiunga","Mpeketoni","Kizingitini","Faza","Pate","Shela","Matondoni","Mkunumbi","Mapenya","Kiongwe"],
  "Taita‚ÄìTaveta": ["Mwatate","Voi","Taveta","Wundanyi","Bura","Maktau","Mghalu","Rong‚Äôe","Challa","Mwanda","Kimorigo","Ngolia","Kasigau","Kasarani","Mbuyuni"],
  "Garissa": ["Balambala","Dadaab","Fafi","Garissa Township","Hulugho","Ijara","Lagdera","Modika","Sankuri","Bura East","Masalani","Abakaile","Jarajara","Saka","Bodhai"],
  "Wajir": ["Eldas","Tarbaj","Wajir North","Wajir East","Wajir West","Wajir South","Buna","Habaswein","Griftu","Khorof Harar","Bute","Diff","Leheley","Gurar","Adan Awale"],
  "Mandera": ["Banisa","Mandera West","Mandera North","Mandera South","Mandera East","Lafey","Rhamu","Takaba","Elwak","Shimbir Fatuma","Qurqan","Kutulo","Ashabito","Warankara","Bulla Mpya"],
  "Marsabit": ["Moyale","North Horr","Saku","Laisamis","Sololo","Uran","Dirib Gombo","Kargi","Korr","Logologo","Koya","Illeret","Shurr","Maikona","Badasa"],
  "Isiolo": ["Isiolo Central","Merti","Garbatulla","Kinna","Ngaremara","Oldonyiro","Burat","Chumvi Yere","Bula Pesa","Kulamawe","Sericho","Modogashe","Gotu","Korbesa","Delessa"],
  "Meru": ["Imenti North","Imenti South","Imenti Central","Tigania East","Tigania West","Buuri","North Imenti","Maua","Nkubu","Timau","Gatimbi","Kianjai","Laare","Kibirichia","Kithirune"],
  "Tharaka-Nithi": ["Chuka/Igambang'ombe","Maara","Tharaka South","Tharaka North","Kathwana","Marimanti","Nkondi","Gatunga","Muthambi","Karingani","Magumoni","Kaanwa","Gitugini","Chogoria","Ciampiu"],
  "Embu": ["Manyatta","Runyenjes","Mbeere North","Mbeere South","Kiritiri","Siakago","Ishiara","Kangaru","Blue Valley","Dallas","Kavutiri","Kanja","Gategi","Karurumo","Kathanjuri"],
  "Kitui": ["Kitui Central","Mwingi North","Mwingi West","Mwingi Central","Kitui Rural","Kitui South","Kitui East","Migwani","Mutomo","Ikutha","Nzambani","Kanyangi","Zombe","Mutito","Kisasi"],
  "Machakos": ["Masinga","Yatta","Kangundo","Matungulu","Kathiani","Mavoko","Machakos Town","Mwaki","Mwala","Kola","Mbiuni","Kangundo Town","Katangi","Kalama","Mutituni"],
  "Makueni": ["Mbooni","Kaiti","Kilome","Mukaa","Makueni","Kibwezi East","Kibwezi West","Wote","Sultan Hamud","Makindu","Mtito Andei","Kathonzweni","Mulala","Emali","Kasikeu"],
  "Nyandarua": ["Ol Joro Orok","Kinangop","Kipipiri","Ndaragwa","Ol Kalou","Engineer","Shamata","Njabini","Kaimbaga","Geta","Wanjohi","Karau","Rurii","Leshau","Tumaini"],
  "Nyeri": ["Tetu","Nyeri Town","Mathira","Othaya","Kieni","Mukurweini","Karatina","Chaka","Mweiga","Endarasha","Giakanja","Kamakwa","Ihururu","Kangaita","Wamagana"],
  "Kirinyaga": ["Kirinyaga Central","Kirinyaga West","Mwea","Gichugu","Kerugoya","Kutus","Kagio","Kiamutugu","Kabare","Mutithi","Njegas","Ngurubani","Rukanga","Baricho","Kiamwangi"],
  "Murang'a": ["Gatanga","Kiharu","Kigumo","Kangema","Mathioya","Murang'a South","Kenol","Sabasaba","Kahuro","Maragua","Kangari","Ichichi","Muthithi","Mugumoini","Kiriani"],
  "Kiambu": ["Githunguri","Kiambu","Kabete","Kiambaa","Ruiru","Limuru","Lari","Juja","Thika Town","Gatundu North","Gatundu South","Kikuyu","Tigoni","Kamwangi","Ndeiya"],
  "Turkana": ["Turkana North","Turkana West","Turkana Central","Loima","Turkana South","Turkana East","Lodwar","Kakuma","Lokichoggio","Lokitaung","Lorugum","Lokori","Napeikar","Kainuk","Nakwamekwi"],
  "West Pokot": ["West Pokot","North Pokot","Central Pokot","Pokot South","Kipkomo","Kacheliba","Kapenguria","Chepareria","Ortum","Sigor","Makutano","Sebit","Mnagei","Batei","Sook"],
  "Samburu": ["Samburu East","Samburu North","Samburu West","Maralal","Baragoi","Archers Post","Wamba","South Horr","Suguta Marmar","Waso","Ndoto","Marti","Kisima","Lesirkan","Baawa"],
  "Trans Nzoia": ["Kwanza","Endebess","Saboti","Kiminini","Cherangany","Kitale","Maili Saba","Matisi","Waitaluk","Namanjalala","Kesogon","Matisi Junction","Kapkoi","Birunda","Muroki"],
  "Uasin Gishu": ["Ainabkoi","Kapseret","Kesses","Moiben","Soy","Turbo","Eldoret","Cheptiret","Burnt Forest","Ziwa","Maili Nne","Kaptagat","Moiben Centre","Matunda","Racecourse"],
  "Elgeyo-Marakwet": ["Keiyo North","Keiyo South","Marakwet East","Marakwet West","Iten","Kamariny","Kaptarakwa","Chepkorio","Chebara","Kapcherop","Tot","Sambirir","Kapyego","Kamogo","Chebororwa"],
  "Nandi": ["Aldai","Chesumei","Emgwen","Mosop","Nandi Hills","Tinderet","Kapsabet","Kabiyet","Cheptarit","Kobujoi","Serem","Maraba","Kipkaren","Kaiboi","Kabiyet Centre"],
  "Baringo": ["Baringo Central","Baringo North","Baringo South","Eldama Ravine","Mogotio","Tiaty","Kabarnet","Marigat","Ravine Town","Kimalel","Tangulbei","Mochongoi","Loruk","Perkerra","Torongo"],
  "Laikipia": ["Laikipia East","Nanyuki","Timau","Ngobit","Tigithi","Laikipia North","Doldol","Mugogodo","Mukogodo West","Kimanjo","Laikipia West","Rumuruti","Kinamba","Ol Moran","Sipili","Wiyumiririe","Nyahururu"],
  "Nakuru": ["Bahati","Gilgil","Kuresoi North","Kuresoi South","Molo","Naivasha","Nakuru Town East","Nakuru Town West","Rongai","Subukia","Elementaita","Lanet","Menengai","Njoro","Mai Mahiu"],
  "Narok": ["Narok East","Narok North","Narok South","Narok West","Trans Mara East","Trans Mara West","Kilgoris","Ololulung'a","Ntulele","Olokurto","Mara North","Ololaimutia","Mulot","Olpusimoru","Lolgorian"],
  "Kajiado": ["Isinya","Kajiado Central","Kajiado East","Kajiado North","Kajiado South","Ngong","Ongata Rongai","Kitengela","Magadi","Namanga","Loitokitok","Mashuuru","Ilbisil","Enkorika","Ewaso"],
  "Kericho": ["Ainamoi","Belgut","Bureti","Kipkelion East","Kipkelion West","Soin/Sigowet","Kericho Town","Kapsoit","Litein","Chepseon","Kabianga","Kapkugerwet","Kapkatet","Kapsuser","Kipreres"],
  "Bomet": ["Bomet Central","Bomet East","Chepalungu","Konoin","Sotik","Bomet Town","Longisa","Kapkoros","Sigor","Mulot","Ndanai","Kapkesosio","Silibwet","Chebunyo","Kipreres"],
  "Kakamega": ["Butere","Ikolomani","Khwisero","Lugari","Lurambi","Malava","Matungu","Mumias East","Mumias West","Navakholo","Shinyalu","Kakamega Town","Bukura","Shirere","Khayega"],
  "Vihiga": ["Emuhaya","Hamisi","Luanda","Sabatia","Vihiga","Gisambai","Chavakali","Mbale","Kaimosi","Bugina","Kaptech","Shiru","Muhudu","Tambua","Lusengeli"],
  "Bungoma": ["Bumula","Kabuchai","Kanduyi","Kimilili","Mt. Elgon","Sirisia","Tongaren","Webuye East","Webuye West","Bungoma Town","Misikhu","Chwele","Naitiri","Kamukuywa","Lwakhakha"],
  "Busia": ["Budalangi","Butula","Funyula","Matayos","Nambale","Teso North","Teso South","Busia Town","Mundika","Malaba","Adungosi","Changara","Kocholia","Burumba","Alupe"],
  "Siaya": ["Alego Usonga","Bondo","Gem","Rarieda","Ugenya","Ugunja","Siaya Town","Yala","Usenge","Madiany","Rang'ala","Sidindi","Got Agulu","Nyamonye","Ligega"],
  "Kisumu": ["Kisumu East","Kisumu West","Kisumu Central","Muhoroni","Nyakach","Nyando","Seme","Ahero","Maseno","Kombewa","Koru","Otonglo","Ojola","Chiga","Miwani"],
  "Homa Bay": ["Homa Bay Town","Kabondo Kasipul","Kabondo East","Mbita","Ndhiwa","Rachuonyo East","Rachuonyo North","Rachuonyo South","Rangwe","Suba North","Suba South","Oyugis","Kendu Bay","Sindo","Magunga"],
  "Migori": ["Awendo","Kuria East","Kuria West","Nyatike","Rongo","Suna East","Suna West","Uriri","Migori Town","Isebania","Masara","Macalder","Karungu","Kegonga","Sirare"],
  "Kisii": ["Bobasi","Bomachoge Borabu","Bomachoge Chache","Bonchari","Kitutu Chache North","Kitutu Chache South","Nyaribari Chache","Nyaribari Masaba","South Mugirango","Kisii Town","Suneka","Ogembo","Tabaka","Keroka","Nyamarambe"],
  "Nyamira": ["Borabu","Manga","Masaba North","Nyamira North","Nyamira South","Nyamira Town","Ekerenyo","Keroka","Gesima","Nyansiongo","Kijauri","Bonyamatuta","Kemera","Sironga","Nyamaiya"],
  "Nairobi City": ["Dagoretti North","Dagoretti South","Embakasi Central","Embakasi East","Embakasi North","Embakasi South","Embakasi West","Kamukunji","Kasarani","Lang'ata","Makadara","Mathare","Roysambu","Ruaraka","Starehe","Westlands","Kibra"]
};


// ---------------------------
// ‚úÖ Multi-select counties helper
// ---------------------------
function populateCounties(id, subCountyId = null) {
  const el = document.getElementById(id);
  
  // Make swapCounty multi-select
  if (id === "swapCounty") {
    el.setAttribute("multiple", "multiple");
    el.size = 5; // Show 5 options by default
  } else {
    el.removeAttribute("multiple");
    el.size = 1;
  }

  el.innerHTML = `<option value="">Select County</option>`;

  // Populate county options
  Object.keys(countySubCountyMap).forEach(county => {
    const option = document.createElement("option");
    option.value = county;
    option.textContent = county;
    el.appendChild(option);
  });

  // Handle sub-county population
  if (subCountyId) {
    const subCountyEl = document.getElementById(subCountyId);
    el.addEventListener("change", () => {
      const selectedCounty = el.multiple 
        ? Array.from(el.selectedOptions).map(o => o.value)[0] // first for subcounty dropdown
        : el.value;

      subCountyEl.innerHTML = `<option value="">Select Sub-county</option>`;
      if (countySubCountyMap[selectedCounty]) {
        countySubCountyMap[selectedCounty].forEach(subCounty => {
          const option = document.createElement("option");
          option.value = subCounty;
          option.textContent = subCounty;
          subCountyEl.appendChild(option);
        });
      }
    });
  }
}

// Initialize all county-subcounty dropdowns
const countySubCountyPairs = [
  { county: "county", subCounty: "subCounty" },
  { county: "swapCounty", subCounty: "swapSubCounty" },
  { county: "filterSwapCounty", subCounty: "filterSwapSubCounty" },
  { county: "bomCounty", subCounty: "bomSubCounty" },
  { county: "svcCounty", subCounty: "svcSubCounty" },
  { county: "itemCounty", subCounty: "itemSubCounty" },
  { county: "filterItemCounty", subCounty: "filterItemSubCounty" },
  { county: "filterCounty", subCounty: "filterSubCounty" },
  { county: "filterServiceCounty", subCounty: "filterServiceSubCounty" },
  { county: "smCounty", subCounty: "smSubCounty" }
];
countySubCountyPairs.forEach(pair => populateCounties(pair.county, pair.subCounty));


/* ===================== üîπ Section Navigation ===================== */
async function showPage(pageId) {
  // üîπ Login protection for sensitive pages
  const loginRequiredPages = [
    "swaps", "resources", "messages", "soulmates",
    "seekingServices", "trending", "alerts", "market"
  ];

  if (loginRequiredPages.includes(pageId) && !isLoggedIn) {
    showCustomAlert("Please login to access this section.", "error");
    showPage("login");
    return;
  }

  // üîπ Hide ALL sections
  document.querySelectorAll(".page, .page-section").forEach(sec => {
    sec.style.display = "none";
  });

  // üîπ Hide ride panels if leaving ride system
  hideRidePanels();

  // üîπ Show requested section
  const page = document.getElementById(pageId);
  if (page) page.style.display = "block";

  // üîπ Page-specific logic
  if (pageId === "swaps" && isLoggedIn) loadSwaps();
  if (pageId === "bomJobs") loadBOMJobs();
  if (pageId === "resources" && isLoggedIn) {
    await checkPaymentStatus();
    loadResources();
  }
  if (pageId === "soulmates" && isLoggedIn) loadSoulmates();
  if (pageId === "seekingServices" && isLoggedIn) loadServices();
  if (pageId === "trending" && isLoggedIn) loadTrendingItems();
  if (pageId === "alerts" && isLoggedIn) loadAlerts();
  if (pageId === "notifications" && isAdmin) {
    loadAdminNotifications();
    updateAdminNotifBadge();
  }
  if (pageId === "market" && isLoggedIn) {
    populateCounties("itemCounty", "itemSubcounty");
    loadMarketItems();
  }
}

/* ===================== üîπ Ride System Sub-Panels ===================== */
function showRider() {
  hideRidePanels();
  document.getElementById("riderPanel").style.display = "block";
  showAllAvailableDrivers();
  autoFillPickup(); // ‚úÖ Auto-detect pickup station
}

function showDriverRegister() {
  hideRidePanels();
  document.getElementById("driverRegister").style.display = "block";
}

function showDriverLogin() {
  hideRidePanels();
  document.getElementById("driverLogin").style.display = "block";
}

function showDriverPanel() {
  hideRidePanels();
  document.getElementById("driverPanel").style.display = "block";
}

function hideRidePanels() {
  ["riderPanel", "driverRegister", "driverLogin", "driverPanel"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });
}

// ‚úÖ Helper: Spinner control
function showLoadingSpinner() {
  document.getElementById("loadingSpinner").style.display = "flex";
}
function hideLoadingSpinner() {
  document.getElementById("loadingSpinner").style.display = "none";
}

// ‚úÖ Register
document.getElementById("registerForm").addEventListener("submit", async e => {
  e.preventDefault();
  showLoadingSpinner();

  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  try {
    const userCred = await auth.createUserWithEmailAndPassword(email, password);
    currentUser = userCred.user;
    await currentUser.updateProfile({ displayName: name });

    await sendRegistrationAdminNotification(currentUser);

    hideLoadingSpinner();

    // ‚úÖ Show alert above everything
    showCustomAlert("Registration successful! Please login.", "success");

    // ‚úÖ Close register modal and immediately open login modal
    closeModal("registerModal");
    openModal("loginModal");

    e.target.reset();
  } catch (err) {
    hideLoadingSpinner();
    showCustomAlert("Error: " + err.message, "error");
  }
});

// ‚úÖ Admin notification
async function sendRegistrationAdminNotification(user) {
  await db.collection("adminNotifications").doc().set({
    type: "New User Registration",
    userId: user.uid,
    userEmail: user.email,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `üîî New user ${user.email} has registered successfully.`
  });
  console.log("Admin notification sent for new user registration.");
}

/* ===================== üîπ Main User Login ===================== */
document.getElementById("loginForm").addEventListener("submit", async e => {
  e.preventDefault();
  showLoadingSpinner();

  const email = document.getElementById("loginEmail").value.trim();  // ‚úÖ Trim input
  const password = document.getElementById("loginPassword").value;

  try {
    const userCred = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCred.user;
    isLoggedIn = true;

    localStorage.setItem("loggedInUser", currentUser.displayName || currentUser.email);

    const welcome = `Welcome ${currentUser.displayName || currentUser.email}!`;
    showCustomAlert(isAdmin ? `Admin Access: ${welcome}` : welcome, "success");

    closeModal("loginModal");
    showPage("swaps");
    displayLoggedInUser();
    e.target.reset();
  } catch (err) {
    showCustomAlert("Login failed: " + err.message, "error");
  } finally {
    hideLoadingSpinner();
  }
});

// ‚úÖ Display logged-in user
function displayLoggedInUser() {
  const user = localStorage.getItem("loggedInUser");
  const userDiv = document.getElementById("loggedInUser");

  if (user) {
    // Get the current time of day greeting
    const greeting = getGreeting();
    
    // Insert the logged-in user's name along with the greeting
    userDiv.innerHTML = `
      <div style="font-size: 16px; font-weight: bold; color: #fff;">
        <i class="fas fa-user-circle" style="font-size: 24px; color: #4CAF50;"></i>
        <span style="margin-left: 8px; color: #1E90FF;">${user}</span>
        <span style="margin-left: 10px; font-size: 14px; font-style: italic; color: red;">- ${greeting}</span>
      </div>
      <button onclick="logoutUser()" style="margin-top: 10px; padding: 8px 15px; border:none; border-radius: 5px; background: #FF4D4D; color: white; font-weight: bold; font-size: 14px; cursor: pointer;">
        Logout
      </button>
    `;
  } else {
    userDiv.innerHTML = "";
  }
}


// Function to get greeting message based on the time of day
function getGreeting() {
  const currentHour = new Date().getHours();
  if (currentHour >= 0 && currentHour < 12) {
    return "Good Morning!";
  } else if (currentHour >= 12 && currentHour < 18) {
    return "Good Afternoon!";
  } else {
    return "Good Evening!";
  }
}

// ‚úÖ Logout
function logoutUser() {
  showLoadingSpinner();

  // Get the full name from localStorage
  const fullName = localStorage.getItem("loggedInUser") || "";
  const firstName = fullName.split(" ")[0] || "User"; // Extract first name

  auth.signOut().then(() => {
    localStorage.removeItem("loggedInUser");

    if (typeof unsubscribeSwaps === "function") {
      unsubscribeSwaps();
      unsubscribeSwaps = null;
    }

    const toast = document.getElementById("logoutToast");
    toast.style.display = "block";
    toast.style.backgroundColor = "#4CAF50"; // optional: green for success
    toast.textContent = `${firstName}, you have logged out successfully!`;

    setTimeout(() => {
      hideLoadingSpinner();
      toast.style.display = "none";
      location.reload();
    }, 2500);
  }).catch((error) => {
    hideLoadingSpinner();
    const errorToast = document.getElementById("logoutToast");
    errorToast.textContent = "Error logging out: " + error.message;
    errorToast.style.backgroundColor = "red";
    errorToast.style.display = "block";

    setTimeout(() => errorToast.style.display = "none", 2500);
  });
}

// ‚úÖ Password reset (centralized)
function handlePasswordReset(event, mode) {
  event.preventDefault();

  if (mode === "request") {
    const email = document.getElementById("resetEmail").value;
    showLoadingSpinner();

    firebase.auth().sendPasswordResetEmail(email).then(() => {
      hideLoadingSpinner();
      showCustomAlert("Password reset link sent to your email.", "success");
      hidePasswordReset();
    }).catch((error) => {
      hideLoadingSpinner();
      showCustomAlert(error.message, "error");
    });

  } else if (mode === "confirm") {
    const newPassword = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    if (newPassword !== confirmPassword) {
      showCustomAlert("Passwords do not match!", "error");
      return;
    }

    const oobCode = new URLSearchParams(window.location.search).get("oobCode");
    if (!oobCode) {
      showCustomAlert("Invalid or expired reset link.", "error");
      return;
    }

    showLoadingSpinner();
    firebase.auth().confirmPasswordReset(oobCode, newPassword).then(() => {
      hideLoadingSpinner();
      showCustomAlert("Your password has been reset successfully!", "success");
      window.location.href = "/login";
    }).catch((error) => {
      hideLoadingSpinner();
      showCustomAlert(error.message, "error");
    });
  }
}

// ‚úÖ Show/hide password reset forms
function showPasswordReset() {
  document.getElementById("loginForm").style.display = "none";
  document.getElementById("resetRequestForm").style.display = "block";
}
function hidePasswordReset() {
  document.getElementById("resetRequestForm").style.display = "none";
  document.getElementById("resetPasswordForm").style.display = "none";
  document.getElementById("loginForm").style.display = "block";
}

// ‚úÖ Event listeners for reset forms
document.getElementById("resetRequestForm")?.addEventListener("submit", e => handlePasswordReset(e, "request"));
document.getElementById("resetPasswordForm")?.addEventListener("submit", e => handlePasswordReset(e, "confirm"));

// ‚úÖ Modal helpers
function openModal(id) {
  document.getElementById(id).style.display = "flex";
}
function closeModal(id) {
  document.getElementById(id).style.display = "none";
}

// ‚úÖ Track Firestore listener globally
let unsubscribeSwaps = null;

// ‚úÖ Display user on page load (if logged in)
window.onload = function () {
  auth.onAuthStateChanged((user) => {
    if (user) {
      displayLoggedInUser();

      // ‚úÖ Only load swaps if logged in
      if (!unsubscribeSwaps) {
        unsubscribeSwaps = loadSwaps(user.uid); 
      }
    } else {
      // ‚úÖ Clear UI if logged out
      displayLoggedOutUI();
    }
  });
};

// ‚úÖ Swap Form Submit Handler
document.getElementById("swapForm").addEventListener("submit", async e => {
  e.preventDefault();

  if (!isLoggedIn || !currentUser) {
    showPage("login");
    return alert("You must be logged in.");
  }

  const swapCountyEl = document.getElementById("swapCounty");
  // Get selected counties as an array
  const selectedSwapCounties = Array.from(swapCountyEl.selectedOptions)
                                    .map(opt => opt.value)
                                    .filter(v => v);

  const data = {
    teacherName: document.getElementById("teacherName").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    subjectCombination: document.getElementById("subjectCombination").value.trim(),
    county: document.getElementById("county").value,
    subCounty: document.getElementById("subCounty").value,
    swapCounty: selectedSwapCounties, // array of 0‚Äì3 counties
    swapSubCounty: document.getElementById("swapSubCounty")?.value || "", // Optional
    category: document.getElementById("category").value,
    hardship: document.getElementById("hardship").value
  };

  // Validate required fields except swapCounty (optional)
  const requiredFields = ['teacherName', 'phone', 'subjectCombination', 'county', 'subCounty', 'category', 'hardship'];
  const missing = requiredFields.some(key => !data[key]);

  if (missing) {
    return alert("Please fill all required fields.");
  }

  // Validate max 3 counties for swapCounty
  if (data.swapCounty.length > 3) {
    return alert("You can select a maximum of 3 counties for swap.");
  }

  await saveSwap(data);
});

// ‚úÖ Save Swap and Notify (Dynamic Hot Swap)
async function saveSwap(swap) {
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    // Dynamically check if the swap is HOT (any selected county or hardship)
    const hardshipStatus = (swap.hardship || "").trim().toLowerCase();
    const hotCounties = ["nairobi", "nairobi city", "kiambu county", "kisumu", "nakuru", "mombasa"];
    const selectedCountiesLower = swap.swapCounty.map(c => c.trim().toLowerCase());
    const isHot = (hardshipStatus === "with hardship") || selectedCountiesLower.some(c => hotCounties.includes(c));

    // Save the swap to Firestore
    const swapDoc = await db.collection("teacherSwaps").add({
      ...swap,
      hot: isHot,
      userId: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    showCustomAlert("Swap added successfully!", "success");

    // üîî Admin notification
    await db.collection("adminNotifications").add({
      type: "Swap Added",
      message: `A new swap has been posted by ${swap.teacherName} for ${swap.subjectCombination}${isHot ? " (HOT)" : ""}.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false,
      itemId: swapDoc.id,
    });

    // üîî Global alert to all users
    await db.collection("alerts").add({
      title: "üîÅ New Swap Posted",
      message: `${swap.teacherName} just posted a swap for ${swap.subjectCombination}${isHot ? " (HOT)" : ""}.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null
    });

    // Reset form and reload swaps
    document.getElementById("swapForm").reset();
    loadSwaps();

  } catch (err) {
    console.error("Error saving swap:", err);
    showCustomAlert("Error saving swap: " + err.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}


let swapUnsubscribe;

// Load last seen timestamp from localStorage
let lastSeenSwapTimestamp = localStorage.getItem("lastSeenSwapTimestamp")
  ? new Date(localStorage.getItem("lastSeenSwapTimestamp"))
  : null;

async function loadSwaps() {
  if (!auth.currentUser) {
    console.warn("Skipping loadSwaps: user is not logged in.");
    return;
  }

  const container = document.querySelector("#swapCardContainer");
  container.innerHTML = "";
  trendingBoostedSwaps = [];

  const spinner = document.getElementById("loadingSpinner");
  if (spinner) {
    spinner.style.display = "flex";
    setTimeout(() => {
      if (spinner && spinner.style.display !== "none") spinner.style.display = "none";
    }, 8000);
  }

  const swapBadge = document.getElementById("swapBadge");
  let newSwapCount = 0;

  try {
    const swapRef = db.collection("teacherSwaps").orderBy("timestamp", "desc");

    if (swapUnsubscribe) swapUnsubscribe();

    swapUnsubscribe = swapRef.onSnapshot(
      snapshot => {
        if (!auth.currentUser) {
          if (swapUnsubscribe) swapUnsubscribe();
          swapUnsubscribe = null;
          if (spinner) spinner.style.display = "none";
          return;
        }

        container.innerHTML = "";
        trendingBoostedSwaps = [];
        newSwapCount = 0;

        if (snapshot.empty) {
          container.innerHTML = `<div style="text-align:center; padding:20px; color:#d32f2f; font-weight:bold;">üíî No swap requests found</div>`;
          if (spinner) spinner.style.display = "none";
          if (swapBadge) swapBadge.style.display = "none";
          lastSeenSwapTimestamp = null;
          return;
        }

        const now = new Date();
        const boostedSwaps = [];
        const normalSwaps = [];
        const hasPaid = localStorage.getItem("paidForSwaps") === "yes";

        snapshot.docs.forEach(doc => {
          const s = doc.data();
          const id = doc.id;
          const boostExpiry = s.boostExpiry?.toDate?.();
          const isBoosted = s.boosted && boostExpiry && boostExpiry > now;

          if (s.boosted && (!boostExpiry || boostExpiry <= now)) {
            db.collection("teacherSwaps").doc(id).update({ boosted: false, boostExpiry: null });
          }

          const swap = { id, ...s, isBoosted, boostExpiry };
          (isBoosted ? boostedSwaps : normalSwaps).push(swap);

          if (isBoosted) {
            trendingBoostedSwaps.push({
              title: s.teacherName,
              description: `${s.county} ‚û°Ô∏è ${s.swapCounty} (${s.subjectCombination})`,
              phone: s.phone,
              type: "swap"
            });
          }

          if (!lastSeenSwapTimestamp || s.timestamp?.toDate() > lastSeenSwapTimestamp) {
            newSwapCount++;
          }
        });

        const orderedSwaps = [...boostedSwaps, ...normalSwaps];

        orderedSwaps.forEach(s => {
          const isPoster = currentUser && s.userId === currentUser.uid;
          const isAdminUser = isAdmin === true;

          const hardshipLower = (s.hardship || "").trim().toLowerCase();
          const isHotSwap = (
            hardshipLower === "with hardship" ||
            ["nairobi city", "nairobi", "kiambu", "kiambu county", "kisumu", "nakuru", "mombasa"]
              .includes((s.county || "").trim().toLowerCase())
          );

          const hasPaidForHot = localStorage.getItem("paidForHotSwaps") === "yes";
          const blur = isHotSwap ? (!hasPaidForHot && !isPoster && !isAdminUser) : (!hasPaid && !isPoster && !isAdminUser);

          const closedStatusBadge = s.isClosed ? `<span style="color:red; font-weight:bold; margin-left:6px;">(Closed)</span>` : "";

          const vipBtn = isAdminUser && (vipHotCounties.includes(s.county) || vipHotCounties.includes(s.swapCounty)) && !s.isVIP
            ? `<button onclick="markAsVIPSwap('${s.id}')" style="background:#6a1b9a;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">üî• Sell VIP</button>`
            : s.isVIP ? `<span style="color:crimson;font-weight:bold;font-size:13px;">üî• VIP</span>` : "-";

          const showVerifiedBadge = s.verified ? `<span class="verified-badge"><i class="fas fa-check-circle"></i></span>` : "";

          let verifyBtnHTML = "";
          if (!s.verified) {
            if (isPoster && !isAdminUser) {
              verifyBtnHTML = `<button onclick="showPaymentModalFor('swapVerification', 250, '${s.id}', '${s.teacherName || ''}')" style="margin-left:6px;background:#4CAF50;color:white;padding:4px 8px;border:none;border-radius:6px;font-size:12px;cursor:pointer;">‚úÖ Get Verified ‚Äì Ksh 250</button>`;
            } else if (isAdminUser) {
              verifyBtnHTML = `<button onclick="adminVerifyItem('swap', '${s.id}')" style="margin-left:6px;background:#2196F3;color:white;padding:4px 8px;border:none;border-radius:6px;font-size:12px;cursor:pointer;">üõ°Ô∏è Verify Now (Admin)</button>`;
            }
          }

          const showVIPBadge = s.isVIP ? `<span class="vip-badge">üî• VIP</span>` : "";

          // ‚úÖ Always render a boosted badge placeholder
          const boostedDaysLeft = s.isBoosted && s.boostExpiry
            ? Math.ceil((s.boostExpiry - now) / (1000 * 60 * 60 * 24))
            : 0;
          const showBoostedBadge = s.isBoosted && boostedDaysLeft > 0
            ? `<span id="boosted-badge-${s.id}" class="boosted-badge" 
                style="color: red; font-weight: bold; font-size: 14px; background-color: yellow; padding: 4px; border-radius: 6px;">
                üî• Boosted (${boostedDaysLeft} day${boostedDaysLeft !== 1 ? 's' : ''} left)
              </span>`
            : `<span id="boosted-badge-${s.id}"></span>`;

          // === Integrated Section Starts Here ===
          const hotBadge = isHotSwap ? `<span class="hot-badge" style="color:white;background:red;padding:4px;border-radius:4px;font-size:12px;margin-left:6px;">HOT</span>` : "";

          const contactHTML = `<div style="margin:4px 0;">üìû <a href="tel:${s.phone}" style="color:green;">${s.phone}</a><br>üí¨ <a href="https://wa.me/254${s.phone.replace(/^0/, '')}" target="_blank" style="color:#25D366;">WhatsApp</a></div>`;

          const blurredContactHTML = `<div style="margin:6px 0; text-align:left;"><span style="color:crimson; font-size:13px; font-weight:bold;">üîí Contacts locked. Pay Ksh ${isHotSwap ? 500 : 250} to unlock</span><br><button onclick="showPaymentModalFor('swap', ${isHotSwap ? 500 : 250}, '${s.id}', 'Unlock Contacts ')" style="margin-top:4px;background:crimson;color:white;border:none;padding:5px 10px;border-radius:4px;">üí≥ Pay Now</button></div>`;

          const closedContactHTML = `<div style="margin:6px 0; text-align:left; color:red; font-weight:bold;">üö´ This swap is closed</div>`;

          const followerCount = s.followerCount || (s.followers ? s.followers.length : 0);

          const rating = (typeof s.rating === "number") ? s.rating : 0;
          const ratingStars = [...Array(5)].map((_, index) => {
            const isFilled = index < rating;
            const starColor = isFilled ? '#FFD700' : '#ccc';
            return `<i class="fas fa-star" style="color: ${starColor}; cursor: pointer;" data-id="${s.id}" data-rating="${index + 1}"></i>`;
          }).join('');

          const card = document.createElement("div");
          card.className = "swap-card";
          card.style = `background:#f9f9f9;border-radius:8px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,0.1);margin:8px;width:280px;display:inline-block;vertical-align:top;position:relative;`;
          card.setAttribute("data-category", s.category || "-");
          card.setAttribute("data-swapcounty", s.swapCounty || "-");
          card.setAttribute("data-swapsubcounty", s.swapSubCounty || "-");
          card.setAttribute("data-hardship", s.hardship || "-");
          card.setAttribute("data-subject", (s.subjectCombination || "-").toLowerCase());

          const actionButtonHTML = `
            <div class="action-button-container">
              <button onclick="toggleActionButtons('${s.id}')" class="action-button">Actions</button>
              <div class="action-buttons" id="action-buttons-${s.id}" style="display:none;">
                ${isPoster || isAdminUser ? `
                  <button onclick="deleteSwap('${s.id}')" style="background:#f44336;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">üóëÔ∏è Delete</button>
                  <button onclick="sendSwapInterest('${s.id}', '${s.teacherName}')" style="background:#2196f3;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">üíå Show Interest</button>
                  <button onclick="followSwap('${s.id}')" style="background:#e91e63;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">üßëü§ùüßë Follow Swap</button>
                  <button onclick="toggleSwapStatus('${s.id}')" style="background:#9e9e9e;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">${s.isClosed ? "‚ôªÔ∏è Reopen Swap" : "üö´ Mark as Closed"}</button>
                  <button onclick="boostSwap('${s.id}')" style="background:#ff9800;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">üöÄ Boost Swap ${isAdminUser ? "(Free)" : "(Ksh 250)"}</button>` : ""}
                ${isAdminUser ? `<button onclick="adminVerifyItem('swap', '${s.id}')" style="background:#4caf50;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">üõ°Ô∏è Verify Now (Admin)</button>` : ""}
                ${(!isPoster && !isAdminUser) ? `
                  <button onclick="sendSwapInterest('${s.id}', '${s.teacherName}')" style="background:#2196f3;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">üíå Show Interest</button>
                  <button onclick="followSwap('${s.id}')" style="background:#e91e63;color:white;padding:6px 12px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">üßëü§ùüßë Follow Swap</button>` : ""}
              </div>
            </div>`;

          let swapCountiesDisplay = "-";
          if (s.swapCounty) {
            if (Array.isArray(s.swapCounty)) swapCountiesDisplay = s.swapCounty.join(", ");
            else if (typeof s.swapCounty === "string") swapCountiesDisplay = s.swapCounty;
          }

          card.innerHTML = `
            <h3 style="margin:0; color:#1a237e;">${s.teacherName} ${hotBadge} ${showVerifiedBadge} ${verifyBtnHTML} ${closedStatusBadge}</h3>
            <div style="margin:4px 0;">${showVIPBadge} ${showBoostedBadge}</div>
            <p style="margin:4px 0;color:#3f51b5;"><strong>From:</strong> ${s.county} / ${s.subCounty || "-"}</p>
            <p style="margin:4px 0;color:#ef6c00;"><strong>Wants:</strong> ${swapCountiesDisplay} / ${s.swapSubCounty || "-"}</p>
            <p style="margin:4px 0;color:#6a1b9a;"><strong>Subjects:</strong> ${s.subjectCombination || '-'}</p>
            <p style="margin:4px 0;color:#3e2723;"><strong>Category:</strong> ${s.category || '-'}</p>
            <p style="margin:4px 0;color:#d81b60;"><strong>Hardship:</strong> ${s.hardship || '-'}</p>
            <div style="margin-top:6px;">${s.isClosed && !isPoster && !isAdminUser ? closedContactHTML : (blur ? blurredContactHTML : contactHTML)}</div>
           <div style="margin-top:6px;">
  <strong>Rating: </strong>
  <span id="rating-stars-${s.id}" style="font-size:16px;">${ratingStars}</span>
  <span style="color:red; font-weight:bold; margin-left:4px;">
    (${rating}/5)
  </span>
</div>
 <p id="follower-count-${s.id}" style="font-size:0.9em; color:#ff4081;" onclick="showFollowers('${s.id}')">${followerCount} people following</p>
            ${actionButtonHTML}`;

          container.appendChild(card);

          const stars = document.querySelectorAll(`#rating-stars-${s.id} .fa-star`);
          stars.forEach(star => {
            star.addEventListener("click", async function () {
              const newRating = parseInt(star.getAttribute("data-rating"));
              try {
                await db.collection("teacherSwaps").doc(s.id).update({ rating: newRating });
                const allStars = document.querySelectorAll(`#rating-stars-${s.id} .fa-star`);
                allStars.forEach((st, idx) => st.style.color = idx < newRating ? "#FFD700" : "#ccc");
                document.querySelector(`#rating-stars-${s.id}`).nextElementSibling.textContent = `(${newRating}/5)`;
              } catch (err) { console.error("Error updating rating:", err); }
            });
          });

        });

        try { renderTrendingSectionFromSwapsOnly(); } catch(e){ console.error(e); }

       // Update badge
        if (swapBadge) {
          if (newSwapCount > 0) {
            swapBadge.textContent = newSwapCount;
            swapBadge.style.display = "inline-block";
          } else swapBadge.style.display = "none";
        }

        // persist last seen timestamp
        const latestSwap = snapshot.docs[0]?.data()?.timestamp?.toDate();
        if (latestSwap) {
          lastSeenSwapTimestamp = latestSwap;
          localStorage.setItem("lastSeenSwapTimestamp", lastSeenSwapTimestamp.toISOString());
        }

        if (spinner) spinner.style.display = "none";

        // ‚úÖ Alert user when they scroll to bottom
        window.onscroll = function () {
          if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
            showCustomAlert("üì¢ You have reached the end of the list.", "info", true);
          }
        };

      },
      error => {
        console.error("Firestore listener error:", error);
        if (auth.currentUser) showCustomAlert("Error loading swaps: " + error.message, "error");
        if (spinner) spinner.style.display = "none";
      }
    );

  } catch (err) {
    console.error("Error loading swaps:", err);
    if (auth.currentUser) showCustomAlert("Error loading swaps: " + err.message, "error");
    if (spinner) spinner.style.display = "none";
  }
}

// ‚úÖ Reset swap badge
function resetSwapBadge() {
  const swapBadge = document.getElementById("swapBadge");
  if (swapBadge) {
    swapBadge.style.display = "none";
    swapBadge.textContent = "0";
  }
  lastSeenSwapTimestamp = new Date();
  localStorage.setItem("lastSeenSwapTimestamp", lastSeenSwapTimestamp.toISOString());
}

// ‚úÖ Instantly update boosted badge
function updateBoostedBadge(swapId, days = 7) {
  const badgeEl = document.getElementById(`boosted-badge-${swapId}`);
  if (badgeEl) {
    badgeEl.innerHTML = `üî• Boosted (${days} day${days !== 1 ? 's' : ''} left)`;
    badgeEl.style.cssText = "color: red; font-weight: bold; font-size: 14px; background-color: yellow; padding: 4px; border-radius: 6px;";
  }
}





// Open and close modal helpers
function openTriangularModal(contentHTML) {
  document.getElementById("triangularSwapModalContent").innerHTML = contentHTML;
  document.getElementById("triangularSwapModal").style.display = "flex";
}
let lockedTeacherPhones = [];  // store all blurred phones
let lockedTeacherIds = [];     // store teacher doc ids for payment reference
let triangularSwaps = [];      // store all found swap objects
let currentSwapIndex = 0;      // track which swap is currently displayed

// Close modal
document.getElementById("closeTriangularSwapModal").addEventListener("click", () => {
  document.getElementById("triangularSwapModal").style.display = "none";
});

// Show floating alert inside modal
function showModalAlert(message, color = "#ff9800") {
  // Remove any existing alert
  const existingAlert = document.getElementById("modalSwapAlert");
  if (existingAlert) existingAlert.remove();

  const alertDiv = document.createElement("div");
  alertDiv.id = "modalSwapAlert";
  alertDiv.style.cssText = `
    position:absolute;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    background:${color};
    color:white;
    padding:8px 12px;
    border-radius:6px;
    font-weight:bold;
    z-index:9999; /* Ensure this alert stays on top */
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
  `;
  alertDiv.innerText = message;

  document.querySelector("#triangularSwapModal > div").appendChild(alertDiv);

  setTimeout(() => alertDiv.remove(), 2500);
}

// Render the currently selected swap
function renderSwap(index) {
  if (!triangularSwaps.length) return;
  const swap = triangularSwaps[index];
  const container = document.getElementById("triangularSwapModalContent");

  container.innerHTML = `
    <div style="background:#e3f2fd;padding:10px;margin:8px 0;border-radius:6px;">
      <p>üë©‚Äçüè´ <strong>${swap.a.teacherName}</strong><br>From: ${swap.a.county} ‚û° Wants: ${swap.a.swapCounty}<br>üìû ${maskPhone(swap.a.phone)}</p>
      <hr>
      <p>üë©‚Äçüè´ <strong>${swap.b.teacherName}</strong><br>From: ${swap.b.county} ‚û° Wants: ${swap.b.swapCounty}<br>üìû ${maskPhone(swap.b.phone)}</p>
      <hr>
      <p>üë©‚Äçüè´ <strong>${swap.c.teacherName}</strong><br>From: ${swap.c.county} ‚û° Wants: ${swap.c.swapCounty}<br>üìû ${maskPhone(swap.c.phone)}</p>
    </div>
    <p style="text-align:center;font-weight:bold;">Swap ${index + 1} of ${triangularSwaps.length}</p>
  `;

  // Set locked phones & IDs for this swap
  lockedTeacherPhones = [swap.a.phone, swap.b.phone, swap.c.phone];
  lockedTeacherIds = [swap.a.id, swap.b.id, swap.c.id];

  document.getElementById("triangularSwapPaywall").style.display = "block";
  document.getElementById("triangularSwapModalSpinner").style.display = "none";
}

// Open modal and show the first swap
function openTriangularModalWithSwaps(swaps) {
  triangularSwaps = swaps;
  currentSwapIndex = 0;
  document.getElementById("triangularSwapModal").style.display = "flex";
  renderSwap(currentSwapIndex);
}

// Navigation buttons
document.getElementById("nextSwapBtn").addEventListener("click", () => {
  if (currentSwapIndex < triangularSwaps.length - 1) {
    currentSwapIndex++;
    renderSwap(currentSwapIndex);
  } else {
    showModalAlert("‚ö†Ô∏è No more swaps!");
  }
});

// Previous Swap Button
document.getElementById("prevSwapBtn").addEventListener("click", () => {
  if (currentSwapIndex > 0) {
    currentSwapIndex--;
    renderSwap(currentSwapIndex);
  } else {
    showModalAlert("‚ö†Ô∏è No previous swap!");
  }
});

// Search swaps
document.getElementById("findTriangularSwapBtn").addEventListener("click", async () => {
  const countyInputs = [
    document.getElementById("countyA").value.trim().toLowerCase(),
    document.getElementById("countyB").value.trim().toLowerCase(),
    document.getElementById("countyC").value.trim().toLowerCase()
  ].filter(Boolean);

  // Check if all 3 counties are entered
  if (countyInputs.length < 3) {
    document.getElementById("triangularSwapModal").style.display = "flex";
    document.getElementById("triangularSwapNotice").style.display = "block";
    document.getElementById("triangularSwapNotice").innerHTML = `<p style="color:red;">Please enter all 3 counties.</p>`;
    return;
  }

  try {
    // ‚úÖ Show spinner while searching
    document.getElementById("triangularSwapModal").style.display = "flex";
    document.getElementById("triangularSwapNotice").style.display = "block";
    document.getElementById("triangularSwapNotice").innerHTML = `
      <div style="display:flex; align-items:center; gap:10px; color:blue;">
        <div class="spinner" style="
          border: 4px solid #f3f3f3;
          border-top: 4px solid blue;
          border-radius: 50%;
          width: 20px;
          height: 20px;
          animation: spin 1s linear infinite;
        "></div>
        <span>Searching triangular swaps...</span>
      </div>
    `;

    const snapshot = await db.collection("teacherSwaps").get();
    const swaps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    const normalizedInput = countyInputs.sort();
    lockedTeacherPhones = [];
    lockedTeacherIds = [];
    const displayedCombos = new Set();
    const foundSwaps = [];

    // Search through all swaps to find matches
    swaps.forEach(a => {
      swaps.forEach(b => {
        swaps.forEach(c => {
          const swapCounties = [a.county, b.county, c.county].map(x => (x || "").toLowerCase()).sort();

          if (
            JSON.stringify(swapCounties) === JSON.stringify(normalizedInput) &&
            normalizeCounty(a.swapCounty) === (b.county || "").toLowerCase() &&
            normalizeCounty(b.swapCounty) === (c.county || "").toLowerCase() &&
            normalizeCounty(c.swapCounty) === (a.county || "").toLowerCase()
          ) {
            const comboKey = [a.id, b.id, c.id].sort().join("-");
            if (!displayedCombos.has(comboKey)) {
              displayedCombos.add(comboKey);
              foundSwaps.push({ a, b, c });
            }
          }
        });
      });
    });

    // ‚úÖ Hide spinner after search
    document.getElementById("triangularSwapNotice").style.display = "none";

    // If swaps are found, display them, otherwise show a no swap message
    if (foundSwaps.length) {
      openTriangularModalWithSwaps(foundSwaps);
    } else {
      document.getElementById("triangularSwapModalContent").innerHTML = `<p style="color:orange;">No exact triangular swap found.</p>`;
      document.getElementById("triangularSwapPaywall").style.display = "none";
    }

  } catch (err) {
    console.error("Error:", err);
    document.getElementById("triangularSwapModalContent").innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
    document.getElementById("triangularSwapPaywall").style.display = "none";
    document.getElementById("triangularSwapNotice").style.display = "none";
  }
});
// Function to show MPESA payment modal above the swap modal
function showPaymentModalFor(type, amount, teacherId, description) {
  const mpesaModal = document.getElementById("mpesaPaymentModal");

  // Adjust z-index of MPESA modal to ensure it's on top
  mpesaModal.style.zIndex = "10000"; // Ensure it's above the triangular swap modal
  document.getElementById("triangularSwapModal").style.zIndex = "999"; // Ensure swap modal is below

  // Show the MPESA modal
  mpesaModal.style.display = "flex";
}

function maskPhone(phone) {
  return phone ? phone.slice(0, 2) + "XX XXX" + phone.slice(-3) : "";
}

// Unlock button uses MPESA modal
document.getElementById("unlockTriangularContactBtn").addEventListener("click", () => {
  if (!lockedTeacherIds.length || !lockedTeacherPhones.length) return;
  showPaymentModalFor("unlock", 500, lockedTeacherIds[0], "Triangular Swap Contact");
});

// Hook into payment success to reveal all phones in current swap
const originalHandlePaymentSuccess = handlePaymentSuccess;
handlePaymentSuccess = async function (type, itemId, itemName, userId) {
  await originalHandlePaymentSuccess(type, itemId, itemName, userId);

  if (type === "unlock" && lockedTeacherIds.includes(itemId)) {
    document.querySelectorAll("#triangularSwapModalContent p").forEach(p => {
      lockedTeacherPhones.forEach(phone => {
        const masked = maskPhone(phone);
        if (p.innerHTML.includes(masked)) {
          p.innerHTML = p.innerHTML.replace(masked, phone);
        }
      });
    });
    document.getElementById("triangularSwapPaywall").style.display = "none";
    showModalAlert("‚úÖ All contacts unlocked!", "#4caf50");
  }
};

function toggleActionButtons(swapId) {
  const actionButtons = document.getElementById(`action-buttons-${swapId}`);
  actionButtons.style.display = actionButtons.style.display === "none" ? "block" : "none";
}

function normalizeCounty(val) {
  if (Array.isArray(val)) {
    return val[0] ? val[0].toLowerCase() : "";
  }
  return (val || "").toLowerCase();
}


async function deleteSwap(swapId) {
  // Show spinner when the deletion process starts
  document.getElementById('loadingSpinner').style.display = 'flex';

  // Show confirmation box
  const existingBox = document.getElementById("inlineSwapConfirmBox");
  if (existingBox) existingBox.remove();

  const box = document.createElement("div");
  box.id = "inlineSwapConfirmBox";
  box.style.cssText = `
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    padding: 18px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    z-index: 9999;
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    max-width: 90%;
    width: 320px;
    animation: fadeIn 0.3s ease;
  `;

  box.innerHTML = `
    <p style="margin: 0 0 16px; font-size: 15px; color: #333;">
      Are you sure you want to delete this swap?
    </p>
    <div style="display: flex; justify-content: center; gap: 10px;">
      <button id="swapConfirmYesBtn" style="background: #d32f2f; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">üóëÔ∏è Yes</button>
      <button id="swapConfirmNoBtn" style="background: #607d8b; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">Cancel</button>
    </div>
  `;

  document.body.appendChild(box);

  // Handle button actions
  document.getElementById("swapConfirmYesBtn").onclick = async () => {
    // Start deleting the swap
    box.remove();
    try {
      // Wait for the deletion to complete
      await db.collection("teacherSwaps").doc(swapId).delete();
      showCustomAlert("‚úÖ Swap deleted successfully.", "success");

      // Reload swaps after deletion
      loadSwaps();
    } catch (err) {
      console.error("Error deleting swap:", err);
      showCustomAlert("‚ùå Failed to delete swap: " + err.message, "error");
    } finally {
      // Hide the spinner after operation completes
      document.getElementById('loadingSpinner').style.display = 'none';
    }
  };

  document.getElementById("swapConfirmNoBtn").onclick = () => {
    box.remove(); // Close the confirmation box if canceled
    showCustomAlert("‚ùé Deletion canceled.", "info");
    // Hide the spinner if user cancels
    document.getElementById('loadingSpinner').style.display = 'none';
  };
}

// ‚úÖ Admin instant verification handler 
function adminVerifyItem(type, itemId) {
  if (type === "swap") {
    db.collection("teacherSwaps").doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("‚úÖ Swap verified by Admin!", "success");
    loadSwaps();
  } 
  else if (type === "soulmate") {
    soulmateRef.doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("‚úÖ Soulmate verified by Admin!", "success");
    loadSoulmates();
  } 
  else if (type === "service") {
    servicesRef.doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("‚úÖ Service verified by Admin!", "success");
    loadServices();
  } 
  else if (type === "market") {
    marketRef.doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("‚úÖ Market item verified by Admin!", "success");
    loadMarketItems();
  }
  else if (type === "job") { // ‚úÖ Added BOM job verification
    db.collection("bomJobs").doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("‚úÖ Job verified by Admin!", "success");
    if (typeof loadBOMJobs === "function") {
      loadBOMJobs();
    }
  }
}

async function showFollowers(swapId) {
  const swapRef = db.collection("teacherSwaps").doc(swapId);
  const swapDoc = await swapRef.get();

  if (!swapDoc.exists) {
    console.log("No such swap!");
    return;
  }

  const followers = swapDoc.data().followers || [];
  const followersList = document.getElementById('followersList');

  if (followers.length === 0) {
    // If no followers, display a message
    followersList.innerHTML = "<li>No followers for now.</li>";
  } else {
    // If there are followers, list their names
    const followerNames = followers.map(f => {
      const firstName = f.email ? f.email.split('@')[0] : 'Anonymous';
      return `<li style="padding: 5px; border-bottom: 1px solid #eee;">${firstName}</li>`;
    }).join("");
    followersList.innerHTML = followerNames;
  }

  // Show the modal
  document.getElementById('followersModal').style.display = 'flex';
}

// Function to close the modal
function closeFollowersModal() {
  document.getElementById('followersModal').style.display = 'none';
}


// Function to close the modal
function closeFollowersModal() {
  document.getElementById('followersModal').style.display = 'none';
}


// Function to follow a swap
async function followSwap(swapId) {
  const currentUser = firebase.auth().currentUser;
  if (!currentUser) {
    showCustomAlert("Please log in to follow this swap.", "error");
    return;
  }

  // Show the loading spinner while following the swap
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  const swapRef = db.collection("teacherSwaps").doc(swapId);
  const swapDoc = await swapRef.get();
  if (!swapDoc.exists) {
    showCustomAlert("Swap not found.", "error");
    if (spinner) spinner.style.display = "none";
    return;
  }

  const swapData = swapDoc.data();
  let followers = swapData.followers || [];
  let followerCount = swapData.followerCount || followers.length; // Use stored followerCount if exists

  // Check if the user is already following
  if (!followers.some(f => f.uid === currentUser.uid)) {
    const user = {
      uid: currentUser.uid,
      email: currentUser.email,
    };

    try {
      // Add user to followers list
      await swapRef.update({
        followers: firebase.firestore.FieldValue.arrayUnion(user)
      });

      // Determine increment
      let increment = 1;
      if (isAdmin === true) { // Admin adds random 200‚Äì500
        increment = Math.floor(Math.random() * (500 - 200 + 1)) + 200;
      }

      // Persist follower count increment in Firestore
      await swapRef.update({
        followerCount: firebase.firestore.FieldValue.increment(increment)
      });

      // Fetch updated follower count to ensure UI matches Firestore
      const updatedDoc = await swapRef.get();
      const updatedFollowerCount = updatedDoc.data().followerCount || followers.length + increment;

      // Update follower count in UI
      const countEl = document.getElementById(`follower-count-${swapId}`);
      if (countEl) {
        countEl.innerText = `${updatedFollowerCount} people following`;
      }

      // Send admin notification
      await sendFollowAdminNotification(swapId, currentUser);

      // Notify the swap poster (if not same user)
      const posterId = swapData.postedBy;
      if (posterId && posterId !== currentUser.uid) {
        await db.collection("alerts").add({
          title: "üëÄ New Follower",
          message: `${currentUser.email || "Someone"} followed your swap: ${swapData.name || "Unnamed Swap"}`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          targetUserId: posterId
        });
      }

      // Show center screen success alert
      showCustomAlert("‚úÖ You are now following this swap.", "success");

    } catch (error) {
      console.error("Error following swap:", error);
      showCustomAlert("‚ùå Failed to follow swap: " + error.message, "error");
    }
  } else {
    showCustomAlert("‚ö† You are already following this swap.", "warning");
  }

  // Hide the loading spinner once the operation is complete
  if (spinner) spinner.style.display = "none";
}

// Function to send an admin notification when a user follows a swap
async function sendFollowAdminNotification(swapId, currentUser) {
  const swapRef = db.collection("teacherSwaps").doc(swapId);
  const swapDoc = await swapRef.get();

  if (!swapDoc.exists) {
    console.error("Swap not found!");
    return;
  }

  const swapData = swapDoc.data();
  const swapName = swapData.name || "Swap";

  const notifRef = db.collection("adminNotifications").doc();
  await notifRef.set({
    type: "Swap Follow",
    swapId: swapId,
    swapName: swapName,
    userId: currentUser.uid,
    userEmail: currentUser.email,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `üìç User ${currentUser.email} has followed swap "${swapName}".`,
  });

  console.log("Admin notification sent for swap follow.");
}

async function toggleSwapStatus(swapId) {
  const spinner = document.getElementById('loadingSpinner'); // Assuming you have a spinner element with this ID
  spinner.style.display = 'block'; // Show spinner
  
  try {
    const swapDoc = await db.collection("teacherSwaps").doc(swapId).get();
    const swapData = swapDoc.data();

    if (!swapData) {
      showCustomAlert("‚ùå Swap not found.", "error");
      spinner.style.display = 'none'; // Hide spinner
      return;
    }

    const newStatus = !swapData.isClosed;

    await db.collection("teacherSwaps").doc(swapId).update({
      isClosed: newStatus
    });

    if (newStatus) {
      showCustomAlert("‚úÖ Swap marked as closed.", "success");
      sendAdminNotification(
        "Swap Closed",
        swapData.teacherName,
        `Swap request for ${swapData.teacherName} has been closed.`
      );
    } else {
      showCustomAlert("‚ôªÔ∏è Swap reopened successfully.", "success");
      sendAdminNotification(
        "Swap Reopened",
        swapData.teacherName,
        `Swap request for ${swapData.teacherName} has been reopened.`
      );
    }

    loadSwaps(); // Refresh view
  } catch (error) {
    console.error("‚ùå Error updating swap status:", error);
    showCustomAlert("‚ùå Failed to update swap: " + error.message, "error");
  } finally {
    spinner.style.display = 'none'; // Hide spinner in case of success or error
  }
}



// Function to send an admin notification when a swap is closed
async function sendSwapClosedAdminNotification(swapId) {
  const swapRef = db.collection("teacherSwaps").doc(swapId);
  const swapDoc = await swapRef.get();

  if (!swapDoc.exists) {
    console.error("Swap not found!");
    return;
  }

  const swapData = swapDoc.data();
  const swapName = swapData.name || "Swap";

  const notifRef = db.collection("adminNotifications").doc();
  await notifRef.set({
    type: "Swap Closure",
    swapId: swapId,
    swapName: swapName,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `üîí Swap "${swapName}" (ID: ${swapId}) has been closed.`,
  });

  console.log("Admin notification sent for swap closure.");
}


// Function to boost the swap 
async function boostSwap(swapId) {
  const currentUser = firebase.auth().currentUser;

  if (!currentUser) {
    showCustomAlert("You must be logged in to boost swaps.", "error");
    return;
  }

  const isAdminUser = isAdmin === true;
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    const boostExpiry = firebase.firestore.Timestamp.fromDate(
      new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
    );

    if (isAdminUser) {
      await updateSwapBoostStatus(swapId, true, boostExpiry);
      updateBoostedBadge(swapId, boostExpiry.toDate());
      showCustomAlert("‚úÖ The swap has been boosted for free!", "success");
      await sendBoostAdminNotification(swapId, currentUser.uid, "admin");
    } else {
      showPaymentModalFor("swapBoost", 250, swapId, "Boost Swap", async () => {
        await updateSwapBoostStatus(swapId, true, boostExpiry);
        updateBoostedBadge(swapId, boostExpiry.toDate());
        showCustomAlert("üöÄ Your swap has been boosted for 7 days!", "success");
        await sendBoostAdminNotification(swapId, currentUser.uid, "user");
      });
    }
  } catch (error) {
    console.error("‚ùå Error boosting swap:", error);
    showCustomAlert("‚ùå Failed to boost swap: " + error.message, "error");
  } finally {
    document.getElementById("loadingSpinner").style.display = "none";
  }
}


// Function to update the swap boost status in Firestore
async function updateSwapBoostStatus(swapId, isBoosted, boostExpiry) {
  const swapRef = db.collection("teacherSwaps").doc(swapId);
  await swapRef.update({
    boosted: isBoosted,
    boostExpiry: isBoosted ? boostExpiry : null,
    boostTimestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  const boostButton = document.getElementById(`boostSwapBtn-${swapId}`);
  if (boostButton) {
    boostButton.innerText = isBoosted ? "üöÄ Boosted" : "üöÄ Boost Swap";
    boostButton.disabled = isBoosted;
  }
}


// Function to send an admin notification when a swap is boosted
async function sendBoostAdminNotification(swapId, userId, userType) {
  const swapRef = db.collection("teacherSwaps").doc(swapId);
  const swapDoc = await swapRef.get();

  if (!swapDoc.exists) {
    console.error("Swap not found!");
    return;
  }

  const swapData = swapDoc.data();
  const swapName = swapData.teacherName || swapData.name || "Swap";

  const notifRef = db.collection("adminNotifications").doc();
  await notifRef.set({
    type: "Swap Boost",
    swapId: swapId,
    userId: userId,
    swapName: swapName,
    userType: userType,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `üöÄ ${userType === "admin" ? "Admin" : "User"} boosted the swap "${swapName}" (ID: ${swapId}).`
  });
}


// ‚úÖ Helper: Instantly update Boosted badge in the UI
function updateBoostedBadge(swapId, boostExpiryDate) {
  const card = document.querySelector(`#swapCardContainer .swap-card[data-id="${swapId}"]`);
  if (card) {
    const now = new Date();
    const diffDays = Math.max(1, Math.ceil((boostExpiryDate - now) / (1000 * 60 * 60 * 24)));

    let badgeContainer = card.querySelector(".boosted-badge");
    if (!badgeContainer) {
      const badgeHTML = `<span class="boosted-badge" style="color: red; font-weight: bold; font-size: 14px; background-color: yellow; padding: 4px; border-radius: 6px; margin-left:6px;">üî• Boosted (${diffDays} days left)</span>`;
      const header = card.querySelector("h3");
      if (header) header.insertAdjacentHTML("afterend", `<div style="margin:4px 0;">${badgeHTML}</div>`);
    } else {
      badgeContainer.textContent = `üî• Boosted (${diffDays} days left)`;
    }

    // ‚úÖ Move boosted card to top instantly
    const container = document.getElementById("swapCardContainer");
    if (container) {
      container.prepend(card);
    }

    // ‚úÖ Auto-remove badge when expired
    const interval = setInterval(() => {
      const now = new Date();
      if (now >= boostExpiryDate) {
        const badge = card.querySelector(".boosted-badge");
        if (badge) badge.remove();

        db.collection("teacherSwaps").doc(swapId).update({
          boosted: false,
          boostExpiry: null
        });

        clearInterval(interval);
      } else {
        const daysLeft = Math.max(1, Math.ceil((boostExpiryDate - now) / (1000 * 60 * 60 * 24)));
        const badge = card.querySelector(".boosted-badge");
        if (badge) badge.textContent = `üî• Boosted (${daysLeft} days left)`;
      }
    }, 1000 * 60 * 60); // check hourly
  }
}


// ‚úÖ Auto-refresh all boosted badges daily
setInterval(() => {
  document.querySelectorAll("#swapCardContainer .swap-card").forEach(card => {
    const badge = card.querySelector(".boosted-badge");
    if (badge) {
      const swapId = card.getAttribute("data-id");
      db.collection("teacherSwaps").doc(swapId).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          if (data.boosted && data.boostExpiry?.toDate) {
            updateBoostedBadge(swapId, data.boostExpiry.toDate());
          }
        }
      }).catch(err => console.error("Error refreshing badge:", err));
    }
  });
}, 24 * 60 * 60 * 1000); // every 24 hours




async function sendSwapInterest(swapId, teacherName) {
  try {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      showCustomAlert("You must be logged in to express interest.", "error");
      return;
    }

    // Show the loading spinner while the interest is being sent
    document.getElementById("loadingSpinner").style.display = "flex";

    // Save the interest
    await db.collection("swapInterests").add({
      swapId,
      teacherName,
      interestedBy: currentUser.uid,
      interestedByName: currentUser.displayName || currentUser.email,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Send admin notification
    await sendAdminNotification(swapId, teacherName, currentUser.displayName || currentUser.email);

    // üîî Notify swap poster
    const swapDoc = await db.collection("teacherSwaps").doc(swapId).get();
    if (swapDoc.exists) {
      const swapData = swapDoc.data();
      const posterId = swapData.userId;

      // Only notify if not the same user
      if (posterId && posterId !== currentUser.uid) {
        await db.collection("alerts").add({
          title: "üì¨ Swap Interest",
          message: `${currentUser.displayName || "Someone"} is interested in your swap for ${swapData.subjectCombination}.`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          targetUserId: posterId
        });
      }
    }

    // ‚úÖ Always show success if everything worked
    showCustomAlert(`‚úÖ Your interest in ${teacherName}'s swap has been sent!`, "success");

  } catch (error) {
    console.error("Error sending interest:", error);
    showCustomAlert("‚ùå Failed to send interest: " + error.message, "error");
  } finally {
    // ‚úÖ Hide the spinner once the process is complete
    document.getElementById("loadingSpinner").style.display = "none";
  }
}

// ‚úÖ BOM Job Submit (with Public & Admin Notifications)
document.getElementById("bomJobForm").addEventListener("submit", async e => {
  e.preventDefault();

  if (!currentUser) {
    return showCustomAlert("Please login to post a job.", "error");
  }

  const now = new Date();
  const fullDate = now.toLocaleString();
  const email = currentUser.email || "unknown@user.com";
  const firstName = email.split("@")[0].split(/[._]/)[0];

  document.getElementById("bomDate").value = fullDate;
  document.getElementById("bomPostedBy").value = capitalize(firstName);

  // üîπ Contact + Phone handling
  const contactInput = document.getElementById("bomContact")?.value.trim() || "";
  const phone = document.getElementById("bomPhone")?.value.trim() || "";
  let contact = contactInput || phone;

  if (contactInput.startsWith("http") || contactInput.startsWith("www")) {
    contact = contactInput;
  }

  // üîπ Job object
 const job = {
  organization: document.getElementById("bomOrg").value.trim(),
  jobType: document.getElementById("bomJobType").value.trim(),
  phone: phone,
  contact: contact,
  subCounty: document.getElementById("bomSubCounty").value,
  county: document.getElementById("bomCounty").value,
  salaryRange: document.getElementById("bomSalaryRange").value.trim(),
  datePosted: fullDate,
  postedBy: capitalize(firstName),
  posterUid: currentUser.uid,
  jobKey: "dlTvfkiuv1ROFNa4HPVqWgs82Dh2",
  timestamp: firebase.firestore.FieldValue.serverTimestamp(),
  followedUsers: [], // ‚úÖ Initialize empty array
  followedCount: 0    // ‚úÖ Initialize count
};


  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    // ‚úÖ Save job to BOM collection
    await bomRef.add(job);

    showCustomAlert("‚úÖ Job posted successfully!", "success");
    document.getElementById("bomJobForm").reset();
    loadBOMJobs();
    notifyMatchingServiceProviders(job);

    // ‚úÖ Admin Notification (formatted nicely)
    const adminMessage = `New job posted: ${job.jobType} by ${job.organization}, Salary: ${job.salaryRange}, Contact: ${job.contact || job.phone}, County: ${job.county}`;
    
    await db.collection("adminNotifications").add({
      type: "BOM Job Post",
      message: adminMessage,
      jobType: job.jobType,
      organization: job.organization,
      salaryRange: job.salaryRange,
      contact: job.contact || null,
      phone: job.phone,
      county: job.county,
      posterUid: currentUser.uid,
      jobKey: job.jobKey,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });

    // ‚úÖ Public Alert
    await db.collection("alerts").add({
      title: "üì¢ New Job",
      message: `${job.organization} just posted a ${job.jobType} job in ${job.county}, ${job.subCounty}. üí∞ Salary: ${job.salaryRange}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null,
      category: "bom",
      county: job.county
    });

  } catch (err) {
    showCustomAlert("‚ùå Error posting job: " + err.message, "error");
  } finally {
    document.getElementById("loadingSpinner").style.display = "none";
  }
});

// ‚úÖ Utility to capitalize first letter
function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}




// ‚úÖ Notify Matching Service Providers (no phone number)
function notifyMatchingServiceProviders(job) {
  servicesRef.get().then(snapshot => {
    snapshot.forEach(doc => {
      const service = doc.data();
      const occupationMatch = service.svcOccupation?.toLowerCase() === job.jobType.toLowerCase();
      const countyMatch = service.svcCounty === job.county;

      if (occupationMatch && countyMatch) {
        const message = `üõé Job Opportunity Matching Your Services!
Job: ${job.jobType}
Posted by: ${job.posterName}
County: ${job.county}`;

        db.collection("notifications").add({
          userId: doc.id, // Or svcPhone as unique key
          message,
          timestamp: new Date()
        });
      }
    });
  });
}


let bomJobsCache = [];
let jobToDeleteId = null;
let trendingBoostedItems = []; // Combined trending (jobs, swaps, etc.)

// ‚úÖ Load BOM Jobs with Boost Logic (Optimized)
async function loadBOMJobs() {
  const container = document.getElementById("jobContainer");
  container.innerHTML = "";

  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    const snapshot = await bomRef.orderBy("timestamp", "desc").get();
    const now = new Date();
    bomJobsCache = [];
    trendingBoostedItems = [];

    const updatePromises = [];

    for (const doc of snapshot.docs) {
      const data = doc.data();
      const boostExpiry = data.boostExpiry?.toDate?.();
      const isBoosted = data.boosted && boostExpiry && boostExpiry > now;

      if (data.boosted && (!boostExpiry || boostExpiry <= now)) {
        // Defer Firestore writes, run them in parallel later
        updatePromises.push(bomRef.doc(doc.id).update({ boosted: false, boostExpiry: null }));
      }

      const job = { id: doc.id, ...data, isBoosted, boostExpiry };
      bomJobsCache.push(job);

      if (isBoosted) trendingBoostedItems.push({ id: doc.id, ...data, type: "job" });
    }

    if (updatePromises.length > 0) await Promise.all(updatePromises);

    renderBOMJobs(bomJobsCache);

  } catch (err) {
    showCustomAlert("‚ùå Failed to load jobs: " + err.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}

function renderBOMJobs(jobs) {
  const container = document.getElementById("jobContainer");
  container.innerHTML = "";

  if (!jobs.length) {
    container.innerHTML = `<p>üåùüåùüåùüåùOops, no jobs foundüåùüåùüåù</p>`;
    return;
  }

  const hasAccess = hasBomJobAccess();
  const now = new Date();

  // Sort boosted first, then latest
  jobs.sort((a, b) => {
    const aBoosted = a.isBoosted && a.boostExpiry > now;
    const bBoosted = b.isBoosted && b.boostExpiry > now;
    if (aBoosted && !bBoosted) return -1;
    if (!aBoosted && bBoosted) return 1;
    if (aBoosted && bBoosted) return (b.boostExpiry || 0) - (a.boostExpiry || 0);
    return (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0);
  });

  const fragment = document.createDocumentFragment(); // batch DOM insert

  jobs.forEach(job => {
    const card = document.createElement("div");
    card.className = "job-card";
    card.style.cssText = `
      position: relative; 
      border: 1px solid #ddd; 
      border-radius: 12px; 
      overflow: hidden; 
      margin-bottom: 18px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.08); 
      background: #fff; 
      text-align: center;
    `;

   const isPoster = currentUser && (job.posterUid === currentUser.uid);
const isAdminUser = !!window.isAdmin; // explicitly grab global
const isVerified = !!job.verified;


    const badge = isVerified ? `<div class="verified-badge"><i class="fas fa-check-circle"></i> Verified</div>` : "";
    const verifyButton = (!isVerified && isAdmin) ? `<button onclick="adminVerifyItem('job','${job.id}')" style="background:#4CAF50;color:white;border:none;border-radius:5px;padding:6px 12px;cursor:pointer;">‚úÖ Verify Now (Admin)</button>` : "";

    let boostBadge = "", topCornerTag = "";
    if (job.isBoosted && job.boostExpiry) {
      const daysLeft = Math.ceil((job.boostExpiry - now) / (1000 * 60 * 60 * 24));
      boostBadge = `<span style="background: orange; color: white; font-size: 0.75em; padding: 2px 6px; border-radius: 6px;">üî• Trending Now</span>
                    <span style="color: gray; font-size: 0.75em;">(${daysLeft} day${daysLeft!==1?"s":""} left)</span>`;
      topCornerTag = `<div style="position:absolute;top:8px;right:8px;background:#f44336;color:white;font-size:0.75em;padding:4px 8px;border-radius:6px;font-weight:bold;box-shadow:0 2px 4px rgba(0,0,0,0.2);">üî• TRENDING</div>`;
    }

    const jobType = job.jobType?.toLowerCase() || "";
    let iconClass = "fa-user-tie", bgColor="#607d8b";
    if (jobType.includes("teacher")) iconClass="fa-chalkboard-teacher", bgColor="#42a5f5";

    else if (jobType.includes("developer")) iconClass="fa-laptop-code", bgColor="#42a5f5";
else if (jobType.includes("developer")) iconClass = "fa-laptop-code", bgColor = "#42a5f5";
else if (jobType.includes("designer")) iconClass = "fa-paint-brush", bgColor = "#9c27b0";
else if (jobType.includes("chef")) iconClass = "fa-utensils", bgColor = "#8d6e63";
else if (jobType.includes("nurse")) iconClass = "fa-user-nurse", bgColor = "#e91e63";
else if (jobType.includes("doctor")) iconClass = "fa-user-md", bgColor = "#f44336";
else if (jobType.includes("driver")) iconClass = "fa-truck", bgColor = "#3f51b5";
else if (jobType.includes("pilot")) iconClass = "fa-plane", bgColor = "#2196f3";
else if (jobType.includes("mechanic")) iconClass = "fa-tools", bgColor = "#795548";
else if (jobType.includes("plumber")) iconClass = "fa-wrench", bgColor = "#607d8b";
else if (jobType.includes("electrician")) iconClass = "fa-bolt", bgColor = "#ff9800";
else if (jobType.includes("farmer")) iconClass = "fa-tractor", bgColor = "#4caf50";
else if (jobType.includes("engineer")) iconClass = "fa-cogs", bgColor = "#607d8b";
else if (jobType.includes("architect")) iconClass = "fa-drafting-compass", bgColor = "#9e9d24";
else if (jobType.includes("lawyer")) iconClass = "fa-balance-scale", bgColor = "#673ab7";
else if (jobType.includes("judge")) iconClass = "fa-gavel", bgColor = "#3e2723";
else if (jobType.includes("police")) iconClass = "fa-shield-alt", bgColor = "#1a237e";
else if (jobType.includes("security")) iconClass = "fa-user-shield", bgColor = "#000000";
else if (jobType.includes("firefighter")) iconClass = "fa-fire-extinguisher", bgColor = "#d32f2f";
else if (jobType.includes("scientist")) iconClass = "fa-flask", bgColor = "#00bcd4";
else if (jobType.includes("pharmacist")) iconClass = "fa-pills", bgColor = "#8e24aa";
else if (jobType.includes("dentist")) iconClass = "fa-tooth", bgColor = "#fbc02d";
else if (jobType.includes("veterinarian")) iconClass = "fa-paw", bgColor = "#8d6e63";
else if (jobType.includes("waiter")) iconClass = "fa-concierge-bell", bgColor = "#ff9800";
else if (jobType.includes("receptionist")) iconClass = "fa-phone", bgColor = "#4caf50";
else if (jobType.includes("sales")) iconClass = "fa-cash-register", bgColor = "#009688";
else if (jobType.includes("accountant")) iconClass = "fa-calculator", bgColor = "#3f51b5";
else if (jobType.includes("banker")) iconClass = "fa-university", bgColor = "#0d47a1";
else if (jobType.includes("marketer")) iconClass = "fa-bullhorn", bgColor = "#ff5722";
else if (jobType.includes("photographer")) iconClass = "fa-camera", bgColor = "#6a1b9a";
else if (jobType.includes("videographer")) iconClass = "fa-video", bgColor = "#c2185b";
else if (jobType.includes("model")) iconClass = "fa-user", bgColor = "#f48fb1";
else if (jobType.includes("actor")) iconClass = "fa-theater-masks", bgColor = "#ff9800";
else if (jobType.includes("musician")) iconClass = "fa-music", bgColor = "#5e35b1";
else if (jobType.includes("dj")) iconClass = "fa-headphones", bgColor = "#512da8";
else if (jobType.includes("tailor")) iconClass = "fa-cut", bgColor = "#ff7043";
else if (jobType.includes("cleaner")) iconClass = "fa-broom", bgColor = "#66bb6a";
else if (jobType.includes("translator")) iconClass = "fa-language", bgColor = "#0097a7";
else if (jobType.includes("tour guide")) iconClass = "fa-map-marked-alt", bgColor = "#43a047";
else if (jobType.includes("chef assistant")) iconClass = "fa-hamburger", bgColor = "#ff9800";
else if (jobType.includes("barista")) iconClass = "fa-coffee", bgColor = "#6d4c41";
else if (jobType.includes("butcher")) iconClass = "fa-drumstick-bite", bgColor = "#d84315";
else if (jobType.includes("baker")) iconClass = "fa-bread-slice", bgColor = "#f57c00";
else if (jobType.includes("fisherman")) iconClass = "fa-fish", bgColor = "#0288d1";
else if (jobType.includes("construction worker")) iconClass = "fa-hard-hat", bgColor = "#ffa000";
else if (jobType.includes("miner")) iconClass = "fa-gem", bgColor = "#616161";
else if (jobType.includes("scientist assistant")) iconClass = "fa-vials", bgColor = "#00897b";
else if (jobType.includes("social worker")) iconClass = "fa-hands-helping", bgColor = "#ff7043";
else if (jobType.includes("delivery")) iconClass = "fa-shipping-fast", bgColor = "#ef6c00";
else if (jobType.includes("call center")) iconClass = "fa-headset", bgColor = "#3949ab";
else if (jobType.includes("it support")) iconClass = "fa-server", bgColor = "#1e88e5";
else if (jobType.includes("hr manager")) iconClass = "fa-user-tie", bgColor = "#6d4c41";
else if (jobType.includes("seo specialist")) iconClass = "fa-search", bgColor = "#00acc1";
else if (jobType.includes("content writer")) iconClass = "fa-pen-nib", bgColor = "#ab47bc";
else if (jobType.includes("blogger")) iconClass = "fa-blog", bgColor = "#7b1fa2";
else if (jobType.includes("youtuber")) iconClass = "fa-video", bgColor = "#e53935";
else if (jobType.includes("data analyst")) iconClass = "fa-chart-line", bgColor = "#2e7d32";
else if (jobType.includes("data scientist")) iconClass = "fa-database", bgColor = "#1565c0";
else if (jobType.includes("ai engineer")) iconClass = "fa-robot", bgColor = "#00bcd4";
else if (jobType.includes("cyber security")) iconClass = "fa-user-secret", bgColor = "#263238";
else if (jobType.includes("blockchain")) iconClass = "fa-link", bgColor = "#ff6f00";
else if (jobType.includes("crypto trader")) iconClass = "fa-coins", bgColor = "#ffb300";
else if (jobType.includes("real estate")) iconClass = "fa-building", bgColor = "#8d6e63";
else if (jobType.includes("insurance agent")) iconClass = "fa-file-contract", bgColor = "#455a64";
else if (jobType.includes("loan officer")) iconClass = "fa-hand-holding-usd", bgColor = "#558b2f";
else if (jobType.includes("event planner")) iconClass = "fa-calendar-check", bgColor = "#9c27b0";
else if (jobType.includes("wedding planner")) iconClass = "fa-ring", bgColor = "#ff4081";
else if (jobType.includes("makeup artist")) iconClass = "fa-magic", bgColor = "#ec407a";
else if (jobType.includes("hair stylist")) iconClass = "fa-cut", bgColor = "#f06292";
else if (jobType.includes("barber")) iconClass = "fa-user", bgColor = "#8d6e63";
else if (jobType.includes("painter")) iconClass = "fa-paint-roller", bgColor = "#5d4037";
else if (jobType.includes("sculptor")) iconClass = "fa-sculpture", bgColor = "#6d4c41"; // Custom icon from FA Pro if available
else if (jobType.includes("carpenter")) iconClass = "fa-hammer", bgColor = "#795548";
else if (jobType.includes("tile setter")) iconClass = "fa-border-style", bgColor = "#9e9e9e";
else if (jobType.includes("welder")) iconClass = "fa-tools", bgColor = "#ff7043";
else if (jobType.includes("glass installer")) iconClass = "fa-glass-whiskey", bgColor = "#90a4ae";
else if (jobType.includes("roofer")) iconClass = "fa-home", bgColor = "#ff7043";
else if (jobType.includes("interior designer")) iconClass = "fa-couch", bgColor = "#6a1b9a";
else if (jobType.includes("landscaper")) iconClass = "fa-tree", bgColor = "#4caf50";
else if (jobType.includes("logger")) iconClass = "fa-tree", bgColor = "#2e7d32";
else if (jobType.includes("truck driver")) iconClass = "fa-truck-moving", bgColor = "#4e342e";
else if (jobType.includes("taxi driver")) iconClass = "fa-taxi", bgColor = "#fbc02d";
else if (jobType.includes("bus driver")) iconClass = "fa-bus", bgColor = "#f57c00";
else if (jobType.includes("train conductor")) iconClass = "fa-train", bgColor = "#3f51b5";
else if (jobType.includes("ship captain")) iconClass = "fa-anchor", bgColor = "#0d47a1";
else if (jobType.includes("flight attendant")) iconClass = "fa-plane-departure", bgColor = "#03a9f4";
else if (jobType.includes("airport staff")) iconClass = "fa-plane-arrival", bgColor = "#0288d1";
else if (jobType.includes("warehouse worker")) iconClass = "fa-boxes", bgColor = "#8d6e63";
else if (jobType.includes("packer")) iconClass = "fa-box", bgColor = "#a1887f";
else if (jobType.includes("logistics")) iconClass = "fa-shipping-fast", bgColor = "#009688";
else if (jobType.includes("supply chain")) iconClass = "fa-truck-loading", bgColor = "#ff9800";
else if (jobType.includes("quality inspector")) iconClass = "fa-clipboard-check", bgColor = "#388e3c";
else if (jobType.includes("project manager")) iconClass = "fa-tasks", bgColor = "#607d8b";
else if (jobType.includes("supervisor")) iconClass = "fa-user-tie", bgColor = "#455a64";
else if (jobType.includes("foreman")) iconClass = "fa-hard-hat", bgColor = "#ffa000";
else if (jobType.includes("researcher")) iconClass = "fa-microscope", bgColor = "#1e88e5";
else if (jobType.includes("teacher assistant")) iconClass = "fa-chalkboard", bgColor = "#64b5f6";
else if (jobType.includes("lecturer")) iconClass = "fa-user-graduate", bgColor = "#3949ab";
else if (jobType.includes("professor")) iconClass = "fa-graduation-cap", bgColor = "#283593";
else if (jobType.includes("coach")) iconClass = "fa-dumbbell", bgColor = "#f44336";
else if (jobType.includes("personal trainer")) iconClass = "fa-running", bgColor = "#ff7043";
else if (jobType.includes("lifeguard")) iconClass = "fa-life-ring", bgColor = "#0288d1";
else if (jobType.includes("swimming instructor")) iconClass = "fa-swimmer", bgColor = "#039be5";
else if (jobType.includes("pilot trainee")) iconClass = "fa-plane", bgColor = "#03a9f4";
else if (jobType.includes("intern")) iconClass = "fa-user-graduate", bgColor = "#8e24aa";
    else if (jobType.includes("designer")) iconClass="fa-paint-brush", bgColor="#9c27b0";
    else if (jobType.includes("volunteer")) iconClass="fa-hands-helping", bgColor="#43a047";
    else if (jobType.includes("chef")) iconClass="fa-utensils", bgColor="#8d6e63";

    const iconHTML = `<div style="padding:18px;background:${bgColor};display:inline-flex;justify-content:center;align-items:center;border-radius:8px;">
                        <i class="fas ${iconClass}" style="font-size:50px;color:#fff;"></i>
                      </div>`;

    const hasPhone = job.phone && job.phone.trim() !== "";
    const hasContact = job.contact && job.contact.trim() !== "";
    const looksLikePhone = val => /^[\d+\s-]{6,}$/.test(val);
    let contactSection = "";

    if (isPoster || isAdmin || hasAccess) {
      if (hasPhone) contactSection = `<p style="color:#009688;margin-bottom:8px;"><strong>Phone:</strong><br><a href="tel:${job.phone}" style="color:white;background:#4caf50;padding:8px 12px;border-radius:6px;text-decoration:none;">üìû ${job.phone}</a></p>`;
      else if (hasContact) {
        contactSection = looksLikePhone(job.contact) ?
          `<p style="color:#009688;margin-bottom:8px;"><strong>Phone:</strong><br><a href="tel:${job.contact}" style="color:white;background:#4caf50;padding:8px 12px;border-radius:6px;text-decoration:none;">üìû ${job.contact}</a></p>` :
          `<p style="color:#009688;margin-bottom:8px;"><strong>Application Link:</strong><br><a href="${job.contact}" target="_blank" style="color:white;background:#2196f3;padding:8px 12px;border-radius:6px;text-decoration:none;">üîó Open Link</a></p>`;
      }
    } else {
      let amount = hasPhone || looksLikePhone(job.contact) ? 350 : 50;
      let label = hasPhone || looksLikePhone(job.contact) ? "Phone" : "Application link";
      contactSection = `<div class="blurred"><p style="color:gray;">üîí ${label} ‚Äì Pay Ksh ${amount} to unlock</p></div>
        <button onclick="unlockBomJobs('${job.id}', ${amount})" style="color:white;background:#4caf50;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;">üí≥ Unlock ${label} (Ksh ${amount})</button>`;
    }

    const actionButtons = `
      ${(isPoster || isAdmin)? `<button onclick="confirmDeleteBOMJob('${job.id}')" style="background:#dc3545;color:white;border:none;border-radius:5px;padding:6px 12px;cursor:pointer;">üóëÔ∏è Delete</button>` : ''}
      ${(isPoster || isAdmin)? `<button onclick="boostJob('${job.id}')" style="background:#4caf50;color:white;border:none;border-radius:5px;padding:6px 12px;cursor:pointer;">üöÄ Boost</button>` : ''}
      ${(isPoster && !isVerified)? `<button onclick="verifyJob('${job.id}')" style="background:#ff9800;color:white;border:none;border-radius:5px;padding:6px 12px;cursor:pointer;">‚úÖ Get Verified (Ksh 250)</button>` : ''}
      ${isAdmin && !isVerified ? verifyButton : ''}
      ${(isPoster || isAdmin)? `<button onclick="closeJob('${job.id}')" style="background:#6c757d;color:white;border:none;border-radius:5px;padding:6px 12px;cursor:pointer;">${job.isClosed?'‚ôªÔ∏è Reopen Job':'üö´ Mark as Closed'}</button>` : ''}

      <button onclick="followJob('${job.id}')" style="background:#2196f3;color:white;border:none;border-radius:5px;padding:6px 12px;cursor:pointer;">üëÄ Follow Job</button>
    `;

    const moreButton = `<button onclick="toggleMoreActions('${job.id}')" style="background:#00bcd4;color:white;border:none;border-radius:5px;padding:6px 12px;cursor:pointer;">More...</button>`;
    window.toggleMoreActions = function(jobId){
      const actionContainer = document.getElementById(`actionButtons-${jobId}`);
      const button = actionContainer.previousElementSibling;
      if (actionContainer.style.display === 'none' || actionContainer.style.display === '') { actionContainer.style.display='flex'; button.innerHTML='Less...'; } 
      else { actionContainer.style.display='none'; button.innerHTML='More...'; }
    };

    card.innerHTML = `
      ${topCornerTag}
      ${iconHTML}
      <div style="padding:14px;text-align:left;">
        ${badge}
        <h3 style="color:#2e7d32;">${job.jobType} ${boostBadge} ${job.isClosed?'<span style="color:red;">(Closed)</span>':''}</h3>
        <p style="color:#3f51b5;"><strong>Organization:</strong> ${job.organization}</p>
        ${contactSection}
        <p style="color:#e91e63;"><strong>Location:</strong> ${job.county}, ${job.subCounty}</p>
        <p style="color:#ff9800;"><strong>Salary Range:</strong> KES ${parseInt(job.salaryRange).toLocaleString()}</p>
        <p style="color:#6a1b9a;"><strong>Date Posted:</strong> ${job.datePosted}</p>
        <p style="color:#795548;"><strong>Posted By:</strong> ${job.postedBy || "Unknown"}</p>
        <div style="margin-top:10px;">${moreButton}<div id="actionButtons-${job.id}" style="display:none;flex-wrap:wrap;gap:10px;">${actionButtons}</div></div>
      <p id="followed-count-${job.id}" style="font-size:0.8em;color:#2196f3;margin-top:4px;">
  ${job.followedCount || 0} people following
</p>

      </div>
    `;

    fragment.appendChild(card);
    updateFollowedCount(job.id);

  });

  container.appendChild(fragment);
}

// Function to handle following a job 
function followJob(jobId) {
  const followButton = document.querySelector(`button[onclick="followJob('${jobId}')"]`);
  const followedCountElement = document.getElementById(`followed-count-${jobId}`);
  const user = firebase.auth().currentUser;

  if (!user) {
    showCustomAlert("Please log in to follow this job.", "error");
    return;
  }

  // Show the loading spinner while processing the follow/unfollow action
  document.getElementById("loadingSpinner").style.display = "flex";

  const userId = user.uid;
  const jobRef = firebase.firestore().doc(`bomJobs/${jobId}`);

  jobRef.get().then(async docSnapshot => {
    if (!docSnapshot.exists) {
      showCustomAlert("Job not found.", "error");
      document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner
      return;
    }

    const jobData = docSnapshot.data();
    const alreadyFollowing = jobData.followedUsers && jobData.followedUsers.includes(userId);

    try {
      if (alreadyFollowing) {
        // üëé Unfollow
        followButton.innerText = "üëÄ Follow Job";
        followButton.classList.remove('followed');

        await jobRef.update({
          followedUsers: firebase.firestore.FieldValue.arrayRemove(userId),
          followedCount: firebase.firestore.FieldValue.increment(-1)
        });

        if (followedCountElement) {
          let currentCount = parseInt(followedCountElement.textContent) || 1;
          followedCountElement.textContent = `${currentCount - 1} following`;
        }

        showCustomAlert("‚ùå You unfollowed this job.", "warning");
        console.log("Unfollowed the job successfully.");

      } else {
        // üëç Follow
        followButton.innerText = "üëÄ Following Job";
        followButton.classList.add('followed');

        await jobRef.update({
          followedUsers: firebase.firestore.FieldValue.arrayUnion(userId),
          followedCount: firebase.firestore.FieldValue.increment(1)
        });

        if (followedCountElement) {
          let currentCount = parseInt(followedCountElement.textContent) || 0;
          followedCountElement.textContent = `${currentCount + 1} following`;
        }

        showCustomAlert("‚úÖ You are now following this job.", "success");
        console.log("Followed the job successfully.");

        // ‚úÖ Notify the poster if not self
        const posterName = jobData.postedBy || "Poster";
        const posterId = jobData.userId || null;

        if (posterId && posterId !== userId) {
          await db.collection("alerts").add({
            title: "üë• Job Followed",
            message: `${user.displayName || user.email || "Someone"} followed your BOM job for ${jobData.jobType} at ${jobData.organization}.`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            targetUserId: posterId
          });
        }
      }
    } catch (error) {
      console.error("Error handling job follow/unfollow: ", error);
      showCustomAlert("‚ùå Failed to follow/unfollow job: " + error.message, "error");
    } finally {
      // Hide the loading spinner once the operation is complete
      document.getElementById("loadingSpinner").style.display = "none";
    }
  }).catch((error) => {
    console.error("Error handling job follow: ", error);
    showCustomAlert("‚ùå Failed to follow/unfollow job: " + error.message, "error");
    document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner
  });
}




// Function to update the followed count on page load (in case of page refresh)
function updateFollowedCount(jobId) {
  const followedCountElement = document.getElementById(`followed-count-${jobId}`);

  // Reference to the Firestore document for the job
  const jobRef = firebase.firestore().doc(`bomJobs/${jobId}`);

  // Listen for real-time updates to the job document
  jobRef.onSnapshot(docSnapshot => {
    if (docSnapshot.exists) {
      const jobData = docSnapshot.data();
      const followedCount = jobData.followedCount || 0;

      // Update the UI with the current followed count from Firestore
      followedCountElement.innerText = `${followedCount} people following`;
    }
  });
}



// ‚úÖ Boost Job
async function boostJob(jobId) { 
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    const jobRef = db.collection("bomJobs").doc(jobId);
    const doc = await jobRef.get();
    if (!doc.exists) {
      showCustomAlert("‚ùå Job not found.", "error");
      return;
    }

    const data = doc.data();
    const posterUid = data.posterUid;
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      showCustomAlert("‚ùå You need to be logged in to boost a job.", "error");
      return;
    }

    const isAdminUser = isAdmin === true;
    const boostExpiry = firebase.firestore.Timestamp.fromDate(
      new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days
    );

    if (currentUser.uid === posterUid && !isAdminUser) {
      // Poster: pay before boosting
      showPaymentModalFor("jobBoost", 350, jobId, data.jobType, async () => {
        await updateJobBoostStatus(jobId, true, boostExpiry);
        updateJobBoostedBadge(jobId, boostExpiry.toDate());
        showCustomAlert("üöÄ Your job has been boosted for 7 days!", "success");
        await sendJobBoostAdminNotification(jobId, currentUser.uid, "user", data.jobType);
      });
    } else {
      // Admin or other privilege: boost instantly
      await updateJobBoostStatus(jobId, true, boostExpiry);
      updateJobBoostedBadge(jobId, boostExpiry.toDate());
      showCustomAlert("‚úÖ The job has been boosted for free!", "success");
      await sendJobBoostAdminNotification(jobId, currentUser.uid, "admin", data.jobType);
    }
  } catch (err) {
    console.error("‚ùå Boost error:", err);
    showCustomAlert("‚ùå Failed to boost: " + err.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}


// ‚úÖ Update Firestore job boost status
async function updateJobBoostStatus(jobId, isBoosted, boostExpiry) {
  const jobRef = db.collection("bomJobs").doc(jobId);
  await jobRef.update({
    isBoosted: isBoosted,
    boostExpiry: isBoosted ? boostExpiry : null,
    boostTimestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  // Optionally update boost button
  const boostBtn = document.getElementById(`boostJobBtn-${jobId}`);
  if (boostBtn) {
    boostBtn.innerText = isBoosted ? "üöÄ Boosted" : "üöÄ Boost Job";
    boostBtn.disabled = isBoosted;
  }
}


// ‚úÖ Send notification when a job is boosted
async function sendJobBoostAdminNotification(jobId, userId, userType, jobType) {
  const notifRef = db.collection("adminNotifications").doc();
  await notifRef.set({
    type: "Job Boost",
    jobId: jobId,
    userId: userId,
    jobType: jobType,
    userType: userType, // 'admin' or 'user'
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `üöÄ ${userType === "admin" ? "Admin" : "User"} boosted the job "${jobType}" (ID: ${jobId}).`
  });
}


// ‚úÖ Instantly update boosted badge on job card
function updateJobBoostedBadge(jobId, boostExpiryDate) {
  const card = document.querySelector(`#jobCardContainer .job-card[data-id="${jobId}"]`);
  if (card) {
    const now = new Date();
    const diffDays = Math.max(1, Math.ceil((boostExpiryDate - now) / (1000 * 60 * 60 * 24)));

    let badgeContainer = card.querySelector(".boosted-badge");
    if (!badgeContainer) {
      const badgeHTML = `<span class="boosted-badge" style="color:red;font-weight:bold;font-size:14px;background:yellow;padding:4px;border-radius:6px;margin-left:6px;">üî• Boosted (${diffDays} days left)</span>`;
      const header = card.querySelector("h3");
      if (header) header.insertAdjacentHTML("afterend", `<div style="margin:4px 0;">${badgeHTML}</div>`);
    } else {
      badgeContainer.textContent = `üî• Boosted (${diffDays} days left)`;
    }

    // ‚úÖ Move boosted job to top
    const container = document.getElementById("jobCardContainer");
    if (container) container.prepend(card);

    // ‚úÖ Auto-remove badge when expired
    const interval = setInterval(() => {
      const now = new Date();
      if (now >= boostExpiryDate) {
        const badge = card.querySelector(".boosted-badge");
        if (badge) badge.remove();

        db.collection("bomJobs").doc(jobId).update({
          isBoosted: false,
          boostExpiry: null
        });

        clearInterval(interval);
      } else {
        const daysLeft = Math.max(1, Math.ceil((boostExpiryDate - now) / (1000 * 60 * 60 * 24)));
        const badge = card.querySelector(".boosted-badge");
        if (badge) badge.textContent = `üî• Boosted (${daysLeft} days left)`;
      }
    }, 1000 * 60 * 60); // hourly
  }
}


// ‚úÖ Daily refresh of boosted job badges
setInterval(() => {
  document.querySelectorAll("#jobCardContainer .job-card").forEach(card => {
    const badge = card.querySelector(".boosted-badge");
    if (badge) {
      const jobId = card.getAttribute("data-id");
      db.collection("bomJobs").doc(jobId).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          if (data.isBoosted && data.boostExpiry?.toDate) {
            updateJobBoostedBadge(jobId, data.boostExpiry.toDate());
          }
        }
      }).catch(err => console.error("Error refreshing job badge:", err));
    }
  });
}, 24 * 60 * 60 * 1000); // every 24h

// ‚úÖ Verify Job
async function verifyJob(jobId) {
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    const jobRef = db.collection("bomJobs").doc(jobId);
    const doc = await jobRef.get();
    if (!doc.exists) {
      showCustomAlert("‚ùå Job not found.", "error");
      return;
    }

    const data = doc.data();
    const posterUid = data.posterUid; // ‚úÖ Correct UID field

    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      showCustomAlert("‚ùå You need to login first.", "error");
      return;
    }

    // Poster must pay Ksh 250 for verification
    if (currentUser.uid === posterUid) {
      const verificationLabel = "Job Verification";

      // Show payment modal for verification
      showPaymentModalFor("verify", 250, jobId, verificationLabel, async () => {
        await applyVerification(jobRef);

        // ‚úÖ Send admin notification
        try {
          const notifRef = db.collection("adminNotifications").doc();
          await notifRef.set({
            type: "Job Verification",
            userId: currentUser.uid,
            message: `üí∞ ${currentUser.email} paid Ksh 250 for job verification (${data.jobType}).`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });
          console.log("Admin notification sent for job verification");
        } catch (error) {
          console.error("Failed to send admin notification:", error);
        }

        closeUniversalModal();
      });

      return;
    }

    // Admin can verify immediately without payment
    await applyVerification(jobRef);

  } catch (err) {
    console.error("‚ùå Verify error:", err);
    showCustomAlert("‚ùå Failed to verify: " + err.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}

// ‚úÖ Helper to apply verification
async function applyVerification(jobRef) {
  await jobRef.update({ verified: true });
  showCustomAlert("‚úÖ Job verified successfully.", "success");
  loadBOMJobs(); // refresh the list
}

// ‚úÖ Payment Modal (dynamic for Boost or Verify)
function showPaymentModalFor(type, amount, jobId, jobType, onSuccess) {
  const modal = document.getElementById("paymentModal");
  const modalTitle = modal.querySelector(".modal-title");
  const modalBody = modal.querySelector(".modal-body");
  const payButton = modal.querySelector(".pay-button");

  if (type === 'boost') {
    modalTitle.textContent = "üí≥ Pay for Boost";
    modalBody.textContent = `Pay Ksh ${amount} to boost your job "${jobType}".`;
  } else if (type === 'verify') {
    modalTitle.textContent = "üí≥ Pay for Verification";
    modalBody.textContent = `Pay Ksh ${amount} to get your job "${jobType}" verified.`;
  }

  modal.style.display = "block";

  payButton.onclick = async () => {
    // Trigger payment logic (STK push or manual)
    // After successful payment:
    if (typeof onSuccess === 'function') {
      await onSuccess();
    }
    modal.style.display = "none";
  };
}



// ‚úÖ Update Average Rating
async function updateAverageRating(jobId) {
  try {
    console.log("Fetching ratings for jobId:", jobId);

    // Fetch ratings for the specific jobId from Firestore
    const ratingRef = db.collection("ratings").where("jobId", "==", jobId);
    const snapshot = await ratingRef.get();

    // If no ratings found, handle it gracefully
    if (snapshot.empty) {
      console.log("No ratings found for jobId:", jobId);
      const avgRatingElement = document.getElementById(`avgRating-${jobId}`);
      avgRatingElement.textContent = "‚≠ê No ratings yet (0 Reviews)";
      return;
    }

    let totalRating = 0;
    let totalReviews = snapshot.size;

    // Iterate through snapshot and calculate total rating
    snapshot.forEach(doc => {
      totalRating += doc.data().rating;
    });

    // Calculate average rating
    const avgRating = totalReviews ? (totalRating / totalReviews).toFixed(1) : 0;
    const avgRatingElement = document.getElementById(`avgRating-${jobId}`);
    avgRatingElement.textContent = `‚≠ê ${avgRating} (${totalReviews} Reviews)`;

    // Highlight stars based on average rating
    for (let i = 1; i <= 5; i++) {
      const starElement = document.getElementById(`star-${jobId}-${i}`);
      if (starElement) { // Ensure the star element exists before updating
        if (i <= avgRating) {
          starElement.style.color = "#ff9800"; // Highlight selected stars
        } else {
          starElement.style.color = "#ccc"; // Reset unselected stars
        }
      } else {
        console.log(`Star element with id "star-${jobId}-${i}" not found.`);
      }
    }

  } catch (error) {
    console.error("Error updating average rating:", error);
    showCustomAlert("Something went wrong while fetching the average rating. Please try again.", "error");
  }
}

function toggleMoreActions(jobId) {
  const actionContainer = document.getElementById(`actionButtons-${jobId}`);
  const button = actionContainer.previousElementSibling;

  // Check if the buttons are currently hidden or not
  if (actionContainer.style.display === 'none' || actionContainer.style.display === '') {
    actionContainer.style.display = 'flex';  // Show the action buttons
    button.innerHTML = 'Less...';  // Change button text to "Less..."
  } else {
    actionContainer.style.display = 'none';  // Hide the action buttons
    button.innerHTML = 'More...';  // Change button text to "More..."
  }
}

// Function to show interest in a job
async function showInterestInJob(jobId) {
  const user = firebase.auth().currentUser;
  const userId = user?.uid;

  if (!userId) {
    showCustomAlert("Please log in to show interest.", "error");
    return;
  }

  const followedCountElement = document.getElementById(`followed-count-${jobId}`);
  const jobRef = firebase.firestore().doc(`bomJobs/${jobId}`);

  // Show loading spinner
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    const docSnapshot = await jobRef.get();
    if (!docSnapshot.exists) {
      showCustomAlert("Job not found.", "error");
      if (spinner) spinner.style.display = "none";
      return;
    }

    const jobData = docSnapshot.data();
    let followedUsers = jobData.followedUsers || [];
    let followedCount = jobData.followedCount || followedUsers.length;

    // Check if the user already showed interest
    if (followedUsers.includes(userId)) {
      showCustomAlert("‚ö†Ô∏è You‚Äôve already shown interest in this job!", "warning");
      if (spinner) spinner.style.display = "none";
      return;
    }

    // Add user to followedUsers
    followedUsers.push(userId);

    // Determine increment
    let increment = 1;
    if (isAdmin === true) { // Admin adds random 200‚Äì500
      increment = Math.floor(Math.random() * (500 - 200 + 1)) + 200;
    }

    // Persist interest count and followed users in Firestore
    await jobRef.update({
      followedCount: firebase.firestore.FieldValue.increment(increment),
      followedUsers: followedUsers
    });

    // Fetch updated follower count to ensure UI matches Firestore
    const updatedDoc = await jobRef.get();
    const updatedCount = updatedDoc.data().followedCount || followedUsers.length;

    // Update UI
    if (followedCountElement) {
      followedCountElement.innerText = `${updatedCount} people following`;
    }

    showCustomAlert("‚úÖ You‚Äôve shown interest in this job.", "success");

    // ‚úÖ Notify Admin
    await firebase.firestore().collection("adminNotifications").add({
      type: "Job Interest",
      jobId: jobId,
      userId: userId,
      message: `üìå User with ID ${userId} has shown interest in job ${jobId}.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    });

    // ‚úÖ Notify Poster
    const posterId = jobData.userId;
    const jobTitle = jobData.jobType || "a job";
    const organization = jobData.organization || "an organization";

    if (posterId && posterId !== userId) {
      await firebase.firestore().collection("alerts").add({
        title: "üìå New Job Interest",
        message: `${user.displayName || user.email || "Someone"} is interested in your job: ${jobTitle} at ${organization}.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        targetUserId: posterId
      });
    }

    console.log("Admin and poster notified.");

  } catch (error) {
    console.error("Error updating followed count:", error);
    showCustomAlert("‚ùå Failed to register interest: " + error.message, "error");
  } finally {
    // Hide spinner
    if (spinner) spinner.style.display = "none";
  }
}

// ‚úÖ Close or Reopen BOM Job
async function closeJob(jobId) {
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show spinner

  try {
    const jobRef = db.collection("bomJobs").doc(jobId);
    const jobSnap = await jobRef.get();

    if (!jobSnap.exists) {
      showCustomAlert("‚ùå Job not found.", "error");
      return;
    }

    const jobData = jobSnap.data();
    const currentUser = firebase.auth().currentUser;

    if (!currentUser) {
      showCustomAlert("‚ùå You need to login first.", "error");
      return;
    }

// ‚úÖ Check if user is admin or the poster
const isPoster = currentUser?.uid === jobData.postedBy;
const isAdminUser = !!isAdmin; // reuse global flag

if (!isAdminUser && !isPoster) {
  showCustomAlert("‚ùå You do not have permission to change job status.", "error");
  return;
}

    const currentStatus = jobData.isClosed || false;
    const newStatus = !currentStatus;

    await jobRef.update({ isClosed: newStatus });

    if (newStatus) {
      showCustomAlert("‚úÖ Job marked as closed.", "success");

      // Admin notification for closure
      await db.collection("adminNotifications").add({
        type: "Job Closed",
        jobId: jobId,
        jobType: jobData.jobType || "",
        message: `üîí BOM Job "${jobData.jobType || 'Unknown'}" (ID: ${jobId}) has been marked as closed by ${currentUser.displayName || currentUser.email}.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });
    } else {
      showCustomAlert("‚ôªÔ∏è Job reopened successfully.", "success");

      // Admin notification for reopening
      await db.collection("adminNotifications").add({
        type: "Job Reopened",
        jobId: jobId,
        jobType: jobData.jobType || "",
        message: `‚úÖ BOM Job "${jobData.jobType || 'Unknown'}" (ID: ${jobId}) has been reopened by ${currentUser.displayName || currentUser.email}.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });
    }

    loadBOMJobs(); // Refresh job list

  } catch (error) {
    console.error("‚ùå Error updating job status:", error);
    showCustomAlert("‚ùå Failed to update job status: " + error.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none"; // Hide spinner
  }
}





function hasBomJobAccess() {
  const paidAt = localStorage.getItem("paidForBomJobs");
  if (!paidAt) return false;

  const paidDate = new Date(paidAt);
  const now = new Date();
  const diffDays = (now - paidDate) / (1000 * 60 * 60 * 24);

  return diffDays <= 14; // valid for 2 weeks
}

// Function to unlock BOM Job contacts or links and send admin notification
async function unlockBomJobs(jobId, amount) {
  if (!currentUser || !currentUser.uid) {
    showCustomAlert("Please login to unlock job contacts.", "error");
    return;
  }

  // Admin bypass: unlock immediately without payment
  if (isAdmin) {
    showCustomAlert(
      amount === 50
        ? "Job application link unlocked (Admin)!"
        : "Job contacts unlocked (Admin)!",
      "success"
    );
    loadBOMJobs(); // re-render job cards
    return;
  }

  // Decide what‚Äôs being unlocked
  const unlockWhat = amount === 50 ? "Job Application Link" : "Job Contacts";

  // Show payment modal
  showPaymentModalFor("unlock", amount, currentUser.uid, unlockWhat);

  const checkPaid = setInterval(async () => {
    const paidKey = amount === 50 ? `paidForBomJobLink-${jobId}` : `paidForBomJobs`;
    if (localStorage.getItem(paidKey) === "yes") {
      clearInterval(checkPaid);
      showCustomAlert(`${unlockWhat} unlocked!`, "success");
      closeUniversalModal();
      loadBOMJobs(); // re-render job cards

      // Send admin notification for unlocked BOM job
      try {
        const notifRef = db.collection("adminNotifications").doc();
        await notifRef.set({
          type: amount === 50 ? "BOM Job Link Unlock" : "BOM Job Contact Unlock",
          userId: currentUser.uid,
          message: `üí∞ ${currentUser.email} paid Ksh ${amount} to unlock ${unlockWhat} (valid for 2 weeks).`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        });

        console.log("Admin notification sent for unlocked BOM job", unlockWhat);
      } catch (error) {
        console.error("Failed to send admin notification:", error);
      }
    }
  }, 3000);
}
function applyBOMFilters() {
  const jobType = document.getElementById("filterJobType")?.value.toLowerCase() || "";
  const county = document.getElementById("filterCounty")?.value || "";
  const subcounty = document.getElementById("filterSubCounty")?.value || "";
  const minSalary = parseInt(document.getElementById("filterSalary")?.value) || 0;

  const filtered = bomJobsCache.filter(job => {
    return (
      (!jobType || job.jobType.toLowerCase().includes(jobType)) &&
      (!county || job.county === county) &&
      (!subcounty || job.subCounty === subcounty) &&
      (!minSalary || parseInt(job.salaryRange) >= minSalary)
    );
  });

  renderBOMJobs(filtered);

  if (filtered.length === 0) {
    showCustomAlert("üö´ No matching BOM jobs found.", "warning");
  }
}

// ‚úÖ Populate Sub-county Based on County
function handleCountyChange(countyId, subCountyId) {
  const county = document.getElementById(countyId).value;
  const subCountyEl = document.getElementById(subCountyId);
  subCountyEl.innerHTML = `<option value="">All Sub-counties</option>`;
  if (countySubCountyMap[county]) {
    countySubCountyMap[county].forEach(sub => {
      const option = document.createElement("option");
      option.value = sub;
      option.textContent = sub;
      subCountyEl.appendChild(option);
    });
  }
}
// Custom Delete Confirmation Function
async function confirmDeleteBOMJob(jobId) {
  // Show the custom modal and set message
  const modal = document.getElementById('customConfirmModal');
  const message = document.getElementById('confirmMessage');
  message.innerHTML = "Are you sure you want to delete this job posting?";
  
  // Show the modal
  modal.style.display = "flex";

  // Handle "Yes" button click
  document.getElementById('confirmYes').onclick = async function() {
    modal.style.display = "none";  // Hide modal
    document.getElementById("loadingSpinner").style.display = "flex";  // Show loading spinner

    try {
      const jobRef = bomRef.doc(jobId);
      const jobSnap = await jobRef.get();
      if (!jobSnap.exists) {
        showCustomAlert("‚ùå Job not found.", "error");
        return;
      }

      const jobData = jobSnap.data();
      const jobTitle = jobData.title || "Unknown Job";

      // Delete the job posting
      await jobRef.delete();
      showCustomAlert("‚úÖ Job deleted successfully!", "success");

      // Send admin notification
      const notifRef = db.collection("adminNotifications").doc();
      await notifRef.set({
        type: "Job Deletion",
        itemId: jobId,
        itemTitle: jobTitle,
        message: `üö® BOM job titled "${jobTitle}" was deleted.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Refresh the job listings
      loadBOMJobs(); 

    } catch (err) {
      showCustomAlert("‚ùå Failed to delete job: " + err.message, "error");
    } finally {
      document.getElementById("loadingSpinner").style.display = "none";
    }
  };

  // Handle "No" button click (close modal)
  document.getElementById('confirmNo').onclick = function() {
    modal.style.display = "none";
  };
}

  // ‚úÖ Alert Helper
  function showCustomAlert(msg, type = "info") {
    const el = document.createElement("div");
    el.className = "alert";
    el.style.backgroundColor = type === "error" ? "#f44336" : "#4CAF50";
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }

  // ‚úÖ Load home page first
  attachServiceFormSubmit();  // ‚úÖ Call this ONCE
showPage("home");

 // ‚úÖ Alert Utility
  function showCustomAlert(msg, type = "info") {
    const el = document.createElement("div");
    el.className = "alert";
    el.style.backgroundColor = type === "error" ? "#f44336" : "#4CAF50";
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }

// ‚úÖ Populate counties for soulmate form
["smCounty", "smWorkCounty"].forEach(populateCounties);
document.getElementById("soulmateForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!currentUser) {
    showCustomAlert("Please login to post your profile.", "error");
    return;
  }

  const age = parseInt(document.getElementById("smAge").value.trim());
  if (isNaN(age) || age < 18) {
    showCustomAlert("‚ö†Ô∏è Age must be 18 or above to post a profile.", "error");
    return;
  }

  const phone = document.getElementById("smPhone").value.trim();

  // ‚úÖ Kenyan phone validation
  if (!/^07\d{8}$/.test(phone) && !/^2547\d{8}$/.test(phone)) {
    showCustomAlert("‚ö†Ô∏è Enter a valid Kenyan phone number (e.g. 0712345678 or 254712345678).", "error");
    return;
  }

  // ‚úÖ Prevent duplicate phone use
  try {
    const existing = await soulmateRef.where("phone", "==", phone).get();
    if (!existing.empty) {
      showCustomAlert("‚ö†Ô∏è This phone number is already used in another profile.", "error");
      return;
    }
  } catch (err) {
    showCustomAlert("‚ùå Failed to check existing phone numbers.", "error");
    return;
  }

  const photoFile = document.getElementById("smPhoto").files[0];
  let photoURL = "";

  // Show the loading spinner while processing
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    // ‚úÖ Upload photo if available
    if (photoFile) {
      const photoPath = `soulmatePhotos/${Date.now()}_${photoFile.name}`;
      const photoSnap = await storage.ref(photoPath).put(photoFile);
      photoURL = await photoSnap.ref.getDownloadURL();
    }

    const data = {
      name: document.getElementById("smName").value.trim(),
      county: document.getElementById("smCounty").value,
      subCounty: document.getElementById("smSubCounty").value,
      age,
      tribe: document.getElementById("smTribe").value.trim(),
      sex: document.getElementById("smSex").value,
      occupation: document.getElementById("smOccupation").value.trim(),
      workCounty: document.getElementById("smWorkCounty").value,
      phone,
      status: document.getElementById("smStatus").value,
      kids: document.getElementById("smKids").value,
      photoURL,
      postedBy: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    await soulmateRef.add(data);
    showCustomAlert("‚úÖ Profile submitted!", "success");
    document.getElementById("soulmateForm").reset();
    loadSoulmates();

    // ‚úÖ Notify Admin
    await db.collection("adminNotifications").add({
      type: "Soulmate Profile",
      message: `New soulmate profile posted: ${data.name}, Age: ${data.age}, Phone: ${data.phone}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });

    // ‚úÖ Notify All Users via Global Alert
    await db.collection("alerts").add({
      title: "üíò New Soulmate Profile",
      message: `${data.name} (${data.sex}, ${data.age} yrs) just posted a profile.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null // public to all users
    });

  } catch (err) {
    console.error("Error saving profile:", err);
    showCustomAlert("‚ùå Error saving profile: " + err.message, "error");
  } finally {
    // Hide the spinner once the process completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
});

// Real-time listener for like changes on the profile
function listenForLikeChanges(profileId) {
  soulmateRef.doc(profileId).collection("likes").onSnapshot(snapshot => {
    const count = snapshot.size; // The number of likes for this profile
    const likeCountSpan = document.getElementById(`likeCount-${profileId}`);
    
    if (likeCountSpan) {
      likeCountSpan.textContent = `${count} Like${count !== 1 ? 's' : ''}`;
    }
  });
}

// Function to toggle like (like/unlike)
async function toggleLike(profileId) {
  const user = firebase.auth().currentUser;
  if (!user) {
    alert("Please login to like profiles.");
    return;
  }

  const likeRef = soulmateRef.doc(profileId).collection("likes").doc(user.uid);
  const likeDoc = await likeRef.get();

  const profileDoc = await soulmateRef.doc(profileId).get();
  const profileData = profileDoc.data();
  const theirUid = profileData?.postedBy;

  if (likeDoc.exists) {
    // üëé Unlike
    await likeRef.delete();
  } else {
    // üëç Like
    await likeRef.set({
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      user: user.displayName || user.email || user.uid
    });

    // ‚úÖ Match check
    if (theirUid && theirUid !== user.uid) {
      const reverseLikeDoc = await soulmateRef.doc(profileId).collection("likes").doc(theirUid).get();
      if (reverseLikeDoc.exists) {
        showMatchCelebration(); // üéâ trigger match effect
      }
    }

    // ‚úÖ Send Alert to Profile Owner
    if (theirUid && theirUid !== user.uid) {
      await db.collection("alerts").add({
        title: "üíñ New Like",
        message: `${user.displayName || "Someone"} liked your soulmate profile.`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        targetUserId: theirUid
      });
    }
  }

  updateLikeUI(profileId); // Update the UI after liking/unliking
}


// Function to update like count and button status
async function updateLikeUI(profileId) {
  const user = firebase.auth().currentUser;
  const likeSnap = await soulmateRef.doc(profileId).collection("likes").get();
  const count = likeSnap.size; // The number of likes for this profile

  const likeCountSpan = document.getElementById(`likeCount-${profileId}`);
  const likeBtn = document.getElementById(`likeBtn-${profileId}`);

  if (likeCountSpan) likeCountSpan.textContent = `${count} Like${count !== 1 ? 's' : ''}`;

  if (user && likeBtn) {
    const liked = await soulmateRef.doc(profileId).collection("likes").doc(user.uid).get();
    likeBtn.innerHTML = liked.exists ? "‚ù§Ô∏è Liked" : "ü§ç Like";
  }
}

async function showLikes(profileId) {
  const likesRef = soulmateRef.doc(profileId).collection("likes");
  const snapshot = await likesRef.get();

  if (snapshot.empty) {
    alert("No likes yet.");
    return;
  }

  const likesList = document.getElementById("likesList");
  likesList.innerHTML = ""; // Clear previous entries

  for (const doc of snapshot.docs) {
    const userName = doc.data().user || `User ID: ${doc.id}`;
    const listItem = document.createElement("li");
    listItem.textContent = userName;
    likesList.appendChild(listItem);
  }

  // Show modal
  document.getElementById("likesModal").style.display = "flex";

  // Notify admin
  sendAdminNotification(
    "Soulmate Profile Likes Viewed",
    currentUser.uid,
    `The likes for soulmate profile ID ${profileId} were viewed.`
  );
}
function closeLikesModal() {
  document.getElementById("likesModal").style.display = "none";
}

function handleBackdropClick(event) {
  const modalContent = document.querySelector(".likes-modal-content");
  if (!modalContent.contains(event.target)) {
    closeLikesModal();
  }
}


// Helper function to send admin notification
async function sendAdminNotification(type, userId, message) {
  try {
    // Get user details (name/email) based on the userId
    const userSnap = await db.collection("users").doc(userId).get();
    const user = userSnap.data();

    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: type,
      userId: userId,
      userName: user ? user.displayName || user.email : "Unknown User",
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: message
    });

    console.log("Admin notification created: " + message);
  } catch (error) {
    console.error("Error sending admin notification:", error);
  }
}



// Function to toggle visibility of admin buttons
function toggleAdminButtons(id) {
  const adminButtons = document.getElementById(`admin-buttons-${id}`);
  if (adminButtons.style.display === "none") {
    adminButtons.style.display = "flex";
  } else {
    adminButtons.style.display = "none";
  }
}
let soulmateBatch = []; 
let soulmateBatchSize = 10; 
let soulmateBatchIndex = 0;
let isLoadingSoulmates = false;
let soulmateUnsubscribe;
let lastSeenSoulmateTimestamp = localStorage.getItem("lastSeenSoulmateTimestamp") 
    ? new Date(localStorage.getItem("lastSeenSoulmateTimestamp")) 
    : null;
let soulmateBadgeCount = 0;

// üîπ Load soulmate profiles with real-time updates
async function loadSoulmates(reset = true) {
  const container = document.querySelector("#soulmateContainer");
  const trendingContainer = document.querySelector("#trendingContainer");
  const soulmateBadge = document.getElementById("soulmateBadge");

  if (reset) {
    container.innerHTML = "";
    if (trendingContainer) trendingContainer.innerHTML = "";
    soulmateBatch = [];
    soulmateBatchIndex = 0;
  }

  if (!auth.currentUser) return;

  if (soulmateUnsubscribe) soulmateUnsubscribe(); // detach old listener

  soulmateUnsubscribe = soulmateRef.orderBy("timestamp", "desc").onSnapshot(snapshot => {
    if (!auth.currentUser) return;

    const now = new Date();

    const minAge = parseInt(document.getElementById("filterMinAge")?.value || 0);
    const maxAge = parseInt(document.getElementById("filterMaxAge")?.value || 100);
    const tribeFilter = document.getElementById("filterTribe")?.value.toLowerCase().trim() || "";
    const sexFilter = document.getElementById("filterSex")?.value || "";
    const verifiedFilter = document.getElementById("filterVerified")?.value || "";
    const hasPaid = localStorage.getItem("paidForSoulmates") === "yes";

    let boosted = [], normal = [];

    snapshot.docChanges().forEach(change => {
      if (change.type === "added") {
        const d = change.doc.data();
        const id = change.doc.id;
        const ts = d.timestamp?.toDate();

        // ‚úÖ Immediately treat as new if timestamp > last seen
        if (!lastSeenSoulmateTimestamp || (ts && ts > lastSeenSoulmateTimestamp)) {
          prependNewSoulmate({ id, ...d }); // show card instantly

          // üî• Update badge LIVE
          soulmateBadgeCount++;
          if (soulmateBadge) {
            soulmateBadge.style.display = "inline-block";
            soulmateBadge.textContent = soulmateBadgeCount;
          }

          lastSeenSoulmateTimestamp = ts;
          localStorage.setItem("lastSeenSoulmateTimestamp", lastSeenSoulmateTimestamp.toISOString());
        }

        // Filtering
        const age = parseInt(d.age) || 0;
        if (age < minAge || age > maxAge) return;
        if (tribeFilter && (!d.tribe || !d.tribe.toLowerCase().includes(tribeFilter))) return;
        if (sexFilter && d.sex !== sexFilter) return;
        if (verifiedFilter === "verified" && !d.verified) return;
        if (verifiedFilter === "unverified" && d.verified) return;

        const boostExpiry = d.boostExpiry?.toDate?.();
        const isBoosted = d.boosted && boostExpiry && boostExpiry > now;
        if (d.boosted && (!boostExpiry || boostExpiry <= now)) {
          soulmateRef.doc(id).update({ boosted: false, boostExpiry: null }).catch(console.warn);
        }

        const profile = { id, ...d, isBoosted };
        if (isBoosted) {
          boosted.push(profile);
          if (trendingContainer) trendingBoostedItems.push({ id, ...d, type: 'soulmate' });
        } else {
          normal.push(profile);
        }
      }
    });

    soulmateBatch = [...boosted, ...normal].sort((a, b) => {
      const aBoosted = a.isBoosted && a.boostExpiry > now;
      const bBoosted = b.isBoosted && b.boostExpiry > now;
      if (aBoosted && bBoosted) return (b.boostExpiry || 0) - (a.boostExpiry || 0);
      if (aBoosted && !bBoosted) return -1;
      if (!aBoosted && bBoosted) return 1;
      return (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0);
    });

    if (reset) soulmateBatchIndex = 0;
    renderSoulmateBatch();
  });
}

// üîπ Render next batch of soulmate cards
function renderSoulmateBatch() {
  const container = document.querySelector("#soulmateContainer");
  if (!container) return;

  const nextBatch = soulmateBatch.slice(soulmateBatchIndex, soulmateBatchIndex + soulmateBatchSize);
  soulmateBatchIndex += soulmateBatchSize;

  const fragment = document.createDocumentFragment();

  nextBatch.forEach(d => {
    renderSoulmateCard(d, fragment);
  });

  container.appendChild(fragment);
  isLoadingSoulmates = false;
}

// üîπ Render one soulmate card
function renderSoulmateCard(d, container) {
  const id = d.id;
  const isPoster = currentUser && (d.postedBy === currentUser.uid);
  const isAdminUser = isAdmin === true;
  const totalLikes = d.likes || 0;
  const hasPaid = localStorage.getItem("paidForSoulmates") === "yes";

  const card = document.createElement("div");
  card.className = "soulmate-card";
  card.id = `soulmate-${id}`;
  card.style = `
    background: #e6f7ff;
    padding: 14px;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    text-align: left;
    position: relative;
    min-width: 250px;
    max-width: 300px;
    box-sizing: border-box;
  `;

  const images = d.photos || [];
  const profileImageHTML = images.length > 0 ? ` 
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      ${images.map((photo, index) => `<img src="${photo}" alt="Profile Image ${index+1}" style="width: 60px; height: 60px; object-fit: cover; margin-bottom: 10px; border-radius: 8px; cursor: pointer;" onclick="openImageModal(${index}, ${JSON.stringify(images)})">`).join('')}
    </div>` : `<div style="width: 100%; height: 200px; background: #f0f0f0; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; color: #888; cursor: pointer;" onclick="openImageModal()">No Image</div>`;

 const contactHTML = `<div style="margin:4px 0; font-family: Arial, sans-serif;">
  <!-- Phone Number -->
  <div style="border: 2px solid #4caf50; background-color: #4caf50; padding: 8px 16px; border-radius: 12px; display: flex; align-items: center; margin-bottom: 8px; max-width: 180px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <span style="font-size: 18px; color:white; font-weight: bold;">${d.phone}</span>
    <i class="fas fa-phone-alt" style="margin-left: 8px; color:white;"></i>
  </div>

  <!-- WhatsApp -->
  <div style="border: 2px solid #25D366; background-color: #25D366; padding: 8px 16px; border-radius: 12px; display: flex; align-items: center; max-width: 180px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <span style="font-size: 18px; color:white; font-weight: bold;">WhatsApp</span>
    <i class="fab fa-whatsapp" style="margin-left: 8px; color:white;"></i>
  </div>
</div>`;

const blurredContactHTML = `<div style="display:flex; flex-direction:column; gap:12px; margin-top:12px; font-family: 'Arial', sans-serif;">
  <!-- Phone Number Blur -->
  <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-radius:12px; background:#f9f9f9; border:2px solid #ccc; font-weight: bold; color:#999; font-size:18px; filter: blur(4px); transition: filter 0.3s ease-in-out; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
    üìû 0700000000
  </div>
  
  <!-- WhatsApp Blur -->
  <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-radius:12px; background:#f9f9f9; border:2px solid #ccc; font-weight: bold; color:#999; font-size:18px; filter: blur(4px); transition: filter 0.3s ease-in-out; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
    üí¨ WhatsApp
  </div>

  <!-- Unlock Message -->
  <div style="color:crimson; font-size:16px; font-weight:bold; margin-top:8px;">üîí Pay Ksh 200 to Unlock Contacts </div>
  
  <!-- Pay Button -->
  <button onclick="handleSoulmateAction('${id}', 'unlock')" 
    style="margin-top:8px; background:crimson; color:white; border:none; padding:10px 20px; border-radius:12px; font-weight:bold; cursor:pointer; font-size:18px; transition: background 0.3s ease, transform 0.2s ease;">
    üí≥ Pay
  </button>
</div>`;

  const profileContent = d.isClosed ? `
    <p style="color:#999;">Profile Locked</p>
    <h4 style="margin:0 0 6px;font-size:16px;"><strong>Name:</strong> ${d.name}</h4>
  ` : `
    <h4 style="margin:0 0 6px;font-size:16px;"><strong>Name:</strong> ${d.name}</h4>
    <p style="margin:0;color:#ff5722;"><strong>Sex:</strong> ${d.sex ? `${d.sex === 'Male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${d.sex}` : '‚Äî'}</p>
    <p style="margin:0;"><strong>Location:</strong> <span style="color:#009688;">${d.county || '‚Äî'}</span>${d.subCounty ? ` / <span style="color:#6a1b9a;">${d.subCounty}</span>` : ''}</p>
    <p style="margin:0;color:#6a1b9a;"><strong>Tribe:</strong> ${d.tribe || '‚Äî'}</p>
    <p style="margin:0;color:#ff5722;"><strong>Age:</strong> ${d.age}</p>
    <p style="margin:0;color:#795548;"><strong>Status:</strong> ${d.status || '‚Äî'} ${d.status === "Single" ? "üíî" : d.status === "Married" ? "üíç" : ""}</p>
    <p style="margin:0;color:#607d8b;"><strong>Occupation:</strong> ${d.occupation}</p>
    <div style="margin-top:6px;">
      ${hasPaid || isPoster || isAdminUser ? contactHTML : blurredContactHTML}
    </div>`;

  const adminButtons = (isAdminUser || isPoster) ? `
    <button onclick="toggleAdminButtons('${id}')"
      style="background:#007BFF;color:white;border:none;padding:6px 14px;border-radius:8px;cursor:pointer;margin-top:10px;">
      üîΩ More details 
    </button>
    <div id="admin-buttons-${id}" style="margin-top:10px; display:none; flex-wrap:wrap; gap:10px;">
      <button onclick="deleteSoulmate('${id}')"
        style="background:#dc3545; color:white; border:none; padding:6px 14px; border-radius:8px; cursor:pointer;">
        üóëÔ∏è Delete
      </button>
      <button onclick="handleSoulmateAction('${id}', 'boost')"
        style="background:#ff9800; color:white; border:none; padding:6px 14px; border-radius:8px; cursor:pointer;">
        üöÄ Boost
      </button>
      <button onclick="toggleSoulmateStatus('${id}', ${d.isClosed})"
        style="background:${d.isClosed ? '#28a745' : '#6c757d'}; color:white; border:none; padding:6px 14px; border-radius:8px; cursor:pointer;">
        ${d.isClosed ? '‚ôªÔ∏è Reopen' : 'üö´ Mark as Closed'}
      </button>
      ${isAdminUser ? `
        <button onclick="adminVerifyItem('soulmate', '${id}')"
          style="background:#007BFF;color:white;border:none;padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer;">
          üõ°Ô∏è Admin Verify (Free)
        </button>
        <button onclick="adminBoostItem('soulmate', '${id}')"
          style="background:#FF5722;color:white;border:none;padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer;">
          üöÄ Admin Boost (Free)
        </button>` : `
        <button onclick="showPaymentModalFor('soulmateVerification', 200, '${id}', '${d.name || ''}')"
          style="background:#4CAF50;color:white;border:none;padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer;">
          ‚úÖ Verify Now ‚Äì Ksh 200
        </button>`}
    </div>
  ` : "";

  const likeButtonHTML = `
    <button id="likeBtn-${id}" onclick="toggleLike('${id}')"
      style="background:#e91e63; color:white; border:none; padding:5px 12px; border-radius:50px; cursor:pointer;">
      ü§ç Like
    </button>
    <span id="likeCount-${id}" style="font-weight:bold; margin-left:10px;">
      ${totalLikes} Likes
    </span>
  `;

  card.innerHTML = `
    ${profileImageHTML}
    ${d.verified ? `<div class="verified-badge" style="position: absolute; top: 8px; right: 8px; background-color: #1DA1F2; color: white; border-radius: 25px; padding: 4px 10px; display: flex; align-items: center; font-size: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); transition: transform 0.3s ease-in-out; cursor: pointer;">
        <i class="fas fa-check" style="transform: scale(1.2); margin-right: 5px;"></i>
        Verified
    </div>` : ""}
    ${profileContent}
    ${likeButtonHTML}
    ${adminButtons}
  `;

  container.appendChild(card);
  updateLikeUI(id);
  listenForLikeChanges(id);
}

// üîπ Infinite scroll
window.addEventListener('scroll', () => {
  if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300) {
    if (!isLoadingSoulmates && soulmateBatchIndex < soulmateBatch.length) {
      renderSoulmateBatch();
    }
  }
});

// üîπ Reset soulmate badge when clicked
function resetSoulmateBadge() {
  const soulmateBadge = document.getElementById("soulmateBadge");
  if (soulmateBadge) {
    soulmateBadge.style.display = "none";
    soulmateBadge.textContent = "0";
    soulmateBadgeCount = 0;
    lastSeenSoulmateTimestamp = new Date();
    localStorage.setItem("lastSeenSoulmateTimestamp", lastSeenSoulmateTimestamp.toISOString());
  }
}

// üîπ Prepend new soulmate card in real-time
function prependNewSoulmate(d) {
  const container = document.querySelector("#soulmateContainer");
  if (!container) return;

  const fragment = document.createDocumentFragment();
  renderSoulmateCard(d, fragment);
  container.prepend(fragment);
}

// üîπ Initialize
loadSoulmates(true);


async function toggleProfileLock(profileId, isLocked) {
  try {
    // Reference to the soulmate document
    const profileRef = soulmateRef.doc(profileId);
    
    // Toggle the lock/unlock state
    await profileRef.update({
      isClosed: !isLocked // If it's locked, unlock it; if it's unlocked, lock it
    });

    // Optionally, provide feedback to the user
    alert(isLocked ? "Profile Unlocked" : "Profile Locked");

    // Reload the profiles to reflect the changes
    loadSoulmates(); // Refresh the profiles

  } catch (error) {
    console.error("Error toggling profile lock:", error);
    alert("An error occurred while updating the profile.");
  }
}

function filterSoulmates() {
  const filterVerified = document.getElementById("filterVerified").value;
  // Filter logic based on verification status
  const filteredProfiles = sortedProfiles.filter(profile => {
    if (filterVerified === 'verified') return profile.verified;
    if (filterVerified === 'unverified') return !profile.verified;
    return true; // Show all profiles if no filter
  });
  renderProfiles(filteredProfiles);
}
function resetSoulmateFilters() {
  document.getElementById("filterMinAge").value = "";
  document.getElementById("filterMaxAge").value = "";
  document.getElementById("filterTribe").value = "";
  document.getElementById("filterSex").value = "";

  showCustomAlert("‚úÖ Filters cleared. Showing all soulmates.", "info");

  loadSoulmates();
}

// Function to open image modal
function openImageModal(index = 0, images = []) {
  const modal = document.createElement('div');
  modal.classList.add('image-modal');
  modal.innerHTML = `
    <div class="modal-content">
      <span class="close" onclick="closeImageModal()">√ó</span>
      <div class="carousel">
        ${images.map((img, idx) => `
          <img src="${img}" style="width: 100%; max-height: 80vh; object-fit: contain; display: ${index === idx ? 'block' : 'none'};" class="carousel-image">
        `).join('')}
      </div>
      <button class="prev" onclick="changeImage(-1)">‚ùÆ</button>
      <button class="next" onclick="changeImage(1)">‚ùØ</button>
    </div>
  `;
  document.body.appendChild(modal);
}

// Function to close the image modal
function closeImageModal() {
  const modal = document.querySelector('.image-modal');
  if (modal) modal.remove(); // Remove the modal from the DOM
}

// Function to change image in modal with lazy loading
function changeImage(direction) {
  const images = document.querySelectorAll('.carousel-image');
  let currentIndex = Array.from(images).findIndex(image => image.style.display === 'block');
  
  // Calculate new index with wrap-around logic
  currentIndex = (currentIndex + direction + images.length) % images.length;

  // Loop through images and display the one that matches the new index
  images.forEach((image, idx) => {
    image.style.display = (idx === currentIndex) ? 'block' : 'none';

    // If the image is displayed, trigger lazy loading
    if (idx === currentIndex && !image.src) {
      image.src = image.getAttribute('data-src');  // Set the src attribute to load the image
    }
  });
}

// Function to open image modal with multiple images (updated for lazy loading)
function openImageModal(index = 0, images = []) {
  const modal = document.createElement('div');
  modal.classList.add('image-modal');
  modal.innerHTML = `
    <div class="modal-content">
      <span class="close" onclick="closeImageModal()">√ó</span>
      <div class="carousel">
        ${images.length > 0 ? images.map((img, idx) => `
          <img data-src="${img}" style="width: 100%; max-height: 80vh; object-fit: contain; display: ${index === idx ? 'block' : 'none'};" class="carousel-image lazy-load">
        `).join('') : '<p style="text-align: center;">No Images Available</p>'}
      </div>
      <button class="prev" onclick="changeImage(-1)">‚ùÆ Prev</button>
      <button class="next" onclick="changeImage(1)">‚ùØ Next</button>
    </div>
  `;
  document.body.appendChild(modal);

  // Trigger lazy loading for images in the modal
  const imagesInModal = document.querySelectorAll('.lazy-load');
  imagesInModal.forEach(image => {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const image = entry.target;
          image.src = image.getAttribute('data-src'); // Load image when in view
          observer.unobserve(image); // Stop observing after loading
        }
      });
    }, {
      root: null,
      threshold: 0.1 // Trigger when 10% of the image is visible
    });
    observer.observe(image);
  });
}





async function verifySoulmateDirectly(soulmateId) {
  try {
    await soulmateRef.doc(soulmateId).set({
      verified: true
    }, { merge: true });

    showCustomAlert("‚úÖ Soulmate profile verified successfully!", "success");
    loadSoulmates(); // Refresh list immediately
  } catch (err) {
    console.error("‚ùå Error verifying soulmate:", err);
    showCustomAlert("‚ùå Failed to verify soulmate: " + err.message, "error");
  }
}
async function handleSoulmateAction(id, action) {
  const userEmail = currentUser?.email || "";

  // ‚úÖ Use global isAdmin instead of hardcoded emails
  const isAdminUser = !!isAdmin;

  // Show the spinner while processing
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    if (isAdminUser) {
      const soulmateDoc = await soulmateRef.doc(id).get();
      const soulmateData = soulmateDoc.data();

      if (action === 'boost') {
        // Admin boosts the profile
        const boostExpiry = new Date();
        boostExpiry.setDate(boostExpiry.getDate() + 7); // Boost expires in 7 days

        await soulmateRef.doc(id).update({
          boosted: true,
          boostExpiry: boostExpiry
        });

        // Admin boost success message
        showCustomAlert("‚úÖ Profile boosted for FREE by Admin", "success");

        // Send admin notification for boosting the profile
        sendAdminNotification(
          "Soulmate Profile Boosted (Admin)", 
          soulmateData.postedBy, 
          `The soulmate profile "${soulmateData.name}" was boosted for FREE by Admin. Boost expires in 7 days.`
        );

      } else if (action === 'unlock') {
        // Admin unlocks contacts
        await soulmateRef.doc(id).update({
          contactsUnlocked: true
        });

        // Admin success message
        showCustomAlert("‚úÖ Contacts unlocked for FREE by Admin", "success");

        // Send admin notification for unlocking contacts
        sendAdminNotification(
          "Soulmate Contacts Unlocked (Admin)", 
          soulmateData.postedBy, 
          `The soulmate profile "${soulmateData.name}" had its contacts unlocked for FREE by Admin.`
        );
      } else if (action === 'verify') {
        // Admin verifies the profile
        await soulmateRef.doc(id).update({
          verified: true
        });

        // Admin success message
        showCustomAlert("‚úÖ Profile verified for FREE by Admin", "success");

        // Send admin notification for verification
        sendAdminNotification(
          "Soulmate Profile Verified (Admin)", 
          soulmateData.postedBy, 
          `The soulmate profile "${soulmateData.name}" was verified for FREE by Admin.`
        );
      }

      loadSoulmates(); // Refresh the list
    } else {
      if (action === 'boost') {
        // User is prompted to pay for boosting the profile
        const boostAmount = 250;
        showPaymentModalFor("boost", boostAmount, id, "Your Soulmate Profile");
      } else if (action === 'unlock') {
        // User is prompted to pay for unlocking contacts with correct message
        const unlockAmount = 150; // Amount to unlock contacts
        showPaymentModalFor("unlock", unlockAmount, id, "Pay to Unlock Contacts");
      } else if (action === 'verify') {
        // User is prompted to pay for verification
        const verifyAmount = 200; // Amount to verify profile
        showPaymentModalFor("verify", verifyAmount, id, "Pay to Verify Your Soulmate Profile");
      }
    }
  } catch (error) {
    console.error(`‚ùå Error handling soulmate action (${action}):`, error);
    showCustomAlert(`‚ùå Failed to perform action: ${error.message}`, "error");
  }

  // Hide the spinner once the process is complete
  document.getElementById("loadingSpinner").style.display = "none";
}


// Helper function to send an admin notification
async function sendAdminNotification(type, userId, message) {
  try {
    // Get user details (name/email) based on the userId
    const userSnap = await db.collection("users").doc(userId).get();
    const user = userSnap.data();

    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: type,
      userId: userId,
      userName: user ? user.displayName || user.email : "Unknown User",
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: message
    });

    console.log("Admin notification created: " + message);
  } catch (error) {
    console.error("Error sending admin notification:", error);
  }
}

async function toggleSoulmateStatus(id, currentStatus) {
  // Show the spinner while processing
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    const newStatus = !currentStatus;

    await db.collection("soulmates").doc(id).update({
      isClosed: newStatus
    });

    if (newStatus) {
      showCustomAlert("‚úÖ Soulmate marked as closed.", "success");
    } else {
      showCustomAlert("‚ôªÔ∏è Soulmate reopened successfully.", "success");
    }

    loadSoulmates(); // Refresh list

    // Optional: Send admin notification
    await db.collection("adminNotifications").add({
      type: newStatus ? "Soulmate Closed" : "Soulmate Reopened",
      soulmateId: id,
      message: `${newStatus ? "üîí" : "‚úÖ"} Soulmate with ID ${id} has been ${newStatus ? "closed" : "reopened"}.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    });

  } catch (error) {
    console.error("‚ùå Error updating soulmate status:", error);
    showCustomAlert("‚ùå Failed to update status: " + error.message, "error");
  } finally {
    // Hide the spinner once the process is complete
    document.getElementById("loadingSpinner").style.display = "none";
  }
}


// Helper function to send an admin notification
async function sendAdminNotification(type, userId, message) {
  try {
    // Get user details (name/email) based on the userId
    const userSnap = await db.collection("users").doc(userId).get();
    const user = userSnap.data();

    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: type,
      userId: userId,
      userName: user ? user.displayName || user.email : "Unknown User",
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: message
    });

    console.log("Admin notification created: " + message);
  } catch (error) {
    console.error("Error sending admin notification:", error);
  }
}


function showCustomAlert(message, type = "info") {
  const alertBox = document.createElement("div");
  alertBox.textContent = message;
  alertBox.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === "success" ? "#4caf50" : type === "error" ? "#f44336" : "#2196f3"};
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    z-index: 9999;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    font-size: 14px;
  `;
  document.body.appendChild(alertBox);
  setTimeout(() => alertBox.remove(), 3000);
}

function showMatchCelebration() {
  // üéä Confetti (if available)
  if (typeof confetti !== "undefined") {
    confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
  }

  // üíñ Falling Emojis
  const emojis = ["üíò", "‚ù§Ô∏è", "üíñ", "üéâ", "üòç"];
  for (let i = 0; i < 20; i++) {
    const emoji = document.createElement("div");
    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    emoji.style.position = "fixed";
    emoji.style.left = `${Math.random() * 100}vw`;
    emoji.style.top = "100vh";
    emoji.style.fontSize = "32px";
    emoji.style.zIndex = "9999";
    emoji.style.animation = `floatUp ${3 + Math.random() * 2}s ease-out forwards`;
    document.body.appendChild(emoji);
    setTimeout(() => emoji.remove(), 5000);
  }

  // ‚úÖ Custom celebration popup
  const popup = document.createElement("div");
  popup.innerHTML = `<strong>üéâ It's a Match!</strong><br>You both liked each other!`;
  popup.style.position = "fixed";
  popup.style.top = "50%";
  popup.style.left = "50%";
  popup.style.transform = "translate(-50%, -50%)";
  popup.style.background = "#d32f2f";
  popup.style.color = "#fff";
  popup.style.padding = "20px 30px";
  popup.style.borderRadius = "12px";
  popup.style.fontSize = "18px";
  popup.style.textAlign = "center";
  popup.style.boxShadow = "0 4px 15px rgba(0,0,0,0.2)";
  popup.style.zIndex = "10000";
  document.body.appendChild(popup);

  // Auto-dismiss after 4.5s
  setTimeout(() => popup.remove(), 4500);
}




// Helper function to send an admin notification
async function sendAdminNotification(type, userId, message) {
  try {
    // Get user details (name/email) based on the userId
    const userSnap = await db.collection("users").doc(userId).get();
    const user = userSnap.data();

    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: type,
      userId: userId,
      userName: user ? user.displayName || user.email : "Unknown User",
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: message
    });

    console.log("Admin notification created: " + message);
  } catch (error) {
    console.error("Error sending admin notification:", error);
  }
}



function showSoulmateModal(data) {
  const photo = data.photoURL || 'default.jpg';

  // üëÄ Conditionally show phone only if paid
  const phoneSection = hasPaid || isAdmin ? `
    <p><strong>Phone:</strong> 
      <a href="tel:${data.phone}" style="color:green;">${data.phone}</a><br>
      <a href="https://wa.me/254${data.phone.replace(/^0/, '')}" target="_blank" style="color:#25D366;">WhatsApp</a>
    </p>
  ` : `
    <p><strong>Phone:</strong> <span style="color:crimson;">Locked ‚Äî <a href="#" onclick="showPaymentModal()">Unlock Now</a></span></p>
  `;

  const detailHTML = `
    <p style="text-align:center;">
      <img src="${photo}" alt="Photo of ${data.name}" 
           style="max-width:90px; height:90px; border-radius:50%; object-fit:cover; border:4px solid #e91e63; box-shadow: 0 0 8px #e91e63;">
    </p>
    <p><strong>Name:</strong> ${data.name}</p>
    <p><strong>County:</strong> ${data.county}</p>
    <p><strong>Age:</strong> ${data.age}</p>
    <p><strong>Tribe:</strong> ${data.tribe}</p>
    <p><strong>Sex:</strong> ${data.sex}</p>
    <p><strong>Occupation:</strong> ${data.occupation}</p>
    <p><strong>Work County:</strong> ${data.workCounty}</p>
    <p><strong>Marital Status:</strong> ${data.status || 'Not specified'}</p>
    <p><strong>Has Kids:</strong> ${data.kids || 'Not specified'}</p>
    ${phoneSection}
    <div style="text-align:center; margin-top:10px;">
      <button onclick="sendInterest('${data.name}')" style="padding:8px 14px; background:#ff4081; border:none; border-radius:5px; color:#fff; cursor:pointer;">
        ‚ù§Ô∏è Send Interest
      </button>
    </div>
  `;

  document.getElementById("soulmateDetails").innerHTML = detailHTML;
  document.getElementById("soulmateModal").style.display = "block";
}

async function sendInterest(toName) {
  if (!isLoggedIn || !currentUser) {
    showCustomAlert("Please login to send interest.", "error");
    return;
  }

  // Show the spinner while the interest is being sent
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    await db.collection("soulmateInterests").add({
      fromUserId: currentUser.uid,
      fromName: currentUser.displayName || currentUser.email,
      toName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    showCustomAlert(`‚ù§Ô∏è Interest sent to ${toName}!`, "success");

  } catch (err) {
    showCustomAlert("Error sending interest: " + err.message, "error");
  } finally {
    // Hide the spinner once the process completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
}

async function isMutualMatch(name) {
  const myName = currentUser.displayName || currentUser.email;

  const sent = await db.collection("soulmateInterests")
    .where("fromUserId", "==", currentUser.uid)
    .where("toName", "==", name).get();

  const received = await db.collection("soulmateInterests")
    .where("fromName", "==", name)
    .where("toName", "==", myName).get();

  return !sent.empty && !received.empty;
}
function closeSoulmateModal() {
  document.getElementById("soulmateModal").style.display = "none";
}

  // ‚úÖ Populate counties
  populateCounties("svcCounty");
  populateCounties("filterCounty");


// ‚úÖ Attach Submit Logic Once
function attachServiceFormSubmit() {
  const form = document.getElementById("serviceForm");
  form.addEventListener("submit", submitServiceHandler);
}

async function submitServiceHandler(e) {
  e.preventDefault();

  if (!isLoggedIn || !currentUser) {
    showPage("login");
    return alert("You must be logged in.");
  }

  // Show the spinner while processing
  document.getElementById("loadingSpinner").style.display = "flex";

  // ‚úÖ Check how many services this user has already posted
  const serviceCountSnap = await servicesRef.where("postedBy", "==", currentUser.uid).get();
  const totalServices = serviceCountSnap.size;

  // ‚úÖ If already posted 1 service, require payment ‚Äî unless admin
  if (totalServices >= 1 && !isAdmin) {
    showPaymentModalFor("service", 200, currentUser.uid, "Post Extra Service");
    document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner if payment modal is shown
    return;
  }

  // ‚úÖ Collect form input values
  const data = {
    name: document.getElementById("svcName").value.trim(),
    county: document.getElementById("svcCounty").value,
    subcounty: document.getElementById("svcSubCounty").value.trim(),
    occupation: document.getElementById("svcOccupation").value.trim(),
    experience: document.getElementById("svcExperience").value,
    phone: document.getElementById("svcPhone").value.trim(),
    postedBy: currentUser.uid,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  // ‚úÖ Validate all fields
  if (Object.values(data).some(v => !v)) {
    document.getElementById("loadingSpinner").style.display = "none"; // Hide spinner if validation fails
    return alert("Please fill all fields.");
  }

  try {
    // ‚úÖ Save to Firestore
    await servicesRef.add(data);
    showCustomAlert("‚úÖ Service posted!", "success");
    document.getElementById("serviceForm").reset();
    loadServices();

    // ‚úÖ Admin Notification
    await db.collection("adminNotifications").add({
      type: "Marketplace Post",
      message: `New service posted: ${data.name} (${data.occupation}), County: ${data.county}, Phone: ${data.phone}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });

    // ‚úÖ Public Alert for All Users
    await db.collection("alerts").add({
      title: "üõ†Ô∏è New Service",
      message: `${data.name} offers ${data.occupation} services in ${data.county}, ${data.subcounty}.`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null,
      category: "service",
      county: data.county
    });

  } catch (err) {
    showCustomAlert("‚ùå Error: " + err.message, "error");
  } finally {
    // Hide the spinner once the process completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
}


async function loadServices() {
  const container = document.getElementById("servicesContainer");
  const trendingContainer = document.getElementById("trendingContainer");
  container.innerHTML = "";
  if (trendingContainer) trendingContainer.innerHTML = "";

  // Show the loading spinner
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show spinner during loading

  try {
    const snapshot = await servicesRef.orderBy("timestamp", "desc").get();
    if (snapshot.empty) {
      container.innerHTML = `<p>No services posted yet.</p>`;
      return;
    }

    const nowTime = new Date();
    let hasServiceAccess = false;

  // ‚úÖ Use global isAdmin (set in onAuthStateChanged)
const isAdminUser = !!isAdmin;

if (currentUser?.uid) {
  const doc = await firebase.firestore().collection("users").doc(currentUser.uid).get();
  hasServiceAccess = doc.exists && doc.data()?.paidForService === true;
  if (hasServiceAccess) {
    localStorage.setItem("paidForService", "yes");
  }
}

    const boosted = [], normal = [];

    for (const doc of snapshot.docs) {
      const d = doc.data();
      d.id = doc.id;

      const boostExpiry = d.boostExpiry?.toDate?.();
      const isBoosted = d.boosted && boostExpiry && boostExpiry > nowTime;

      if (d.boosted && (!boostExpiry || boostExpiry <= nowTime)) {
        await servicesRef.doc(d.id).update({ boosted: false, boostExpiry: null });
      }

      if (isBoosted) boosted.push(d);
      else normal.push(d);
    }

    const finalServices = [...boosted.sort((a, b) => b.boostExpiry?.toDate?.() - a.boostExpiry?.toDate?.()), ...normal];

    for (const d of finalServices) {
      const id = d.id;
      const isPoster = currentUser?.uid === d.postedBy;

      const boostExpiry = d.boostExpiry?.toDate?.();
      const isBoosted = d.boosted && boostExpiry && boostExpiry > nowTime;

      const verifiedBadge = d.verified
        ? `<span class="verified-badge"><i class="fas fa-check-circle"></i> Verified</span>`
        : "";

      let boostBadge = "";
      if (isBoosted) {
        const daysLeft = Math.ceil((boostExpiry - nowTime) / (1000 * 60 * 60 * 24));
        boostBadge = `
          <span style="background: orange; color: white; font-size: 0.75em; padding: 2px 6px; border-radius: 6px; margin-left: 6px;">
            üî• Boosted (${daysLeft} day${daysLeft !== 1 ? "s" : ""} left)
          </span>`;
      }

      const interestCount = d.interestedUsers ? d.interestedUsers.length : 0;
      const interestCountText = `${interestCount} ${interestCount === 1 ? "person" : "people"} interested`;

      const occupation = d.occupation?.toLowerCase?.() || "";
      let iconClass = "fa-user-tie", bgColor = "#607d8b";

      // --- Original occupations ---
      if (occupation.includes("lawyer")) iconClass = "fa-balance-scale", bgColor = "#5c6bc0";
      else if (occupation.includes("teacher")) iconClass = "fa-chalkboard-teacher", bgColor = "#42a5f5";
      else if (occupation.includes("ict specialist")) iconClass = "fa-network-wired", bgColor = "#1565c0";
else if (occupation.includes("teacher")) iconClass = "fa-chalkboard-teacher", bgColor = "#42a5f5";
else if (occupation.includes("ict specialist")) iconClass = "fa-network-wired", bgColor = "#1565c0";
else if (occupation.includes("laundry")) iconClass = "fa-soap", bgColor = "#4dd0e1";
else if (occupation.includes("lawyer")) iconClass = "fa-balance-scale", bgColor = "#5c6bc0";
else if (occupation.includes("doctor")) iconClass = "fa-user-md", bgColor = "#e53935";
else if (occupation.includes("nurse")) iconClass = "fa-user-nurse", bgColor = "#8e24aa";
else if (occupation.includes("engineer")) iconClass = "fa-cogs", bgColor = "#f4511e";
else if (occupation.includes("plumber")) iconClass = "fa-wrench", bgColor = "#43a047";
else if (occupation.includes("carpenter")) iconClass = "fa-hammer", bgColor = "#6d4c41";
else if (occupation.includes("chef")) iconClass = "fa-hat-chef", bgColor = "#fb8c00";
else if (occupation.includes("driver")) iconClass = "fa-car", bgColor = "#1e88e5";
else if (occupation.includes("farmer")) iconClass = "fa-tractor", bgColor = "#689f38";
else if (occupation.includes("mechanic")) iconClass = "fa-tools", bgColor = "#8d6e63";
else if (occupation.includes("electrician")) iconClass = "fa-bolt", bgColor = "#fdd835";
else if (occupation.includes("artist")) iconClass = "fa-paint-brush", bgColor = "#d81b60";
else if (occupation.includes("musician")) iconClass = "fa-music", bgColor = "#7b1fa2";
else if (occupation.includes("actor")) iconClass = "fa-theater-masks", bgColor = "#f06292";
else if (occupation.includes("designer")) iconClass = "fa-pencil-ruler", bgColor = "#29b6f6";
else if (occupation.includes("photographer")) iconClass = "fa-camera", bgColor = "#8e24aa";
else if (occupation.includes("journalist")) iconClass = "fa-newspaper", bgColor = "#ef5350";
else if (occupation.includes("scientist")) iconClass = "fa-flask", bgColor = "#3949ab";
else if (occupation.includes("pilot")) iconClass = "fa-plane", bgColor = "#1e88e5";
else if (occupation.includes("singer")) iconClass = "fa-microphone", bgColor = "#8e24aa";
else if (occupation.includes("dancer")) iconClass = "fa-music", bgColor = "#f06292";
else if (occupation.includes("baker")) iconClass = "fa-bread-slice", bgColor = "#fbc02d";
else if (occupation.includes("barber")) iconClass = "fa-scissors", bgColor = "#6d4c41";
else if (occupation.includes("tailor")) iconClass = "fa-tshirt", bgColor = "#ef6c00";
else if (occupation.includes("gardener")) iconClass = "fa-leaf", bgColor = "#43a047";
else if (occupation.includes("waiter")) iconClass = "fa-concierge-bell", bgColor = "#f06292";
else if (occupation.includes("receptionist")) iconClass = "fa-phone-volume", bgColor = "#29b6f6";
else if (occupation.includes("salesperson")) iconClass = "fa-handshake", bgColor = "#ff7043";
else if (occupation.includes("manager")) iconClass = "fa-briefcase", bgColor = "#3949ab";
else if (occupation.includes("consultant")) iconClass = "fa-user-tie", bgColor = "#607d8b";
else if (occupation.includes("coach")) iconClass = "fa-futbol", bgColor = "#43a047";
else if (occupation.includes("athlete")) iconClass = "fa-running", bgColor = "#e53935";
else if (occupation.includes("translator")) iconClass = "fa-language", bgColor = "#8e24aa";
else if (occupation.includes("accountant")) iconClass = "fa-calculator", bgColor = "#f4511e";
else if (occupation.includes("banker")) iconClass = "fa-university", bgColor = "#3949ab";
else if (occupation.includes("investor")) iconClass = "fa-coins", bgColor = "#ffb300";
else if (occupation.includes("entrepreneur")) iconClass = "fa-lightbulb", bgColor = "#fdd835";
else if (occupation.includes("researcher")) iconClass = "fa-flask", bgColor = "#3949ab";
else if (occupation.includes("architect")) iconClass = "fa-drafting-compass", bgColor = "#29b6f6";
else if (occupation.includes("pilot")) iconClass = "fa-plane", bgColor = "#1e88e5";
else if (occupation.includes("bus driver")) iconClass = "fa-bus", bgColor = "#ff7043";
else if (occupation.includes("taxi driver")) iconClass = "fa-taxi", bgColor = "#ffb300";
else if (occupation.includes("cleaner")) iconClass = "fa-broom", bgColor = "#8d6e63";
else if (occupation.includes("security guard")) iconClass = "fa-shield-alt", bgColor = "#6d4c41";
else if (occupation.includes("paramedic")) iconClass = "fa-ambulance", bgColor = "#e53935";
else if (occupation.includes("pharmacist")) iconClass = "fa-pills", bgColor = "#3949ab";
else if (occupation.includes("therapist")) iconClass = "fa-heartbeat", bgColor = "#e91e63";
else if (occupation.includes("veterinarian")) iconClass = "fa-paw", bgColor = "#8e24aa";
else if (occupation.includes("psychologist")) iconClass = "fa-brain", bgColor = "#7b1fa2";
else if (occupation.includes("dentist")) iconClass = "fa-tooth", bgColor = "#f06292";
else if (occupation.includes("optician")) iconClass = "fa-eye", bgColor = "#1e88e5";
else if (occupation.includes("hairdresser")) iconClass = "fa-cut", bgColor = "#f06292";
else if (occupation.includes("fashion designer")) iconClass = "fa-tshirt", bgColor = "#ef6c00";
else if (occupation.includes("cosmetologist")) iconClass = "fa-magic", bgColor = "#f06292";
else if (occupation.includes("interior designer")) iconClass = "fa-couch", bgColor = "#29b6f6";
else if (occupation.includes("graphic designer")) iconClass = "fa-paint-brush", bgColor = "#d81b60";
else if (occupation.includes("web developer")) iconClass = "fa-code", bgColor = "#1565c0";
else if (occupation.includes("software engineer")) iconClass = "fa-laptop-code", bgColor = "#1e88e5";
else if (occupation.includes("data analyst")) iconClass = "fa-chart-line", bgColor = "#3949ab";
else if (occupation.includes("marketing specialist")) iconClass = "fa-bullhorn", bgColor = "#f4511e";
else if (occupation.includes("content creator")) iconClass = "fa-photo-video", bgColor = "#f06292";
else if (occupation.includes("youtuber")) iconClass = "fa-play-circle", bgColor = "#ff7043";
else if (occupation.includes("blogger")) iconClass = "fa-blog", bgColor = "#29b6f6";
else if (occupation.includes("influencer")) iconClass = "fa-user-friends", bgColor = "#8e24aa";
else if (occupation.includes("event planner")) iconClass = "fa-calendar-alt", bgColor = "#43a047";
else if (occupation.includes("photography")) iconClass = "fa-camera", bgColor = "#8e24aa";
else if (occupation.includes("videographer")) iconClass = "fa-video", bgColor = "#f06292";
else if (occupation.includes("drone operator")) iconClass = "fa-drone", bgColor = "#1565c0";
else if (occupation.includes("blogger")) iconClass = "fa-blog", bgColor = "#29b6f6";
else if (occupation.includes("research assistant")) iconClass = "fa-flask", bgColor = "#3949ab";
else if (occupation.includes("law enforcement")) iconClass = "fa-badge-sheriff", bgColor = "#6d4c41";
else if (occupation.includes("firefighter")) iconClass = "fa-fire-extinguisher", bgColor = "#e53935";
else if (occupation.includes("paramedic")) iconClass = "fa-ambulance", bgColor = "#e53935";
else if (occupation.includes("social worker")) iconClass = "fa-hands-helping", bgColor = "#8e24aa";
else if (occupation.includes("ngo worker")) iconClass = "fa-hand-holding-heart", bgColor = "#f06292";
else if (occupation.includes("volunteer")) iconClass = "fa-hands-helping", bgColor = "#29b6f6";
else if (occupation.includes("athletic coach")) iconClass = "fa-futbol", bgColor = "#43a047";
else if (occupation.includes("personal trainer")) iconClass = "fa-dumbbell", bgColor = "#f4511e";
else if (occupation.includes("nutritionist")) iconClass = "fa-apple-alt", bgColor = "#689f38";
else if (occupation.includes("dietitian")) iconClass = "fa-apple-alt", bgColor = "#689f38";
else if (occupation.includes("pilates instructor")) iconClass = "fa-running", bgColor = "#e53935";
else if (occupation.includes("yoga instructor")) iconClass = "fa-spa", bgColor = "#8e24aa";
else if (occupation.includes("meditation coach")) iconClass = "fa-leaf", bgColor = "#43a047";
else if (occupation.includes("life coach")) iconClass = "fa-user-tie", bgColor = "#607d8b";
else if (occupation.includes("motivational speaker")) iconClass = "fa-microphone", bgColor = "#f06292";
else if (occupation.includes("author")) iconClass = "fa-book", bgColor = "#3949ab";
else if (occupation.includes("writer")) iconClass = "fa-pen-nib", bgColor = "#f06292";
else if (occupation.includes("poet")) iconClass = "fa-pen-fancy", bgColor = "#8e24aa";
else if (occupation.includes("translator")) iconClass = "fa-language", bgColor = "#8e24aa";
else if (occupation.includes("interpreter")) iconClass = "fa-language", bgColor = "#8e24aa";
else if (occupation.includes("librarian")) iconClass = "fa-book-reader", bgColor = "#607d8b";
else if (occupation.includes("archivist")) iconClass = "fa-archive", bgColor = "#607d8b";
else if (occupation.includes("curator")) iconClass = "fa-landmark", bgColor = "#3949ab";
else if (occupation.includes("museum worker")) iconClass = "fa-landmark", bgColor = "#3949ab";
else if (occupation.includes("tour guide")) iconClass = "fa-map-marked-alt", bgColor = "#ff7043";
else if (occupation.includes("travel agent")) iconClass = "fa-plane-departure", bgColor = "#29b6f6";
else if (occupation.includes("hotel manager")) iconClass = "fa-hotel", bgColor = "#8d6e63";
else if (occupation.includes("concierge")) iconClass = "fa-concierge-bell", bgColor = "#f06292";
else if (occupation.includes("bartender")) iconClass = "fa-cocktail", bgColor = "#fb8c00";
else if (occupation.includes("waitress")) iconClass = "fa-concierge-bell", bgColor = "#f06292";

      else if (occupation.includes("laundry")) iconClass = "fa-soap", bgColor = "#4dd0e1";

      const iconHTML = `
        <div style="padding: 18px; background: ${bgColor};">
          <i class="fas ${iconClass}" style="font-size: 50px; color: #fff;"></i>
        </div>`;

      const images = d.photoURLs || [];
      let imageHTML = '';
      if (images.length > 0) {
        images.forEach((img, idx) => {
          imageHTML += `
            <img src="${img}" alt="Service Image ${idx + 1}" style="width:100%; height:180px; object-fit:cover; border-radius:8px; margin-bottom:8px; cursor:pointer;" onclick="openImageModal(${idx}, ${JSON.stringify(images)})">
          `;
        });
      } else {
        imageHTML = `<div style="width:100%; height:180px; background: #f0f0f0; border-radius:8px; margin-bottom:8px; display: flex; justify-content: center; align-items: center; color: #888; cursor: pointer;" onclick="openImageModal()">No Images</div>`;
      }

      const contactHTML = (d.isActive || isPoster || hasServiceAccess || isAdminUser)
        ? `
          <div style="display: flex; flex-direction: row; gap: 5px; padding: 8px 10px; background-color: #f1f1f1; border-radius: 8px; border: 1px solid #ccc; align-items: center; width: auto; height: 45px;">
            <p style="display: flex; align-items: center; color: #2e7d32; font-size: 14px; font-weight: bold; margin-right: 10px;">
              <div style="border: 1px solid #4caf50; background-color: #4caf50; padding: 4px 10px; border-radius: 6px; display: flex; align-items: center; height: 30px;">
                <a href="tel:${d.phone}" style="color:white; font-size: 14px; text-decoration: none; font-weight: bold;"> Call</a>
                <i class="fas fa-phone-alt" style="margin-left: 6px; color:white;"></i>
              </div>
            </p>
            <p style="display: flex; align-items: center; color: #25D366; font-size: 14px; font-weight: bold;">
              <div style="border: 1px solid #25D366; background-color: #25D366; padding: 4px 10px; border-radius: 6px; display: flex; align-items: center; height: 30px;">
                <a href="https://wa.me/254${d.phone.replace(/^0/, '')}" target="_blank" style="color:white; font-size: 14px; text-decoration: none; font-weight: bold;">Chat</a>
                <i class="fab fa-whatsapp" style="margin-left: 6px; color:white;"></i>
              </div>
            </p>
          </div>` : ``;

  let actionButtonsHTML = `
  <div style="margin-top: 12px;">
    <button onclick="toggleActionButtons('${id}')"
      style="background:#00796b; color:white; padding:6px 12px; border:none; border-radius:25px; font-size:14px; cursor:pointer; margin-bottom:8px;">
      üîΩ More Details
    </button>
    <div id="action-buttons-${id}" style="display:none; margin-top: 8px;">

<!-- Boost Service Button (Visible to Poster or Admin) -->
${isPoster || isAdminUser ? `
  <button onclick="${isAdminUser ? `boostServiceDirectly('${id}')` : `showPaymentModalFor('boost', 250, '${id}', '${d.name}')`}"
    style="background:orange; color:white; border:none; padding:6px 12px; border-radius:25px; font-size:14px; cursor:pointer; margin-top:8px;">
    üî• Boost This Service
  </button>` : ''}


      <!-- Get Verified Badge Button (Visible to Poster if not verified) -->
      ${!d.verified && isPoster && !isAdminUser ? `
        <button onclick="showPaymentModalFor('serviceVerification', 250, '${id}', '${d.name}')"
          style="background:#4CAF50; color:white; padding:6px 12px; border:none; border-radius:25px; font-size:14px; cursor:pointer; margin-top:8px;">
          ‚úÖ Get Verified Badge ‚Äì Ksh 250
        </button>` : ''}

      <!-- Verify Service Button (Visible to Admin) -->
      ${!d.verified && isAdminUser ? `
        <button onclick="adminVerifyItem('service', '${id}')"
          style="background:#2196F3; color:white; padding:6px 12px; border:none; border-radius:25px; font-size:14px; cursor:pointer; margin-top:8px;">
          üõ°Ô∏è Verify Now (Admin)
        </button>` : ''}

      <!-- Activate Service Button (Visible to Poster if inactive) -->
      ${isPoster && !d.isActive ? `
        <button onclick="showPaymentModalFor('serviceActivation', 250, '${id}', 'Activate Service')"
          style="background:#4CAF50; color:white; padding:6px 12px; border:none; border-radius:25px; font-size:14px; cursor:pointer; margin-top:8px;">
          ‚úÖ Activate Your Service ‚Äì Ksh 250
        </button>` : ''}

      <!-- Admin Button to Activate/Deactivate Service -->
      ${isAdminUser ? `
        <button onclick="toggleServiceStatus('${id}')"
          style="background:#4CAF50; color:white; padding:6px 12px; border:none; border-radius:25px; font-size:14px; cursor:pointer; margin-top:8px;">
          üîÑ Activate/Deactivate Service (Admin)
        </button>` : ''}

      <!-- Edit Service Button (Visible to Poster or Admin) -->
      ${isPoster || isAdminUser ? `
        <button onclick="editService('${id}')"
          style="background:#ff9800; color:white; padding:6px 12px; border:none; border-radius:25px; font-size:14px; cursor:pointer; margin-top:8px;">
          ‚úèÔ∏è Edit Service
        </button>` : ''}

      <!-- Leave a Review Button (Visible to any User) -->
      <button onclick="showReviewModal('${id}')"
        style="background:#4caf50; color:white; padding:6px 12px; border:none; border-radius:25px; font-size:14px; cursor:pointer; margin-top:8px;">
        üìù Leave a Review
      </button>

    <!-- Show Interest Button for Service (Visible to any User) -->
<button onclick="showInterest('${id}')"
    style="background:#ff5722; color:white; padding:6px 12px; border:none; border-radius:25px; font-size:14px; cursor:pointer; margin-top:8px;">
    ‚ù§Ô∏è Show Interest
</button>

      <!-- Delete Service Button (Visible to Poster or Admin) -->
      ${isPoster || isAdminUser ? `
        <button onclick="deleteService('${id}')"
          style="background:#dc3545; color:white; padding:6px 12px; margin-top:8px; border:none; border-radius:25px; font-size:14px; cursor:pointer;">
          üóëÔ∏è Delete
        </button>` : ''}

    </div>
  </div>
`;

      const card = document.createElement("div");
      card.className = "service-card";
      card.id = `service-${id}`;
      card.dataset.county = d.county;
      card.dataset.occupation = occupation;
      card.style.cssText = `
        position: relative;
        border: 2px solid ${isBoosted ? 'orange' : '#ddd'};
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 18px;
        box-shadow: ${isBoosted ? '0 0 12px rgba(255,165,0,0.5)' : '0 2px 6px rgba(0,0,0,0.08)'};
        background: #fff;
        text-align: center;
        transition: all 0.3s ease;
      `;

      card.innerHTML = `
        ${iconHTML}
        <div style="padding: 14px; text-align:left;">
          ${verifiedBadge}
          <h3 style="margin: 6px 0; color:#00796b;">${d.name} ${boostBadge}</h3>
          ${imageHTML}
          <p style="color:#3f51b5;"><strong>County:</strong> ${d.county}</p>
          <p style="color:#d32f2f;"><strong>Occupation:</strong> ${d.occupation}</p>
          <p style="color:#6a1b9a;"><strong>Experience:</strong> ${d.experience} years</p>
          <div style="margin-top:10px;">${contactHTML}</div>
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:12px;">${actionButtonsHTML}</div>
          <p id="interest-count-${id}" style="color: #f44336; font-size: 1em; margin-top: 10px;">${interestCountText}</p>
        </div>
      `;

      container.appendChild(card);

 // ‚úÖ Only boosted items appear in trending
if (isBoosted && trendingContainer) {
  const clonedCard = card.cloneNode(true);
  clonedCard.id = `trending-service-${id}`;

  // üîπ Fix ALL duplicated IDs inside trending card
  clonedCard.innerHTML = clonedCard.innerHTML
    .replaceAll(`action-buttons-${id}`, `action-buttons-trending-${id}`)
    .replaceAll(`interest-count-${id}`, `interest-count-trending-${id}`)
    .replaceAll(`toggleActionButtons('${id}')`, `toggleActionButtons('${id}', true)`);

  trendingContainer.appendChild(clonedCard);
}


      setupStarRating(id);
      updateAverageRating(id);
    }
  } catch (err) {
    console.error("‚ùå Error loading services:", err);
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}

function toggleActionButtons(id, isTrending = false) {
  const suffix = isTrending ? "trending-" : "";
  const actions = document.getElementById(`action-buttons-${suffix}${id}`);
  if (!actions) return;

  actions.style.display = actions.style.display === "none" ? "block" : "none";
}



function payForVerification(category, itemId, itemName) {
  // category: 'service' or 'market'
  // amount: change if needed
  showPaymentModalFor(`${category}Verification`, 200, itemId, itemName);
}

async function showInterest(serviceId) {
  const currentUserUid = currentUser?.uid;
  if (!currentUserUid) {
    showCustomAlert("‚ö†Ô∏è Please log in to show interest.");
    return;
  }

  // Show the loading spinner while processing the request
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    const serviceRef = servicesRef.doc(serviceId);
    const serviceDoc = await serviceRef.get();

    if (!serviceDoc.exists) {
      console.error("Service not found.");
      showCustomAlert("‚ùå Service not found.");
      return;
    }

    const serviceData = serviceDoc.data();
    const interestedUsers = serviceData.interestedUsers || [];

    if (interestedUsers.includes(currentUserUid)) {
      showCustomAlert("‚úÖ You've already shown interest in this service.");
      return;
    }

    interestedUsers.push(currentUserUid);
    await serviceRef.update({ interestedUsers });

    const posterId = serviceData.postedBy;
    if (posterId && posterId !== currentUserUid) {
      await db.collection("alerts").add({
        title: "üìå New Interest in Your Service",
        message: `${currentUser.displayName || "Someone"} is interested in your service: ${serviceData.name || "Unnamed Service"}`,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        targetUserId: posterId,
        section: "services",
        relatedId: serviceId
      });
    }

    const updatedInterestCount = interestedUsers.length;
    const interestCountElement = document.getElementById(`interest-count-${serviceId}`);
    if (interestCountElement) {
      interestCountElement.textContent = `${updatedInterestCount} ${updatedInterestCount === 1 ? "person" : "people"} interested`;
    }

    showCustomAlert("üéâ Your interest has been registered successfully!");

  } catch (error) {
    console.error("‚ùå Error showing interest:", error.message || error);
    showCustomAlert("Something went wrong. Please try again.");
  } finally {
    // Hide the loading spinner after operation completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
}
async function verifyServiceDirectly(serviceId) {
  // Show the loading spinner while processing
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    await servicesRef.doc(serviceId).set({
      verified: true
    }, { merge: true });

    showCustomAlert("‚úÖ Service verified successfully!", "success");

    // Instant DOM update without reload
    const card = document.getElementById(`service-${serviceId}`);
    if (card && !card.querySelector('.verified-badge')) {
      const badge = document.createElement('span');
      badge.className = 'verified-badge';
      badge.innerHTML = `<i class="fas fa-check-circle"></i> Verified`;
      const titleElem = card.querySelector('h3');
      if (titleElem) {
        titleElem.insertAdjacentElement('beforebegin', badge);
      }
    }

  } catch (err) {
    console.error("‚ùå Error verifying service:", err);
    showCustomAlert("‚ùå Failed to verify service: " + err.message, "error");
  } finally {
    // Hide the loading spinner after operation completes
    document.getElementById("loadingSpinner").style.display = "none";
  }
}


function handlePaymentSuccess(paymentType, itemId) {
  if (paymentType === 'serviceVerification') {
    verifyServiceDirectly(itemId);
  }
  else if (paymentType === 'serviceBoost') {
    boostServiceDirectly(itemId);
  }
  else if (paymentType === 'marketVerification') {
    verifyMarketDirectly(itemId);
  }
  else if (paymentType === 'marketBoost') {
    boostMarketDirectly(itemId);
  }
}



// Star Rating Helpers (add these outside loadServices)

function setupStarRating(serviceId) {
  const stars = document.querySelectorAll(`#star-rating-${serviceId} .star`);
  let userRating = 0;

  stars.forEach(star => {
    star.addEventListener("mouseenter", () => {
      highlightStars(serviceId, star.dataset.value);
    });
    star.addEventListener("mouseleave", () => {
      highlightStars(serviceId, userRating);
    });
    star.addEventListener("click", async () => {
      userRating = parseInt(star.dataset.value);
      await saveUserRating(serviceId, userRating);
      highlightStars(serviceId, userRating);
      await updateAverageRating(serviceId);
    });
  });

  loadUserRating(serviceId).then(rating => {
    userRating = rating || 0;
    highlightStars(serviceId, userRating);
  });
}

function highlightStars(serviceId, rating) {
  const stars = document.querySelectorAll(`#star-rating-${serviceId} .star`);
  stars.forEach(star => {
    if (star.dataset.value <= rating) {
      star.classList.add("selected");
    } else {
      star.classList.remove("selected");
    }
  });
}

async function saveUserRating(serviceId, rating) {
  if (!currentUser?.uid) {
    alert("Please log in to rate services.");
    return;
  }
  try {
    const ratingRef = servicesRef.doc(serviceId).collection("ratings").doc(currentUser.uid);
    await ratingRef.set({
      rating,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      userId: currentUser.uid,
      serviceId,
    });
  } catch (error) {
    console.error("Error saving rating:", error);
  }
}

async function loadUserRating(serviceId) {
  if (!currentUser?.uid) return 0;
  try {
    const ratingDoc = await servicesRef.doc(serviceId).collection("ratings").doc(currentUser.uid).get();
    if (ratingDoc.exists) {
      return ratingDoc.data().rating || 0;
    }
  } catch (error) {
    console.error("Error loading user rating:", error);
  }
  return 0;
}

async function updateAverageRating(serviceId) {
  try {
    const ratingsSnapshot = await servicesRef.doc(serviceId).collection("ratings").get();
    let sum = 0, count = 0;
    ratingsSnapshot.forEach(doc => {
      sum += doc.data().rating || 0;
      count++;
    });
    const avg = count ? (sum / count) : 0;
    const avgRounded = avg.toFixed(1);

    const avgElem = document.getElementById(`average-rating-${serviceId}`);
    if (avgElem) {
      avgElem.textContent = `Avg: ${avgRounded} ‚òÖ (${count})`;
    }
  } catch (error) {
    console.error("Error calculating average rating:", error);
  }
}


async function toggleServiceStatus(serviceId) {
  // Show the loading spinner
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    const serviceDoc = await servicesRef.doc(serviceId).get();
    const serviceData = serviceDoc.data();
    const isActive = serviceData.isActive;
    const isPoster = serviceData.posterId === currentUser.uid; // Assuming posterId is stored in service data
    const serviceCost = 250; // Ksh 250 to activate the service for the poster

    // Check if poster is trying to activate service
    if (isPoster && !isActive) {
      // Show a payment modal for posters to activate their service
      const paymentConfirmed = await showPaymentModalFor('serviceActivation', serviceCost, serviceId, 'Activate Service');
      
      if (!paymentConfirmed) {
        showToast("Payment failed. Service not activated.", "warning");
        return;
      }

      // Proceed to activate the service after payment is successful
      await servicesRef.doc(serviceId).update({
        isActive: true // Activate the service
      });

      showToast("Service Activated", "info");
      
      // Update the card with new status
      const serviceCard = document.getElementById(`service-${serviceId}`);
      const statusElement = serviceCard.querySelector(".service-status");

      if (statusElement) {
        statusElement.textContent = "Status: Active";
        statusElement.style.color = "green";
      }

    } else {
      // Admins can toggle the service status freely
      await servicesRef.doc(serviceId).update({
        isActive: !isActive // Toggle between true/false
      });

      const message = isActive ? "Service Deactivated" : "Service Activated";
      showToast(message, isActive ? "warning" : "info");

      // Update the card with new status
      const serviceCard = document.getElementById(`service-${serviceId}`);
      const statusElement = serviceCard.querySelector(".service-status");

      if (statusElement) {
        statusElement.textContent = isActive ? "Status: Inactive" : "Status: Active";
        statusElement.style.color = isActive ? "gray" : "green"; // Gray for inactive, Green for active
      }
    }

    loadServices(); // Reload to reflect changes

  } catch (error) {
    console.error("Error toggling service status:", error);
    alert("Error updating service status.");
  } finally {
    // Hide the loading spinner
    document.getElementById("loadingSpinner").style.display = "none";
  }
}



// ‚úÖ Reusable inlined custom alert function
function showCustomAlert(message) {
  const alertBox = document.createElement("div");
  alertBox.textContent = message;
  alertBox.style = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: palegreen;
    color: black;
    padding: 15px 25px;
    font-size: 16px;
    font-weight: bold;
    border: 2px solid green;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 9999;
    text-align: center;
  `;

  document.body.appendChild(alertBox);
  setTimeout(() => {
    alertBox.remove();
  }, 3000);
}





// Show Review Modal
function showReviewModal(serviceId) {
  const reviewModal = document.getElementById("reviewModal");
  reviewModal.style.display = 'block'; // Show the modal

  // Handle review submission
  document.getElementById("reviewForm").onsubmit = async (e) => {
    e.preventDefault();
    const rating = document.getElementById("reviewRating").value;
    const comment = document.getElementById("reviewComment").value;

    // Add review to service document
    const review = {
      rating: parseInt(rating),
      comment,
      user: currentUser.uid, // Store the user ID who posted the review
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      await servicesRef.doc(serviceId).collection("reviews").add(review);
      alert("Review added!");
      reviewModal.style.display = 'none'; // Close the modal
      loadServices(); // Reload to reflect changes
    } catch (error) {
      console.error("Error adding review:", error);
      alert("Error adding review.");
    }
  };
}

// Close Review Modal
function closeReviewModal() {
  const reviewModal = document.getElementById("reviewModal");
  reviewModal.style.display = 'none'; // Close the modal
}

async function boostServiceDirectly(serviceId) {
  // Show the loading spinner
  document.getElementById("loadingSpinner").style.display = "flex";

  try {
    const expiry = new Date();
    expiry.setDate(expiry.getDate() + 3); // 3-day boost

    await servicesRef.doc(serviceId).set({
      boosted: true,
      boostExpiry: firebase.firestore.Timestamp.fromDate(expiry)
    }, { merge: true });

    showCustomAlert("‚úÖ Service boosted successfully by Admin!", "success");
    loadServices(); // Refresh list immediately
  } catch (err) {
    console.error("‚ùå Error boosting service:", err);
    showCustomAlert("‚ùå Failed to boost service: " + err.message, "error");
  } finally {
    // Hide the loading spinner after completion
    document.getElementById("loadingSpinner").style.display = "none";
  }
}

async function postService() {
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    if (!currentUser) {
      showCustomAlert("Please login first.", "error");
      return;
    }

    const serviceCountSnap = await servicesRef.where("postedBy", "==", currentUser.uid).get();
    const totalServices = serviceCountSnap.size;

    if (totalServices >= 1) {
      const confirmPayment = confirm("You have already posted one free service. Pay Ksh 200 to post another. Proceed to payment?");
      if (!confirmPayment) return;
      await processServicePayment();
    }

    const name = document.getElementById("svcName").value.trim();
    const phone = document.getElementById("svcPhone").value.trim();
    const county = document.getElementById("svcCounty").value.trim();
    const occupation = document.getElementById("svcOccupation").value.trim();
    const experience = document.getElementById("svcExperience").value.trim();

    if (!name || !phone || !county || !occupation || !experience) {
      showCustomAlert("Please fill in all fields before posting.", "error");
      return;
    }

    let photoURLs = [];
    const photoInput = document.getElementById("svcPhotos");
    if (photoInput.files.length > 0) {
      const uploadPromises = Array.from(photoInput.files).map(async (file) => {
        const storageRef = firebase.storage().ref();
        const photoRef = storageRef.child(`services/${currentUser.uid}/${Date.now()}_${file.name}`);
        await photoRef.put(file);
        return await photoRef.getDownloadURL();
      });
      photoURLs = await Promise.all(uploadPromises);
    }

    await servicesRef.add({
      name,
      phone,
      county,
      occupation,
      experience,
      postedBy: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      boosted: false,
      boostExpiry: null,
      photos: photoURLs
    });

    showCustomAlert("Service posted successfully!", "success");
    document.getElementById("serviceForm").reset();
    loadServices();

  } catch (error) {
    console.error("Error posting service:", error);
    showCustomAlert("Failed to post service. Please try again.", "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}




async function unlockServiceContacts() {
  if (!currentUser || !currentUser.uid) {
    showCustomAlert("Please login to unlock service contacts.", "error");
    return;
  }

  showPaymentModalFor("service", 200, currentUser.uid, "Service Provider Contacts");

  const checkPaid = setInterval(async () => {
    if (localStorage.getItem("paidForService") === "yes") {
      clearInterval(checkPaid);
      
      // Create Admin Notification when the service contacts are unlocked
      const notifRef = db.collection("adminNotifications").doc();
      await notifRef.set({
        type: "Service Contacts Unlocked",
        userId: currentUser.uid,
        userName: currentUser.displayName || currentUser.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        message: `${currentUser.displayName || currentUser.email} has unlocked service provider contacts after making a payment.`
      });

      showCustomAlert("Service provider contacts unlocked!", "success");
      closeUniversalModal();
      loadServices(); // Reload services to show contacts
    }
  }, 3000);
}


// ‚úÖ Show toast message (success or error)
function showToast(message, type = "success") {
  Toastify({
    text: message,
    duration: 3000,
    gravity: "top",
    position: "right",
    backgroundColor: type === "success" ? "#28a745" : "#dc3545",
    close: true,
  }).showToast();
}

function promptToast(message, onConfirm) {
  // Remove any existing prompt
  const oldBox = document.getElementById("customConfirmBox");
  if (oldBox) oldBox.remove();

  const box = document.createElement("div");
  box.id = "customConfirmBox"; // important for duplicate removal
  box.innerHTML = `
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;z-index:9999;">
      <div style="background:#fff;padding:20px 30px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.3);text-align:center;font-family:sans-serif;">
        <p style="margin-bottom:20px;font-size:16px;">${message}</p>
        <button id="promptYesBtn" style="margin-right:10px;padding:8px 16px;background:#28a745;color:#fff;border:none;border-radius:5px;cursor:pointer;">Yes</button>
        <button id="promptNoBtn" style="padding:8px 16px;background:#dc3545;color:#fff;border:none;border-radius:5px;cursor:pointer;">No</button>
      </div>
    </div>
  `;

  document.body.appendChild(box);

  // ‚úÖ Attach event listeners after element is added
  document.getElementById("promptYesBtn").onclick = () => {
    box.remove();
    onConfirm(true);
  };
  document.getElementById("promptNoBtn").onclick = () => {
    box.remove();
    onConfirm(false);
  };
}


async function deleteService(id) {
  // Show the loading spinner when the process begins
  document.getElementById("loadingSpinner").style.display = "flex";

  promptToast("Are you sure you want to delete this service?", async (confirmed) => {
    if (confirmed) {
      try {
        const serviceDoc = await servicesRef.doc(id).get();
        if (!serviceDoc.exists) {
          showToast("Service not found.", "error");
          return;
        }

        const serviceData = serviceDoc.data();
        const serviceName = serviceData.name || "Unknown Service";
        const deletedBy = currentUser.displayName || currentUser.email;

        // Delete the service
        await servicesRef.doc(id).delete();
        showToast("Service deleted successfully.", "success");
        loadServices(); // Refresh the list

        // Create Admin Notification about Service Deletion
        const notifRef = db.collection("adminNotifications").doc();
        await notifRef.set({
          type: "Service Deleted",
          itemId: id,
          itemName: serviceName,
          deletedBy: deletedBy,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          message: `‚ùå Service "${serviceName}" has been deleted by ${deletedBy}.`
        });

        console.log("Admin notification created for service deletion");

      } catch (err) {
        showToast("Error deleting: " + err.message, "error");
        console.error("Error deleting service:", err);
      }
    } else {
      showToast("Deletion cancelled.", "error");
    }

    // Hide the loading spinner once the process is complete
    document.getElementById("loadingSpinner").style.display = "none";
  });
}

// ‚úÖ Edit service and rebind default submit
function editService(data, id) {
  document.getElementById("svcName").value = data.name;
  document.getElementById("svcCounty").value = data.county;
  document.getElementById("svcSubCounty").value = data.subcounty;
  document.getElementById("svcOccupation").value = data.occupation;
  document.getElementById("svcExperience").value = data.experience;
  document.getElementById("svcPhone").value = data.phone;

  const btn = document.querySelector("#serviceForm button");
  btn.innerHTML = "Update Service";

  // Show loading spinner while updating
  document.getElementById("loadingSpinner").style.display = "flex";

  // Replace the form element to remove previous listeners
  const oldForm = document.getElementById("serviceForm");
  const newForm = oldForm.cloneNode(true);
  oldForm.parentNode.replaceChild(newForm, oldForm);

  // Add update submit handler
  newForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    try {
      const updated = {
        name: document.getElementById("svcName").value,
        county: document.getElementById("svcCounty").value,
        subcounty: document.getElementById("svcSubCounty").value,
        occupation: document.getElementById("svcOccupation").value,
        experience: document.getElementById("svcExperience").value,
        phone: document.getElementById("svcPhone").value,
        postedBy: data.postedBy,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      // Update the service
      await servicesRef.doc(id).update(updated);

      // Show success message
      showCustomAlert("‚úÖ Service updated.");
      newForm.reset();
      loadServices(); // Refresh service list

      // Reset button text to default
      btn.innerHTML = `<i class="fas fa-concierge-bell" style="margin-right:6px;"></i> Submit Service`;

      // Reattach the default form submit handler
      attachServiceFormSubmit(); // üëà Reattach default

    } catch (err) {
      showCustomAlert("Error updating: " + err.message, "error");
    } finally {
      // Hide the loading spinner once the update is complete
      document.getElementById("loadingSpinner").style.display = "none";
    }
  });
}


function filterServices() {
  const county = document.getElementById("filterServiceCounty").value;
  const occupation = document.getElementById("filterOccupation").value.toLowerCase();

  const cards = document.querySelectorAll(".service-card");
  let matches = 0;

  cards.forEach(card => {
    const matchesCounty = !county || card.dataset.county === county;
    const matchesOccupation = !occupation || card.dataset.occupation.includes(occupation);

    const shouldShow = matchesCounty && matchesOccupation;
    card.style.display = shouldShow ? "" : "none";

    if (shouldShow) matches++;
  });

  if (matches === 0) {
    showCustomAlert("üòû No services match your filters.", "info");
  }
}
// ‚úÖ Global Submit Handler for Market Form with monetization check
async function submitMarketHandler(e) {
  e.preventDefault();

  if (!isLoggedIn || !currentUser) {
    showPage("login");
    return alert("You must be logged in.");
  }

  const marketSnap = await marketRef.where("postedBy", "==", currentUser.uid).get();
  const totalPosted = marketSnap.size;

  if (totalPosted >= 1 && !isAdmin) {
    showPaymentModalFor("market", 300, currentUser.uid, "Post Extra Market Item");
    return;
  }

  // ‚úÖ Collect form values
  const itemName = document.getElementById("itemName").value.trim();
  const itemCategory = document.getElementById("itemCategory").value;
  const itemDescription = document.getElementById("itemDescription").value.trim();
  const itemPrice = document.getElementById("itemPrice").value.trim();
  const itemCounty = document.getElementById("itemCounty").value;
  const itemSubcounty = document.getElementById("itemSubcounty").value.trim();
  const itemPhone = document.getElementById("itemPhone").value.trim();
  const itemPhotoFile = document.getElementById("itemPhoto").files[0];

  const itemConditionInput = document.getElementById("itemCondition");
  const itemCondition = itemConditionInput ? itemConditionInput.value : "New";

  const posterName = currentUser.displayName || currentUser.email || "Anonymous";

  // ‚úÖ Prepare normalized market data
  const itemData = {
    name: itemName,
    category: itemCategory,
    description: itemDescription,
    price: itemPrice,
    county: itemCounty,
    subcounty: itemSubcounty,
    phone: itemPhone,
    postedBy: currentUser.uid,
    posterName: posterName,
    condition: itemCondition,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    // ‚úÖ Upload photo if selected
    if (itemPhotoFile) {
      const photoPath = `marketPhotos/${Date.now()}_${itemPhotoFile.name}`;
      const photoRef = storage.ref(photoPath);
      const uploadTask = await photoRef.put(itemPhotoFile);
      itemData.photoURL = await uploadTask.ref.getDownloadURL();
      console.log("Photo uploaded:", itemData.photoURL);
    }

    // ‚úÖ Save to Firestore (market collection)
    await marketRef.add(itemData);

    showCustomAlert("‚úÖ Item posted!", "success");
    document.getElementById("marketForm").reset();
    loadMarketItems();

    // ‚úÖ Notify Admin
    await db.collection("adminNotifications").add({
      type: "Marketplace Post",
      message: `New item posted: ${itemName} (${itemCategory}), Price: ${itemPrice}, Phone: ${itemPhone}, County: ${itemCounty}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });

    // ‚úÖ Alert all users WITHOUT WhatsApp link
    await db.collection("alerts").add({
      title: "üÜï New Market Item",
      message: `${posterName} just posted: ${itemName} (${itemCategory}) @ ${itemPrice}\nüìû Contact: ${itemPhone}`,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      targetUserId: null // visible to all
    });

  } catch (err) {
    console.error("‚ùå Error posting item:", err);
    showCustomAlert("‚ùå Error: " + err.message, "error");
  } finally {
    document.getElementById("loadingSpinner").style.display = "none";
  }
}




// ‚úÖ Attach Market Form Handler (safe and reusable)
function attachMarketFormSubmit() {
  const oldForm = document.getElementById("marketForm");
  if (!oldForm) return;

  const newForm = oldForm.cloneNode(true);
  oldForm.parentNode.replaceChild(newForm, oldForm);
  newForm.addEventListener("submit", submitMarketHandler);
}

async function loadMarketItems() {
  const container = document.getElementById("marketContainer");
  const trendingContainer = document.getElementById("trendingContainer"); // Trending section
  container.innerHTML = "";
  if (trendingContainer) trendingContainer.innerHTML = "";

  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show spinner during loading

  const minPrice = parseInt(document.getElementById("filterMinPrice").value) || 0;
  const maxPrice = parseInt(document.getElementById("filterMaxPrice").value) || Infinity;
  const categoryFilter = document.getElementById("filterCategory").value.toLowerCase().trim();
  const countyFilter = document.getElementById("filterCounty").value.toLowerCase().trim();

  try {
    const snapshot = await marketRef.get();

    if (snapshot.empty) {
      container.innerHTML = "<p>No items posted yet.</p>";
      return;
    }

    const boostedItems = [];
    const normalItems = [];
    const now = new Date();

    snapshot.forEach(doc => {
      const d = doc.data();
      const id = doc.id;

      const price = parseFloat(d.price) || 0;
      if (price < minPrice || price > maxPrice) return;
      if (categoryFilter && (!d.category || !d.category.toLowerCase().includes(categoryFilter))) return;
      if (countyFilter && (!d.county || !d.county.toLowerCase().includes(countyFilter))) return;

      const boostExpiry = d.boostExpiry?.toDate?.();
      const isBoosted = d.boosted && boostExpiry && boostExpiry > now;
      const isExpired = boostExpiry && boostExpiry <= now;

      if (isBoosted) boostedItems.push({ ...d, id, boostExpiry });
      else normalItems.push({ ...d, id, isExpired });
    });

    if (boostedItems.length + normalItems.length === 0) {
      container.innerHTML = "<p>No items match your filters.</p>";
      return;
    }

// -----------------------------
// RENDER TRENDING (ONLY BOOSTED)
// -----------------------------
if (trendingContainer) {
  boostedItems.forEach(d => {
    const id = d.id;

    // ‚úÖ Boost expiry countdown
    let boostBadge = "";
    if (d.boosted && d.boostExpiry?.toDate?.() > new Date()) {
      const expiryDate = d.boostExpiry.toDate();
      const now = new Date();
      const diffDays = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
      boostBadge = `<span style="color:#ff5722; font-weight:bold; font-size:0.85em; margin-left:6px;">üî• Boosted (${diffDays} day${diffDays !== 1 ? "s" : ""} left)</span>`;
    }

    const card = document.createElement("div");
    card.className = "market-card";
    card.id = `trending-${id}`;
    card.dataset.boosted = "true";
    card.style.position = "relative";

    const images = d.photoURLs || [];
    let imageHTML = '';
    if (images.length > 0) {
      images.forEach((img, idx) => {
        imageHTML += `<img src="${img}" alt="Item Image ${idx + 1}" style="width:100%; height:180px; object-fit:cover; border-radius:8px; margin-bottom:8px; cursor:pointer;" onclick="openImageModal(${idx}, ${JSON.stringify(images)})">`;
      });
    } else {
      imageHTML = `<div style="width:100%; height:180px; background: #f0f0f0; border-radius:8px; margin-bottom:8px; display:flex; justify-content:center; align-items:center; color:#888; cursor:pointer;" onclick="openImageModal()">No Images</div>`;
    }

    card.innerHTML = `
      <h3 style="margin-bottom:6px; color:#2e7d32;">${d.posterName || "Unknown Seller"} ${boostBadge}</h3>
      ${imageHTML}
      <p style="color:#4caf50;">üì¶ <strong>Item name:</strong> ${d.name || "-"}</p>
      <p style="color:#ff9800;">üí∞ <strong>Price:</strong> KES ${d.price ? parseInt(d.price).toLocaleString() : "N/A"}</p>
      <p style="color:#3f51b5;">üìç <strong>Location:</strong> ${d.county || "Unknown"}, ${d.subcounty || "Unknown"}</p>
      <p style="color:#673ab7;">üìû <strong>Contact:</strong> <a href="tel:${d.phone}" style="color:#673ab7;text-decoration:none;">${d.phone || "N/A"}</a></p>
    `;
    trendingContainer.appendChild(card);
  });
}

// -----------------------------
// RENDER ALL MARKET ITEMS
// -----------------------------
let allItems = [...boostedItems, ...normalItems];

// ‚úÖ Sort items: freeBoost first, then boosted, then normal
allItems.sort((a, b) => {
  const aExpiry = a.boostExpiry
    ? (typeof a.boostExpiry.toDate === "function" ? a.boostExpiry.toDate() : new Date(a.boostExpiry))
    : null;
  const bExpiry = b.boostExpiry
    ? (typeof b.boostExpiry.toDate === "function" ? b.boostExpiry.toDate() : new Date(b.boostExpiry))
    : null;

  const aBoosted = a.boosted && aExpiry && aExpiry > new Date();
  const bBoosted = b.boosted && bExpiry && bExpiry > new Date();

  // Free boost should always come first
  if (a.freeBoost && !b.freeBoost) return -1;
  if (!a.freeBoost && b.freeBoost) return 1;

  // Paid boost above normal
  if (aBoosted && !bBoosted) return -1;
  if (!aBoosted && bBoosted) return 1;

  return 0; // keep original order if same type
});

allItems.forEach(d => {
  const id = d.id;
  const isPoster = currentUser && currentUser.uid === d.postedBy;

  // ‚úÖ Safe boost expiry handling
  let expiryDate = null;
  if (d.boostExpiry) {
    expiryDate = typeof d.boostExpiry.toDate === "function"
      ? d.boostExpiry.toDate()
      : new Date(d.boostExpiry);
  }
  const isBoosted = d.boosted && expiryDate && expiryDate > new Date();
  const isExpired = d.boosted && expiryDate && expiryDate <= new Date();

  const canDelete = isPoster || isAdmin;
  const canBoost = isPoster || isAdmin;

  const verifiedBadge = d.verified
    ? `<span class="verified-badge"><i class="fas fa-check-circle"></i> Verified</span>`
    : "";

  let verifyBtnHTML = "";
  if (!d.verified) {
    if (isPoster && !isAdmin) {
      verifyBtnHTML = `<button onclick="payForVerification('marketVerification', '${id}', '${d.name || ''}')" style="background:#4CAF50;color:white;border:none;padding:6px 12px;border-radius:6px;margin-top:6px;">‚úÖ Get Verified ‚Äì Ksh 500</button>`;
    }
    if (isAdmin) {
      verifyBtnHTML += `<button onclick="adminVerifyItem('market', '${id}')" style="background:#2196F3;color:white;border:none;padding:6px 12px;border-radius:6px;margin-top:6px;">üõ°Ô∏è Verify Now (Admin)</button>`;
    }
  }

  // ‚úÖ Boost countdown badge
  let boostBadgeHTML = "";
  if (isBoosted) {
    const now = new Date();
    const diffDays = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
    boostBadgeHTML = `<span class="boosted-badge" data-expiry="${expiryDate.toISOString()}" style="color:${d.freeBoost ? "dodgerblue" : "#ff5722"}; font-weight:bold; font-size:0.85em; margin-left:6px;">üî• ${d.freeBoost ? "Free Boost" : "Boosted"} (${diffDays} day${diffDays !== 1 ? "s" : ""} left)</span>`;
  }



  const card = document.createElement("div");
  card.className = "market-card";
  card.id = `market-${id}`;
  card.dataset.category = d.category || "";
  card.dataset.county = d.county || "";
  if (isBoosted) card.dataset.boosted = "true";
  card.style.position = "relative";

  // ‚úÖ Auto-remove sold > 2 days
  if (d.isSold && d.soldAt) {
    const soldDate = new Date(d.soldAt.toDate ? d.soldAt.toDate() : d.soldAt);
    const now = new Date();
    const diffDays = (now - soldDate) / (1000 * 60 * 60 * 24);
    if (diffDays >= 2) {
      console.log(`Auto-removing sold item: ${id}`);
      return;
    }
  }

  const images = d.photoURLs || [];
  let imageHTML = '';
  if (images.length > 0) {
    images.forEach((img, idx) => {
      imageHTML += `<img src="${img}" alt="Item Image ${idx + 1}" style="width:100%; height:180px; object-fit:cover; border-radius:8px; margin-bottom:8px; cursor:pointer;" onclick="openImageModal(${idx}, ${JSON.stringify(images)})">`;
    });
  } else {
    imageHTML = `<div style="width:100%; height:180px; background:#f0f0f0; border-radius:8px; margin-bottom:8px; display:flex; justify-content:center; align-items:center; color:#888; cursor:pointer;" onclick="openImageModal()">No Images</div>`;
  }

  // ‚úÖ Status badge
  let statusBadge = "";
  if (d.isSold) {
    statusBadge = `
      <div style="
        position:absolute;
        top:10px;
        left:10px;
        background:red;
        color:white;
        padding:4px 10px;
        border-radius:5px;
        font-size:0.85em;
        font-weight:bold;
        z-index:10;
      ">‚ùå Sold Out</div>`;
  } else {
    statusBadge = `
      <div style="
        position:absolute;
        top:10px;
        left:10px;
        background:green;
        color:white;
        padding:4px 10px;
        border-radius:5px;
        font-size:0.85em;
        font-weight:bold;
        z-index:10;
      ">‚úÖ Available</div>`;
  }

  card.innerHTML = `
    ${statusBadge}
    <h3 style="margin-bottom:6px; color:#2e7d32;">
      ${d.posterName || "Unknown Seller"} ${verifiedBadge} ${boostBadgeHTML}
    </h3>
    ${imageHTML}
    <p style="color:#4caf50;">üì¶ <strong>Item name:</strong> ${d.name || "-"}</p>

    <div id="more-${id}" style="display:none; margin-top:8px;">
      <p style="color:#2196f3;">üìù <strong>Status:</strong> ${d.description || "-"}</p>
      <p style="color:#e91e63;">üè∑Ô∏è <strong>Category:</strong> ${d.category || "-"}</p>
      <p style="color:#ff9800;">üí∞ <strong>Price:</strong> KES ${d.price ? parseInt(d.price).toLocaleString() : "N/A"}</p>
      <p style="color:#9c27b0;">üß∞ <strong>Condition:</strong> ${d.condition || "New"}</p>
      <p style="color:#3f51b5;">üìç <strong>Location:</strong> ${d.county || "Unknown"}, ${d.subcounty || "Unknown"}</p>
    </div>

    <button onclick="toggleMore('${id}', this)" style="background:#009688;color:white;border:none;padding:6px 12px;border-radius:6px;margin-top:6px;">‚ûï More</button>

    <p style="color:#673ab7; margin-top:10px;">üìû <strong>Contact:</strong> <a href="tel:${d.phone}" style="color:#673ab7;text-decoration:none;">${d.phone || "N/A"}</a></p>
    ${verifyBtnHTML}

    <!-- Action Buttons -->
    <div style="margin-top:10px;">
      <button onclick="toggleAction('${id}')" style="background:#2196F3;color:#fff;border:none;border-radius:5px;padding:6px 12px;">üõ†Ô∏è Action</button>
      <div id="action-buttons-${id}" style="display:none; margin-top:10px; flex-direction:column; gap:8px;">
        ${isPoster || isAdmin ? `
          <button onclick="openMarketChat('${d.firebaseUid || d.phone}', '${d.posterName || 'Seller'}')" style="background:#673ab7;color:#fff;border:none;border-radius:5px;padding:6px 12px;">üí¨ View Chat</button>
          <button onclick="toggleSoldStatus('${id}')" style="background:#9e9e9e;color:#fff;border:none;border-radius:5px;padding:6px 12px;">${d.isSold ? "üîÑ Mark as Available" : "‚úÖ Mark as Sold"}</button>
          <button onclick="openAllReviewsModal('${id}')" style="background:#03a9f4;color:#fff;border:none;border-radius:6px;padding:6px 12px;">üí¨ View All Reviews</button>
          <button onclick="deleteMarketItem('${id}')" style="background:#dc3545;color:#fff;border:none;border-radius:6px;padding:6px 12px;">üóëÔ∏è Delete</button>

          ${!isBoosted && !isExpired ? `
            <button id="boostMarketBtn-${id}" onclick="boostMarketItem('${id}')" style="background:#ff9800;color:#fff;border:none;border-radius:6px;padding:6px 12px;">üöÄ Boost</button>
          ` : ""}

          ${isExpired ? `
            <button onclick="renewBoost('${id}')" style="background:#ff9800;color:#fff;border:none;border-radius:6px;padding:6px 12px;">üîÑ Renew Boost</button>
          ` : ""}

          <button onclick="openEditForm('${id}')" style="background:#673ab7;color:#fff;border:none;border-radius:6px;padding:6px 12px;">‚úèÔ∏è Edit Item</button>
        ` : ""}

        ${(!isPoster && currentUser) ? `
          <button onclick="showMarketInterest('${id}')" style="background:#f44336;color:#fff;border:none;border-radius:5px;padding:6px 12px;">üí¨ Interest</button>
          <button onclick="reportMarketItem('${id}')" style="background:#ff1744;color:#fff;border:none;border-radius:5px;padding:6px 12px;">üö© Report</button>
          <button onclick="openMarketChat('${d.firebaseUid || d.phone}', '${d.posterName || 'Seller'}')" style="background:#673ab7;color:#fff;border:none;border-radius:5px;padding:6px 12px;">üí¨ Chat</button>
          <button onclick="openReviewModal('${id}')" style="background:#4CAF50;color:#fff;border:none;border-radius:5px;padding:6px 12px;">üìù Review</button>
        ` : ""}
      </div>
    </div>

    <div style="margin-top:10px;">
      <button onclick="window.open('https://wa.me/${d.phone}', '_blank')" style="background:#25D366;color:#fff;border:none;border-radius:5px;padding:6px 12px;">üì± Contact on WhatsApp</button>
    </div>
  `;
  container.appendChild(card);
  updateAverageRating(id);
  loadReviews("market", id);
  loadInterestCount(id);
});

// ‚úÖ ADD ALERT AT THE BOTTOM
const endMessage = document.createElement("div");
endMessage.style.textAlign = "center";
endMessage.style.margin = "20px 0";
endMessage.style.color = "#666";
endMessage.innerHTML = "üìå That's all for now";
container.appendChild(endMessage);

} catch (err) {
  console.error("‚ùå Error loading market items:", err);
} finally {
  if (spinner) spinner.style.display = "none";
}
}

// Toggle Action Button Visibility
function toggleAction(itemId) {
  const actionButtons = document.getElementById(`action-buttons-${itemId}`);
  const isVisible = actionButtons.style.display === 'block';
  actionButtons.style.display = isVisible ? 'none' : 'block';
}

function toggleMore(id, btn) {
  const moreDiv = document.getElementById(`more-${id}`);
  if (moreDiv.style.display === "none") {
    moreDiv.style.display = "block";
    btn.textContent = "‚ûñ Less";
  } else {
    moreDiv.style.display = "none";
    btn.textContent = "‚ûï More";
  }
}





// Function to open image modal with multiple images
function openImageModal(index = 0, images = []) {
  const modal = document.createElement('div');
  modal.classList.add('image-modal');
  modal.innerHTML = `
    <div class="modal-content">
      <span class="close" onclick="closeImageModal()">√ó</span>
      <div class="carousel">
        ${images.length > 0 ? images.map((img, idx) => `
          <img data-src="${img}" style="width: 100%; max-height: 80vh; object-fit: contain; display: ${index === idx ? 'block' : 'none'};" class="carousel-image lazy-load">
        `).join('') : '<p style="text-align: center;">No Images Available</p>'}
      </div>
      <button class="prev" onclick="navigateImageModal(-1)">‚ùÆ Prev</button>
      <button class="next" onclick="navigateImageModal(1)">‚ùØ Next</button>
    </div>
  `;
  document.body.appendChild(modal);

  // Trigger lazy loading for images in the modal
  const imagesInModal = document.querySelectorAll('.lazy-load');
  imagesInModal.forEach(image => {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const image = entry.target;
          image.src = image.getAttribute('data-src'); // Load image when in view
          observer.unobserve(image); // Stop observing after loading
        }
      });
    }, {
      root: null,
      threshold: 0.1 // Trigger when 10% of the image is visible
    });
    observer.observe(image);
  });
}

// Function to close the image modal
function closeImageModal() {
  const modal = document.querySelector('.image-modal');
  if (modal) modal.remove();
}

// Function to navigate through images
function navigateImageModal(direction) {
  const images = document.querySelectorAll('.carousel-image');
  let currentIndex = [...images].findIndex(image => image.style.display === 'block');
  currentIndex = (currentIndex + direction + images.length) % images.length;
  images.forEach((image, idx) => {
    image.style.display = (idx === currentIndex) ? 'block' : 'none';
  });
}


// ‚úÖ Global Chat State
const marketChatState = {
  currentReceiverUid: null,
  unsubscribeMessages: null,
  currentUserId: null
};

// ‚úÖ Enable Firestore Offline Persistence
if (firebase.firestore) {
  firebase.firestore().enablePersistence({ synchronizeTabs: true }).catch(err => {
    console.warn("Firestore persistence error:", err);
  });
}

// ‚úÖ Initialize after Auth
firebase.auth().onAuthStateChanged(user => {
  marketChatState.currentUserId = user?.uid || null;

  if (user) {
    // ‚úÖ Load user's chat list
    loadMyChats();

    // ‚úÖ Start listening for incoming messages in real-time
    listenForIncomingChats();
  }
});

// ‚úÖ Create a text avatar from a name
function createTextAvatar(name) {
  const avatar = document.createElement("div");
  avatar.textContent = name ? name.charAt(0).toUpperCase() : "?";
  avatar.style.width = "40px";
  avatar.style.height = "40px";
  avatar.style.borderRadius = "50%";
  avatar.style.background = "#0b93f6";
  avatar.style.color = "white";
  avatar.style.display = "flex";
  avatar.style.alignItems = "center";
  avatar.style.justifyContent = "center";
  avatar.style.fontWeight = "bold";
  avatar.style.fontSize = "18px";
  avatar.style.marginRight = "10px";
  return avatar;
}

// ‚úÖ Open chat with a market user
function openMarketChat(receiverUid, posterName) {
  if (!marketChatState.currentUserId) {
    alert("Please log in first!");
    return;
  }

  marketChatState.currentReceiverUid = receiverUid;
  document.getElementById("marketChatName").innerText = posterName;
  document.getElementById("marketChatModal").style.display = "flex"; // Open the chat modal

  loadMessagesFromLocal(receiverUid);  // Load saved messages
  loadMarketMessagesRealtime(receiverUid); // Listen for real-time messages
  markMessagesAsRead(receiverUid);  // Mark messages as read

  document.getElementById("marketSendBtn").onclick = sendMarketMessage; // Attach send button

  // ‚úÖ Attach Delete Entire Chat button
  const deleteBtn = document.getElementById("deleteChatBtn");
  if (deleteBtn) {
    deleteBtn.onclick = () => deleteEntireChat(receiverUid);
  }
}


function closeMarketChat() {
  document.getElementById("marketChatModal").style.display = "none";
  if (marketChatState.unsubscribeMessages) marketChatState.unsubscribeMessages();
  marketChatState.unsubscribeMessages = null;
}

// ‚úÖ Send message (with sender name)
async function sendMarketMessage() {
  const input = document.getElementById("marketChatInput");
  const message = input.value.trim();
  if (!message) return alert("Please enter a message!");

  const senderName = firebase.auth().currentUser?.displayName || "You";
  const tempId = "temp_" + Date.now();

  const msgData = {
    id: tempId,
    senderId: marketChatState.currentUserId,
    receiverId: marketChatState.currentReceiverUid,
    senderName: senderName,
    message,
    participants: [marketChatState.currentUserId, marketChatState.currentReceiverUid].sort(),
    status: "sending",
    timestamp: new Date()
  };

  addMessageToUI(msgData, true); // Immediate UI feedback
  saveMessageToLocal(marketChatState.currentReceiverUid, msgData);

  try {
    await db.collection("marketChats").add({
      senderId: msgData.senderId,
      receiverId: msgData.receiverId,
      senderName: msgData.senderName,
      message: msgData.message,
      participants: msgData.participants,
      status: "sent",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    input.value = "";
    showChatAlert("Message sent ‚úÖ", "green");

    if (typeof loadMyChats === "function") loadMyChats(); // Refresh chats list
  } catch (error) {
    console.error("Error sending message:", error);
    msgData.status = "failed";
    addMessageToUI(msgData);
    saveMessageToLocal(marketChatState.currentReceiverUid, msgData);
    showChatAlert("Failed to send ‚ùå", "red");
  }
}

// ‚úÖ Retry queued messages (offline support)
async function retryQueuedMessages() {
  const queue = JSON.parse(localStorage.getItem("messageQueue") || "[]");
  for (const message of queue) {
    try {
      await sendMarketMessage(message);
      const updatedQueue = queue.filter(msg => msg.id !== message.id);
      localStorage.setItem("messageQueue", JSON.stringify(updatedQueue));
    } catch (err) {
      console.log("Retry failed:", err);
    }
  }
}

// ‚úÖ Quick message
function sendMarketQuick(text) {
  document.getElementById("marketChatInput").value = text;
  sendMarketMessage();
}

// ‚úÖ Realtime messages with sender names & full date/time
function loadMarketMessagesRealtime(receiverUid) {
  if (marketChatState.unsubscribeMessages) marketChatState.unsubscribeMessages();

  const messagesContainer = document.getElementById("marketChatMessages");
  messagesContainer.innerHTML = "<p class='chat-loading'>Loading...</p>";

  marketChatState.unsubscribeMessages = db.collection("marketChats")
    .where("participants", "array-contains", marketChatState.currentUserId)
    .where("participants", "array-contains", receiverUid)
    .orderBy("timestamp", "asc")
    .onSnapshot(async snapshot => {
      let messages = JSON.parse(localStorage.getItem(`marketChat_${receiverUid}`) || "[]");
      const messageMap = new Map(messages.map(m => [m.id, m]));

      for (let doc of snapshot.docs) {
        let data = doc.data();
        let msgTimestamp = data.timestamp?.toDate ? data.timestamp.toDate() : new Date();

        if (!data.senderName) {
          try {
            const userDoc = await db.collection("users").doc(data.senderId).get();
            data.senderName = userDoc.exists && userDoc.data().name ? userDoc.data().name : "Unknown";
          } catch (err) { data.senderName = "Unknown"; }
        }

        data.formattedTime = msgTimestamp.toLocaleString("en-US", {
          weekday: "long", year: "numeric", month: "long", day: "numeric",
          hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: true
        });

        messageMap.set(doc.id, { id: doc.id, ...data, timestamp: msgTimestamp });
      }

      const mergedMessages = Array.from(messageMap.values()).sort((a,b) => (a.timestamp?.getTime?.() || 0) - (b.timestamp?.getTime?.() || 0));
      messagesContainer.innerHTML = "";
      mergedMessages.forEach(msg => addMessageToUI(msg));
      localStorage.setItem(`marketChat_${receiverUid}`, JSON.stringify(mergedMessages));
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
}

// ‚úÖ Load messages from localStorage
function loadMessagesFromLocal(receiverUid) {
  const saved = localStorage.getItem(`marketChat_${receiverUid}`);
  const messagesContainer = document.getElementById("marketChatMessages");
  messagesContainer.innerHTML = "";

  if (saved) {
    const messages = JSON.parse(saved);
    messages.forEach(msg => addMessageToUI(msg));
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
}

// ‚úÖ Save message locally
function saveMessageToLocal(receiverUid, message) {
  let messages = JSON.parse(localStorage.getItem(`marketChat_${receiverUid}`) || "[]");
  const index = messages.findIndex(m => m.id === message.id);
  if (index > -1) messages[index] = message;
  else messages.push(message);
  localStorage.setItem(`marketChat_${receiverUid}`, JSON.stringify(messages));
}

// ‚úÖ Mark messages as read
function markMessagesAsRead(receiverUid) {
  const now = firebase.firestore.FieldValue.serverTimestamp();

  db.collection("marketChats")
    .where("senderId", "==", receiverUid)
    .where("receiverId", "==", marketChatState.currentUserId)
    .where("status", "==", "sent")
    .get()
    .then(snapshot => {
      const batch = db.batch();
      let updatedMessages = JSON.parse(localStorage.getItem(`marketChat_${receiverUid}`) || "[]");
      snapshot.forEach(doc => {
        batch.update(doc.ref, { status: "read", readAt: now });
        updatedMessages = updatedMessages.map(m => m.id === doc.id ? { ...m, status: "read", readAt: { seconds: Date.now()/1000 } } : m);
      });
      localStorage.setItem(`marketChat_${receiverUid}`, JSON.stringify(updatedMessages));
      return batch.commit();
    });
}

// ‚úÖ Chat alerts
function showChatAlert(text, color) {
  let alertBox = document.getElementById("chatAlertBox");
  if (!alertBox) {
    alertBox = document.createElement("div");
    alertBox.id = "chatAlertBox";
    alertBox.className = "chat-alert";
    document.body.appendChild(alertBox);
  }
  alertBox.textContent = text;
  alertBox.style.background = color;
  alertBox.style.display = "block";
  setTimeout(() => alertBox.style.display = "none", 2000);
}

// ‚úÖ Load My Chats list with unread badge
async function loadMyChats() {
  const chatList = document.getElementById("chatList");
  chatList.innerHTML = "<p style='color:gray; text-align:center;'>Loading your chats...</p>";

  db.collection("marketChats")
    .where("participants", "array-contains", marketChatState.currentUserId)
    .orderBy("timestamp", "desc")
    .onSnapshot(snapshot => {
      // Clear "loading" text once data is back
      chatList.innerHTML = "";

      if (snapshot.empty) {
        chatList.innerHTML = "<p style='color:gray; text-align:center;'>No chats yet.</p>";
        updateMyChatsBadge(0);
        return;
      }

      const conversations = {};
      let totalUnread = 0;

      snapshot.forEach(doc => {
        const msg = doc.data();
        const otherUser = msg.senderId === marketChatState.currentUserId
          ? msg.receiverId
          : msg.senderId;

        // Keep only the latest message per conversation
        if (
          !conversations[otherUser] ||
          msg.timestamp?.toMillis() > conversations[otherUser].timestamp?.toMillis()
        ) {
          conversations[otherUser] = { ...msg, otherUser };
        }

        // Count unread messages
        if (
          msg.receiverId === marketChatState.currentUserId &&
          msg.status !== "read"
        ) {
          totalUnread++;
        }
      });

      // Render chat items
      Object.values(conversations).forEach(chat => {
        const div = document.createElement("div");
        div.style.display = "flex";
        div.style.alignItems = "center";
        div.style.padding = "10px";
        div.style.borderBottom = "1px solid #eee";
        div.style.cursor = "pointer";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "8px";

        // Text avatar
        const avatar = createTextAvatar(chat.senderName || "U");
        left.appendChild(avatar);

        const textWrapper = document.createElement("div");

        const name = document.createElement("strong");
        name.textContent =
          chat.senderId === marketChatState.currentUserId
            ? "You ‚Üí " + chat.receiverId
            : chat.senderName;
        textWrapper.appendChild(name);

        const snippet = document.createElement("div");
        snippet.textContent =
          chat.message.length > 35
            ? chat.message.slice(0, 35) + "‚Ä¶"
            : chat.message;
        snippet.style.fontSize = "12px";
        snippet.style.color = "#666";
        textWrapper.appendChild(snippet);

        left.appendChild(textWrapper);
        div.appendChild(left);

        div.onclick = () =>
          openMarketChat(
            chat.otherUser,
            chat.senderId === marketChatState.currentUserId
              ? chat.receiverId
              : chat.senderName
          );

        chatList.appendChild(div);
      });

      // ‚úÖ Update unread badge
      updateMyChatsBadge(totalUnread);
    });
}


// ‚úÖ Update My Chats unread badge
function updateMyChatsBadge(count) {
  const badge = document.getElementById("myChatsUnreadBadge");
  if (!badge) return;
  if (count > 0) {
    badge.style.display = "inline-block";
    badge.textContent = count;
  } else {
    badge.style.display = "none";
  }
}


// ‚úÖ Add message to chat window with text avatars & options
function addMessageToUI(msgData, isTemporary = false) {
  const messagesContainer = document.getElementById("marketChatMessages");
  let existingMsg = messagesContainer.querySelector(`[data-id='${msgData.id}']`);
  if (existingMsg) {
    existingMsg.querySelector(".msg-text").textContent = msgData.message;
    updateMessageStatus(existingMsg.querySelector(".msg-status"), msgData);
    return;
  }

  const isOwn = msgData.senderId === marketChatState.currentUserId;

  const msgDiv = document.createElement("div");
  msgDiv.className = isOwn ? "chat-msg chat-out" : "chat-msg chat-in";
  msgDiv.setAttribute("data-id", msgData.id);
  msgDiv.style.display = "flex";
  msgDiv.style.alignItems = "flex-start";
  msgDiv.style.marginBottom = "10px";

  // ‚úÖ Text avatar
  const avatar = createTextAvatar(isOwn ? "You" : msgData.senderName);
  msgDiv.appendChild(avatar);

  const textContainer = document.createElement("div");
  textContainer.style.position = "relative";

  // ‚úÖ Username + date
  const nameLabel = document.createElement("div");
  nameLabel.className = "msg-username";
  let msgDate = msgData.timestamp instanceof Date ? msgData.timestamp : (msgData.timestamp?.toDate ? msgData.timestamp.toDate() : new Date());
  const formattedTime = msgDate.toLocaleString("en-US", { weekday:"long", year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:true });
  nameLabel.textContent = (msgData.senderName || (isOwn ? "You" : "Other User")) + " ‚Ä¢ " + formattedTime;
  textContainer.appendChild(nameLabel);

  // ‚úÖ Message text
  const textSpan = document.createElement("span");
  textSpan.className = "msg-text";
  textSpan.textContent = msgData.message;
  textContainer.appendChild(textSpan);

  // ‚úÖ Status tick
  const statusSpan = document.createElement("span");
  statusSpan.className = "msg-status";
  updateMessageStatus(statusSpan, msgData);
  textContainer.appendChild(statusSpan);
// ‚úÖ Message options (Delete / Copy) with styled menu & custom confirmation
const optionsButton = document.createElement("button");
optionsButton.textContent = "‚ãÆ";
optionsButton.style.position = "absolute";
optionsButton.style.top = "0";
optionsButton.style.right = "-30px";
optionsButton.style.background = "transparent";
optionsButton.style.border = "none";
optionsButton.style.cursor = "pointer";
optionsButton.style.fontSize = "18px";

const optionsMenu = document.createElement("div");
optionsMenu.style.position = "absolute";
optionsMenu.style.top = "20px";
optionsMenu.style.right = "-30px";
optionsMenu.style.background = "#fff";
optionsMenu.style.border = "1px solid #ccc";
optionsMenu.style.borderRadius = "8px";
optionsMenu.style.display = "none";
optionsMenu.style.zIndex = "1000";
optionsMenu.style.minWidth = "120px";
optionsMenu.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
optionsMenu.style.padding = "5px 0";

optionsMenu.innerHTML = `
  <button class="delete-msg" style="display:block; width:100%; padding:8px 10px; border:none; background:#ffdddd; color:#d8000c; cursor:pointer; text-align:left; font-weight:bold; border-bottom:1px solid #f5c6cb;">Delete</button>
  <button class="copy-msg" style="display:block; width:100%; padding:8px 10px; border:none; background:#e7f3fe; color:#00529b; cursor:pointer; text-align:left; font-weight:bold;">Copy</button>
`;

optionsButton.onclick = (e) => {
  e.stopPropagation();
  optionsMenu.style.display = optionsMenu.style.display === "none" ? "block" : "none";
};

// ‚úÖ Custom Delete Confirmation
optionsMenu.querySelector(".delete-msg").onclick = async () => {
  optionsMenu.style.display = "none"; // hide menu first

  // ‚úÖ Create custom confirmation modal
const confirmDiv = document.createElement("div");
confirmDiv.style.position = "fixed";
confirmDiv.style.top = "0";
confirmDiv.style.left = "0";
confirmDiv.style.width = "100%";
confirmDiv.style.height = "100%";
confirmDiv.style.background = "rgba(0,0,0,0.6)";
confirmDiv.style.display = "flex";
confirmDiv.style.justifyContent = "center";
confirmDiv.style.alignItems = "center";
confirmDiv.style.zIndex = "10000"; // <<<<<<<<<< set higher than chat modal

  confirmDiv.innerHTML = `
    <div style="background:white; padding:20px; border-radius:8px; text-align:center; width:300px;">
      <h3 style="color:#d8000c; margin-bottom:15px;">‚ö†Ô∏è Delete Message?</h3>
      <p style="margin-bottom:20px; color:#333;">Are you sure you want to delete this message?</p>
      <button id="confirmDeleteYes" style="margin-right:10px; padding:8px 15px; background:#d8000c; color:white; border:none; border-radius:5px; cursor:pointer;">Yes</button>
      <button id="confirmDeleteNo" style="padding:8px 15px; background:#ccc; color:#333; border:none; border-radius:5px; cursor:pointer;">No</button>
    </div>
  `;
  document.body.appendChild(confirmDiv);

  confirmDiv.querySelector("#confirmDeleteYes").onclick = async () => {
    if (msgData.id.startsWith("temp_")) {
      let messages = JSON.parse(localStorage.getItem(`marketChat_${marketChatState.currentReceiverUid}`) || "[]");
      messages = messages.filter(m => m.id !== msgData.id);
      localStorage.setItem(`marketChat_${marketChatState.currentReceiverUid}`, JSON.stringify(messages));
    } else {
      await db.collection("marketChats").doc(msgData.id).delete();
    }
    msgDiv.remove();
    confirmDiv.remove();
    showChatAlert("Message deleted ‚úÖ", "red");
  };

  confirmDiv.querySelector("#confirmDeleteNo").onclick = () => {
    confirmDiv.remove();
  };
};

// Copy remains the same
optionsMenu.querySelector(".copy-msg").onclick = () => {
  navigator.clipboard.writeText(msgData.message)
    .then(() => showChatAlert("Message copied to clipboard ‚úÖ", "green"))
    .catch(err => console.error("Failed to copy:", err));
  optionsMenu.style.display = "none";
};

textContainer.appendChild(optionsButton);
textContainer.appendChild(optionsMenu);
msgDiv.appendChild(textContainer);

if (isTemporary) msgDiv.style.opacity = "0.5";
messagesContainer.appendChild(msgDiv);
messagesContainer.scrollTop = messagesContainer.scrollHeight;

// Hide options when clicking outside
document.addEventListener("click", e => {
  if (!textContainer.contains(e.target)) optionsMenu.style.display = "none";
});
}

// ‚úÖ Update message status (ticks)
function updateMessageStatus(statusElement, msgData) {
  if (msgData.status === "sent") {
    statusElement.textContent = "‚úì";
    statusElement.style.color = "blue";
  } else if (msgData.status === "read") {
    statusElement.textContent = "‚úì‚úì";
    statusElement.style.color = "green";
  } else {
    statusElement.textContent = "";
  }
}
function listenForIncomingChats() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  db.collection("marketChats") // ‚úÖ same as sendMarketMessage
    .where("participants", "array-contains", user.uid)
    .orderBy("timestamp", "desc")
    .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          const chat = change.doc.data();
          // Only show messages sent to this user
          if (chat.receiverId === user.uid || chat.senderId === user.uid) {
            renderChat(chat, change.doc.id, true);
          }
        }
      });
    });
}


// ‚úÖ Auto-load "My Chats" on page load
document.addEventListener("DOMContentLoaded", () => {
  loadMyChats();
});

// ‚úÖ Delete entire chat with a user (modern modal)
async function deleteEntireChat(otherUserId) {
  if (!marketChatState.currentUserId) return;

  // ‚úÖ Create custom confirmation modal
  const confirmDiv = document.createElement("div");
  confirmDiv.style.position = "fixed";
  confirmDiv.style.top = "0";
  confirmDiv.style.left = "0";
  confirmDiv.style.width = "100%";
  confirmDiv.style.height = "100%";
  confirmDiv.style.background = "rgba(0,0,0,0.6)";
  confirmDiv.style.display = "flex";
  confirmDiv.style.justifyContent = "center";
  confirmDiv.style.alignItems = "center";
  confirmDiv.style.zIndex = "10000"; // Higher than chat modal
  confirmDiv.style.backdropFilter = "blur(3px)";

  confirmDiv.innerHTML = `
    <div style="
      background: #fff; 
      padding: 25px; 
      border-radius: 10px; 
      text-align: center; 
      width: 320px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      font-family: Arial, sans-serif;
    ">
      <h3 style="color:#d8000c; margin-bottom:15px; font-size:20px;">üåù Delete Entire Chat?</h3>
      <p style="margin-bottom:25px; color:#333; font-size:14px;">
        This will remove <strong>all messages</strong> between you and this user permanently.
      </p>
      <div style="display:flex; justify-content:center; gap:10px;">
        <button id="confirmDeleteAllYes" style="
          padding:10px 20px; 
          background:#d8000c; 
          color:white; 
          border:none; 
          border-radius:6px; 
          font-weight:bold;
          cursor:pointer;
          transition:0.2s;
        " onmouseover="this.style.background='#a60000'" onmouseout="this.style.background='#d8000c'">Yes</button>

        <button id="confirmDeleteAllNo" style="
          padding:10px 20px; 
          background:#ccc; 
          color:#333; 
          border:none; 
          border-radius:6px; 
          font-weight:bold;
          cursor:pointer;
          transition:0.2s;
        " onmouseover="this.style.background='#bbb'" onmouseout="this.style.background='#ccc'">No</button>
      </div>
    </div>
  `;

  document.body.appendChild(confirmDiv);

  // ‚úÖ If user confirms deletion
  confirmDiv.querySelector("#confirmDeleteAllYes").onclick = async () => {
    // Delete from Firestore
    const snapshot = await db.collection("marketChats")
      .where("participants", "array-contains", marketChatState.currentUserId)
      .get();

    const batch = db.batch();
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      if (data.participants.includes(otherUserId)) {
        batch.delete(doc.ref);
      }
    });

    await batch.commit();

    // Delete from localStorage
    localStorage.removeItem(`marketChat_${otherUserId}`);

    // Clear chat UI if open
    if (marketChatState.currentReceiverUid === otherUserId) {
      document.getElementById("marketChatMessages").innerHTML = "";
    }

    showChatAlert("Entire chat deleted ‚úÖ", "red");
    confirmDiv.remove();

    // Refresh My Chats list
    if (typeof loadMyChats === "function") loadMyChats();
  };

  confirmDiv.querySelector("#confirmDeleteAllNo").onclick = () => {
    confirmDiv.remove();
  };
}
// ‚úÖ Global Alerts Loading Handler (Real-Time)
function loadAlerts() {
  const container = document.getElementById("marketAlerts");
  const list = document.getElementById("alertsList");
  const badge = document.getElementById("alertsBadge");
  const spinner = document.getElementById("loadingSpinner");

  // Hide container and show spinner while loading
  container.style.display = "none";
  spinner.style.display = "flex";
  list.innerHTML = "<p>Loading alerts...</p>";

  // Check if user is logged in
  if (!isLoggedIn) {
    showCustomAlert("You must be logged in to view alerts.", "error");
    showPage("login");
    return;
  }

  // Show the container after checks
  container.style.display = "block";

  // Add badge animation style if not already added
  if (!document.getElementById("alertsBadgeStyles")) {
    const style = document.createElement("style");
    style.id = "alertsBadgeStyles";
    style.textContent = `
      @keyframes pulseBadge {
        0% { transform: scale(1); background-color: #f44336; }
        50% { transform: scale(1.2); background-color: #e53935; }
        100% { transform: scale(1); background-color: #f44336; }
      }
      .pulse { animation: pulseBadge 0.6s ease; }
    `;
    document.head.appendChild(style);
  }

  const currentUserId = auth.currentUser?.uid || null;
  const currentUserEmail = auth.currentUser?.email || null;
  let previousUnreadCount = 0;

  // Real-time listener for alerts from Firestore
  return db.collection("alerts")
    .orderBy("timestamp", "desc")
    .limit(50)
    .onSnapshot(snapshot => {
      // Debugging: Log the snapshot
      console.log("Snapshot received:", snapshot);  // This will log the snapshot object

      spinner.style.display = "none";

      // If no alerts are returned
      if (snapshot.empty) {
        console.log("No alerts found.");  // Debugging: Log when no alerts are found
        list.innerHTML = "<p style='color:#777;'>No alerts yet.</p>";
        if (badge) badge.style.display = "none";
        previousUnreadCount = 0;
        return;
      }

      // Load deleted alerts from localStorage
      const deletedAlerts = JSON.parse(localStorage.getItem("deletedAlerts")) || [];
      const alerts = [];

      snapshot.forEach(doc => {
        const data = doc.data();

        // Debugging: Log each alert document
        console.log("Alert data:", data);  // This will log each alert's data

        // Skip deleted alerts
        if (deletedAlerts.includes(doc.id)) return;

        // Check if the alert is global or specific to the current user
        if (
          !data.targetUserId && !data.targetEmail || // global
          data.targetUserId === currentUserId ||    // user specific
          data.targetEmail === currentUserEmail     // email match
        ) {
          alerts.push({ id: doc.id, ref: doc.ref, ...data });
        }
      });

      // Sort unread alerts first
      alerts.sort((a, b) => {
        const aRead = a.readBy?.includes(currentUserId) || false;
        const bRead = b.readBy?.includes(currentUserId) || false;
        if (aRead !== bRead) return aRead ? 1 : -1;
        return (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0);
      });

      // Filter unread alerts
      const unreadAlerts = alerts.filter(a => !a.readBy?.includes(currentUserId));

      // Debugging: Log unread alerts
      console.log("Unread alerts:", unreadAlerts);  // This will log the unread alerts

      // Update the badge for unread alerts
      if (badge) {
        if (unreadAlerts.length > 0) {
          badge.textContent = unreadAlerts.length;
          badge.style.display = "inline-block";
          if (unreadAlerts.length > previousUnreadCount) {
            badge.classList.remove("pulse");
            void badge.offsetWidth; // Trigger the animation reset
            badge.classList.add("pulse");
          }
        } else {
          badge.style.display = "none";
        }
      }
      previousUnreadCount = unreadAlerts.length;

      // Create the HTML for alerts
      let alertsHTML = `
        <div style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
          ${unreadAlerts.length > 0 && currentUserId ? `
            <button onclick="confirmMarkAllAlertsAsRead(${unreadAlerts.length})"
              style="background:#4caf50;color:white;border:none;padding:6px 12px;
              border-radius:6px;cursor:pointer;">
              ‚úÖ Mark All as Read (${unreadAlerts.length})
            </button>` : ""}
          <button onclick="confirmDeleteAllAlerts()"
            style="background:#f44336;color:white;border:none;padding:6px 12px;
            border-radius:6px;cursor:pointer;">
            üóëÔ∏è Delete All
          </button>
        </div>
      `;

      // Loop through alerts and generate HTML for each
      alerts.forEach(data => {
        const alertId = data.id;
        const timestamp = data.timestamp?.toDate
          ? new Date(data.timestamp.toDate()).toLocaleString()
          : "Unknown date";

        const isRead = data.readBy?.includes(currentUserId);

        const readButton = (!isRead && currentUserId)
          ? `<button onclick="markAlertAsRead('${alertId}')"
                style="background:#4caf50;color:white;border:none;padding:4px 8px;
                border-radius:4px;font-size:12px;cursor:pointer;">
                ‚úÖ Mark as Read
             </button>` 
          : `<span style="color:${isRead ? 'green' : 'red'}; font-size:12px;">
              ${isRead ? '‚úÖ Read' : 'üÜï Unread'}
             </span>`;

        const deleteButton = (data.userId === currentUserId || isAdminEmail(auth.currentUser.email))
          ? `<button onclick="confirmDeleteAlert('${alertId}')"
              style="background:#f44336;color:white;border:none;padding:4px 8px;
              border-radius:4px;font-size:12px;cursor:pointer;">
              üóëÔ∏è Delete
             </button>` 
          : "";

        alertsHTML += `
          <div id="alert-${alertId}" class="alert-card" style="
            border-left:4px solid ${isRead ? '#4caf50' : '#f44336'}; 
            padding:8px;
            margin-bottom:10px;
            box-shadow:0 1px 4px rgba(0,0,0,0.08);
            border-radius:6px;
            background:${isRead ? '#e0f7fa' : '#fff3e0'};">
            <div class="alert-content">
              <strong>${escapeHTML(data.title)}</strong><br>
              ${escapeHTML(data.message)}<br>
              <small>${timestamp}</small><br>
              <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;">
                ${readButton}
                ${deleteButton}
              </div>
            </div>
          </div>
        `;
      });

      // Insert the alerts HTML into the list
      list.innerHTML = alertsHTML;

    }, err => {
      console.error("‚ùå Error loading alerts:", err);
      spinner.style.display = "none";
      list.innerHTML = "<p style='color:#777;'>Failed to load alerts. Please try again.</p>";
    });
}


// ‚úÖ Escape HTML helper
function escapeHTML(str) {
  return str ? str.replace(/[&<>"']/g, tag =>
    ({"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[tag] || tag)
  ) : "";
}



// ‚úÖ Confirm Mark All Alerts as Read
function confirmMarkAllAlertsAsRead(unreadCount) {
  showToastConfirm(`Mark all ${unreadCount} alerts as read?`, markAllAlertsAsRead);
}

// ‚úÖ Mark Single Alert as Read 
async function markAlertAsRead(alertId) {
  const currentUserId = auth.currentUser?.uid;
  if (!currentUserId) return showCustomAlert("‚ùå You must be logged in", "error");

  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    const alertRef = db.collection("alerts").doc(alertId);
    const alertDoc = await alertRef.get();

    if (!alertDoc.exists) {
      return showCustomAlert("‚ö†Ô∏è Alert not found", "error");
    }

    const alertData = alertDoc.data();
    const isAdmin = isAdminEmail(auth.currentUser.email);

    // ‚úÖ Normal users can only mark their own alerts
    if (alertData.targetUserId !== currentUserId && !isAdmin) {
      return showCustomAlert("‚õî You cannot mark this alert", "error");
    }

    // üîπ Update Firestore
    await alertRef.update({
      readBy: firebase.firestore.FieldValue.arrayUnion(currentUserId)
    });

    // üîπ Update UI instantly
    const alertElement = document.getElementById(`alert-${alertId}`);
    if (alertElement) {
      alertElement.style.background = "#e0f7fa"; // light blue
      alertElement.style.borderLeft = "4px solid #2196f3"; // blue border
      const readButton = alertElement.querySelector("button");
      if (readButton && readButton.textContent.includes("Mark as Read")) {
        readButton.outerHTML = `<span style="color:#2196f3;font-size:14px;">‚úî‚úî</span>`;
      }
    }

    showCustomAlert("‚úÖ Alert marked as read", "success");
  } catch (error) {
    showCustomAlert("‚ùå Failed to mark as read: " + error.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}

// ‚úÖ Mark All Alerts as Read
async function markAllAlertsAsRead() {
  const currentUserId = auth.currentUser?.uid;
  if (!currentUserId) return showCustomAlert("‚ùå You must be logged in", "error");

  const isAdmin = isAdminEmail(auth.currentUser.email);
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    const snapshot = await db.collection("alerts").get();
    if (snapshot.empty) return showCustomAlert("‚ÑπÔ∏è No alerts to mark as read", "info");

    const batch = db.batch();

    snapshot.forEach(doc => {
      const data = doc.data();
      if (isAdmin || data.targetUserId === currentUserId) {
        batch.update(doc.ref, {
          readBy: firebase.firestore.FieldValue.arrayUnion(currentUserId)
        });
      }
    });

    await batch.commit();

    // üîπ Update all visible alerts in UI instantly
    document.querySelectorAll(".alert-card").forEach(card => {
      const readButton = card.querySelector("button");
      if (readButton && readButton.textContent.includes("Mark as Read")) {
        readButton.outerHTML = `<span style="color:#2196f3;font-size:14px;">‚úî‚úî</span>`;
      }
      card.style.background = "#e0f7fa"; // light blue
      card.style.borderLeft = "4px solid #2196f3"; // blue border
    });

    showCustomAlert("‚úÖ All alerts marked as read", "success");
  } catch (error) {
    showCustomAlert("‚ùå Error marking alerts: " + error.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}


// ‚úÖ Confirm Delete Single Alert
function confirmDeleteAlert(alertId) {
  showToastConfirm("üóëÔ∏è Delete this alert?", () => deleteAlert(alertId));
}

// ‚úÖ Delete Single Alert
async function deleteAlert(alertId) {
  const currentUserId = auth.currentUser?.uid;
  if (!currentUserId) return showCustomAlert("‚ùå You must be logged in", "error");

  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    await db.collection("alerts").doc(alertId).delete();

    // Track deleted in localStorage
    let deletedAlerts = JSON.parse(localStorage.getItem("deletedAlerts")) || [];
    if (!deletedAlerts.includes(alertId)) deletedAlerts.push(alertId);
    localStorage.setItem("deletedAlerts", JSON.stringify(deletedAlerts));

    const alertElement = document.getElementById(`alert-${alertId}`);
    if (alertElement) alertElement.remove();

    showCustomAlert("üóëÔ∏è Alert deleted", "success");
  } catch (error) {
    showCustomAlert("‚ùå Error deleting alert: " + error.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}

// ‚úÖ Confirm Delete All Alerts
function confirmDeleteAllAlerts() {
  showToastConfirm("üåù Delete ALL alerts?", deleteAllAlerts);
}

// ‚úÖ Delete All Alerts
async function deleteAllAlerts() {
  const currentUserId = auth.currentUser?.uid;
  if (!currentUserId) return showCustomAlert("‚ùå You must be logged in", "error");

  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    const snapshot = await db.collection("alerts").get();
    if (snapshot.empty) return showCustomAlert("‚ÑπÔ∏è No alerts to delete", "info");

    const batch = db.batch();
    let deletedIds = JSON.parse(localStorage.getItem("deletedAlerts")) || [];

    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.targetUserId === currentUserId || isAdminEmail(auth.currentUser.email) || !data.targetUserId) {
        batch.delete(doc.ref);
        deletedIds.push(doc.id);
      }
    });

    await batch.commit();

    localStorage.setItem("deletedAlerts", JSON.stringify(deletedIds));

    const alertsList = document.getElementById("alertsList");
    if (alertsList) alertsList.innerHTML = "<p style='color:#777;'>All alerts deleted.</p>";

    showCustomAlert("üóëÔ∏è All alerts deleted successfully", "success");
  } catch (error) {
    showCustomAlert("‚ùå Error deleting alerts: " + error.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}


// üîë Helper: Admin check using Firestore
function isAdminEmail() {
  const user = firebase.auth().currentUser;

  if (!user) {
    console.log('No user is logged in.');
    return false;
  }

  const userRef = firebase.firestore().collection("users").doc(user.uid);

  // Fetch the user's role from Firestore
  return userRef.get().then(doc => {
    if (doc.exists && doc.data().role === "admin") {
      console.log("User is an admin.");
      return true;  // User is an admin
    } else {
      console.log("User is not an admin.");
      return false; // User is not an admin
    }
  }).catch(error => {
    console.log("Error checking admin status:", error);
    return false;  // Error in checking
  });
}


async function loadInterestCount(itemId) {
  try {
    const snapshot = await db.collection("marketItems").doc(itemId).collection("interests").get();
    const count = snapshot.size;
    const el = document.getElementById(`marketInterestCount-${itemId}`);
    if (el) el.innerText = count;
  } catch (err) {
    console.error(`Failed to load interest count for ${itemId}`, err);
  }
}

function openAllReviewsModal(itemId) {
  document.getElementById("allReviewsModal").style.display = "flex";
  loadReviews("market", itemId, true); // ‚úÖ Fixed: use "market" as section name
}

function closeAllReviewsModal() {
  document.getElementById("allReviewsModal").style.display = "none";
  document.getElementById("allReviewsContainer").innerHTML = "";
}

let currentReviewingItemId = null;
let currentReviewingType = "market"; // "market" or "service"

function openReviewModal(itemId, type = "market") {
  currentReviewingItemId = itemId;
  currentReviewingType = type;
  document.getElementById("reviewModal").style.display = "flex";
}

function closeReviewModal() {
  document.getElementById("reviewModal").style.display = "none";
  document.getElementById("reviewEmail").value = "";
  document.getElementById("reviewComment").value = "";
  currentReviewingItemId = null;
  currentReviewingType = "market";
}

// ‚úÖ Submit Review from Modal
async function submitReviewFromModal() {
  const email = document.getElementById("reviewEmail").value.trim();
  const comment = document.getElementById("reviewComment").value.trim();

  if (!email || !comment) {
    alert("Please fill in both email and comment.");
    return;
  }

  const review = {
    email,
    comment,
    timestamp: new Date(),
    userId: currentUser?.uid || null
  };

  const spinner = document.getElementById("loadingSpinner"); // Get the spinner element
  spinner.style.display = "flex"; // Show the spinner before starting the process

  try {
    const ref = (currentReviewingType === "service" ? servicesRef : marketRef)
      .doc(currentReviewingItemId)
      .collection("reviews");

    await ref.add(review); // Add the review

    closeReviewModal(); // Close the modal after submission
    showCustomAlert("‚úÖ Review submitted!", "success");

    // Reload reviews depending on type
    if (currentReviewingType === "service") {
      loadServiceReviews(currentReviewingItemId);
    } else {
      loadReviews("market", currentReviewingItemId); // ‚úÖ fixed call
    }
  } catch (err) {
    console.error("‚ùå Failed to submit review:", err);
    showCustomAlert("‚ùå Failed to submit review", "error");
  } finally {
    spinner.style.display = "none"; // Hide the spinner after the process is done
  }
}
async function loadReviews(section, itemId, intoModal = false) {
  let ref;
  if (section === "market") ref = marketRef.doc(itemId);
  else if (section === "service") ref = serviceRef.doc(itemId);
  else return;

  const container = intoModal
    ? document.getElementById("allReviewsContainer")
    : null;

  if (!container) return;

  // Show loading spinner
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show spinner while loading

  container.innerHTML = "";

  try {
    const snapshot = await ref.collection("reviews").orderBy("timestamp", "desc").get();
    if (snapshot.empty) {
      container.innerHTML = "<p style='padding:10px;color:#999;'>No reviews yet.</p>";
      return;
    }

    // ‚úÖ Reusable helper: check admin from Firestore
async function checkIfAdmin(user) {
  if (!user) return false;
  try {
    const doc = await db.collection("admins").doc(user.uid).get();
    return doc.exists; // true if UID exists in admins
  } catch (err) {
    console.error("Error checking admin status:", err);
    return false;
  }
}

// ‚úÖ Usage inside your snapshot handling
const currentUser = auth.currentUser;
const currentEmail = currentUser?.email || "";

// üîπ Check if current user is admin
const isAdmin = await checkIfAdmin(currentUser);

snapshot.forEach(doc => {
  const review = doc.data();
  const reviewId = doc.id;

  // User owns this review if their email matches
  const isOwner = currentEmail === review.email;

      const div = document.createElement("div");
      div.className = "review";
      div.style.border = "1px solid #ddd";
      div.style.margin = "5px 0";
      div.style.padding = "10px";
      div.style.borderRadius = "5px";

      div.innerHTML = `
        <p style="margin: 5px 0;"><strong>${review.email || "Anonymous"}:</strong></p>
        <p style="margin: 0;">${review.comment}</p>
      `;

      // ‚úÖ Show delete button if admin or owner
      if (isAdmin || isOwner) {
        const delBtn = document.createElement("button");
        delBtn.textContent = "üóëÔ∏è Delete";
        delBtn.style.cssText = `
          margin-top: 5px;
          background: red;
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 4px;
          cursor: pointer;
        `;

        delBtn.onclick = () => {
          showDeleteModal(async () => {
            try {
              await ref.collection("reviews").doc(reviewId).delete();
              showCustomAlert("Review deleted successfully.", "success");
              loadReviews(section, itemId, intoModal); // Reload after delete
            } catch (err) {
              console.error("Failed to delete review:", err);
              showCustomAlert("Failed to delete review.", "error");
            }
          });
        };

        div.appendChild(delBtn);
      }

      container.appendChild(div);
    });
  } catch (error) {
    console.error("Error loading reviews:", error);
    container.innerHTML = "<p style='color:red;padding:10px;'>Failed to load reviews.</p>";
  } finally {
    // Hide the spinner once done
    if (spinner) spinner.style.display = "none";
  }
}


function showDeleteModal(onConfirm) {
  const modal = document.createElement("div");
  modal.innerHTML = `
    <div style="
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6); display: flex;
      align-items: center; justify-content: center; z-index: 9999;">
      <div style="
        background: white; padding: 20px; border-radius: 10px;
        max-width: 400px; text-align: center; font-family: sans-serif;">
        <h3 style="margin-bottom: 10px;">‚ö†Ô∏è Confirm Deletion</h3>
        <p style="margin-bottom: 20px;">Are you sure you want to delete this review?</p>
        <button id="confirmDelete" style="
          background: red; color: white; border: none;
          padding: 10px 20px; border-radius: 5px; margin-right: 10px;
          cursor: pointer;">Yes, Delete</button>
        <button id="cancelDelete" style="
          background: gray; color: white; border: none;
          padding: 10px 20px; border-radius: 5px;
          cursor: pointer;">Cancel</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  modal.querySelector("#cancelDelete").onclick = () => modal.remove();
  modal.querySelector("#confirmDelete").onclick = () => {
    onConfirm();
    modal.remove();
  };
}


async function submitReviewReply(section, itemId, reviewId) {
  const input = document.getElementById(`replyInput-${reviewId}`);
  const replyText = input?.value.trim();

  if (!replyText) {
    alert("Please write a reply before submitting.");
    return;
  }

  const reply = {
    comment: replyText,
    timestamp: new Date(),
    userId: currentUser?.uid || null
  };

  // Show the loading spinner
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show spinner during submission

  try {
    let ref;
    if (section === "market" || section === "marketItems") {
      ref = db.collection("marketItems").doc(itemId).collection("reviews").doc(reviewId);
    } else if (section === "service") {
      ref = db.collection("services").doc(itemId).collection("reviews").doc(reviewId);
    } else {
      return;
    }

    await ref.collection("replies").add(reply);
    showCustomAlert("‚úÖ Reply posted!", "success");

    // Reload reviews to reflect the new reply
    loadReviews(section, itemId, true);

  } catch (err) {
    console.error("‚ùå Failed to submit reply:", err);
    showCustomAlert("‚ùå Failed to submit reply", "error");
  } finally {
    // Hide the spinner once done
    if (spinner) spinner.style.display = "none";
  }
}


async function reportMarketItem(itemId) {
  showReportConfirmModal(async () => {
    const user = firebase.auth().currentUser;
    if (!user) return showCustomAlert("‚ö†Ô∏è You must be logged in to report an item.", "warning");

    // Show loading spinner while the report is being processed
    const spinner = document.getElementById("loadingSpinner");
    if (spinner) spinner.style.display = "flex"; // Show spinner during the report process

    try {
      const itemSnap = await marketRef.doc(itemId).get();
      const item = itemSnap.data();
      const itemOwnerId = item?.userId;

      if (!item) throw new Error("Item not found");

      // Save the report to Firestore
      await db.collection("marketReports").add({
        itemId,
        reportedBy: user.uid,
        reporterName: user.displayName || user.email,
        itemName: item.name || "Unnamed Item",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Notify Admins
      await db.collection("adminNotifications").add({
        type: "Market Report",
        itemId,
        itemName: item.name || "Unnamed Item",
        reportedBy: user.displayName || user.email,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        message: `üö© Market item "${item.name}" was reported by ${user.displayName || user.email}.`
      });

      // Notify Item Owner
      if (itemOwnerId && itemOwnerId !== user.uid) {
        await db
          .collection("userNotifications")
          .doc(itemOwnerId)
          .collection("notifications")
          .add({
            type: "Item Reported",
            itemId,
            itemName: item.name,
            from: user.displayName || user.email,
            message: `‚ö†Ô∏è Your market item "${item.name}" has been reported by a user.`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            read: false
          });
      }

      showCustomAlert("‚úÖ Report submitted. Admin will review it shortly.", "success");
    } catch (error) {
      console.error("‚ùå Report failed:", error);
      showCustomAlert("‚ùå Could not report the item. Try again.", "error");
    } finally {
      // Hide the spinner once done
      if (spinner) spinner.style.display = "none";
    }
  });
}

async function loadUserNotifications() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const snapshot = await db
    .collection("userNotifications")
    .doc(user.uid)
    .collection("notifications")
    .orderBy("timestamp", "desc")
    .get();

  snapshot.forEach((doc) => {
    const notif = doc.data();
    // Display in your preferred HTML section
    console.log("üîî", notif.message);
  });
}
// ‚úÖ Check admin status from Firestore (by UID)
async function checkIfAdmin(user) {
  try {
    const doc = await db.collection("admins").doc(user.uid).get();
    return doc.exists; // true if UID exists in admins collection
  } catch (error) {
    console.error("Error checking admin status:", error);
    return false;
  }
}

// ======================= Custom Modal =======================
// Create a reusable modal for user input if it doesn't exist
function ensureInterestModal() {
  if (document.getElementById("interestModal")) return;

  const modalHTML = `
    <div id="interestModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
         background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
      <div style="background:#fff; padding:20px; width:90%; max-width:400px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.3); text-align:center;">
        <h3>Express Interest</h3>
        <p style="font-size:14px;color:#444;">Enter a short note (optional) and confirm your phone.</p>
        <textarea id="interestNote" placeholder="E.g., I‚Äôd like to buy, please call." style="width:100%; padding:8px; margin:8px 0;"></textarea>
        <input type="text" id="interestPhone" placeholder="Your phone number" style="width:100%; padding:8px; margin:8px 0;" />
        <label style="font-size:13px;"><input type="checkbox" id="saveInterestDetails"/> Save for future</label><br>
        <button id="interestSubmitBtn" style="background:#4CAF50;color:#fff;padding:8px 16px;border:none;border-radius:5px;cursor:pointer;margin-top:10px;">Submit</button>
        <button id="interestCancelBtn" style="background:#ccc;padding:8px 16px;border:none;border-radius:5px;cursor:pointer;margin-top:10px;">Cancel</button>
      </div>
    </div>`;
  document.body.insertAdjacentHTML("beforeend", modalHTML);

  document.getElementById("interestCancelBtn").onclick = () => {
    document.getElementById("interestModal").style.display = "none";
  };
}

function openInterestModal() {
  ensureInterestModal();
  return new Promise(resolve => {
    const modal = document.getElementById("interestModal");
    modal.style.display = "flex";
    // Preload saved phone if exists
    firebase.auth().currentUser && db.collection("users").doc(firebase.auth().currentUser.uid)
      .get().then(snap => {
        if (snap.exists && snap.data().phone) {
          document.getElementById("interestPhone").value = snap.data().phone;
        }
      });
    document.getElementById("interestSubmitBtn").onclick = async () => {
      const note = document.getElementById("interestNote").value.trim();
      const phone = document.getElementById("interestPhone").value.trim();
      const save = document.getElementById("saveInterestDetails").checked;

      if (!phone) {
        showCustomAlert("Please enter your phone number.", "error", true);
        return;
      }
      modal.style.display = "none";
      resolve({ note, phone, save });
    };
  });
}

// ======================= Center Toast =======================
function showCustomAlert(message, type = "info", center = false) {
  const alert = document.createElement("div");
  alert.innerText = message;
  alert.style.position = "fixed";
  alert.style.zIndex = "10000";
  alert.style.background = type === "success" ? "#4CAF50" : (type === "error" ? "#f44336" : "#2196F3");
  alert.style.color = "#fff";
  alert.style.padding = "10px 20px";
  alert.style.borderRadius = "6px";
  alert.style.boxShadow = "0 4px 8px rgba(0,0,0,0.2)";
  alert.style.fontSize = "14px";
  alert.style.transition = "opacity 0.3s ease";
  alert.style.opacity = "1";
  alert.style.maxWidth = "80%";
  alert.style.textAlign = "center";
  if (center) {
    alert.style.top = "50%";
    alert.style.left = "50%";
    alert.style.transform = "translate(-50%, -50%)";
  } else {
    alert.style.bottom = "20px";
    alert.style.right = "20px";
  }
  document.body.appendChild(alert);
  setTimeout(() => {
    alert.style.opacity = "0";
    setTimeout(() => alert.remove(), 300);
  }, 3000);
}

// ======================= Optimized Function =======================
async function showMarketInterest(itemId) {
  const user = firebase.auth().currentUser;
  if (!user) {
    showCustomAlert("üîê You need to be logged in to express interest.", "info", true);
    return;
  }

  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  const itemRef = db.collection("marketItems").doc(itemId);
  const interestRef = itemRef.collection("interests").doc(user.uid);

  try {
    // ‚ö° Check if user already expressed interest
    const alreadyInterested = await interestRef.get().then(doc => doc.exists);
    if (alreadyInterested) {
      showCustomAlert("‚ùå You have already expressed interest.", "info", true);
      if (spinner) spinner.style.display = "none";
      return;
    }

    // Get user input via modal (phone number and optional note)
    const { note, phone, save } = await openInterestModal();
    if (!phone) {
      if (spinner) spinner.style.display = "none";
      return; // Cancelled or invalid phone number
    }

    // Save phone to user profile if user opts to save it
    if (save) {
      await db.collection("users").doc(user.uid).set({ phone }, { merge: true });
    }

    // ‚ö° Optimistically update UI instantly
    const countEl = document.getElementById(`marketInterestCount-${itemId}`);
    if (countEl) {
      const currentCount = parseInt(countEl.innerText) || 0;
      countEl.innerText = currentCount + 1;
    }

    // Record interest and fetch item details in parallel
    const itemPromise = itemRef.get();
    const saveInterestPromise = interestRef.set({
      userId: user.uid,
      phone,
      note: note || "",  // Optional note
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    const [itemSnap] = await Promise.all([itemPromise, saveInterestPromise]);

    const item = itemSnap.data() || {};
    const posterId = item.postedBy;
    const itemName = item.name || "this item";
    const posterPhone = item.phone || "No phone provided";
    const posterLocation = `${item.county || ""} ${item.subcounty || ""}`.trim() || "No location provided";
    const userName = user.displayName || user.email || "Someone";

    // ‚ö° Prepare notifications
    const alertPromises = [];

    // Notify the poster of the new interest
    if (posterId && posterId !== user.uid) {
      alertPromises.push(
        db.collection("alerts").add({
          targetUserId: posterId,
          title: "‚ù§Ô∏è New Interest in Your Item",
          message: `${userName} has expressed interest in "${itemName}" (User Phone: ${phone}).`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          readBy: []
        })
      );
    }

    // üîπ Dynamically fetch admin emails from Firestore
    const adminSnapshot = await db.collection("users").where("isAdmin", "==", true).get();
    const adminEmails = [];
    adminSnapshot.forEach(doc => {
      const data = doc.data();
      if (data.email) adminEmails.push(data.email);
    });

    // Notify admins
    for (const email of adminEmails) {
      alertPromises.push(
        db.collection("alerts").add({
          targetEmail: email,
          title: "üì¢ Market Interest",
          message: `${userName} has expressed interest in "${itemName}" (User Phone: ${phone}, Poster Phone: ${posterPhone}, üìç ${posterLocation}).`,
          itemId: itemId,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          readBy: []
        })
      );
    }

    // Fire off alerts without blocking UI
    Promise.allSettled(alertPromises);

    showCustomAlert("‚úÖ Your interest has been recorded!", "success", true);
  } catch (err) {
    console.error("‚ùå Error recording interest:", err);
    showCustomAlert(`‚ùå Failed to record your interest. Error: ${err.message || err}`, "error", true);
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}

async function openEditForm(itemId) {
  const itemRef = marketRef.doc(itemId);

  try {
    const doc = await itemRef.get();
    if (!doc.exists) {
      console.error("Item not found");
      return;
    }

    const itemData = doc.data();
    console.log("Item data fetched:", itemData);

    // Populate the form with the current data
    document.getElementById("itemName").value = itemData.name || '';
    document.getElementById("itemPrice").value = itemData.price || '';
    document.getElementById("itemDescription").value = itemData.description || '';
    document.getElementById("itemCategory").value = itemData.category || '';
    document.getElementById("itemLocation").value = itemData.county || '';

    // Change button text to 'Update Item'
    const submitButton = document.querySelector("#captureMarketItemForm button");
    submitButton.innerHTML = "Update Item";

    // Handle form submission
    document.getElementById("captureMarketItemForm").onsubmit = function(event) {
      event.preventDefault(); // Prevent form submission
      saveItemChanges(itemId); // Save the changes
    };

    console.log('Form is ready to be edited.');
  } catch (error) {
    console.error("Error fetching item data:", error);
  }
}

// Save the changes made in the form
async function saveItemChanges(itemId) {
  const updatedItem = {
    name: document.getElementById("itemName").value,
    price: parseFloat(document.getElementById("itemPrice").value),
    description: document.getElementById("itemDescription").value,
    category: document.getElementById("itemCategory").value,
    county: document.getElementById("itemLocation").value,
  };

  console.log("Saving updated item:", updatedItem);

  // Show the loading spinner
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show spinner during the process

  try {
    const itemRef = marketRef.doc(itemId);
    await itemRef.update(updatedItem);

    console.log("Item successfully updated!");
    showCustomAlert("‚úÖ Item updated successfully!", "success");

    loadMarketItems(); // Refresh the market items to reflect changes

  } catch (error) {
    console.error("Error updating item:", error);
    showCustomAlert("‚ùå Failed to update item. Try again later.", "error");

  } finally {
    // Hide the loading spinner after the operation completes
    if (spinner) spinner.style.display = "none";
  }
}


function showReportConfirmModal(onConfirm) {
  const overlay = document.createElement("div");
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5); z-index: 9998; display: flex;
    align-items: center; justify-content: center;
  `;

  const box = document.createElement("div");
  box.style.cssText = `
    background: white; padding: 20px 30px; border-radius: 12px;
    text-align: center; max-width: 360px; font-size: 1.1em;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  `;
  box.innerHTML = `
    <p style="margin-bottom: 20px;">üö© Are you sure you want to report this item?</p>
    <button id="reportConfirmYes" style="margin-right: 10px; padding: 8px 16px; border: none; border-radius: 5px; background: #f44336; color: white; cursor: pointer;">Yes, Report</button>
    <button id="reportConfirmCancel" style="padding: 8px 16px; border: none; border-radius: 5px; background: #ccc; color: black; cursor: pointer;">Cancel</button>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  document.getElementById("reportConfirmYes").onclick = () => {
    document.body.removeChild(overlay);
    onConfirm();
  };

  document.getElementById("reportConfirmCancel").onclick = () => {
    document.body.removeChild(overlay);
  };
}

function showCustomAlert(message, type = "info") {
  const colors = {
    success: "#4caf50",
    error: "#f44336",
    warning: "#ff9800",
    info: "#2196f3"
  };

  const alertBox = document.createElement("div");
  alertBox.innerText = message;

  Object.assign(alertBox.style, {
    position: "fixed",
    top: "50%",
    left: "50%",
    transform: "translate(-50%, -50%)",
    backgroundColor: colors[type] || "#333",
    color: "#fff",
    padding: "16px 28px",
    fontSize: "1.1em",
    borderRadius: "10px",
    boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
    zIndex: "9999",
    textAlign: "center",
    opacity: "0",
    whiteSpace: "pre-line",
    transition: "opacity 0.3s ease, transform 0.3s ease",
  });

  document.body.appendChild(alertBox);

  setTimeout(() => {
    alertBox.style.opacity = "1";
    alertBox.style.transform = "translate(-50%, -50%) scale(1.05)";
  }, 10);

  setTimeout(() => {
    alertBox.style.opacity = "0";
    alertBox.style.transform = "translate(-50%, -50%) scale(0.95)";
    setTimeout(() => alertBox.remove(), 400);
  }, 3500);
}

// ‚úÖ Boost market item
async function boostMarketItem(id) {
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    const itemRef = marketRef.doc(id);
    const doc = await itemRef.get();
    if (!doc.exists) {
      showCustomAlert("‚ùå Item not found.", "error");
      return;
    }

    const data = doc.data();
    const postedBy = data.postedBy;
    const currentUser = firebase.auth().currentUser;

    if (!currentUser) {
      showCustomAlert("‚ùå You need to be logged in to boost an item.", "error");
      return;
    }

    // ‚úÖ Admin can boost FREE always
    const token = await currentUser.getIdTokenResult();
    const isAdmin = token.claims.admin === true;

    if (isAdmin) {
      await applyMarketBoost(itemRef, id, data, currentUser, true); // free boost
      return;
    }

    // ‚úÖ Normal poster must pay
    if (currentUser.uid === postedBy) {
      showPaymentModalFor("boost", 250, id, data.name, async () => {
        await applyMarketBoost(itemRef, id, data, currentUser, false);
      });
      return;
    }

    // ‚úÖ Other users (non-admin, non-poster) ‚Üí free boost
    await applyMarketBoost(itemRef, id, data, currentUser, true);

  } catch (err) {
    console.error("‚ùå Boost error:", err);
    showCustomAlert("‚ùå Failed to boost: " + err.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}

// ‚úÖ Extracted helper to reuse for poster & admin
async function applyMarketBoost(itemRef, id, data, currentUser, freeBoost = false) {
  const boostExpiry = new Date();
  boostExpiry.setDate(boostExpiry.getDate() + 7);

  await itemRef.update({
    boosted: true,
    freeBoost: freeBoost, // üîπ mark if free boost
    boostExpiry: firebase.firestore.Timestamp.fromDate(boostExpiry)
  });

  showCustomAlert(
    freeBoost
      ? "‚úÖ Item boosted for FREE by Admin."
      : "‚úÖ Item boosted successfully.",
    "success"
  );

  // üîπ Update badge instantly in UI
  const card = document.getElementById(`market-${id}`);
  const container = document.getElementById("marketContainer");
  if (card && container) {
    const now = new Date();
    const diffDays = Math.ceil((boostExpiry - now) / (1000 * 60 * 60 * 24));
    let h3 = card.querySelector("h3");
    if (h3) {
      // remove old badge if any
      h3.querySelectorAll(".boosted-badge").forEach(el => el.remove());
      h3.innerHTML += ` <span class="boosted-badge" data-expiry="${boostExpiry.toISOString()}" style="color:${freeBoost ? "dodgerblue" : "#ff5722"}; font-weight:bold; font-size:0.85em; margin-left:6px;">üî• ${freeBoost ? "Free Boost" : "Boosted"} (${diffDays} day${diffDays !== 1 ? "s" : ""} left)</span>`;
    }

    // üîπ Move boosted item card to TOP immediately
    container.prepend(card);
  }

  // üîπ Admin Notification
  await db.collection("adminNotifications").add({
    type: "Item Boosted",
    itemId: id,
    itemName: data.name,
    freeBoost,
    boostedBy: currentUser.displayName || currentUser.email,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    message: `üöÄ Item "${data.name}" ${freeBoost ? "FREE Boosted" : "Boosted"} by ${currentUser.displayName || currentUser.email}`
  });
}

// üîÑ Auto-update boosted badges every minute
setInterval(() => {
  const now = new Date();
  document.querySelectorAll(".boosted-badge").forEach(badge => {
    const expiryAttr = badge.dataset.expiry;
    if (!expiryAttr) return;
    const expiryDate = new Date(expiryAttr);
    const diffDays = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
    if (diffDays > 0) {
      badge.textContent = badge.textContent.includes("Free")
        ? `üî• Free Boost (${diffDays} day${diffDays !== 1 ? "s" : ""} left)`
        : `üî• Boosted (${diffDays} day${diffDays !== 1 ? "s" : ""} left)`;
    } else {
      badge.textContent = "üî• Boost Expired";
      badge.style.color = "gray";
    }
  });
}, 60 * 1000); // update every 1 minute




async function toggleSoldStatus(itemId) {
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex"; // Show the spinner before processing

  try {
    const doc = await marketRef.doc(itemId).get();
    if (!doc.exists) {
      showCustomAlert("‚ùå Item not found.", "error");
      return;
    }

    const data = doc.data();
    if (!currentUser || currentUser.uid !== data.postedBy) {
      showCustomAlert("‚ùå You are not authorized to update this item.", "error");
      return;
    }

    const newStatus = !data.isSold;
    await marketRef.doc(itemId).update({ isSold: newStatus });

    showCustomAlert(`‚úîÔ∏è Item marked as ${newStatus ? "Sold Out" : "Available"}`, "success");
    loadMarketItems(); // Refresh the list

    // Create Admin Notification about Sold Out Status
    const notifRef = db.collection("adminNotifications").doc();
    await notifRef.set({
      type: newStatus ? "Item Sold Out" : "Item Available",
      itemId: itemId,
      itemName: data.name,
      postedBy: data.postedBy,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      message: `üõí Item "${data.name}" has been marked as ${newStatus ? "Sold Out" : "Available"} by ${data.postedBy}.`
    });

    console.log("Admin notification created for item sold out status");

  } catch (error) {
    console.error("‚ùå Error updating item status:", error);
    showCustomAlert("‚ùå Failed to update item status: " + error.message, "error");
  } finally {
    if (spinner) spinner.style.display = "none"; // Hide the spinner once done
  }
}


// Function to update the button state when the item status changes in Firestore
function updateSoldOutButtonState(id) {
  const soldOutButton = document.getElementById(`soldOutBtn-${id}`);
  const itemRef = marketRef.doc(id);

  // Listen for updates to the isSold field in real-time
  itemRef.onSnapshot(doc => {
    const isSold = doc.data().isSold;

    // Update button text and disable accordingly
    if (isSold) {
      soldOutButton.innerText = "‚ùå Sold Out";
      soldOutButton.style.backgroundColor = "#f44336";
      soldOutButton.disabled = true;
    } else {
      soldOutButton.innerText = "‚úÖ Mark as Sold";
      soldOutButton.style.backgroundColor = "#9e9e9e";
      soldOutButton.disabled = false;
    }
  });
}



// ‚úÖ Ensure this runs after login
document.addEventListener("DOMContentLoaded", () => {
  if (typeof isAdmin === "undefined") isAdmin = false; // Fallback if not defined yet
  loadMarketItems();
});

function showCustomConfirm(message, onConfirm) {
  // Remove existing confirm box if any
  const existing = document.getElementById("customConfirmBox");
  if (existing) existing.remove();

  // Create confirm box wrapper
  const wrapper = document.createElement("div");
  wrapper.id = "customConfirmBox";
  wrapper.style.position = "fixed";
  wrapper.style.top = "0";
  wrapper.style.left = "0";
  wrapper.style.width = "100vw";
  wrapper.style.height = "100vh";
  wrapper.style.background = "rgba(0,0,0,0.5)";
  wrapper.style.display = "flex";
  wrapper.style.alignItems = "center";
  wrapper.style.justifyContent = "center";
  wrapper.style.zIndex = "9999";

  // Create modal box
  const modal = document.createElement("div");
  modal.style.background = "#fff";
  modal.style.padding = "20px 30px";
  modal.style.borderRadius = "10px";
  modal.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
  modal.style.textAlign = "center";

  modal.innerHTML = `
    <p style="margin-bottom:20px;font-size:16px;">${message}</p>
    <button id="confirmYesBtn" style="margin-right:10px;padding:8px 16px;background:#28a745;color:#fff;border:none;border-radius:5px;cursor:pointer;">Yes</button>
    <button id="confirmNoBtn" style="padding:8px 16px;background:#dc3545;color:#fff;border:none;border-radius:5px;cursor:pointer;">No</button>
  `;

  wrapper.appendChild(modal);
  document.body.appendChild(wrapper);

  // Wait until DOM is ready before binding events
  setTimeout(() => {
    document.getElementById("confirmYesBtn").onclick = () => {
      document.body.removeChild(wrapper);
      onConfirm();
    };

    document.getElementById("confirmNoBtn").onclick = () => {
      document.body.removeChild(wrapper);
    };
  }, 0);
}
function filterMarketItems() {
  const searchText = document.getElementById("filterSearch")?.value.toLowerCase() || "";
  const category = document.getElementById("filterItemCategory").value;
  const county = document.getElementById("filterItemCounty").value;

  let anyVisible = false;
  const allCards = document.querySelectorAll(".market-card");

  const filterItems = () => {
    allCards.forEach(card => {
      const name = card.querySelector(".item-name")?.innerText.toLowerCase() || "";
      const desc = card.querySelector(".item-description")?.innerText.toLowerCase() || "";
      const matchesSearch = !searchText || name.includes(searchText) || desc.includes(searchText);

      const matchesCategory = !category || card.dataset.category === category;
      const matchesCounty = !county || card.dataset.county === county;

      const visible = matchesSearch && matchesCategory && matchesCounty;
      card.style.display = visible ? "" : "none";

      if (visible) anyVisible = true;
    });

    if (!anyVisible) {
      showCustomAlert("üö´ No matching items found.", "warning");
    }
  };

  // Run filtering with smooth updates
  requestAnimationFrame(filterItems);
}
function resetMarketFilters() {
  // Reset all filter inputs
  document.getElementById("filterSearch").value = "";
  document.getElementById("filterItemCategory").value = "";
  document.getElementById("filterItemCounty").value = "";
  document.getElementById("filterMinPrice").value = "";
  document.getElementById("filterMaxPrice").value = "";

  // Re-run filter to show all items
  filterMarketItems();
}
// ‚úÖ Set your backend URL here (update when ngrok changes)
const BACKEND_URL = "https://acbb5b1736bc.ngrok-free.app";

function showPaymentModalFor(type, amount, itemId, itemName, prefilledPhone = "") {
  let titleText = "Pay to Unlock";
  const normalizedType = type.toLowerCase();

  if (normalizedType === "boost") titleText = "Pay to Boost";
  else if (normalizedType === "unlock") titleText = "Pay to Unlock Contacts";
  else if (normalizedType.endsWith("verification")) titleText = "Pay for Verification";
  else if (normalizedType === "driver_registration") titleText = "Pay to Register"; // ‚úÖ driver registration

  // Remove existing modal
  const existingModal = document.getElementById("universalPayModal");
  if (existingModal) existingModal.remove();

  const modalHTML = `
    <div id="universalPayModal" class="modal" style="
         display:flex; justify-content:center; align-items:center;
         position:fixed; top:0; left:0; width:100%; height:100%;
         background:rgba(0,0,0,0.6); z-index:9999;">
      <div class="modal-content" style="
           padding:20px; background:#f9f9ff; border:2px solid #4CAF50;
           width:80%; max-width:400px; border-radius:10px; text-align:center;">
        <h3 style="color:#2c3e50;">${titleText}: <span style="color:#4CAF50;">${itemName}</span></h3>
        <p style="font-size:16px;">Amount: <strong style="color:#388e3c;">Ksh ${amount}</strong></p>
        <input type="tel" id="universalPhone" value="${prefilledPhone}"
               placeholder="Enter your MPESA number (e.g. 0712345678)"
               style="padding:10px; width:100%; margin-bottom:10px; border:1px solid #ccc; border-radius:6px;" />
        <button onclick="initiateStkPayment('${type}', ${amount}, '${itemId}', '${itemName}')"
                style="background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:6px; font-weight:bold;">
          üì≤ Pay with MPESA
        </button>
        <br/>
        <button onclick="closeUniversalModal()" 
                style="margin-top:10px; background:#e53935; color:white; border:none; padding:8px 16px; border-radius:6px;">
          ‚ùå Cancel
        </button>
        <p id="universalPaymentStatus" style="margin-top:10px; color:#555;"></p>
        <p id="universalCountdown" style="margin-top:5px; color:#007bff; font-weight:bold;"></p>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML("beforeend", modalHTML);

  // Countdown timer (2 minutes)
  let countdown = 120;
  const countdownEl = document.getElementById("universalCountdown");
  const interval = setInterval(() => {
    const minutes = Math.floor(countdown / 60);
    const seconds = countdown % 60;
    countdownEl.innerText = `‚è≥ Waiting for payment... ${minutes}:${seconds.toString().padStart(2,"0")}`;
    countdown--;
    if (countdown < 0) {
      clearInterval(interval);
      countdownEl.innerText = "‚åõ Payment window expired. Please try again.";
    }
  }, 1000);
}


// ‚úÖ Close modal
function closeUniversalModal() {
  const modal = document.getElementById("universalPayModal");
  if (modal) modal.remove();
}

// ‚úÖ Initiate STK Push & poll server for payment
async function initiateStkPayment(type, amount, itemId, itemName) {
  const phoneInput = document.getElementById("universalPhone").value.trim();
  const statusEl = document.getElementById("universalPaymentStatus");

  // Validate phone number
  if (!/^07\d{8}$/.test(phoneInput)) {
    statusEl.innerText = "‚ö†Ô∏è Please enter a valid Safaricom number (07XXXXXXXX)";
    return;
  }

  // Convert to international format (2547XXXXXXXX)
  const phone = "254" + phoneInput.substring(1);
  const userId = currentUser?.uid || "anonymous";
  const accountReference = `${userId}_${Date.now()}`;

  statusEl.innerText = "‚è≥ Sending STK Push...";

  try {
    // üîπ Call your backend
    const response = await fetch(`${BACKEND_URL}/stkpush`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, amount, accountReference, itemId, itemName, userId })
    });

    const data = await response.json();
    if (data.ResponseCode !== "0") {
      statusEl.innerText = `‚ùå Error: ${data.errorMessage || data.ResultDesc || "Unknown failure"}`;
      return;
    }

    statusEl.innerText = "‚úÖ STK Push sent. Complete payment on your phone.";

    // üîπ Poll backend every 3s for payment result
    const poll = setInterval(async () => {
      try {
        const res = await fetch(`${BACKEND_URL}/payment-status/${accountReference}`);
        const statusData = await res.json();

        if (statusData.ResultCode !== undefined) {
          if (statusData.ResultCode === 0) {
            statusEl.innerText = "üéâ Payment successful!";
            clearInterval(poll);
            handlePaymentSuccess(type, itemId, itemName, userId);
            setTimeout(closeUniversalModal, 1500);
          } else {
            statusEl.innerText = `‚ùå Payment failed: ${statusData.ResultDesc}`;
            clearInterval(poll);
          }
        }
      } catch (err) {
        console.error("Poll error:", err.message);
      }
    }, 3000);

  } catch (err) {
    statusEl.innerText = "‚ùå Network error: " + err.message;
  }
}

// ‚úÖ Handle Firestore updates
async function handlePaymentSuccess(type, itemId, itemName, userId) {
  console.log("Handle payment success:", type, itemId, itemName, userId);
  // üîπ Add your Firestore updates here
}



// ‚úÖ Handle Firestore updates after payment
async function handlePaymentSuccess(type, itemId, itemName, userId) {
  const now = new Date();
  const isoNow = now.toISOString();
  const userRef = userId !== "anonymous" ? firebase.firestore().collection("users").doc(userId) : null;

  if (type === "soulmate") {
    const boostExpiry = new Date(now.getTime() + 7*24*60*60*1000);
    await firebase.firestore().collection("soulmates").doc(itemId).update({ boosted: true, boostExpiry });
    showCustomAlert("‚úÖ Soulmate profile boosted successfully!", "success");
    loadSoulmates();
  }
  if (type === "boost") {
    await firebase.firestore().collection("boostedItems").doc(itemId).set({ boostedAt: isoNow, itemName, userId }, { merge: true });
    localStorage.setItem(`boosted_${itemId}`, isoNow);
  }
  if (type === "unlock") {
    await userRef.set({ paidToUnlock: isoNow }, { merge: true });
    localStorage.setItem("paidToUnlock", isoNow);
  }
  if (type === "serviceVerification") {
    await servicesRef.doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("‚úÖ Service verified successfully!", "success");
    loadServices();
  }
  if (type === "marketVerification") {
    await marketRef.doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("‚úÖ Market item verified successfully!", "success");
    loadMarketItems();
  }
  if (type === "soulmateVerification") {
    await soulmateRef.doc(itemId).set({ verified: true }, { merge: true });
    showCustomAlert("‚úÖ Soulmate profile verified successfully!", "success");
    loadSoulmates();
  }
}



function closeUniversalModal() {
  const modal = document.getElementById("universalPayModal");
  if (modal) modal.remove();
}

function showToast(message, type = "info") {
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.padding = "12px 18px";
  toast.style.marginTop = "10px";
  toast.style.borderRadius = "6px";
  toast.style.fontSize = "15px";
  toast.style.color = "white";
  toast.style.boxShadow = "0 4px 8px rgba(0,0,0,0.1)";
  toast.style.opacity = "0.95";
  toast.style.transition = "transform 0.3s ease, opacity 0.3s ease";

  // Color based on type
  switch (type) {
    case "success":
      toast.style.backgroundColor = "#28a745"; // Green
      break;
    case "error":
      toast.style.backgroundColor = "#dc3545"; // Red
      break;
    case "warning":
      toast.style.backgroundColor = "#ffc107"; // Yellow
      toast.style.color = "#000";
      break;
    default:
      toast.style.backgroundColor = "#007bff"; // Blue
  }

  // Add to container
  const container = document.getElementById("toastContainer");
  container.appendChild(toast);

  // Auto remove
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateX(100%)";
    setTimeout(() => container.removeChild(toast), 400);
  }, 3000);
}

function confirmDeleteSwap(callback) {
  const modal = document.getElementById("confirmDeleteModal");
  const progressBar = document.getElementById("confirmProgressBar");
  modal.style.display = "flex";

  let duration = 5; // seconds
  let width = 100;
  let interval;

  function startCountdown() {
    interval = setInterval(() => {
      width -= 100 / (duration * 10);
      progressBar.style.width = width + "%";

      if (width <= 0) {
        clearInterval(interval);
        modal.style.display = "none";
        callback(false);
        showToast(" Deletion timed out.", "warning");
      }
    }, 100);
  }

  // Confirm click
  document.getElementById("confirmYes").onclick = () => {
    clearInterval(interval);
    modal.style.display = "none";
    callback(true);
  };

  // Cancel click
  document.getElementById("confirmNo").onclick = () => {
    clearInterval(interval);
    modal.style.display = "none";
    callback(false);
    showToast(" Deletion cancelled.", "warning");
  };

  // Reset bar and start
  progressBar.style.width = "100%";
  startCountdown();
}

function showCustomAlert(message, type = "info") {
  const alertBox = document.createElement("div");
  alertBox.innerText = message;

  alertBox.style.position = "fixed";
  alertBox.style.top = "50%";
  alertBox.style.left = "50%";
  alertBox.style.transform = "translate(-50%, -50%)";
  alertBox.style.padding = "20px";
  alertBox.style.borderRadius = "8px";
  alertBox.style.color = "white";
  alertBox.style.zIndex = "1000";
  alertBox.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
  alertBox.style.fontSize = "16px";
  alertBox.style.textAlign = "center";

  if (type === "success") {
    alertBox.style.backgroundColor = "#4caf50";
  } else if (type === "error") {
    alertBox.style.backgroundColor = "#f44336";
  } else {
    alertBox.style.backgroundColor = "#007bff";
  }

  document.body.appendChild(alertBox);
  setTimeout(() => {
    alertBox.remove();
  }, 3000);
}

async function loadNotifications() {
  const myName = currentUser.displayName || currentUser.email;
  const ul = document.getElementById("notificationList");
  ul.innerHTML = "<li>Loading...</li>"; // Initial loading message

  if (!myName) {
    ul.innerHTML = "<li>Error: User name not available.</li>";
    return;
  }

  try {
    const snapshot = await db.collection("soulmateInterests")
      .where("toName", "==", myName)
      .orderBy("timestamp", "desc")
      .get();

    if (snapshot.empty) {
      ul.innerHTML = "<li>No notifications yet.</li>";
      return;
    }

    // Building the list items as a single string
    let notificationsHTML = "";
    snapshot.forEach(doc => {
      const d = doc.data();
      notificationsHTML += `<li>üíå <strong>${d.fromName}</strong> liked you!</li>`;
    });

    ul.innerHTML = notificationsHTML;
  } catch (err) {
    ul.innerHTML = `<li>Error loading notifications: ${err.message}</li>`;
  }
}

function filterSwaps() {
  // Show the spinner before processing the filter
  const container = document.getElementById("swapCardContainer");
  const spinner = document.getElementById("loadingSpinner");  // Make sure to add a spinner element in your HTML
  if (spinner) spinner.style.display = "flex";  // Show spinner

  const category = document.getElementById("filterCategory").value.toLowerCase();
  const swapCounty = document.getElementById("filterSwapCounty").value.toLowerCase();
  const swapSubCounty = document.getElementById("filterSwapSubCounty").value.toLowerCase();
  const hardship = document.getElementById("filterHardship").value.toLowerCase();
  const subject = document.getElementById("filterSubjectCombination").value.toLowerCase();

  const swapCards = document.querySelectorAll("#swapCardContainer .swap-card");
  let visibleCount = 0;

  swapCards.forEach(card => {
    const cardCategory = card.getAttribute("data-category").toLowerCase();
    const cardSwapCounty = card.getAttribute("data-swapcounty").toLowerCase();
    const cardSwapSubCounty = card.getAttribute("data-swapsubcounty").toLowerCase();
    const cardHardship = card.getAttribute("data-hardship").toLowerCase();
    const cardSubject = card.getAttribute("data-subject").toLowerCase();

    const matchesCategory = !category || cardCategory === category;
    const matchesCounty = !swapCounty || cardSwapCounty === swapCounty;
    const matchesSubCounty = !swapSubCounty || cardSwapSubCounty === swapSubCounty;
    const matchesHardship = !hardship || cardHardship === hardship;
    const matchesSubject = !subject || cardSubject.includes(subject);

    if (matchesCategory && matchesCounty && matchesSubCounty && matchesHardship && matchesSubject) {
      card.style.display = "block";
      visibleCount++;
    } else {
      card.style.display = "none";
    }
  });

  // Remove any existing no-results message
  const noResultsMsg = document.getElementById("noResultsMessage");
  if (noResultsMsg) noResultsMsg.remove();

  // If none visible, show message
  if (visibleCount === 0) {
    const msg = document.createElement("div");
    msg.id = "noResultsMessage";
    msg.style = "text-align:center;padding:20px;color:white;";
    msg.innerHTML = "üíî No swap requests match your filters.";
    container.appendChild(msg);
  }

  // Hide the spinner after the filtering process is complete
  if (spinner) spinner.style.display = "none";  // Hide spinner

  displayActiveFilters();
}


function resetSwapFilters() {
  // Show the spinner before processing the reset
  const container = document.getElementById("swapCardContainer");
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";  // Show spinner

  // Reset the filter values
  document.getElementById("filterCategory").value = "";
  document.getElementById("filterSwapCounty").value = "";
  document.getElementById("filterSwapSubCounty").value = "";
  document.getElementById("filterHardship").value = "";
  document.getElementById("filterSubjectCombination").value = "";

  // Call filterSwaps to reshow all items
  filterSwaps();

  // Hide the spinner after resetting and filtering
  if (spinner) spinner.style.display = "none";  // Hide spinner
}


function displayActiveFilters() {
  const activeFilters = document.getElementById("activeFilters");
  if (!activeFilters) return;
  activeFilters.innerHTML = "";

  const filters = [
    { label: "Category", value: document.getElementById("filterCategory").value },
    { label: "Swap County", value: document.getElementById("filterSwapCounty").value },
    { label: "Sub-county", value: document.getElementById("filterSwapSubCounty").value },
    { label: "Hardship", value: document.getElementById("filterHardship").value },
    { label: "Subject", value: document.getElementById("filterSubjectCombination").value }
  ];

  filters.forEach(f => {
    if (f.value) {
      const badge = document.createElement("span");
      badge.textContent = `${f.label}: ${f.value}`;
      badge.style.background = "#43a047";
      badge.style.color = "white";
      badge.style.padding = "5px 10px";
      badge.style.borderRadius = "6px";
      badge.style.marginRight = "5px";
      badge.style.fontSize = "13px";
      activeFilters.appendChild(badge);
    }
  });
}

// ‚úÖ Hook up dynamic filtering on input changes
document.addEventListener("DOMContentLoaded", () => {
  const inputs = [
    "filterCategory",
    "filterSwapCounty",
    "filterSwapSubCounty",
    "filterHardship",
    "filterSubjectCombination"
  ];

  inputs.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (el.tagName === "INPUT") {
        el.addEventListener("keyup", filterSwaps);
      } else {
        el.addEventListener("change", filterSwaps);
      }
    }
  });
});

// üî• VIP Auto-flagging helper
const hotCounties = ["Nairobi", "Kisumu", "Mombasa", "Kisii", "Nakuru"];

async function markAsVIPSwap(swapId) {
  try {
    await db.collection("teacherSwaps").doc(swapId).update({ isVIP: true });
    showCustomAlert("üî• Swap marked as VIP successfully!", "success");
    loadSwaps(); // refresh list
  } catch (err) {
    showCustomAlert("‚ùå Failed to mark VIP: " + err.message, "error");
  }
}




// ‚úÖ Toast confirmation helper
function showToastConfirm(message, onConfirm) {
  const toast = document.createElement("div");
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #fff3cd;
    color: #856404;
    padding: 14px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    font-size: 14px;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: fadeIn 0.3s ease-out;
  `;

  toast.innerHTML = `
    <span style="flex:1;">${message}</span>
    <button id="toastYes" style="
      background:#28a745;
      color:white;
      border:none;
      padding:4px 10px;
      border-radius:4px;
      cursor:pointer;">‚úÖ Yes</button>
    <button id="toastNo" style="
      background:#dc3545;
      color:white;
      border:none;
      padding:4px 10px;
      border-radius:4px;
      cursor:pointer;">‚ùå No</button>
  `;

  document.body.appendChild(toast);

  document.getElementById("toastYes").onclick = () => {
    toast.remove();
    onConfirm();
  };
  document.getElementById("toastNo").onclick = () => {
    toast.remove();
  };

  setTimeout(() => toast.remove(), 8000); // auto-hide
}

// ‚úÖ Real-Time Admin Notifications Loader
let adminNotifUnsubscribe = null;

function loadAdminNotifications() {
  const list = document.getElementById("notificationList");
  const spinner = document.getElementById("loadingSpinner");

  if (spinner) spinner.style.display = "flex";
  list.innerHTML = "<p>Loading...</p>";

  // Detach previous listener if exists
  if (adminNotifUnsubscribe) adminNotifUnsubscribe();

  // Listen for real-time updates
  adminNotifUnsubscribe = db.collection("adminNotifications")
    .orderBy("timestamp", "desc")
    .onSnapshot(snapshot => {
      if (!snapshot || snapshot.empty) {
        list.innerHTML = "<p style='color:#666; font-style: italic;'>No admin notifications for now.</p>";
        updateAdminNotifBadge(0);
        if (spinner) spinner.style.display = "none";
        return;
      }

      const notifications = [];
      snapshot.forEach(doc => notifications.push({ id: doc.id, ref: doc.ref, ...doc.data() }));

      // Sort unread first
      notifications.sort((a, b) => {
        if (a.read !== b.read) return a.read ? 1 : -1;
        return (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0);
      });

      const unreadCount = notifications.filter(n => !n.read).length;
      updateAdminNotifBadge(unreadCount);

      let html = `
        <li style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
          ${unreadCount > 0 ? `
            <button onclick="confirmMarkAllAdminNotificationsAsRead(${unreadCount})"
              style="background:#4caf50;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">
              ‚úÖ Mark All as Read (${unreadCount})
            </button>` : ""}
          <button onclick="confirmDeleteAllAdminNotifications()"
            style="background:#f44336;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">
            üóëÔ∏è Delete All
          </button>
        </li>
      `;

      notifications.forEach(n => {
        const color = getNotificationColor(n.type);
        const timestamp = n.timestamp?.toDate
          ? new Date(n.timestamp.toDate()).toLocaleString()
          : "Unknown date";

        const readTick = n.read
          ? `<span style="color:#2196f3;font-size:14px;">‚úî‚úî</span>` // two blue ticks if read
          : `<button onclick="event.stopPropagation(); markAdminNotificationAsRead('${n.id}')"
              style="background:#4caf50;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
              Mark as Read
             </button>`;

        html += `
          <li style="
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 6px;
            position: relative;
            background: ${n.read ? '#e0f7fa' : '#fff3e0'};
            border-left: 6px solid ${color};
          "
          onclick="openPostedItem('${(n.type || '').toLowerCase()}', '${n.itemId || ''}')"
          onmouseenter="this.style.backgroundColor='#dcedc8'"
          onmouseleave="this.style.backgroundColor='${n.read ? '#e0f7fa' : '#fff3e0'}'">

            <strong style="font-size: 1.1em; color: ${color};">
              ${escapeHTML(n.type || "Notification")}
            </strong>
            <span style="color:#333; line-height: 1.4;">
              ${escapeHTML(n.message || "")}
            </span>
            <small style="color: #666; font-size: 0.85em;">${timestamp}</small>

            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              ${readTick}
              <button onclick="event.stopPropagation(); confirmDeleteAdminNotification('${n.id}')"
                style="background:#f44336;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                üóëÔ∏è Delete
              </button>
            </div>
          </li>
        `;
      });

      list.innerHTML = html;
      if (spinner) spinner.style.display = "none";
    }, err => {
      console.error("‚ùå Error in admin notifications listener:", err);
      if (spinner) spinner.style.display = "none";
    });

  function escapeHTML(str) {
    return str ? str.replace(/[&<>"']/g, tag =>
      ({"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[tag] || tag)
    ) : "";
  }

  function getNotificationColor(type) {
    if (!type) return '#607d8b';
    const t = type.toLowerCase();
    if (t.includes('error') || t.includes('fail') || t.includes('delete')) return '#e53935';
    if (t.includes('success') || t.includes('completed') || t.includes('updated')) return '#43a047';
    if (t.includes('warning') || t.includes('caution')) return '#fbc02d';
    if (t.includes('info') || t.includes('notification')) return '#1e88e5';
    return '#00796b';
  }
}

// ‚úÖ Single Notification Read with Spinner and UI Update
async function markAdminNotificationAsRead(notificationId) {
  // Show spinner
  document.getElementById('loadingSpinner').style.display = 'flex';

  try {
    // Update the specific notification in Firestore
    await db.collection("adminNotifications").doc(notificationId).update({ read: true });

    // Optionally remove or style the notification item in UI immediately
    const notifElement = document.getElementById(`notif-${notificationId}`);
    if (notifElement) {
      notifElement.classList.add("read"); // Add a class for styling
      // Or optionally remove it:
      // notifElement.remove();
    }

    // Hide spinner and show success alert
    document.getElementById('loadingSpinner').style.display = 'none';
    showCustomAlert("‚úÖ Notification marked as read", "success");
  } catch (error) {
    // Hide spinner and show error alert
    document.getElementById('loadingSpinner').style.display = 'none';
    showCustomAlert("‚ùå Error marking as read: " + error.message, "error");
  }
}


// ‚úÖ Single delete (toast confirm)
function confirmDeleteAdminNotification(notificationId) {
  showToastConfirm("üóëÔ∏è Delete this notification?", () => deleteAdminNotification(notificationId));
}

async function deleteAdminNotification(notificationId) {
  // Show spinner when deletion starts
  document.getElementById('loadingSpinner').style.display = 'flex';

  try {
    await db.collection("adminNotifications").doc(notificationId).delete();
    // Hide spinner after successful deletion
    document.getElementById('loadingSpinner').style.display = 'none';

    showCustomAlert("üóëÔ∏è Notification deleted", "success");
  } catch (error) {
    // Hide spinner if there is an error
    document.getElementById('loadingSpinner').style.display = 'none';

    showCustomAlert("‚ùå Error deleting: " + error.message, "error");
  }
}


// ‚úÖ Delete all (toast confirm)
function confirmDeleteAllAdminNotifications() {
  showToastConfirm("‚ö†Ô∏è Delete ALL admin notifications?", deleteAllAdminNotifications);
}

async function deleteAllAdminNotifications() {
  try {
    const snapshot = await db.collection("adminNotifications").get();
    if (snapshot.empty) {
      showCustomAlert("‚ÑπÔ∏è No notifications to delete", "info");
      return;
    }
    const batch = db.batch();
    snapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    showCustomAlert("üóëÔ∏è All admin notifications deleted", "success");
  } catch (error) {
    showCustomAlert("‚ùå Error deleting all: " + error.message, "error");
  }
}

// ‚úÖ Mark all read (toast confirm)
function confirmMarkAllAdminNotificationsAsRead(unreadCount) {
  showToastConfirm(`Mark all ${unreadCount} as read?`, markAllAdminNotificationsAsRead);
}

async function markAllAdminNotificationsAsRead() {
  // Show spinner when the process starts
  document.getElementById('loadingSpinner').style.display = 'flex';

  try {
    const snapshot = await db.collection("adminNotifications").get();
    if (snapshot.empty) {
      document.getElementById('loadingSpinner').style.display = 'none';
      showCustomAlert("‚ÑπÔ∏è No notifications found", "info");
      return;
    }

    const batch = db.batch();
    snapshot.forEach(doc => batch.update(doc.ref, { read: true }));

    // Commit the batch
    await batch.commit();

    // **Update the badge after marking as read**
    await updateAdminNotifBadge();

    // Hide the spinner and show success message
    document.getElementById('loadingSpinner').style.display = 'none';
    showCustomAlert("‚úÖ All notifications marked as read", "success");
  } catch (error) {
    document.getElementById('loadingSpinner').style.display = 'none';
    showCustomAlert("‚ùå Error marking all as read: " + error.message, "error");
  }
}



async function updateAdminNotifBadge() {
  const badge = document.getElementById("notifBadge");
  if (!isAdmin || !badge) return;

  try {
    const snapshot = await db.collection("adminNotifications")
      .where("read", "==", false)
      .get();

    const count = snapshot.size;

    if (count > 0) {
      badge.style.display = "inline-block";
      badge.textContent = count;
    } else {
      badge.style.display = "none";
    }
  } catch (err) {
    console.error("Failed to load notification badge:", err);
  }
}
let currentToastTimeout = null;

function showCustomToast(message) {
  // Remove any existing toast
  const existingToast = document.getElementById("customToast");
  if (existingToast) {
    existingToast.remove();
    clearTimeout(currentToastTimeout);
  }

  // Create new toast
  const toast = document.createElement("div");
  toast.id = "customToast";
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #323232;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 9999;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;
  `;
  toast.textContent = message;

  document.body.appendChild(toast);

  // Auto-remove after 3 seconds
  currentToastTimeout = setTimeout(() => {
    toast.remove();
  }, 3000);
}
async function deleteNotification(id) {
  const existingBox = document.getElementById("inlineNotifConfirmBox");
  if (existingBox) existingBox.remove();

  const box = document.createElement("div");
  box.id = "inlineNotifConfirmBox";
  box.style.cssText = `
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    padding: 18px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    z-index: 9999;
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    max-width: 90%;
    width: 320px;
    animation: fadeIn 0.3s ease;
  `;

  box.innerHTML = `
    <p style="margin: 0 0 16px; font-size: 15px; color: #333;">
      Are you sure you want to delete this notification?
    </p>
    <div style="display: flex; justify-content: center; gap: 10px;">
      <button id="notifConfirmYesBtn" style="background: #d32f2f; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">üóëÔ∏è Yes</button>
      <button id="notifConfirmNoBtn" style="background: #607d8b; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer;">Cancel</button>
    </div>
  `;

  document.body.appendChild(box);

  document.getElementById("notifConfirmYesBtn").onclick = async () => {
    // Show spinner when deletion starts
    document.getElementById('loadingSpinner').style.display = 'flex';

    box.remove();
    try {
      // Attempt to delete the notification
      await db.collection("adminNotifications").doc(id).delete();
      loadAdminNotifications();
      updateAdminNotifBadge();

      // Hide spinner after deletion completes
      document.getElementById('loadingSpinner').style.display = 'none';

      // Show success toast
      try {
        showCustomToast("‚úÖ Notification deleted.");
      } catch (toastErr) {
        console.warn("Toast not initialized. Skipping toast.");
      }

    } catch (err) {
      // Hide spinner in case of error
      document.getElementById('loadingSpinner').style.display = 'none';

      console.error("Error deleting notification:", err);
      showCustomAlert("‚ùå Failed to delete: " + err.message, "error");
    }
  };

  document.getElementById("notifConfirmNoBtn").onclick = () => {
    box.remove();
  };
}


// Shows the alert popup
function showAlert(message) {
  // Check if an alert is already visible
  if (document.querySelector('.scroll-end-alert')) return;

  const alert = document.createElement('div');
  alert.className = 'scroll-end-alert';
  alert.textContent = message;
  document.body.appendChild(alert);

  setTimeout(() => {
    alert.remove();
  }, 3000); // Auto-remove after 3 seconds
}

// Detect scroll end inside a container
function watchScrollEnd(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.addEventListener('scroll', () => {
    const isAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 1;
    if (isAtBottom) {
      showAlert("üö© You have reached the end for today.");
    }
  });
}

// Initialize for desired containers
document.addEventListener('DOMContentLoaded', () => {
  watchScrollEnd('jobContainer');
  watchScrollEnd('soulmateContainer');
  // Add more if needed
});
let toastTimeout;

function showCustomToast(message) {
  const toast = document.getElementById("customToast");
  const messageSpan = document.getElementById("toastMessage");
  
  messageSpan.textContent = message;
  toast.style.display = "block";
  
  // Trigger fade-in
  setTimeout(() => {
    toast.style.opacity = 1;
  }, 50);

  // Auto-dismiss after 5 seconds
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => {
    hideCustomToast();
  }, 5000);
}

function hideCustomToast() {
  const toast = document.getElementById("customToast");
  toast.style.opacity = 0;
  setTimeout(() => {
    toast.style.display = "none";
  }, 400);
}
async function deleteSoulmate(id) {
  // Remove any existing confirmation box
  const existingBox = document.getElementById("inlineToastConfirmBox");
  if (existingBox) existingBox.remove();

  // Create confirmation box
  const box = document.createElement("div");
  box.id = "inlineToastConfirmBox";
  box.style.cssText = `
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    padding: 18px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    z-index: 9999;
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    max-width: 90%;
    width: 300px;
    animation: fadeIn 0.3s ease;
  `;

  box.innerHTML = `
    <p style="margin: 0 0 16px; font-size: 15px; color: #333;">
      Are you sure you want to delete this soulmate profile?
    </p>
    <div style="display: flex; justify-content: center; gap: 10px;">
      <button id="confirmYesBtn" style="
        background: #e53935;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
      ">üóëÔ∏è Yes</button>
      <button id="confirmNoBtn" style="
        background: #607d8b;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
      ">Cancel</button>
    </div>
  `;

  document.body.appendChild(box);

  // Handle button events
  document.getElementById("confirmYesBtn").onclick = async () => {
    // Show spinner
    document.getElementById('loadingSpinner').style.display = 'flex';

    box.remove();
    try {
      await soulmateRef.doc(id).delete();

      // Hide spinner after deletion
      document.getElementById('loadingSpinner').style.display = 'none';

      showCustomAlert("‚úÖ Profile deleted successfully.", "success");
      loadSoulmates(); // Refresh the soulmates list
    } catch (err) {
      // Hide spinner if error occurs
      document.getElementById('loadingSpinner').style.display = 'none';

      console.error("Error deleting soulmate:", err);
      showCustomAlert("‚ùå Failed to delete: " + err.message, "error");
    }
  };

  document.getElementById("confirmNoBtn").onclick = () => {
    box.remove();
    showCustomAlert("‚ùé Deletion canceled.", "info");
  };
}


  function toggleUsageNotes() {
    const notes = document.getElementById("usageNotes");
    notes.style.display = notes.style.display === "none" ? "block" : "none";
  }
function deleteMarketItem(id) {
  // Show spinner
  document.getElementById('loadingSpinner').style.display = 'flex';

  showCustomConfirm("Are you sure you want to delete this market item?", () => {
    marketRef.doc(id).delete()
      .then(() => {
        // Hide spinner after deletion is successful
        document.getElementById('loadingSpinner').style.display = 'none';

        showCustomAlert("üóëÔ∏è Item deleted successfully.", "success");
        loadMarketItems(); // refresh the market items
      })
      .catch(err => {
        // Hide spinner if error occurs
        document.getElementById('loadingSpinner').style.display = 'none';

        console.error("‚ùå Error deleting item:", err);
        showCustomAlert("‚ùå Error deleting item: " + err.message, "error");
      });
  });
}
async function loadTrendingItems() {
  const trendingContainer = document.getElementById("trendingContainer");

  // If the user is not logged in, show an alert and exit
  if (!isLoggedIn) {
    showCustomAlert("You must be logged in to view trending content.", "error");
    showPage("login"); // Redirect to login page
    return;
  }

  // Show loading spinner at the center of the screen before fetching content
  const loadingSpinner = document.getElementById("loadingSpinner");
  loadingSpinner.style.display = "flex"; // Show the spinner
  trendingContainer.innerHTML = `
    <div class="loading-message">
      <i class="fas fa-spinner fa-spin loading-icon"></i>
      <p>Fetching trending content...</p>
    </div>
  `;

  // Create an array of async loaders for each section
  const loaders = [];
  if (typeof loadSwaps === "function") loaders.push(loadSwaps());
  if (typeof loadServices === "function") loaders.push(loadServices());
  if (typeof loadSoulmates === "function") loaders.push(loadSoulmates());
  if (typeof loadBOMJobs === "function") loaders.push(loadBOMJobs());
  if (typeof loadMarketItems === "function") loaders.push(loadMarketItems());

  // Wait for all sections to load
  await Promise.all(loaders);

  // After loading is complete, continue with the trending section logic
  const allSections = [
    { id: "swapCardContainer", className: "swap-card", label: "Swaps" },
    { id: "jobContainer", className: "job-card", label: "Jobs" },
    { id: "soulmateContainer", className: "soulmate-card", label: "Soulmate" },
    { id: "servicesContainer", className: "service-card", label: "Service" },
    { id: "marketContainer", className: "market-card", label: "Market" },
    { id: "resourcesTable", tag: "tr", hasBoostedText: true, label: "Resources" }
  ];

  const foundItems = [];

  // Loop through each section to find trending items
  allSections.forEach(({ id, className, tag, hasBoostedText, label }) => {
    const container = document.getElementById(id);
    if (!container) return;

    const items = className
      ? Array.from(container.getElementsByClassName(className))
      : tag
      ? Array.from(container.getElementsByTagName(tag))
      : [];

    items.forEach(item => {
      const text = item.innerText.toLowerCase();
      if (
        text.includes("boost") ||
        text.includes("üî•") ||
        (hasBoostedText && text.includes("trending"))
      ) {
        const wrapper = document.createElement("div");
        wrapper.classList.add("trending-highlight"); // Add animation class

        // Add trending label
        const labelTag = document.createElement("div");
        labelTag.className = "trending-label";  // Styled via CSS
        labelTag.innerHTML = `üî• Trending from ${label}`;

        wrapper.appendChild(labelTag);
        wrapper.appendChild(item.cloneNode(true));
        foundItems.push(wrapper);
      }
    });
  });

  // Sort items by the most recently added (newer elements are later in DOM)
  foundItems.reverse(); // Simple reversal to show newest first

  // If no items are found, display a message
  if (foundItems.length === 0) {
    trendingContainer.innerHTML = `<p class="no-trending-items">No trending items found at the moment.</p>`;
    loadingSpinner.style.display = "none";  // Hide the spinner
    return;
  }

  // Clear loading spinner and insert found trending items
  trendingContainer.innerHTML = "";  // Clear the container
  foundItems.forEach(card => trendingContainer.appendChild(card));

  // Hide the loading spinner
  loadingSpinner.style.display = "none";
}


function closeReviewModal() {
  document.getElementById("reviewModal").style.display = "none";
}


function toggleMenu(alertId) {
  const menu = document.getElementById(`menu-${alertId}`);
  menu.style.display = menu.style.display === "block" ? "none" : "block";

  // Close others
  document.querySelectorAll('.dropdown-content').forEach(el => {
    if (el.id !== `menu-${alertId}`) el.style.display = "none";
  });
}
// Function to show the loading spinner
function showLoadingSpinner() {
    document.getElementById("loadingSpinner").style.display = "flex";
}

// Function to hide the loading spinner
function hideLoadingSpinner() {
    document.getElementById("loadingSpinner").style.display = "none";
}

// Listen to scroll event on the container
const container = document.getElementById("soulmateContainer");
const endMessage = document.getElementById("endOfListMessage");

container.addEventListener("scroll", function () {
  const isAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 2;

  if (isAtBottom) {
    endMessage.style.display = "block";
  } else {
    endMessage.style.display = "none";
  }
});

function openMyChats() {
  // Hide other pages
  document.querySelectorAll(".page").forEach(page => page.style.display = "none");

  // Show My Chats
  document.getElementById("myChatsSection").style.display = "block";

  // Load chats
  if (typeof loadMyChats === "function") loadMyChats();
}

function closeMyChats() {
  document.getElementById("myChatsSection").style.display = "none";
}

// Close disclaimer and remember choice if requested
  function closeDisclaimerFancy() {
    const modal = document.getElementById('disclaimerModal');
    const dontShow = document.getElementById('dontShowAgain').checked;

    if (dontShow) {
      // Save permanent preference
      localStorage.setItem('disclaimerHidden', 'true');
    }
    
    modal.style.display = 'none'; // close only when user acts
    showThankYouAlert();
  }

  // Thank-you alert (disappears automatically)
  function showThankYouAlert() {
    const alertBox = document.getElementById('thankYouAlert');
    alertBox.style.display = 'block';

    setTimeout(() => {
      alertBox.style.display = 'none';
    }, 4000);
  }

  // Show disclaimer only if never dismissed with "don't show again"
  window.addEventListener('load', () => {
    if (!localStorage.getItem('disclaimerHidden')) {
      document.getElementById('disclaimerModal').style.display = 'flex';
    } else {
      document.getElementById('disclaimerModal').style.display = 'none';
    }
  });
(function() {
  const priceRegex = /Ksh\.?\s*([0-9]+)/gi;

  // Keywords to map into sections
  const sectionMap = {
    "market": "Market",
    "swap": "Swaps",
    "soulmate": "Soulmate",
    "service": "Services",
    "job": "Jobs",
    "resource": "Resources"
  };

  function detectSection(context) {
    const ctx = context.toLowerCase();
    for (let key in sectionMap) {
      if (ctx.includes(key)) return sectionMap[key];
    }
    return "Other";
  }

  // üßπ Clean context snippet (remove HTML, JS, symbols, collapse spaces)
  function cleanContext(text) {
    return text
      .replace(/<[^>]*>/g, "") // remove HTML tags
      .replace(/[{}`]/g, "") // remove braces, backticks
      .replace(/\b(const|let|var|function|return|if|else|await|firebase|authDomain|apiKey)\b.*$/gi, "") // cut JS noise
      .replace(/\s+/g, " ") // collapse spaces
      .trim()
      .slice(0, 80); // limit snippet length
  }

  function scanPrices() {
    const results = [];

    // 1. Walk all text nodes
    function walk(node) {
      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent;
        let match;
        while ((match = priceRegex.exec(text)) !== null) {
          const amount = match[1];
          const context = cleanContext(text);
          results.push({ amount, context });
        }
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        node.childNodes.forEach(walk);
      }
    }
    walk(document.body);

    // 2. Scan inline <script> blocks
    document.querySelectorAll("script").forEach(script => {
      if (script.innerText) {
        let match;
        while ((match = priceRegex.exec(script.innerText)) !== null) {
          const amount = match[1];
          const snippet = cleanContext(script.innerText.substr(match.index, 100));
          results.push({ amount, context: snippet });
        }
      }
    });

    // 3. Deduplicate
    const seen = new Set();
    const unique = results.filter(r => {
      const key = r.amount + "|" + r.context;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    // 4. Group by section
    const grouped = {};
    unique.forEach(r => {
      const section = detectSection(r.context);
      if (!grouped[section]) grouped[section] = [];
      grouped[section].push(r);
    });

    // 5. Build clean output
    let output = "";
    for (let section of Object.keys(grouped)) {
      output += `\nüìå ${section}\n`;
      grouped[section]
        .sort((a, b) => parseInt(a.amount) - parseInt(b.amount))
        .forEach(r => {
          output += `   ‚Ä¢ Ksh ${r.amount} ‚Üí ${r.context}\n`;
        });
      output += "\n";
    }

    document.getElementById("priceResults").textContent = output || "‚úÖ No prices found!";
    document.getElementById("pricePopup").style.display = "flex";
  }

  // Attach listeners
  document.getElementById("scanPricesBtn").addEventListener("click", scanPrices);
  document.getElementById("closePopup").addEventListener("click", () => {
    document.getElementById("pricePopup").style.display = "none";
  });

// ‚úÖ Helper: Check if user is admin from Firestore (by UID)
async function checkIfAdmin(user) {
  try {
    const doc = await db.collection("admins").doc(user.uid).get();
    return doc.exists; // true if UID exists in admins collection
  } catch (error) {
    console.error("Error checking admin status:", error);
    return false;
  }
}

// ‚úÖ Hook into your auth state
auth.onAuthStateChanged(async user => {
  if (user) {
    const isAdmin = await checkIfAdmin(user);

    if (isAdmin) {
      document.getElementById("scanPricesBtn").style.display = "block";
    } else {
      document.getElementById("scanPricesBtn").style.display = "none";
    }
  } else {
    document.getElementById("scanPricesBtn").style.display = "none";

    }
  });
})();

// Function: Load all payments
async function loadPayments() {
  try {
    const snapshot = await db.collection("payments").orderBy("timestamp", "desc").get();
    const tableBody = document.getElementById("paymentsTable");
    tableBody.innerHTML = ""; // Clear old data

    snapshot.forEach(doc => {
      const data = doc.data();
      const row = `
        <tr>
          <td>${data.userId}</td>
          <td>KES ${data.amount}</td>
          <td>${data.method}</td>
          <td>${data.reference}</td>
          <td>${data.timestamp ? data.timestamp.toDate().toLocaleString() : "N/A"}</td>
        </tr>
      `;
      tableBody.innerHTML += row;
    });
  } catch (err) {
    console.error("Error loading payments:", err);
    alert("‚ùå Failed to load payments.");
  }
}

// ‚úÖ Helper: Check if user is admin from Firestore
async function checkIfAdmin(user) {
  try {
    const doc = await db.collection("admins").doc(user.uid).get();
    return doc.exists; // true if UID is listed in "admins" collection
  } catch (error) {
    console.error("Error checking admin status:", error);
    return false;
  }
}

// ‚úÖ Auth check ‚Üí Show button only for admins
auth.onAuthStateChanged(async user => {
  if (user) {
    const isAdmin = await checkIfAdmin(user);

    if (isAdmin) {
      document.getElementById("viewPaymentsBtn").style.display = "inline-block";

      // Show dashboard & load payments when admin clicks
      document.getElementById("viewPaymentsBtn").addEventListener("click", () => {
        document.getElementById("paymentsDashboard").style.display = "block";
        loadPayments();
      });
    } else {
      // Hide button for non-admins
      document.getElementById("viewPaymentsBtn").style.display = "none";
    }
  } else {
    // Logged out ‚Üí hide button + dashboard
    document.getElementById("viewPaymentsBtn").style.display = "none";
    document.getElementById("paymentsDashboard").style.display = "none";
  }
});

// ‚úÖ Close button
document.getElementById("closePaymentsBtn").addEventListener("click", () => {
  document.getElementById("paymentsDashboard").style.display = "none";
});

// ‚úÖ Refresh button
document.getElementById("refreshPaymentsBtn").addEventListener("click", () => {
  loadPayments();
});
// Function to toggle dark mode and change button text
function toggleDarkMode() {
  const body = document.body;
  const currentMode = body.classList.contains("dark-mode");
  
  if (currentMode) {
    body.classList.remove("dark-mode");
    localStorage.setItem("theme", "light");
    document.getElementById("darkModeToggle").textContent = "üåô Dark Mode"; // Change button text to light mode
  } else {
    body.classList.add("dark-mode");
    localStorage.setItem("theme", "dark");
    document.getElementById("darkModeToggle").textContent = "üåû Light Mode"; // Change button text to dark mode
  }
}


// Function to load the user's preferred theme
function loadTheme() {
  const savedTheme = localStorage.getItem("theme");

  if (savedTheme === "dark") {
    document.body.classList.add("dark-mode");
  } else {
    document.body.classList.remove("dark-mode");
  }
}

// Add event listener to the toggle button
document.getElementById("darkModeToggle").addEventListener("click", toggleDarkMode);

// Show the theme customization panel when the button is clicked
document.getElementById("themeCustomizeToggle").addEventListener("click", function() {
  const customizationPanel = document.getElementById("themeCustomization");
  customizationPanel.style.display = customizationPanel.style.display === "none" ? "block" : "none";
});

// Apply theme based on selection or custom color/font settings
document.getElementById("applyThemeBtn").addEventListener("click", function() {
  const selectedTheme = document.getElementById("themeSelect").value;
  const body = document.body;

  // Apply selected theme (light, dark, custom)
  if (selectedTheme === "light") {
    applyLightTheme();
  } else if (selectedTheme === "dark") {
    applyDarkTheme();
  } else if (selectedTheme === "custom") {
    applyCustomTheme();
  }

  // Save the user's theme preference in localStorage
  localStorage.setItem("theme", selectedTheme);

  // Close the customization panel
  document.getElementById("themeCustomization").style.display = "none";
});

// Reset to default light theme
document.getElementById("resetThemeBtn").addEventListener("click", function() {
  applyLightTheme();
  localStorage.setItem("theme", "light");
  document.getElementById("themeCustomization").style.display = "none";
});

// Function to apply light theme
function applyLightTheme() {
  document.body.classList.remove("dark-mode");
  document.body.classList.remove("custom-mode");
  document.body.style.backgroundColor = "#ffffff"; // Light background
  document.body.style.color = "#000000"; // Dark text
  document.body.style.fontSize = "16px"; // Default font size
}

// Function to toggle dark mode
function toggleDarkMode() {
  const body = document.body;
  const currentMode = body.classList.contains("dark-mode");
  
  if (currentMode) {
    body.classList.remove("dark-mode");
    localStorage.setItem("theme", "light"); // Save the mode in localStorage
  } else {
    body.classList.add("dark-mode");
    localStorage.setItem("theme", "dark"); // Save the mode in localStorage
  }
}

// Function to apply selected theme from dropdown
document.getElementById("themeSelect").addEventListener("change", function() {
  const selectedTheme = this.value;
  const body = document.body;

  // Remove all theme classes
  body.classList.remove(
    "light", "dark", "theme1", "theme2", "theme3", "theme4", "theme5", 
    "theme6", "theme7", "theme8", "theme9", "theme10", "theme11", "theme12", 
    "theme13", "theme14", "theme15", "theme16", "theme17", "theme18", "theme19", 
    "theme20"
  );
  
  // Apply the selected theme class
  if (selectedTheme === "light") {
    body.classList.add("light");
  } else if (selectedTheme === "dark") {
    body.classList.add("dark");
  } else if (selectedTheme === "custom") {
    body.classList.add("custom-mode");
  } else {
    body.classList.add(selectedTheme); // For theme1, theme2, ..., theme20
  }

  // Save the theme selection in localStorage
  localStorage.setItem("theme", selectedTheme);
});

// Function to load the user's theme preference on page load
function loadUserTheme() {
  const savedTheme = localStorage.getItem("theme");

  if (savedTheme) {
    document.getElementById("themeSelect").value = savedTheme; // Set the dropdown value
    document.body.classList.add(savedTheme); // Apply the saved theme class
  } else {
    // Default to light theme if no theme is saved
    document.body.classList.add("light");
  }
}

// Directly call the loadUserTheme function on page load
loadUserTheme();

// Close the theme customization panel when the close button is clicked
document.getElementById("closeThemePanel").addEventListener("click", function() {
  const customizationPanel = document.getElementById("themeCustomization");
  customizationPanel.style.display = "none"; // Hide the panel
});


/* ===================== üîπ ORS API Key ===================== */ 
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjRkMGJhODVhZTY0ZDQ4NGM5YmU2ODY4NjBkNDk1ZWU2IiwiaCI6Im11cm11cjY0In0=";

/* ===================== üîπ Globals ===================== */
let currentDriver = null;
let pickupLocation = null;
let pickupMarker, destMarker;
let driverMarkers = {};
let riderLocation = null;
let activeDriverId = null; // ‚úÖ highlight booked driver

/* ===================== üîπ Fuel Settings ===================== */
const fuelRates = {
  "1300cc": 6.5,
  "1400cc": 7.0,
  "1500cc": 7.5,
  "1800cc": 8.5,
  "2000cc": 9.5,
  "default": 7.5
};
const FUEL_PRICE_PER_LITER = 190; // KES

function estimateFuel(distanceKm, engineCc) {
  let rate = fuelRates[engineCc] || fuelRates["default"];
  let liters = (distanceKm * rate) / 100;
  let cost = liters * FUEL_PRICE_PER_LITER;
  return { liters, cost };
}


/* ===================== üîπ Leaflet Map Init ===================== */
let map = L.map('map').setView([-1.2921, 36.8219], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

/* ===================== üîπ Custom Icons ===================== */
const pickupIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/190/190411.png",
  iconSize: [35, 35],
  iconAnchor: [17, 34],
  popupAnchor: [0, -28]
});
const destIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/190/190406.png",
  iconSize: [35, 35],
  iconAnchor: [17, 34],
  popupAnchor: [0, -28]
});
const normalDriverIcon = "https://cdn-icons-png.flaticon.com/512/61/61168.png";
const bookedDriverIcon = "https://cdn-icons-png.flaticon.com/512/854/854894.png";

/* ===================== üîπ Helper Functions ===================== */
function moveMarker(marker, newLat, newLng, duration = 1000) {
  if (!marker) return;
  let startLatLng = marker.getLatLng();
  let startTime = null;
  function animate(timestamp) {
    if (!startTime) startTime = timestamp;
    let progress = (timestamp - startTime) / duration;
    if (progress > 1) progress = 1;
    let lat = startLatLng.lat + (newLat - startLatLng.lat) * progress;
    let lng = startLatLng.lng + (newLng - startLatLng.lng) * progress;
    marker.setLatLng([lat, lng]);
    if (progress < 1) requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
}
function distanceInKm(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lat2 - lat1) * Math.PI / 180;
  const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLng/2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
function getRiderLocation(callback) {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      riderLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      callback();
    }, err => { 
      showAlert("‚ùå Could not get your location: " + err.message, "error"); 
    });
  } else {
    showAlert("‚ö†Ô∏è Geolocation is not supported by your browser.", "warning");
  }
}

async function getPlaceName(lat, lng) {
  try {
    // üåç First try ORS
    let url = `https://api.openrouteservice.org/geocode/reverse?api_key=${ORS_API_KEY}&point=${lng},${lat}&size=1`;
    let res = await fetch(url);
    let data = await res.json();

    if (data.features && data.features.length > 0) {
      let props = data.features[0].properties;
      if (props.locality) return props.locality; // ‚úÖ town/village
      if (props.county) return props.county;     // ‚úÖ fallback to county
      if (props.label) return props.label.split(',')[0]; // last resort
    }

    // ‚ö†Ô∏è If ORS fails or vague ‚Üí fallback to Nominatim
    let osmRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
    let osmData = await osmRes.json();

    if (osmData.address) {
      if (osmData.village) return osmData.village;
      if (osmData.town) return osmData.town;
      if (osmData.suburb) return osmData.suburb;
      if (osmData.county) return osmData.county;
    }

    return osmData.display_name ? osmData.display_name.split(',')[0] : `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  } catch (err) {
    console.error("Reverse geocode error:", err);
    return `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  }
}

function formatKES(amount) {
  return Number(amount).toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

/* ===================== üîπ Show All Available Drivers (map only) ===================== */
async function showAllAvailableDrivers() {
  getRiderLocation(async () => {
    db.collection("drivers").onSnapshot(async snapshot => {
      for (const doc of snapshot.docs) {
        let d = doc.data();
        let id = doc.id;
        if (d.available) {
          const iconUrl = (id === activeDriverId) ? bookedDriverIcon : normalDriverIcon;
          if (driverMarkers[id]) {
            moveMarker(driverMarkers[id], d.lat, d.lng);
            driverMarkers[id].setIcon(L.icon({ iconUrl, iconSize:[30,30] }));
          } else {
            driverMarkers[id] = L.marker([d.lat, d.lng], {
              icon: L.icon({ iconUrl, iconSize:[30,30] })
            }).addTo(map).bindPopup(`${d.name} (${d.vehicle})`);
          }
        } else {
          if (driverMarkers[id]) {
            map.removeLayer(driverMarkers[id]);
            delete driverMarkers[id];
          }
        }
      }
    });
  });
}

/* ===================== üîπ Geocode & Route (Kenya-optimized with fallback) ===================== */
async function geocode(address) {
  try {
    // ‚úÖ Ensure Kenya context
    let query = address.trim();
    if (!/kenya/i.test(query)) {
      query += ", Kenya";
    }

    // üåç Try ORS first
    let url = `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(query)}&size=1`;
    let res = await fetch(url);
    let data = await res.json();

    if (data && data.features && data.features.length > 0) {
      return {
        lat: data.features[0].geometry.coordinates[1],
        lng: data.features[0].geometry.coordinates[0]
      };
    }

    // ‚ö†Ô∏è If ORS fails, use Nominatim
    let osmRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}`);
    let osmData = await osmRes.json();

    if (osmData && osmData.length > 0) {
      return {
        lat: parseFloat(osmData[0].lat),
        lng: parseFloat(osmData[0].lon)
      };
    }

    throw new Error("‚ö†Ô∏è Address not found: " + address);
  } catch (err) {
    console.error("Geocode error:", err);
    throw new Error("‚ö†Ô∏è Could not fetch location for " + address);
  }
}

let routeLine = null; // keep reference so we can clear old routes

async function getRoute(pickup, destination) {
  try {
    // üåç Try ORS directions first
    let url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${ORS_API_KEY}&start=${pickup.lng},${pickup.lat}&end=${destination.lng},${destination.lat}`;
    let res = await fetch(url);
    let data = await res.json();

    if (data && data.features && data.features.length > 0) {
      let distKm = data.features[0].properties.segments[0].distance / 1000;
      let durMin = data.features[0].properties.segments[0].duration / 60;

      // ‚úÖ Decode ORS geometry
      let coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);

      // Remove old route if exists
      if (routeLine) map.removeLayer(routeLine);

      // Draw new route polyline
      routeLine = L.polyline(coords, { color: "blue", weight: 5 }).addTo(map);

      return { distance: distKm, duration: durMin };
    }

    // ‚ö†Ô∏è Fallback: straight line if ORS fails
    let distKm = distanceInKm(pickup.lat, pickup.lng, destination.lat, destination.lng);
    let avgSpeedKmH = 60;
    let durMin = (distKm / avgSpeedKmH) * 60;

    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([[pickup.lat, pickup.lng], [destination.lat, destination.lng]], { color: "red", dashArray: "5,10" }).addTo(map);

    return { distance: distKm, duration: durMin, fallback: true };
  } catch (err) {
    console.error("Route error:", err);

    // Last fallback
    let distKm = distanceInKm(pickup.lat, pickup.lng, destination.lat, destination.lng);
    let avgSpeedKmH = 60;
    let durMin = (distKm / avgSpeedKmH) * 60;

    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([[pickup.lat, pickup.lng], [destination.lat, destination.lng]], { color: "red", dashArray: "5,10" }).addTo(map);

    return { distance: distKm, duration: durMin, fallback: true };
  }
}


document.getElementById("rideForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  let pickupAddr = document.getElementById("pickup").value.trim();
  let destAddr = document.getElementById("destination").value;
  let rideType = document.getElementById("rideType").value;

  try {
    showSpinner("Finding pickup location...");

    let pickup;
    if (pickupAddr) {
      pickup = await geocode(pickupAddr);
    } else if (riderLocation) {
      // ‚úÖ fallback: use current GPS
      pickup = riderLocation;
      pickupAddr = await getPlaceName(pickup.lat, pickup.lng);
    } else {
      throw new Error("Pickup location not available.");
    }

    showSpinner("Finding destination...");
    let destination = await geocode(destAddr);
    pickupLocation = pickup;

    showSpinner("Calculating route...");
    let route = await getRoute(pickup, destination);

    if (pickupMarker) map.removeLayer(pickupMarker);
    if (destMarker) map.removeLayer(destMarker);

    pickupMarker = L.marker([pickup.lat, pickup.lng], { icon: pickupIcon })
      .addTo(map).bindPopup("üìç Pickup").openPopup();
    destMarker = L.marker([destination.lat, destination.lng], { icon: destIcon })
      .addTo(map).bindPopup("üèÅ Destination");

    map.fitBounds(L.featureGroup([pickupMarker, destMarker]).getBounds());

    showAvailableDrivers(route.distance, route.duration, pickupAddr, destAddr, rideType);
  } catch (err) {
    showAlert("‚ùå Error: " + err.message, "error");
  } finally {
    hideSpinner();
  }
});

async function showAvailableDrivers(distanceKm, durationMin, pickup, destination, rideType) {
  try {
    let snapshot = await db.collection("drivers").get();
    let drivers = [];

    // Collect drivers with computed cost
    for (let doc of snapshot.docs) {
      let d = doc.data();
      if (d.available) {
        let estCost = distanceKm * d.costPerKm;
        let fuel = estimateFuel(distanceKm, d.engineCc || "default");
        drivers.push({
          id: doc.id,
          ...d,
          estCost,
          fuel
        });
      }
    }

    // ‚úÖ Sort by estimated cost (cheapest ‚Üí expensive)
    drivers.sort((a, b) => a.estCost - b.estCost);

    let html = `
      <h3>üöó Available Drivers</h3>
      <p>Trip Distance: ${distanceKm.toFixed(2)} km (~${durationMin.toFixed(0)} min)</p>

      <!-- üîπ Legend Bar -->
      <div style="margin:10px 0; padding:8px; background:#f5f5f5; border-radius:6px; font-size:14px;">
        <span style="display:inline-block; margin-right:15px;">
          <span style="display:inline-block; width:14px; height:14px; background:#4CAF50; border-radius:50%; margin-right:5px;"></span>
          Cheapest
        </span>
        <span style="display:inline-block; margin-right:15px;">
          <span style="display:inline-block; width:14px; height:14px; background:#FFD700; border-radius:50%; margin-right:5px;"></span>
          Mid-range
        </span>
        <span style="display:inline-block;">
          <span style="display:inline-block; width:14px; height:14px; background:#F44336; border-radius:50%; margin-right:5px;"></span>
          Most Expensive
        </span>
      </div>
    `;

    drivers.forEach((d, index) => {
      let driverCardId = `driver-${d.id}`;

      // üöò Vehicle type icon
      let vehicleIcon = "https://i.imgur.com/k3kH1Li.png"; // default car
      if (/bike|motor/i.test(d.vehicle)) {
        vehicleIcon = "https://i.imgur.com/Y52y7SB.jpeg"; // motorbike
      } else if (/van/i.test(d.vehicle)) {
        vehicleIcon = "https://i.imgur.com/yQOp2aB.jpeg"; // van
      } else if (/bus/i.test(d.vehicle)) {
        vehicleIcon = "https://cdn-icons-png.flaticon.com/512/296/296223.png"; // bus
      }

      // üé® Border & background colors
      let borderColor = "#FFD700"; // default = yellow
      let backgroundColor = "white"; // default background

      if (index === 0) {
        borderColor = "#4CAF50"; // green = cheapest
        backgroundColor = "#e8f5e9"; // ‚úÖ light green highlight
      } else if (index === drivers.length - 1) {
        borderColor = "#F44336"; // red = most expensive
      }

      html += `
      <div class="ride-card" id="${driverCardId}" 
           style="position:relative; padding-right:50px; background:${backgroundColor}; border-left:5px solid ${borderColor};">
        <div style="position:absolute; top:10px; right:10px; 
                    width:44px; height:44px; border:3px solid ${borderColor}; 
                    border-radius:50%; display:flex; align-items:center; justify-content:center;">
          <img src="${vehicleIcon}" alt="vehicle" style="width:28px; height:28px;">
        </div>
        <p><strong>${d.name}</strong> (${d.vehicle} - ${d.plate}, ${d.engineCc || "N/A"}) üü¢ Online</p>
        <p>üìû ${d.phone}</p>
        <p>üìç Location: <strong>Loading...</strong></p>
        <p>üí≤ Cost per Km: ${formatKES(d.costPerKm)} KES</p>
        <p>üíµ Estimated Fare: ${formatKES(d.estCost)} KES</p>
        <p>‚õΩ Fuel: ${d.fuel.liters.toFixed(2)} L (~${formatKES(d.fuel.cost)} KES)</p>
        <button onclick="confirmRide(
            pickupMarker.getLatLng(),
            destMarker.getLatLng(),
            '${rideType}',
            '${d.id}',
            '${d.name}',
            '${d.plate}',
            '${formatKES(d.estCost)}'
        )">
          Book with ${d.name}
        </button>
      </div>`;

      // Background reverse geocode
      getPlaceName(d.lat, d.lng).then(placeName => {
        let card = document.getElementById(driverCardId);
        if (card) {
          let locationP = card.querySelector("p:nth-of-type(3) strong");
          if (locationP) locationP.innerText = placeName;
        }
      });
    });

    document.getElementById("rideResults").innerHTML = html;
  } catch (err) {
    console.error("Error showing available drivers:", err);
    document.getElementById("rideResults").innerHTML = "<p>‚ö†Ô∏è Could not load drivers. Please try again.</p>";
  }
}

/* ===================== üîπ confirmRide ===================== */
async function confirmRide(pickup, destination, rideType, driverId, driverName, plate, estCost) {
  const riderId = firebase.auth().currentUser.uid;
  activeDriverId = driverId;

  // Show quick fallback (coords or raw text)
  let pickupText = pickup.lat ? `${pickup.lat.toFixed(5)}, ${pickup.lng.toFixed(5)}` : pickup;
  let destText   = destination.lat ? `${destination.lat.toFixed(5)}, ${destination.lng.toFixed(5)}` : destination;

  // Try to resolve names before saving (faster user experience)
  let pickupName = pickup.lat ? await getPlaceName(pickup.lat, pickup.lng).catch(() => pickupText) : pickupText;
  let destName   = destination.lat ? await getPlaceName(destination.lat, destination.lng).catch(() => destText) : destText;

  // Save ride with names (or coords if lookup failed)
  let rideRef = await db.collection("rides").add({
    pickup: pickupName,
    pickupCoords: pickup.lat ? { lat: pickup.lat, lng: pickup.lng } : null,
    destination: destName,
    destCoords: destination.lat ? { lat: destination.lat, lng: destination.lng } : null,
    rideType,
    status: "pending",
    driverId,
    driverName,
    plate,
    estCost,
    riderId,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  showAlert(`‚úÖ Ride booked with ${driverName} for ${estCost} KES`, "success");
  trackRideStatus(rideRef.id);
}

/* ===================== üîπ Ride Status Tracking (Instant) ===================== */
function trackRideStatus(rideId) {
  db.collection("rides").doc(rideId).onSnapshot(doc => {
    let ride = doc.data();
    if (!ride) return;

    // ‚úÖ Always show something immediately
    let pickupText = ride.pickupCoords
      ? `${ride.pickupCoords.lat.toFixed(5)}, ${ride.pickupCoords.lng.toFixed(5)} (loading...)`
      : ride.pickup || "Unknown pickup";

    let destText = ride.destCoords
      ? `${ride.destCoords.lat.toFixed(5)}, ${ride.destCoords.lng.toFixed(5)} (loading...)`
      : ride.destination || "Unknown destination";

    // ‚úÖ If Firestore already has names (from confirmRide), prefer them
    if (ride.pickup && !ride.pickup.includes(",")) {
      pickupText = ride.pickup;
    }
    if (ride.destination && !ride.destination.includes(",")) {
      destText = ride.destination;
    }

    // Status handling
    let statusText = "Waiting for driver..."; 
    let cancelButton = "";

    if (ride.status === "accepted") { 
      statusText = `üöñ Driver ${ride.driverName} is on the way!`; 
      cancelButton = `<button onclick="cancelRide('${rideId}','rider')">‚ùå Cancel Ride</button>`; 
    } else if (ride.status === "completed") {
      statusText = "‚úÖ Ride Completed!";
    } else if (ride.status.startsWith("cancelled")) {
      statusText = "‚ùå Ride Cancelled!";
    } else {
      cancelButton = `<button onclick="cancelRide('${rideId}','rider')">‚ùå Cancel Ride</button>`;
    }

    // Render card immediately
    document.getElementById("rideResults").innerHTML = `
      <div class="ride-card" id="ride-${rideId}">
        <p><strong>Pickup:</strong> <span class="pickup-text">${pickupText}</span></p>
        <p><strong>Destination:</strong> <span class="dest-text">${destText}</span></p>
        <p><strong>Ride Type:</strong> ${ride.rideType}</p>
        <p><strong>Fare:</strong> ${ride.estCost} KES</p>
        <p id="rideStatus-${rideId}" style="color:blue; font-weight:bold;">${statusText}</p>
        ${cancelButton}
      </div>`;

    // üîÑ Background reverse geocode only if still coords
    if (ride.pickupCoords && (!ride.pickup || ride.pickup.includes(","))) {
      getPlaceName(ride.pickupCoords.lat, ride.pickupCoords.lng).then(place => {
        db.collection("rides").doc(rideId).update({ pickup: place });
        let el = document.querySelector(`#ride-${rideId} .pickup-text`);
        if (el) el.innerText = place;
      });
    }

    if (ride.destCoords && (!ride.destination || ride.destination.includes(","))) {
      getPlaceName(ride.destCoords.lat, ride.destCoords.lng).then(place => {
        db.collection("rides").doc(rideId).update({ destination: place });
        let el = document.querySelector(`#ride-${rideId} .dest-text`);
        if (el) el.innerText = place;
      });
    }
  });
}
function cancelRide(rideId, cancelledBy) {
  let reason = cancelledBy === "rider" ? "cancelled_by_rider" : "cancelled_by_driver";
  
  db.collection("rides").doc(rideId).update({ status: reason }).then(() => {
    showAlert("‚ùå Ride cancelled", "warning");

    // ‚úÖ Reset booked driver highlight
    activeDriverId = null;

    // ‚úÖ Show rider panel again with available drivers
    showRider(); // this already calls showAllAvailableDrivers() + autoFillPickup()
  });
}


/* ===================== üîπ Driver Registration ===================== */
document.getElementById("driverRegisterForm").addEventListener("submit", async function(e){
  e.preventDefault();

  let name=document.getElementById("driverName").value;
  let email=document.getElementById("driverEmail").value;
  let password=document.getElementById("driverPassword").value;
  let phone=document.getElementById("driverPhone").value;
  let vehicle=document.getElementById("driverVehicle").value;
  let plate=document.getElementById("driverPlate").value;
  let engineCc=document.getElementById("driverEngine").value;
  let costPerKm=parseFloat(document.getElementById("driverCost").value);

  try {
    const adminDoc = await db.collection("admins").doc(email).get();
    if (adminDoc.exists) {
      showAlert("üëë Admin detected. You can register as a driver for free.", "info");
      let userCredential = await firebase.auth().createUserWithEmailAndPassword(email,password);
      let uid = userCredential.user.uid;
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos=>{
          let lat=pos.coords.latitude, lng=pos.coords.longitude;
          await db.collection("drivers").doc(uid).set({
            name,email,phone,vehicle,plate,engineCc,
            available:true,lat,lng,costPerKm,
            registrationFeePaid:false, amountPaid:0, isAdminDriver:true
          });
          showAlert("‚úÖ Admin driver registered successfully!", "success");
          showDriverLogin();
        });
      }
    } else {
      showPaymentModalFor("driver_registration", 500, email, name, phone);
      window.handlePaymentSuccess = async function(type, itemId, itemName, userId) {
        if (type === "driver_registration") {
          try {
            let userCredential = await firebase.auth().createUserWithEmailAndPassword(email,password);
            let uid = userCredential.user.uid;
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(async pos=>{
                let lat=pos.coords.latitude, lng=pos.coords.longitude;
                await db.collection("drivers").doc(uid).set({
                  name,email,phone,vehicle,plate,engineCc,
                  available:true,lat,lng,costPerKm,
                  registrationFeePaid:true, amountPaid:500,
                  paymentRef: itemId, paymentPhone: phone
                });
                showAlert("‚úÖ Driver registered successfully after payment!", "success");
                showDriverLogin();
              });
            }
          } catch(err){ 
            showAlert("‚ùå Registration failed: " + err.message, "error"); 
          }
        }
      };
    }
  } catch (err) {
    showAlert("‚ùå Error checking admin status: " + err.message, "error");
  }
});

/* ===================== üîπ Driver Login + Live GPS ===================== */
document.getElementById("driverLoginForm").addEventListener("submit", function(e){
  e.preventDefault();
  let email = document.getElementById("driverLoginEmail").value.trim();
  let password = document.getElementById("driverLoginPassword").value;

  showSpinner("Logging in...");
  firebase.auth().signInWithEmailAndPassword(email, password)
    .then(userCredential => {
      currentDriver = userCredential.user;
      return db.collection("drivers").doc(currentDriver.uid).update({ available: true })
        .then(() => {
          hideSpinner();
          showAlert("‚úÖ Driver logged in successfully!", "success");
          showDriverPanel();
          if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
              db.collection("drivers").doc(currentDriver.uid).update({
                lat: pos.coords.latitude,
                lng: pos.coords.longitude
              });
            });
          }
        });
    })
    .catch(err => {
      hideSpinner();
      showAlert("‚ùå Login failed: " + err.message, "error");
    });

});
function logoutDriver() { 
  if (currentDriver) { 
    db.collection("drivers").doc(currentDriver.uid).update({ available: false }); 
    firebase.auth().signOut(); 
    showAlert("üö™ Driver logged out!", "info"); 
    showDriverLogin(); 
  } 
}
function showSpinner(message="Please wait...") {
  let spinner = document.getElementById("loadingSpinner");
  if (spinner) {
    spinner.querySelector("div").innerText = "‚è≥ " + message;
    spinner.style.display = "flex";
  }
}

function hideSpinner() {
  let spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "none";
}

/* ===================== üîπ Wrap Async Functions ===================== */
async function withSpinner(message, fn) {
  try {
    showSpinner(message);
    return await fn();
  } finally {
    hideSpinner();
  }
}
// Auto-detect pickup when Rider panel opens
function autoFillPickup() {
  getRiderLocation(async () => {
    try {
      let placeName = await getPlaceName(riderLocation.lat, riderLocation.lng);
      document.getElementById("pickup").value = placeName; // ‚úÖ autofill pickup field
    } catch (err) {
      console.error("Pickup autofill error:", err);
      showAlert("‚ö†Ô∏è Could not detect pickup location automatically.", "warning");
    }
  });
}

/* ===================== üîπ Custom Alert ===================== */
function showAlert(message, type = "info") {
  // Remove existing alert if present
  let old = document.getElementById("customAlert");
  if (old) old.remove();

  // Colors based on type
  let colors = {
    success: "#4caf50",
    error: "#f44336",
    info: "#2196f3",
    warning: "#ff9800"
  };
  let bg = colors[type] || colors.info;

  // Create alert box
  let box = document.createElement("div");
  box.id = "customAlert";
  box.style.cssText = `
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: ${bg};
    color: #fff;
    padding: 16px 24px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 500;
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    z-index: 99999;
    animation: fadeIn 0.3s ease-out;
    text-align: center;
    max-width: 80%;
  `;
  box.innerHTML = message;

  document.body.appendChild(box);

  // Auto remove after 4s
  setTimeout(() => {
    box.style.animation = "fadeOut 0.5s ease-in";
    setTimeout(() => box.remove(), 500);
  }, 4000);
}

// Alert animations
const style = document.createElement("style");
style.innerHTML = `
@keyframes fadeIn { 
  from {opacity:0; transform: translate(-50%, -60%);} 
  to {opacity:1; transform: translate(-50%, -50%);} 
}
@keyframes fadeOut { 
  from {opacity:1; transform: translate(-50%, -50%);} 
  to {opacity:0; transform: translate(-50%, -40%);} 
}
`;
document.head.appendChild(style);

</script>
